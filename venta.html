<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ventas Realizadas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

  <style>
    /* DISE√ëO MINIMALISTA SIMPLE - PANTALLA COMPLETA */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    html, body {
      height: 100vh;
      font-family: system-ui, -apple-system, sans-serif;
      background: #f9fafb;
      color: #111827;
      overflow: hidden;
    }

    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* HEADER SIMPLE */
    .header {
      background: white;
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .theme-btns button {
      padding: 8px 16px;
      margin-left: 8px;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 6px;
      cursor: pointer;
    }

    .theme-btns button.active {
      background: #111827;
      color: white;
      border-color: #111827;
    }

    /* CONTROLS */
    .controls {
      padding: 20px;
      background: white;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-input, select, button {
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }

    button {
      background: #111827;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }

    button:hover { background: #1f2937; }

    /* TOTALS */
    .totals {
      padding: 24px;
      background: white;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: center;
      gap: 48px;
    }

    .total-box {
      text-align: center;
    }

    .total-label {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .total-value {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
    }

    /* MAIN CONTENT */
    .main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      position: relative;
    }

    .card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .checkbox {
      position: absolute;
      top: 16px;
      right: 16px;
    }

    .card img {
      width: 100%;
      height: 140px;
      object-fit: contain;
      border-radius: 6px;
      margin-bottom: 12px;
      cursor: pointer;
    }

    .card h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .price {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 8px;
    }

    .info {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .delete-btn {
      width: 100%;
      padding: 10px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .delete-btn:hover {
      background: #dc2626;
    }

    /* PAGINATION */
    .pagination {
      padding: 20px;
      background: white;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    /* SPINNER */
    .spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.9);
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .spinner.active { display: block; }

    /* EMPTY */
    .empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    /* LOGIN */
    #loginOverlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #loginBox {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      text-align: center;
      min-width: 300px;
    }

    #loginBox h2 {
      margin-bottom: 24px;
      font-size: 28px;
    }

    #pinInput {
      width: 100%;
      padding: 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 20px;
      text-align: center;
      margin-bottom: 16px;
    }

    @media (max-width: 768px) {
      .totals { 
        flex-direction: column; 
        gap: 24px;
        text-align: center;
      }
      
      .main {
        grid-template-columns: 1fr;
        padding: 12px;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .controls > div {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
    }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div id="loginOverlay">
    <div id="loginBox">
      <h2>üîê Acceso</h2>
      <input id="pinInput" type="password" placeholder="Ingrese PIN (1234)" autocomplete="off">
      <div id="loginMsg" style="color:#ef4444; font-size:14px; min-height:20px;"></div>
    </div>
  </div>

  <div class="app" id="mainApp" style="display:none;">
    <div class="spinner" id="spinner">
      <i class="fas fa-spinner fa-spin" style="font-size:32px; color:#6b7280;"></i>
      <div style="margin-top:12px; color:#6b7280;">Cargando...</div>
    </div>

    <!-- HEADER -->
    <div class="header">
      <h1>Ventas Realizadas</h1>
      <div class="theme-btns">
        <button class="active" onclick="setTheme('light')">Claro</button>
        <button onclick="setTheme('dark')">Oscuro</button>
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
      <div style="display:flex; gap:12px; flex:1; flex-wrap:wrap;">
        <input type="text" id="searchInput" placeholder="Buscar nombre / c√≥digo / barcode">
        <select id="rowsPerPage">
          <option value="12">12 items</option>
          <option value="24" selected>24 items</option>
          <option value="48">48 items</option>
          <option value="100">100 items</option>
        </select>
      </div>
      <div style="display:flex; gap:12px;">
        <button onclick="generateFactura()">
          <i class="fas fa-receipt"></i> Generar Factura
        </button>
        <button onclick="window.location.href='lista.html'">
          <i class="fas fa-chart-line"></i> Ver Ingresos
        </button>
      </div>
    </div>

    <!-- TOTALS -->
    <div class="totals">
      <div class="total-box">
        <div class="total-label">Unidades Vendidas</div>
        <div id="totalQty" class="total-value">0</div>
      </div>
      <div class="total-box">
        <div class="total-label">Total Vendido</div>
        <div id="totalUSD" class="total-value">$0.00</div>
      </div>
    </div>

    <!-- GRID -->
    <div class="main" id="soldInventoryList"></div>
    <div class="empty" id="noResults" style="display:none;">
      <i class="fas fa-inbox" style="font-size:64px; opacity:0.5; margin-bottom:20px;"></i>
      <h3>No se encontraron ventas</h3>
      <p>Registra tus primeras ventas para verlas aqu√≠</p>
    </div>

    <!-- PAGINATION -->
    <div class="pagination">
      <button onclick="prevPage()" id="prevBtn">‚Üê Anterior</button>
      <span id="pageInfo" style="padding:12px 20px; color:#6b7280;">P√°gina 1</span>
      <button onclick="nextPage()" id="nextBtn">Siguiente ‚Üí</button>
    </div>
  </div>

  <!-- FACTURA MODAL -->
  <div id="facturaModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; padding:20px; align-items:center; justify-content:center;">
    <div style="background:white; padding:32px; border-radius:12px; max-width:500px; width:100%; max-height:90vh; overflow-y:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
        <h2>Factura</h2>
        <button onclick="cerrarFactura()" style="background:none; border:none; font-size:28px; cursor:pointer; color:#6b7280;">√ó</button>
      </div>
      
      <div style="margin-bottom:16px;">
        <label>Factura N¬∞</label>
        <input id="fNum" value="00015" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; margin-top:4px;">
      </div>
      
      <div style="margin-bottom:16px;">
        <label>Fecha</label>
        <input id="fFecha" readonly style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; margin-top:4px;">
      </div>
      
      <div style="margin-bottom:24px;">
        <label>Cliente</label>
        <input id="fCliente" value="Consumidor Final" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; margin-top:4px;">
      </div>

      <div style="background:#f9fafb; padding:20px; border-radius:8px; margin-bottom:24px;">
        <div style="font-weight:600; margin-bottom:12px;">Productos seleccionados:</div>
        <div id="facturaPreview"></div>
        <div style="font-size:24px; font-weight:700; text-align:right; margin-top:16px; color:#111827;">
          TOTAL: $<span id="facturaTotal">0.00</span>
        </div>
      </div>

      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button onclick="cerrarFactura()" style="padding:12px 24px; background:#6b7280; color:white; border:none; border-radius:6px; cursor:pointer;">Cancelar</button>
        <button onclick="imprimirFactura()" style="padding:12px 24px; background:#059669; color:white; border:none; border-radius:6px; cursor:pointer;">Imprimir</button>
        <button onclick="descargarPDF()" style="padding:12px 24px; background:#dc2626; color:white; border:none; border-radius:6px; cursor:pointer;">PDF</button>
      </div>
    </div>
  </div>

  <script>
    let soldInventory = JSON.parse(localStorage.getItem('soldInventory')) || [];
    let currentPage = 1;
    let rowsPerPage = 24;
    let filteredData = [];

    // LOGIN
    document.getElementById('pinInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        if (this.value === '1234') {
          document.getElementById('loginOverlay').style.display = 'none';
          document.getElementById('mainApp').style.display = 'flex';
          loadSoldInventory();
        } else {
          document.getElementById('loginMsg').textContent = 'PIN incorrecto';
          this.value = '';
          setTimeout(() => document.getElementById('loginMsg').textContent = '', 2000);
        }
      }
    });

    // EVENT LISTENERS
    document.getElementById('searchInput').addEventListener('input', function() {
      clearTimeout(window.searchTimeout);
      window.searchTimeout = setTimeout(loadSoldInventory, 300);
    });

    document.getElementById('rowsPerPage').addEventListener('change', function() {
      rowsPerPage = parseInt(this.value);
      currentPage = 1;
      loadSoldInventory();
    });

    function showSpinner() {
      document.getElementById('spinner').classList.add('active');
    }

    function hideSpinner() {
      document.getElementById('spinner').classList.remove('active');
    }

    function loadSoldInventory() {
      showSpinner();
      
      const search = document.getElementById('searchInput').value.toLowerCase();
      filteredData = soldInventory.filter(item =>
        item.name.toLowerCase().includes(search) ||
        item.code.toLowerCase().includes(search) ||
        (item.barcode || '').toLowerCase().includes(search)
      );

      // Update totals
      const totalQty = filteredData.reduce((sum, item) => sum + parseInt(item.quantity || 0), 0);
      const totalUSD = filteredData.reduce((sum, item) => sum + parseFloat(item.total || 0), 0);
      
      document.getElementById('totalQty').textContent = new Intl.NumberFormat('es-SV').format(totalQty);
      document.getElementById('totalUSD').textContent = '$' + new Intl.NumberFormat('es-SV').format(totalUSD.toFixed(2));

      // Pagination
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = filteredData.slice(start, end);

      const container = document.getElementById('soldInventoryList');
      container.innerHTML = '';

      if (pageData.length === 0) {
        document.getElementById('noResults').style.display = 'block';
      } else {
        document.getElementById('noResults').style.display = 'none';
        pageData.forEach(item => {
          const card = createCard(item);
          container.appendChild(card);
        });
      }

      updatePagination();
      hideSpinner();
    }

    function createCard(item) {
      const card = document.createElement('div');
      card.className = 'card';

      const img = document.createElement('img');
      localforage.getItem(`img_${item.code}`).then(blob => {
        if (blob) {
          img.src = URL.createObjectURL(blob);
          img.onclick = () => {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px';
            modal.innerHTML = `<img src="${img.src}" style="max-width:90%;max-height:90%;border-radius:8px;"><button onclick="this.parentNode.remove()" style="position:absolute;top:20px;right:20px;background:none;border:none;font-size:30px;color:white;cursor:pointer;">√ó</button>`;
            document.body.appendChild(modal);
          };
        } else {
          img.style.display = 'none';
        }
      });

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'checkbox';
      checkbox.value = JSON.stringify(item);

      card.innerHTML = `
        ${img.outerHTML}
        ${checkbox.outerHTML}
        <h3>${item.name}</h3>
        <div class="price">$${parseFloat(item.price).toLocaleString('es-SV', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
        <div class="info">Cantidad: ${parseInt(item.quantity).toLocaleString('es-SV')}</div>
        <div class="info">Total: $${parseFloat(item.total).toLocaleString('es-SV', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
        <div style="font-size:12px; color:#6b7280; font-family:monospace; margin-top:8px;">${item.barcode || item.code}</div>
        <button class="delete-btn" onclick="confirmDelete('${item.code}')">Eliminar Venta</button>
      `;

      return card;
    }

    function updatePagination() {
      const totalPages = Math.ceil(filteredData.length / rowsPerPage);
      document.getElementById('pageInfo').textContent = `P√°gina ${currentPage} de ${totalPages}`;
      
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage === totalPages;
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        loadSoldInventory();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(filteredData.length / rowsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        loadSoldInventory();
      }
    }

    window.confirmDelete = function(code) {
      if (confirm('¬øEliminar esta venta permanentemente?')) {
        soldInventory = soldInventory.filter(item => item.code !== code);
        localStorage.setItem('soldInventory', JSON.stringify(soldInventory));
        loadSoldInventory();
      }
    }

    // FACTURA FUNCTIONS
    function generateFactura() {
      const selected = Array.from(document.querySelectorAll('.checkbox:checked'))
        .map(cb => JSON.parse(cb.value));
      
      if (selected.length === 0) {
        alert('Selecciona al menos un producto marcando la casilla ‚úì');
        return;
      }

      document.getElementById('facturaModal').style.display = 'flex';
      document.getElementById('fFecha').value = new Date().toLocaleDateString('es-SV');
      actualizarFacturaPreview(selected);
    }

    function cerrarFactura() {
      document.getElementById('facturaModal').style.display = 'none';
    }

    function actualizarFacturaPreview(selected) {
      let total = 0;
      let html = '';
      
      selected.forEach(item => {
        const itemTotal = parseFloat(item.total || 0);
        total += itemTotal;
        html += `
          <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #e5e7eb;">
            <span>${item.name} (${parseInt(item.quantity).toLocaleString('es-SV')})</span>
            <span>$${itemTotal.toLocaleString('es-SV', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
          </div>
        `;
      });

      document.getElementById('facturaPreview').innerHTML = html;
      document.getElementById('facturaTotal').textContent = total.toLocaleString('es-SV', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function imprimirFactura() {
      const num = document.getElementById('fNum').value;
      const fecha = document.getElementById('fFecha').value;
      const cliente = document.getElementById('fCliente').value;
      
      const win = window.open('', '', 'width=400,height=600');
      win.document.write(`
        <html>
          <head>
            <title>Factura ${num}</title>
            <style>
              body { margin: 0; padding: 20px 15px; font-family: 'Courier New', monospace; font-size: 12px; width: 370px; }
              .header { text-align: center; margin-bottom: 20px; }
              .line { border-top: 2px dashed #000; margin: 10px 0; }
              table { width: 100%; border-collapse: collapse; }
              th, td { padding: 4px 2px; text-align: left; }
              th:last-child, td:last-child { text-align: right; }
              .total { font-size: 16px; font-weight: bold; text-align: right; margin-top: 15px; }
              .footer { font-size: 10px; margin-top: 15px; line-height: 1.3; }
            </style>
          </head>
          <body>
            <div class="header">
              <div style="font-size:16px; font-weight:bold;">KLOHESV</div>
              <div>San Salvador, El Salvador</div>
              <div>industriastobias@gmail.com</div>
              <div>Instagram: @Klohesv</div>
            </div>
            <div class="line"></div>
            <table>
              <tr><td>Factura:</td><td>${num}</td></tr>
              <tr><td>Fecha:</td><td>${fecha}</td></tr>
              <tr><td>Cliente:</td><td>${cliente}</td></tr>
            </table>
            <div class="line"></div>
            <table>
              <thead><tr><th>Producto</th><th style="width:50px;">Cant</th><th style="width:80px;">Total</th></tr></thead>
              <tbody id="printBody"></tbody>
            </table>
            <div class="line"></div>
            <div class="total">TOTAL: $${document.getElementById('facturaTotal').textContent}</div>
            <div class="footer">
              ¬°Gracias por su compra!<br>
              No se aceptan cambios ni devoluciones, salvo da√±o en producto dentro de 5 d√≠as.
            </div>
          </body>
        </html>
      `);
      win.document.close();
      win.focus();
      win.print();
      win.close();
    }

    function descargarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: [80, 200] });
      let y = 10;

      // Header
      doc.setFontSize(16);
      doc.text('KLOHESV', 40, y, { align: 'center' });
      y += 8;
      doc.setFontSize(10);
      doc.text('San Salvador, El Salvador', 40, y, { align: 'center' });
      y += 5;
      doc.text('industriastobias@gmail.com', 40, y, { align: 'center' });
      y += 5;
      doc.text('IG: @Klohesv', 40, y, { align: 'center' });
      y += 8;

      // Line
      doc.line(5, y, 75, y);
      y += 8;

      // Data
      doc.setFontSize(11);
      doc.text(`Factura N¬∞: ${document.getElementById('fNum').value}`, 5, y);
      y += 6;
      doc.text(`Fecha: ${document.getElementById('fFecha').value}`, 5, y);
      y += 6;
      doc.text(`Cliente: ${document.getElementById('fCliente').value}`, 5, y);
      y += 8;

      // Line
      doc.line(5, y, 75, y);
      y += 8;

      // Products (simplified)
      doc.text('Producto', 5, y);
      doc.text('Cant', 45, y);
      doc.text('Total', 65, y, { align: 'right' });
      y += 6;

      // Add your selected products logic here
      doc.text('Productos seleccionados', 5, y);
      y += 6;
      doc.text(`TOTAL: $${document.getElementById('facturaTotal').textContent}`, 65, y, { align: 'right' });
      
      y += 10;
      doc.setFontSize(9);
      doc.text('¬°Gracias por su compra! No se aceptan cambios salvo da√±o en 5 d√≠as.', 5, y, { maxWidth: 70 });

      doc.save(`factura_${document.getElementById('fNum').value}.pdf`);
    }

    function setTheme(theme) {
      document.querySelectorAll('.theme-btns button').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
    }

    // INIT
    function init() {
      loadSoldInventory();
    }

    // Auto-save on unload
    window.addEventListener('beforeunload', () => {
      localStorage.setItem('soldInventory', JSON.stringify(soldInventory));
    });

    // Start
    setTimeout(init, 500);
  </script>
</body>
</html>
