<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compra</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <style>
    :root{--bg:#f5f7fa;--card:#ffffff;--text:#1f2937;--accent:#3b82f6;--accent-hover:#2563eb;--danger:#ef4444;--success:#10b981;--radius:16px;--shadow:0 6px 20px rgba(0,0,0,.08);--shadow-hover:0 8px 24px rgba(0,0,0,.12);--transition:.3s ease;}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',system-ui,sans-serif}
    body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;padding:2rem 1rem}
    .sticky-menu{position:fixed;top:1rem;right:1rem;z-index:9999;}
    .menu-toggle{background:var(--card);border:none;border-radius:var(--radius);width:48px;height:48px;font-size:1.4rem;cursor:pointer;box-shadow:var(--shadow-hover);transition:transform .2s;}
    .menu-toggle:hover{transform:scale(1.1)}
    .menu-icons{display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem;background:var(--card);padding:.75rem;border-radius:var(--radius);box-shadow:var(--shadow-hover);display:none;}
    .menu-icons.show{display:flex}
    .menu-icons a{color:var(--text);font-size:1.3rem;text-align:center;padding:.4rem;border-radius:8px;transition:background .2s, color .2s;}
    .menu-icons a:hover{background:var(--accent);color:#fff}

    .total-box-fixed{position:fixed;top:1rem;left:1rem;z-index:9998;background:var(--card);padding:.75rem 1.25rem;border-radius:var(--radius);box-shadow:var(--shadow-hover);font-size:.9rem;line-height:1.2;}
    .total-box-fixed h2{font-size:.9rem;color:var(--accent);margin:0}
    .total-box-fixed p{font-size:1.4rem;font-weight:700;margin:0;color:var(--accent)}

    h1{font-size:2rem;font-weight:700;margin:3.5rem 0 1rem;letter-spacing:-.5px}
    .tipo-compra{display:flex;gap:.75rem;margin-bottom:1.2rem}
    .tipo-compra label{cursor:pointer;font-weight:500}
    .tipo-compra input{margin-right:.25rem}
    form, .table-cards, .mini-lote, #editLoteBubble > div{width:95%;max-width:1200px;margin:0 auto 2rem;}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.2rem}
    label{font-size:.9rem;font-weight:500;margin-bottom:.25rem;display:block}
    input,select,textarea{width:100%;padding:.75rem 1rem;border:1px solid #e5e7eb;border-radius:12px;background:#f9fafb;color:var(--text);transition:background .3s,border-color .3s;}
    input:focus,select:focus,textarea:focus{outline:none;background:#fff;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.2);}
    button{padding:.75rem 1.5rem;border:none;border-radius:12px;font-weight:600;cursor:pointer;transition:transform .2s,box-shadow .2s;}
    button:hover{transform:translateY(-2px)}
    .btn-primary{background:var(--accent);color:#fff;box-shadow:0 4px 14px rgba(59,130,246,.4)}
    .btn-danger{background:var(--danger);color:#fff;box-shadow:0 4px 14px rgba(239,68,68,.4)}
    .btn-success{background:var(--success);color:#fff;box-shadow:0 4px 14px rgba(16,185,129,.4)}
    .actions{display:flex;gap:1rem;flex-wrap:wrap;margin-top:1.2rem}
    .card-item{background:var(--card);border-radius:var(--radius);padding:1.5rem;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:.75rem;transition:transform var(--transition),box-shadow var(--transition);}
    .card-item:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover)}
    .card-item img{width:100%;height:160px;object-fit:cover;border-radius:12px}
    .card-item h3{font-size:1.1rem;color:var(--accent)}
    .card-item p{margin:0;font-size:.85rem;color:#6b7280}
    .card-item .actions{margin-top:auto;display:flex;gap:.5rem}
    #pagControls{display:flex;justify-content:center;gap:.5rem;margin:1rem 0;flex-wrap:wrap}
    #pagControls button{padding:.4rem .8rem;font-size:.8rem}
    #pagInfo{font-size:.8rem;align-self:center}
  </style>
</head>
<body>

<nav class="sticky-menu" aria-label="Navegaci√≥n principal">
  <button class="menu-toggle" id="menuToggle"><i class="fa-solid fa-bars"></i></button>
  <div class="menu-icons" id="menuIcons">
    <a href="compra.html" title="Compra"><i class="fa-solid fa-cart-plus"></i></a>
    <a href="almacenamiento.html" title="Almacenamiento"><i class="fa-solid fa-warehouse"></i></a>
    <a href="finanzas.html" title="Finanzas"><i class="fa-solid fa-dollar-sign"></i></a>
    <a href="inventario.html" title="Inventario"><i class="fa-solid fa-boxes-stacked"></i></a>
    <a href="catalogo.html" title="Cat√°logo"><i class="fa-solid fa-book"></i></a>
    <a href="clientes.html" title="Clientes"><i class="fa-solid fa-users"></i></a>
    <a href="descuentos.html" title="Descuentos"><i class="fa-solid fa-percent"></i></a>
    <a href="facturas.html" title="Facturas"><i class="fa-solid fa-file-invoice"></i></a>
    <a href="traslados.html" title="Traslados"><i class="fa-solid fa-truck-fast"></i></a>
    <a href="venta.html" title="Venta"><i class="fa-solid fa-cash-register"></i></a>
  </div>
</nav>

<div class="total-box-fixed">
  <h2>Total en USD</h2>
  <p id="totalAmount">$0.00</p>
</div>

<h1><i class="fa fa-cart-plus"></i> Compra</h1>

<div class="tipo-compra">
  <label><input type="radio" name="tipoCompra" value="normal" checked> Producto normal</label>
  <label><input type="radio" name="tipoCompra" value="lote"> Producto por lote / mayoreo</label>
</div>

<form id="purchaseForm" class="form-grid">
  <div><label>Nombre *</label><input type="text" id="name" name="name" required></div>
  <div><label>C√≥digo *</label><input type="text" id="code" name="code" required></div>
  <div>
    <label>C√≥digo de Barras *</label>
    <input type="text" id="barcode" name="barcode" required>
  </div>
  <div><label>Precio de venta *</label><input type="number" id="price" name="price" step="0.01" required></div>
  <div><label>Valor real (costo)</label><input type="number" id="valorReal" name="valorReal" step="0.01"></div>
  <div>
    <label>% ganancia sugerida</label>
    <input type="number" id="porcentajeGanancia" value="60" step="1" min="0" max="999">
  </div>
  <div>
    <label>Sugerencia venta</label>
    <input type="number" id="sugerenciaVenta" step="0.01" readonly style="background:#e5e7eb;color:#333">
  </div>
  <div><label>Fecha de compra *</label><input type="date" id="fechaCompra" name="fechaCompra" required></div>
  <div><label>Descuento (%)</label><input type="number" id="discount" name="discount" step="0.01" value="0"></div>
  <div><label>Cantidad en Stock *</label><input type="number" id="quantity" name="quantity" required></div>
  <div style="grid-column:1/-1"><label>Descripci√≥n *</label><textarea id="description" name="description" rows="2" required></textarea></div>
  <div>
    <label>Categor√≠a *</label>
    <select id="category" name="category" required>
      <option value="">-- Seleccione --</option>
      <option value="Accesorios para el cabello">Accesorios para el cabello</option>
      <option value="Anillos">Anillos</option>
      <option value="Aritos">Aritos</option>
      <option value="Billeteras">Billeteras</option>
      <option value="Carteras">Carteras</option>
      <option value="Case aud√≠fonos">Case aud√≠fonos</option>
      <option value="Case tel√©fonos">Case tel√©fonos</option>
      <option value="Chokers">Chokers</option>
      <option value="Collares">Collares</option>
      <option value="General">General</option>
      <option value="Lentes de sol">Lentes de sol</option>
      <option value="Otros">Otros</option>
      <option value="Pulseras">Pulseras</option>
      <option value="Relojes">Relojes</option>
    </select>
  </div>
  <div style="grid-column:1/-1">
    <label>Imagen del producto:</label>
    <input type="file" id="imageFile" accept="image/*" onchange="previewImage(event)">
    <div style="margin-top:.5rem"><img id="imagePreview" src="" alt="Vista previa" style="display:none;max-height:200px;border-radius:12px;box-shadow:var(--shadow)"></div>
  </div>
  <div style="grid-column:1/-1" class="actions">
    <button type="submit" class="btn-primary">Guardar producto</button>
    <button type="button" class="btn-primary" onclick="exportToZip()">Exportar ZIP</button>
    <button type="button" class="btn-primary" onclick="exportToPDF()">Exportar PDF con Im√°genes</button>
    <button type="button" class="btn-primary" onclick="resetAndOpenImport()">Importar ZIP</button>
    <input type="file" id="importFile" accept=".zip" style="display:none" onchange="importFromZip(event)">
    <button type="button" class="btn-danger" onclick="vaciarInventario()">Vaciar Inventario</button>
  </div>
</form>

<div style="width:95%;max-width:1200px;margin:0 auto 1rem;display:flex;gap:.75rem;flex-wrap:wrap">
  <input id="searchBox" type="text" placeholder="üîç Buscar por c√≥digo de barras (exacto)‚Ä¶" style="flex:1 1 260px">
  <select id="categoryFilter" style="flex:1 1 200px">
    <option value="">Todas las categor√≠as</option>
    <option value="Accesorios para el cabello">Accesorios para el cabello</option>
    <option value="Anillos">Anillos</option>
    <option value="Aritos">Aritos</option>
    <option value="Billeteras">Billeteras</option>
    <option value="Carteras">Carteras</option>
    <option value="Case aud√≠fonos">Case aud√≠fonos</option>
    <option value="Case tel√©fonos">Case tel√©fonos</option>
    <option value="Chokers">Chokers</option>
    <option value="Collares">Collares</option>
    <option value="General">General</option>
    <option value="Lentes de sol">Lentes de sol</option>
    <option value="Otros">Otros</option>
    <option value="Pulseras">Pulseras</option>
    <option value="Relojes">Relojes</option>
  </select>
</div>

<div>
  <h2><i class="fa fa-boxes"></i> Inventario actual</h2>
  <div id="inventoryList" class="table-cards"></div>
</div>

<!-- Controles de paginaci√≥n -->
<div id="pagControls">
  <button onclick="changePage(-1)">‚Üê Anterior</button>
  <span id="pagInfo"></span>
  <button onclick="changePage(1)">Siguiente ‚Üí</button>
</div>

<script>
/* =====  MEN√ö  ===== */
const menuToggle = document.getElementById('menuToggle');
const menuIcons = document.getElementById('menuIcons');
menuToggle.addEventListener('click', () => menuIcons.classList.toggle('show'));

/* =====  GLOBALES  ===== */
let inventory = [];
let currentPage = 0;
const ITEMS_PER_PAGE = 50;

/* =====  UTILS  ===== */
function escapeHtml(text) {
  return String(text || '').replace(/[&<>"'`]/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '`': '&#96;' })[s]);
}

/* =====  CARGAR INVENTARIO  ===== */
async function loadInventory() {
  inventory = await localforage.getItem('inventory') || [];
  renderPaginated();
  updateTotal();
}

/* =====  RENDER PAGINADO  ===== */
function renderPaginated() {
  const list = document.getElementById('inventoryList');
  if (!list) return;
  list.innerHTML = '';

  const search = document.getElementById('searchBox').value.trim();
  const cat = document.getElementById('categoryFilter').value;
  const filtered = inventory.filter(p =>
    (!search || p.barcode === search) &&
    (!cat || p.category === cat)
  );

  const start = currentPage * ITEMS_PER_PAGE;
  const end = start + ITEMS_PER_PAGE;
  const page = filtered.slice(start, end);

  list.innerHTML = page.map((item, idx) => `
    <div class="card-item" data-barcode="${item.barcode}" data-category="${item.category}">
      <img id="invImg${start + idx}" src="" alt="${escapeHtml(item.name)}"/>
      <h3>${escapeHtml(item.name)}</h3>
      <p>C√≥digo: ${escapeHtml(item.code)}</p>
      <p>C√≥d.Barras: ${escapeHtml(item.barcode)}</p>
      <p>Precio: $${Number(item.price).toFixed(2)}</p>
      <p>Stock: ${Number(item.quantity)}</p>
      <div class="actions">
        <button class="btn-primary" onclick="alert('Editar ${item.code}')"><i class="fa fa-edit"></i> Editar</button>
        <button class="btn-danger" onclick="alert('Borrar ${item.code}')"><i class="fa fa-trash"></i> Eliminar</button>
      </div>
    </div>
  `).join('');

  page.forEach((p, i) => {
    localforage.getItem(`img_${p.code}`).then(blob => {
      const img = document.getElementById(`invImg${start + i}`);
      if (blob && img) img.src = URL.createObjectURL(blob);
    });
  });

  updatePagControls(filtered.length);
}

/* =====  PAGINACI√ìN  ===== */
function updatePagControls(totalFiltered) {
  const totalPages = Math.ceil(totalFiltered / ITEMS_PER_PAGE);
  document.getElementById('pagInfo').textContent = `P√°g ${currentPage + 1} / ${totalPages}`;
  document.querySelector('#pagControls button:first-child').disabled = currentPage === 0;
  document.querySelector('#pagControls button:last-child').disabled = currentPage >= totalPages - 1;
}

function changePage(dir) {
  const search = document.getElementById('searchBox').value.trim();
  const cat = document.getElementById('categoryFilter').value;
  const filtered = inventory.filter(p =>
    (!search || p.barcode === search) &&
    (!cat || p.category === cat)
  );
  const max = Math.ceil(filtered.length / ITEMS_PER_PAGE) - 1;
  currentPage = Math.max(0, Math.min(max, currentPage + dir));
  renderPaginated();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* =====  FILTROS  ===== */
document.getElementById('searchBox').addEventListener('input', () => {
  currentPage = 0;
  renderPaginated();
});
document.getElementById('categoryFilter').addEventListener('change', () => {
  currentPage = 0;
  renderPaginated();
});

/* =====  TOTAL  ===== */
function updateTotal() {
  const total = inventory.reduce((sum, item) => {
    const price = Number(item.price) || 0;
    const quantity = Number(item.quantity) || 0;
    const discount = Number(item.discount) || 0;
    const finalPrice = price * (1 - discount / 100);
    return sum + finalPrice * quantity;
  }, 0);
  document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
}

/* =====  INICIALIZAR  ===== */
loadInventory();
</script>
</body>
</html>
