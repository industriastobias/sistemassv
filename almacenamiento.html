<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventario</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
    :root {
      --bg:#f9fafb; --text:#1f2937; --border:#e5e7eb; --accent:#3b82f6;
      --accent-hover:#2563eb; --highlight:#f3f4f6; --white:#ffffff; --danger:#ef4444;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Courier Prime',monospace}
    body{display:flex;flex-direction:column;align-items:center;font-size:16px;background:var(--bg);color:var(--text)}
    h1{font-size:1.8rem;font-weight:700;text-align:center;margin:.8rem 0 .6rem;letter-spacing:1px;text-transform:uppercase}
    .container{width:98vw;height:96vw;max-height:96vh;background:var(--white);border:1px solid var(--border);padding:1.2rem;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.05);display:flex;flex-direction:column;overflow:hidden}
    .search-block{display:flex;flex-wrap:wrap;gap:.8rem;margin-bottom:1rem;align-items:flex-end}
    label{font-weight:700;font-size:.9rem}
    input,select{padding:.55rem .65rem;border:1px solid var(--border);border-radius:6px;font-size:.95rem}
    button.stamp{padding:.55rem .9rem;border:1px solid var(--accent);background:var(--accent);color:var(--white);font-weight:700;font-size:.85rem;text-transform:uppercase;cursor:pointer;border-radius:6px;transition:background .2s ease}
    button.stamp:hover{background:var(--accent-hover)}
    table{width:100%;border-collapse:collapse;margin-top:.6rem}
    thead{background:var(--highlight)}
    th,td{padding:.55rem .65rem;border:1px solid var(--border);text-align:left;font-size:.9rem}
    th{font-weight:700;letter-spacing:.5px}
    tbody tr:nth-child(odd){background:var(--highlight)}
    td img{max-height:48px;border-radius:4px;object-fit:cover;cursor:pointer}
    .no-results,.result-message{font-weight:700;text-align:center;margin-top:.6rem;font-size:.9rem}
    .no-results{color:var(--danger)}
    .result-message{color:var(--text)}
    .highlight{background-color:#fef3c7 !important}
    img[src=""],img:not([src]){visibility:hidden}
    /* modales */
    .modal{display:none;position:fixed;z-index:20;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);backdrop-filter:blur(4px)}
    .modal-content{position:relative;margin:5vh auto;background:#fff;border-radius:16px;width:90vw;max-width:900px;height:90vh;max-height:800px;padding:2rem;box-shadow:0 10px 30px rgba(0,0,0,.15);display:flex;flex-direction:column;overflow-y:auto}
    .close{position:absolute;top:16px;right:20px;color:#6b7280;font-size:28px;font-weight:300;cursor:pointer;line-height:1}
    .close:hover{color:#111827}
    #modalImage{width:100%;height:auto;max-height:70vh;object-fit:contain;border-radius:12px;margin-top:1rem}
  </style>
</head>
<body>
  <h1>Inventario</h1>
  <div class="container">
    <div class="search-block">
      <div>
        <label for="searchCategory">Filtrar por categoría:</label>
        <select id="searchCategory">
          <option value="">Todas las categorías</option>
          <option>Aritos</option><option>Billeteras</option><option>Carteras</option>
          <option>Chokers</option><option>Collares</option><option>Lentes de sol</option>
          <option>Pulseras</option><option>Relojes</option><option>Anillos</option>
          <option>Accesorios para el cabello</option><option>Otros</option>
        </select>
      </div>
      <div>
        <label for="searchCode">Buscar por código de barras:</label>
        <input type="text" id="searchCode" autocomplete="off">
      </div>
      <button class="stamp" onclick="filterInventory()">Buscar</button>
    </div>

    <div style="display:flex;gap:.6rem;align-items:center;flex-wrap:wrap">
      <label for="goToRow">Ir a fila:</label>
      <input type="number" id="goToRow" min="1" style="width:80px;">
      <button class="stamp" onclick="goToRow()">Ir</button>
      <button class="stamp" onclick="clearFilters()" style="margin-left:auto">Limpiar filtros</button>
    </div>

    <div style="flex:1 1 auto;overflow:auto;margin-top:.5rem">
      <table>
        <thead>
          <tr>
            <th>#</th><th>Imagen</th><th>Nombre</th><th>Código</th>
            <th>Código de Barras</th><th>Precio</th><th>Desc(%)</th>
            <th>Precio c/Desc</th><th>Descripción</th><th>Categoría</th>
            <th>Stock</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody id="inventoryList"></tbody>
      </table>
      <div id="noResultsMessage" class="no-results" style="display:none">No se encontraron productos.</div>
      <div id="resultMessage" class="result-message" style="display:none"></div>
    </div>
  </div>

  <!-- Modal vender -->
  <div id="soldModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeSoldModal()">&times;</span>
      <h2>Registrar Venta</h2>
      <label for="soldQuantity">Cantidad vendida:</label>
      <input type="number" id="soldQuantity" min="1" max="999999">
      <label for="soldPrice" style="margin-top:1rem;display:block">Precio vendido (unidad):</label>
      <input type="number" id="soldPrice" min="0" step="0.01" placeholder="Ej: 1500">
      <button class="stamp" onclick="processSale()">Registrar</button>
      <div id="confirmationMessage" class="result-message" style="display:none;margin-top:1rem">¡Venta registrada!</div>
    </div>
  </div>

  <!-- Modal imagen -->
  <div id="imageModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeImageModal()">&times;</span>
      <img id="modalImage" src="" alt="Imagen ampliada">
    </div>
  </div>

  <script>
    /* ----------  helpers  ---------- */
    const $ = id => document.getElementById(id);
    const safeLS = (k,v) => { try { localStorage.setItem(k,JSON.stringify(v)); } catch(e){ alert('Memoria llena'); } };
    const loadLS = k => { try { return JSON.parse(localStorage.getItem(k)||'[]'); } catch(e){ return []; } };

    let inventory   = loadLS('inventory');
    let saleCode    = '';   // código único del producto que se está vendiendo

    /* ----------  render  ---------- */
    function loadInventory(filtered = inventory){
      const list = $('inventoryList');
      const noRes = $('noResultsMessage');
      const resMsg = $('resultMessage');
      list.innerHTML = '';
      noRes.style.display = 'none';
      resMsg.style.display = 'none';

      if(!filtered.length){ noRes.style.display='block'; return; }

      list.innerHTML = filtered.map((it,idx)=>{
        const priceWD = (it.price*(1-it.discount/100)).toFixed(2);
        return `
          <tr data-code="${it.code}">
            <td>${idx+1}</td>
            <td><img id="img-${it.code}" alt="${it.name}" onclick="openImageModal(this.src)"></td>
            <td>${it.name}</td><td>${it.code}</td><td>${it.barcode}</td>
            <td>${it.price}</td><td>${it.discount}</td><td>${priceWD}</td>
            <td>${it.description}</td><td>${it.category}</td><td>${it.quantity}</td>
            <td><button class="stamp" onclick="markSold('${it.code}')">Vender</button></td>
          </tr>`;
      }).join('');

      // carga imgenes asíncrona
      filtered.forEach(it=>{
        localforage.getItem(`img_${it.code}`).then(blob=>{
          if(blob){
            const url = URL.createObjectURL(blob);
            const img = $(`img-${it.code}`);
            if(img){ img.src = url; img.style.visibility='visible'; }
          }
        });
      });
    }

    /* ----------  venta  ---------- */
    function markSold(code){ saleCode = code; $('soldModal').style.display='block'; }
    function closeSoldModal(){
      $('soldModal').style.display='none';
      $('confirmationMessage').style.display='none';
      $('soldQuantity').value='';
      $('soldPrice').value='';
    }
    function processSale(){
      const qty = parseInt($('soldQuantity').value);
      const price = parseFloat($('soldPrice').value);
      if(isNaN(qty)||qty<=0){ alert('Cantidad inválida'); return; }
      if(isNaN(price)||price<0){ alert('Precio inválido'); return; }

      const item = inventory.find(x=>x.code===saleCode);
      if(!item){ alert('Producto no encontrado'); return; }
      if(qty>item.quantity){ alert('Stock insuficiente'); return; }

      item.quantity -= qty;
      safeLS('inventory',inventory);

      const sold = {
        name:item.name, code:item.code, price, quantity:qty, total:price*qty,
        date:new Date().toISOString()
      };
      const soldList = loadLS('soldInventory');
      soldList.push(sold);
      safeLS('soldInventory',soldList);

      filterInventory();          // refresca tabla
      closeSoldModal();
      $('resultMessage').textContent=`Venta registrada. Quedan ${item.quantity} unidades.`;
      $('resultMessage').style.display='block';
      setTimeout(()=>$('resultMessage').style.display='none',3000);
    }

    /* ----------  filtros  ---------- */
    function filterInventory(){
      const cat = $('searchCategory').value.trim().toLowerCase();
      const code = $('searchCode').value.trim().toLowerCase();

      // quita highlights anteriores
      document.querySelectorAll('tr.highlight').forEach(r=>r.classList.remove('highlight'));

      if(code){
        const found = inventory.findIndex(x=>x.barcode.trim().toLowerCase()===code);
        if(found===-1){
          $('inventoryList').innerHTML='';
          $('noResultsMessage').style.display='block';
          $('resultMessage').style.display='none';
          return;
        }
        const it = inventory[found];
        const priceWD = (it.price*(1-it.discount/100)).toFixed(2);
        $('inventoryList').innerHTML = `
          <tr data-code="${it.code}" class="highlight">
            <td>${found+1}</td>
            <td><img id="img-${it.code}" alt="${it.name}" onclick="openImageModal(this.src)"></td>
            <td>${it.name}</td><td>${it.code}</td><td>${it.barcode}</td>
            <td>${it.price}</td><td>${it.discount}</td><td>${priceWD}</td>
            <td>${it.description}</td><td>${it.category}</td><td>${it.quantity}</td>
            <td><button class="stamp" onclick="markSold('${it.code}')">Vender</button></td>
          </tr>`;
        localforage.getItem(`img_${it.code}`).then(blob=>{
          if(blob){ const url=URL.createObjectURL(blob); const img=$(`img-${it.code}`); if(img){ img.src=url; img.style.visibility='visible'; } }
        });
        $('noResultsMessage').style.display='none';
        $('resultMessage').textContent=`Producto encontrado en fila ${found+1} de ${inventory.length}.`;
        $('resultMessage').style.display='block';
        document.querySelector(`tr[data-code="${it.code}"]`).scrollIntoView({behavior:'smooth',block:'center'});
        return;
      }

      const filtered = inventory.filter(x=>{
        const catOk = !cat || x.category.trim().toLowerCase()===cat;
        return catOk && x.quantity>0;
      });
      loadInventory(filtered);
    }

    function goToRow(){
      const n = parseInt($('goToRow').value);
      const rows = document.querySelectorAll('#inventoryList tr');
      rows.forEach(r=>r.classList.remove('highlight'));
      if(n>=1 && n<=rows.length){
        rows[n-1].classList.add('highlight');
        rows[n-1].scrollIntoView({behavior:'smooth',block:'center'});
      } else alert('Fila fuera de rango.');
    }

    function clearFilters(){
      $('searchCategory').value='';
      $('searchCode').value='';
      $('goToRow').value='';
      loadInventory();
      $('resultMessage').style.display='none';
    }

    /* ----------  imagen  ---------- */
    function openImageModal(src){ $('modalImage').src=src; $('imageModal').style.display='block'; }
    function closeImageModal(){ $('imageModal').style.display='none'; }

    /* ----------  utils  ---------- */
    function debounce(fn,d){
      let t; return function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args),d); };
    }

    /* ----------  init  ---------- */
    $('searchCategory').addEventListener('change',debounce(filterInventory,300));
    $('searchCode').addEventListener('input',debounce(filterInventory,300));
    window.addEventListener('keydown',e=>{ if(e.key==='Escape'){ closeSoldModal(); closeImageModal(); } });
    loadInventory();
  </script>
</body>
</html>
