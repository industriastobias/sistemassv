<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventario</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css "/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js "></script>
  <style>
    :root{--bg:#f5f7fa;--card:#ffffff;--text:#1f2937;--accent:#3b82f6;--accent-hover:#2563eb;--danger:#ef4444;--success:#10b981;--radius:16px;--shadow:0 6px 20px rgba(0,0,0,.08);--shadow-hover:0 8px 24px rgba(0,0,0,.12);--transition:.3s ease;--highlight:#fef08a;}
    body.dark{--bg:#111;--card:#1e1e1e;--text:#eee;--highlight:#fde047;}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',system-ui,sans-serif}
    html{scroll-behavior:smooth}
    body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;padding:2rem 1rem}

    /* ---------- MENÚ KIOSKO ---------- */
    #kioskoBar{
      position:fixed;
      top:0; right:0;
      z-index: 9999;
      background: var(--card);
      box-shadow: var(--shadow);
      border-radius: 0 0 0 var(--radius);
      padding: .4rem .6rem;
      display: flex; gap: .5rem; flex-wrap: wrap;
      transform: translateX(100%);
      transition: transform .3s ease;
    }
    #kioskoBar.show{ transform: translateX(0); }
    #kioskoBar a{
      color: var(--accent);
      font-size: 1.3rem;
      padding: .4rem;
      border-radius: 50%;
      transition: background .2s;
    }
    #kioskoBar a:hover{background: var(--highlight);}

    #menuToggle{
      position: fixed;
      top: 1rem; right: 1rem;
      z-index: 10000;
      background: var(--accent);
      color: #fff;
      border: none;
      padding: .5rem .7rem;
      border-radius: 50%;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: var(--shadow);
    }

    h1{font-size:2rem;font-weight:700;margin-bottom:1rem;letter-spacing:-.5px}
    mark{background:var(--highlight);padding:.05rem .2rem;border-radius:4px;color:var(--text)}
    #themeToggle{position:fixed;top:1rem;left:1rem;background:var(--accent);color:#fff;border:none;padding:.5rem .7rem;border-radius:50%;font-size:1rem;cursor:pointer;box-shadow:var(--shadow);}
    .price-range{display:flex;gap:.5rem;align-items:center;margin-bottom:1rem;width:100%;max-width:960px}
    .price-range input{width:100%;padding:.5rem;border:1px solid #e5e7eb;border-radius:8px;background:#f9fafb;font-size:.9rem}
    .summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1.5rem;width:100%;max-width:960px;}
    .summary-card{background:var(--card);border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow);text-align:center;}
    .summary-card h3{font-size:.8rem;color:#6b7280;margin-bottom:.25rem}
    .summary-card p{font-size:1.5rem;font-weight:700;color:var(--accent);margin:0}
    .search-bar{width:100%;max-width:960px;margin-bottom:1.5rem;}
    .search-bar input{width:100%;padding:.75rem 1rem;border:1px solid #e5e7eb;border-radius:12px;background:#f9fafb;font-size:1rem;}
    .search-bar input:focus{outline:none;background:#fff;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.2);}
    
    /* Botón PDF */
    .pdf-button{
      width:100%;
      max-width:960px;
      margin-bottom:1rem;
    }
    .pdf-button button{
      width:100%;
      padding:.75rem 1rem;
      background:var(--success);
      color:#fff;
      border:none;
      border-radius:12px;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 4px 14px rgba(16,185,129,.4);
      transition:transform .2s;
    }
    .pdf-button button:hover{transform:translateY(-2px)}
    .pdf-button button i{margin-right:.5rem}

    .table-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:1.5rem;width:100%;max-width:1200px;}
    @media(max-width:1200px){.table-grid{grid-template-columns:repeat(4,1fr)}}
    @media(max-width:900px){.table-grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:600px){.table-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:400px){.table-grid{grid-column:1fr}}
    .line-item{background:var(--card);border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:.5rem;transition:transform var(--transition),box-shadow var(--transition);}
    .line-item:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover)}
    .line-item img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;cursor:zoom-in}
    .line-item h3{font-size:1rem;color:var(--accent)}
    .line-item p{margin:0;font-size:.75rem;color:#6b7280}
    .stock-line{font-weight:600;color:var(--success)}
    .actions{display:flex;gap:.5rem;margin-top:auto}
    button{padding:.4rem .8rem;border:none;border-radius:12px;font-weight:600;cursor:pointer;transition:transform .2s,box-shadow .2s;font-size:.75rem;}
    button:hover{transform:translateY(-2px)}
    .btn-primary{background:var(--accent);color:#fff;box-shadow:0 4px 14px rgba(59,130,246,.4);}
    .btn-danger{background:var(--danger);color:#fff;box-shadow:0 4px 14px rgba(239,68,68,.4);}
    .total-box{background:var(--card);padding:1.2rem 2rem;border-radius:var(--radius);box-shadow:var(--shadow);text-align:center;margin-top:2rem;}
    .total-box h2{font-size:1rem;color:var(--accent);margin:0}
    .total-box p{font-size:2rem;font-weight:700;margin:0;color:var(--accent)}
    .copy-barcode{cursor:pointer;margin-left:.3rem;color:var(--accent)}
    .copy-barcode:hover{color:var(--accent-hover)}
    .edit-form{display:flex;flex-direction:column;gap:.4rem;margin-top:.5rem;font-size:.75rem;}
    .edit-form input, .edit-form select{padding:.4rem .5rem;border:1px solid #e5e7eb;border-radius:6px;font-size:.75rem;}
    .edit-form button{padding:.3rem .6rem;font-size:.7rem;}
    @media print{body *{visibility:hidden} #printArea,#printArea *{visibility:visible} #printArea{position:absolute;top:0;left:0;width:100%}}
    #lightbox{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:9999;}
    #lightbox img{max-width:90%;max-height:90%;border-radius:12px;}

    /* Estilos para el PDF - CORREGIDO: posición fuera de pantalla en lugar de display:none */
    #pdfContent{
      position: absolute;
      left: -9999px;
      top: 0;
      width: 210mm;
      background:#fff;
      color:#000;
      padding:20px;
      font-family:Arial,sans-serif;
    }
    #pdfContent h1{
      text-align:center;
      color:#000;
      margin-bottom:20px;
      font-size:24px;
    }
    #pdfContent .pdf-item{
      border:1px solid #ccc;
      padding:15px;
      margin-bottom:15px;
      page-break-inside:avoid;
    }
    #pdfContent .pdf-item h3{
      margin:0 0 10px 0;
      color:#000;
      font-size:18px;
      border-bottom:2px solid #3b82f6;
      padding-bottom:5px;
    }
    #pdfContent .pdf-field{
      margin:5px 0;
      font-size:14px;
    }
    #pdfContent .pdf-label{
      font-weight:bold;
      color:#333;
    }
  </style>
</head>
<body>

<button id="menuToggle" title="Abrir menú"><i class="fa fa-bars"></i></button>

<nav id="kioskoBar">
  <a href="compra.html" title="Compra"><i class="fa fa-shopping-cart"></i></a>
  <a href="almacenamiento.html" title="Almacenamiento"><i class="fa fa-warehouse"></i></a>
  <a href="finanzas.html" title="Finanzas"><i class="fa fa-chart-line"></i></a>
  <a href="inventario.html" title="Inventario"><i class="fa fa-boxes"></i></a>
  <a href="catalogo.html" title="Catálogo"><i class="fa fa-book"></i></a>
  <a href="clientes.html" title="Clientes"><i class="fa fa-users"></i></a>
  <a href="descuentos.html" title="Descuentos"><i class="fa fa-percent"></i></a>
  <a href="facturas.html" title="Facturas"><i class="fa fa-file-invoice"></i></a>
  <a href="traslados.html" title="Traslados"><i class="fa fa-truck"></i></a>
  <a href="venta.html" title="Venta"><i class="fa fa-cash-register"></i></a>
  <a href="menu.html" title="Menú"><i class="fa fa-bars"></i></a>
</nav>

<button id="themeToggle" title="Cambiar tema"><i class="fa fa-moon"></i></button>

<h1><i class="fa fa-boxes"></i> Inventario – Sincronizado con Compras</h1>

<div class="summary-cards">
  <div class="summary-card"><h3>Total de productos</h3><p id="totalProducts">0</p></div>
  <div class="summary-card"><h3>Stock total</h3><p id="totalStock">0</p></div>
</div>

<div class="price-range">
  <input id="minPrice" type="number" placeholder="Precio mínimo" min="0" step="0.01"/>
  <input id="maxPrice" type="number" placeholder="Precio máximo" min="0" step="0.01"/>
</div>

<div class="search-bar">
  <input id="searchInput" type="text" placeholder="Buscar por nombre, código, barras o categoría..."/>
</div>

<div class="pdf-button">
  <button onclick="downloadPDF()"><i class="fa fa-file-pdf"></i> Descargar PDF del Inventario</button>
</div>

<div id="inventoryTable" class="table-grid"></div>

<div class="total-box"><h2>Total en USD</h2><p id="totalAmount">$0.00</p></div>

<div id="printArea" style="display:none;"></div>

<div id="lightbox" onclick="closeLightbox()">
  <img id="lightboxImg" src="" alt="Imagen ampliada"/>
</div>

<!-- Contenedor oculto para generar el PDF - CORREGIDO: posición absoluta fuera de pantalla -->
<div id="pdfContent">
  <h1>Reporte de Inventario</h1>
  <div id="pdfItems"></div>
</div>

<script>
function entrarKiosko(){
  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen().catch(()=>{});
  }
}
window.addEventListener('load', entrarKiosko);

const menuToggle = document.getElementById('menuToggle');
const kioskoBar  = document.getElementById('kioskoBar');
menuToggle.addEventListener('click', () => kioskoBar.classList.toggle('show'));

const CATEGORY_ORDER = [
  "Carteras","Aritos","Billeteras","Chokers","Collares","Lentes de sol","Pulseras","Relojes","Anillos","Accesorios para el cabello","Otros","Case teléfonos","Case audífonos","General"
];

let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
let filtered   = [...inventory];
let searchTerm = '';

const themeToggle = document.getElementById('themeToggle');
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  themeToggle.innerHTML = document.body.classList.contains('dark') ? '<i class="fa fa-sun"></i>' : '<i class="fa fa-moon"></i>';
});

function calculateTotal(list){
  return list.reduce((sum,item)=>{
    const price = parseFloat(item.price)||0;
    const qty   = parseFloat(item.quantity)||0;
    const disc  = parseFloat(item.discount)||0;
    return sum + (price * (1 - disc/100)) * qty;
  },0);
}
function stockTotal(list){
  return list.reduce((sum,item)=> sum + (parseInt(item.quantity)||0), 0);
}

function sortByCustomCategory(list) {
  return [...list].sort((a, b) => {
    const catA = (a.category || "Otros").trim();
    const catB = (b.category || "Otros").trim();
    const indexA = CATEGORY_ORDER.indexOf(catA);
    const indexB = CATEGORY_ORDER.indexOf(catB);
    const posA = indexA === -1 ? 999 : indexA;
    const posB = indexB === -1 ? 999 : indexB;
    return posA - posB || a.name.localeCompare(b.name);
  });
}

function highlight(text, query){
  if(!query) return text;
  const re = new RegExp(`(${query})`, 'gi');
  return text.replace(re, '<mark>$1</mark>');
}
function copyToClipboard(text){
  navigator.clipboard.writeText(text).then(()=>{
    alert('Código de barras copiado: ' + text);
  });
}

function openLightbox(src) {
  const lightbox = document.getElementById('lightbox');
  const img = document.getElementById('lightboxImg');
  img.src = src;
  lightbox.style.display = 'flex';
}
function closeLightbox() {
  document.getElementById('lightbox').style.display = 'none';
}

function renderTable(){
  const container = document.getElementById('inventoryTable');

  document.getElementById('totalProducts').textContent = inventory.length;
  document.getElementById('totalStock').textContent = stockTotal(inventory);

  filtered = sortByCustomCategory(filtered);

  if(!filtered.length){
    container.innerHTML = '<p style="text-align:center;color:#6b7280;grid-column:1/-1">No hay productos que coincidan con la búsqueda.</p>';
    document.getElementById('totalAmount').textContent = '$0.00';
    return;
  }

  container.innerHTML = filtered.map((item,idx)=>`
    <div class="line-item" id="card-${idx}">
      <img id="invImg${idx}" src="" alt="${item.name}"/>
      <h3>${highlight(item.name, searchTerm)}</h3>
      <p>Código: ${highlight(item.code, searchTerm)}</p>
      <p class="stock-line"><i class="fa fa-box"></i> Stock: ${item.quantity} u.</p>
      ${typeof item.discount === 'number' && item.discount > 0 ? `
        <p style="color:#ef4444;font-weight:600;">${item.discount}% OFF</p>
        <p>Precio: <del style="color:#9ca3af;">$${item.price}</del> <strong>$${(item.price * (1 - item.discount / 100)).toFixed(2)}</strong></p>
      ` : `
        <p>Precio: $${item.price}</p>
      `}
      <p>Categoría: ${highlight(item.category, searchTerm)}</p>
      <p style="font-size:.7rem;">Barras: ${highlight(item.barcode, searchTerm)}
        <i class="fa fa-copy copy-barcode" onclick="copyToClipboard('${item.barcode}')" title="Copiar código"></i>
      </p>
      <div class="actions">
        <button onclick="viewItem(${idx})" class="btn-primary">Ver</button>
        <button onclick="deleteItem(${idx})" class="btn-danger">Eliminar</button>
        <button onclick="editItem(${idx})" class="btn-primary">Editar</button>
      </div>
    </div>
  `).join('');

  filtered.forEach((p,i)=>{
    localforage.getItem(`img_${p.code}`).then(blob=>{
      if(blob){
        const url = URL.createObjectURL(blob);
        const img = document.getElementById(`invImg${i}`);
        img.src = url;
        img.onclick = () => openLightbox(url);
      }
    });
  });

  document.getElementById('totalAmount').textContent = `$${calculateTotal(filtered).toFixed(2)}`;
}

function viewItem(index){
  alert(`Detalles:\n\n${JSON.stringify(filtered[index],null,2)}`);
}
function deleteItem(index){
  if(!confirm('¿Eliminar producto?'))return;
  const realIndex = inventory.findIndex(it=> it.code === filtered[index].code);
  const item = inventory[realIndex];
  localforage.removeItem(`img_${item.code}`);
  inventory.splice(realIndex,1);
  localStorage.setItem('inventory', JSON.stringify(inventory));
  doFilter();
}

function editItem(index){
  const card = document.getElementById(`card-${index}`);
  const p    = filtered[index];
  const realIndex = inventory.findIndex(it=> it.code === p.code);
  if(card.querySelector('.edit-form')) return;

  const form = document.createElement('div');
  form.className = 'edit-form';
  form.innerHTML = `
    <input id="editName${index}" value="${p.name}" placeholder="Nombre"/>
    <input id="editPrice${index}" type="number" step="0.01" value="${p.price}" placeholder="Precio"/>
    <input id="editQty${index}"  type="number" value="${p.quantity}" placeholder="Stock"/>
    <select id="editCat${index}">
      <option value="Accesorios para el cabello" ${p.category === 'Accesorios para el cabello' ? 'selected' : ''}>Accesorios para el cabello</option>
      <option value="Anillos" ${p.category === 'Anillos' ? 'selected' : ''}>Anillos</option>
      <option value="Aritos" ${p.category === 'Aritos' ? 'selected' : ''}>Aritos</option>
      <option value="Billetera" ${p.category === 'Billetera' ? 'selected' : ''}>Billetera</option>
      <option value="Carteras" ${p.category === 'Carteras' ? 'selected' : ''}>Carteras</option>
      <option value="Case audífonos" ${p.category === 'Case audífonos' ? 'selected' : ''}>Case audífonos</option>
      <option value="Case teléfonos" ${p.category === 'Case teléfonos' ? 'selected' : ''}>Case teléfonos</option>
      <option value="Chokers" ${p.category === 'Chokers' ? 'selected' : ''}>Chokers</option>
      <option value="Collares" ${p.category === 'Collares' ? 'selected' : ''}>Collares</option>
      <option value="General" ${p.category === 'General' ? 'selected' : ''}>General</option>
      <option value="Lentes de sol" ${p.category === 'Lentes de sol' ? 'selected' : ''}>Lentes de sol</option>
      <option value="Pulseras" ${p.category === 'Pulseras' ? 'selected' : ''}>Pulseras</option>
      <option value="Relojes" ${p.category === 'Relojes' ? 'selected' : ''}>Relojes</option>
      <option value="Otros" ${p.category === 'Otros' ? 'selected' : ''}>Otros</option>
    </select>
    <input id="editBar${index}"  value="${p.barcode}" placeholder="Código de barras"/>
    <div style="display:flex;gap:.3rem">
      <button onclick="saveEdit(${index},${realIndex})" class="btn-primary">Guardar</button>
      <button onclick="cancelEdit(${index})" class="btn-danger">Cancelar</button>
    </div>
  `;
  card.appendChild(form);
}
function cancelEdit(index){
  document.getElementById(`card-${index}`).querySelector('.edit-form').remove();
}
function saveEdit(filterIdx, invIdx){
  const newData = {
    name:     document.getElementById(`editName${filterIdx}`).value.trim(),
    price:    document.getElementById(`editPrice${filterIdx}`).value.trim(),
    quantity: document.getElementById(`editQty${filterIdx}`).value.trim(),
    category: document.getElementById(`editCat${filterIdx}`).value.trim(),
    barcode:  document.getElementById(`editBar${filterIdx}`).value.trim(),
    code:     filtered[filterIdx].code,
    discount: filtered[filterIdx].discount || 0
  };
  inventory[invIdx] = newData;
  localStorage.setItem('inventory', JSON.stringify(inventory));
  doFilter();
}

function doFilter(){
  searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
  const minP = parseFloat(document.getElementById('minPrice').value) || 0;
  const maxP = parseFloat(document.getElementById('maxPrice').value) || Infinity;

  filtered = inventory.filter(p=>{
    const price = parseFloat(p.price)||0;
    const matchText = !searchTerm ||
      p.name.toLowerCase().includes(searchTerm) ||
      p.code.toLowerCase().includes(searchTerm) ||
      p.barcode.toLowerCase().includes(searchTerm) ||
      p.category.toLowerCase().includes(searchTerm);
    const matchPrice = price >= minP && price <= maxP;
    return matchText && matchPrice;
  });
  renderTable();
}
document.getElementById('searchInput').addEventListener('input',doFilter);
document.getElementById('minPrice').addEventListener('input',doFilter);
document.getElementById('maxPrice').addEventListener('input',doFilter);

window.addEventListener('storage', e => {
  if(e.key === 'inventory'){
    inventory = JSON.parse(e.newValue) || [];
    doFilter();
  }
});
window.addEventListener('storage', e => {
  if (e.key === 'inventario') {
    inventory = JSON.parse(e.newValue) || [];
    localStorage.setItem('inventory', JSON.stringify(inventory));
    doFilter();
  }
});
const originalSetItem = localStorage.setItem;
localStorage.setItem = function(key, value) {
  originalSetItem.call(this, key, value);
  if (key === 'inventory') {
    originalSetItem.call(this, 'inventario', value);
  }
};

// Función para descargar PDF - CORREGIDA
async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  
  if (!filtered || filtered.length === 0) {
    alert('No hay productos para generar el PDF');
    return;
  }
  
  // Preparar el contenido del PDF con los datos filtrados
  const pdfItems = document.getElementById('pdfItems');
  pdfItems.innerHTML = '';
  
  const sortedItems = sortByCustomCategory(filtered);
  
  sortedItems.forEach(item => {
    const finalPrice = item.discount > 0 
      ? (item.price * (1 - item.discount / 100)).toFixed(2)
      : item.price;
      
    const itemDiv = document.createElement('div');
    itemDiv.className = 'pdf-item';
    itemDiv.innerHTML = `
      <h3>${item.name}</h3>
      <div class="pdf-field"><span class="pdf-label">DESCRIPCIÓN:</span> ${item.name}</div>
      <div class="pdf-field"><span class="pdf-label">CÓDIGO:</span> ${item.code}</div>
      <div class="pdf-field"><span class="pdf-label">Stock:</span> ${item.quantity} unidades</div>
      <div class="pdf-field"><span class="pdf-label">Precio:</span> $${finalPrice} ${item.discount > 0 ? `(Descuento ${item.discount}%)` : ''}</div>
      <div class="pdf-field"><span class="pdf-label">Categoría:</span> ${item.category}</div>
      <div class="pdf-field"><span class="pdf-label">Barras:</span> ${item.barcode}</div>
    `;
    pdfItems.appendChild(itemDiv);
  });
  
  // CORRECCIÓN: El contenedor ya está posicionado fuera de pantalla con CSS
  // No necesitamos cambiar display, solo asegurarnos que esté renderizado
  const pdfContent = document.getElementById('pdfContent');
  
  // Forzar reflow para asegurar que el contenido esté renderizado
  pdfContent.offsetHeight;
  
  try {
    // Esperar un momento para que el DOM se actualice
    await new Promise(resolve => setTimeout(resolve, 100));
    
    const canvas = await html2canvas(pdfContent, {
      scale: 2,
      useCORS: true,
      logging: false,
      allowTaint: true,
      backgroundColor: '#ffffff',
      width: 794, // Ancho A4 en pixels a 96 DPI
      windowWidth: 794
    });
    
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    const imgWidth = 210;
    const pageHeight = 297;
    const imgHeight = canvas.height * imgWidth / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;
    
    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;
    
    while (heightLeft >= 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }
    
    pdf.save('inventario.pdf');
  } catch (error) {
    console.error('Error generando PDF:', error);
    alert('Error al generar el PDF: ' + error.message);
  }
}

window.addEventListener('DOMContentLoaded',()=> doFilter());
</script>
</body>
</html>
