<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <title>Lista Financiera - IndexedDB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;margin:0;padding:1rem}
    header{background:#1a73e8;color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center}
    button{cursor:pointer;padding:.4rem .8rem;border:none;border-radius:4px;background:#fff;color:#1a73e8;font-weight:600}
    nav{display:flex;gap:1rem;background:#fff;border-bottom:1px solid #ddd;padding:.5rem 1rem}
    .tab{cursor:pointer;padding:.5rem 1rem;border-radius:4px}
    .tab.active{background:#1a73e8;color:#fff}
    section{display:none}
    section.active{display:block}
    form{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.5rem;background:#fff;padding:1rem;border-radius:6px;margin:1rem 0}
    input,select,textarea{width:100%;padding:.4rem;font-size:.9rem}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:6px;overflow:hidden}
    th,td{padding:.5rem;font-size:.85rem;border-bottom:1px solid #eee}
    th{background:#f5f5f5}
    .acciones button{background:none;border:none;font-size:1rem;margin:0 .2rem}
    .acciones .editar{color:#1a73e8}
    .acciones .eliminar{color:#e53935}
  </style>
</head>
<body>

<header>
  <span>üìä Lista Financiera</span>
  <div>
    <button onclick="exportar()">üì• Exportar</button>
    <button onclick="document.getElementById('inpImport').click()">üì§ Importar</button>
    <input type="file" id="inpImport" accept=".json" style="display:none" onchange="importar(event)">
  </div>
</header>

<nav>
  <div class="tab active" onclick="mostrar('dashboard')">Dashboard</div>
  <div class="tab" onclick="mostrar('ingresos')">Ingresos</div>
  <div class="tab" onclick="mostrar('gastos')">Gastos</div>
  <div class="tab" onclick="mostrar('proveedores')">Proveedores</div>
  <div class="tab" onclick="mostrar('cuentas')">Cuentas</div>
</nav>

<!-- DASHBOARD -->
<section id="dashboard" class="active">
  <h3>Resumen</h3>
  <p><strong>Total Ingresos:</strong> <span id="tIngresos">$0.00</span></p>
  <p><strong>Total Gastos:</strong> <span id="tGastos">$0.00</span></p>
  <p><strong>Saldo:</strong> <span id="tSaldo">$0.00</span></p>
</section>

<!-- INGRESOS -->
<section id="ingresos">
  <h3>Ingresos</h3>
  <form onsubmit="agregar(event,'ingreso')">
    <input name="fecha" type="date" required>
    <input name="descripcion" placeholder="Descripci√≥n" required>
    <input name="categoria" placeholder="Categor√≠a">
    <input name="monto" type="number" step="0.01" placeholder="Monto" required>
    <input name="metodo_pago" placeholder="M√©todo pago">
    <input name="responsable" placeholder="Responsable">
    <button>Guardar</button>
  </form>
  <table id="tblIngresos"><thead><tr>
    <th>Fecha</th><th>Descripci√≥n</th><th>Categor√≠a</th><th>Monto</th><th>M√©todo</th><th>Responsable</th><th></th>
  </tr></thead><tbody></tbody></table>
</section>

<!-- GASTOS -->
<section id="gastos">
  <h3>Gastos</h3>
  <form onsubmit="agregar(event,'gasto')">
    <input name="fecha" type="date" required>
    <input name="proveedor" placeholder="Proveedor">
    <input name="categoria" placeholder="Categor√≠a">
    <input name="descripcion" placeholder="Descripci√≥n">
    <input name="monto" type="number" step="0.01" placeholder="Monto" required>
    <input name="metodo_pago" placeholder="M√©todo pago">
    <input name="responsable" placeholder="Responsable">
    <button>Guardar</button>
  </form>
  <table id="tblGastos"><thead><tr>
    <th>Fecha</th><th>Proveedor</th><th>Categor√≠a</th><th>Descripci√≥n</th><th>Monto</th><th>M√©todo</th><th>Responsable</th><th></th>
  </tr></thead><tbody></tbody></table>
</section>

<!-- PROVEEDORES -->
<section id="proveedores">
  <h3>Proveedores</h3>
  <form onsubmit="agregar(event,'proveedor')">
    <input name="nombre" placeholder="Nombre" required>
    <input name="nit" placeholder="NIT">
    <input name="telefono" placeholder="Tel√©fono">
    <input name="email" type="email" placeholder="Email">
    <input name="direccion" placeholder="Direcci√≥n">
    <button>Guardar</button>
  </form>
  <table id="tblProveedores"><thead><tr>
    <th>Nombre</th><th>NIT</th><th>Tel√©fono</th><th>Email</th><th>Direcci√≥n</th><th></th>
  </tr></thead><tbody></tbody></table>
</section>

<!-- CUENTAS -->
<section id="cuentas">
  <h3>Cuentas pendientes</h3>
  <form onsubmit="agregar(event,'cuenta')">
    <select name="tipo"><option>Por cobrar</option><option>Por pagar</option></select>
    <input name="cliente_proveedor" placeholder="Cliente / Proveedor">
    <input name="concepto" placeholder="Concepto">
    <input name="monto" type="number" step="0.01" placeholder="Monto" required>
    <input name="fecha_vencimiento" type="date">
    <select name="estado"><option>Pendiente</option><option>Pagado</option></select>
    <button>Guardar</button>
  </form>
  <table id="tblCuentas"><thead><tr>
    <th>Tipo</th><th>Cliente/Prov</th><th>Concepto</th><th>Monto</th><th>Vencimiento</th><th>Estado</th><th></th>
  </tr></thead><tbody></tbody></table>
</section>

<script>
/* ==========  INDEXEDDB  ========== */
const DB_NAME = 'finanzas';
const STORE   = 'datos';
let db;

function abrirDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onerror = () => reject(req.error);
    req.onsuccess = () => { db = req.result; resolve(); };
    req.onupgradeneeded = e => {
      const st = e.target.result.createObjectStore(STORE, {keyPath: 'id', autoIncrement: true});
      st.createIndex('tipo', 'tipo', {unique: false});
    };
  });
}

async addTipo(tipo, obj) {
  obj.tipo = tipo;
  const tx = db.transaction(STORE, 'readwrite');
  tx.objectStore(STORE).add(obj);
  await tx.done;
}

async getTipo(tipo) {
  const tx = db.transaction(STORE, 'readonly');
  const idx = tx.objectStore(STORE).index('tipo');
  return idx.getAll(tipo);
}

async delId(id) {
  const tx = db.transaction(STORE, 'readwrite');
  tx.objectStore(STORE).delete(id);
  await tx.done;
}

/* ==========  NAVEGACI√ìN  ========== */
function mostrar(pantalla) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.getElementById(pantalla).classList.add('active');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  refrescar();
}

/* ==========  ALTA / BAJA / LISTADO  ========== */
async agregar(ev, tipo) {
  ev.preventDefault();
  const frm = ev.target;
  const obj = Object.fromEntries(new FormData(frm));
  await addTipo(tipo, obj);
  frm.reset();
  refrescar();
}

async borrar(id) {
  if (confirm('¬øEliminar?')) { await delId(id); refrescar(); }
}

/* ==========  REFRESCAR TABLAS / DASHBOARD  ========== */
async refrescar() {
  const ing = await getTipo('ingreso');
  const gas = await getTipo('gasto');
  const prov= await getTipo('proveedor');
  const cta = await getTipo('cuenta');

  const sum = arr => arr.reduce((s, x) => s + (parseFloat(x.monto) || 0), 0);
  document.getElementById('tIngresos').textContent = '$' + sum(ing).toFixed(2);
  document.getElementById('tGastos').textContent    = '$' + sum(gas).toFixed(2);
  document.getElementById('tSaldo').textContent     = '$' + (sum(ing) - sum(gas)).toFixed(2);

  pintar('tblIngresos', ing, ['fecha','descripcion','categoria','monto','metodo_pago','responsable']);
  pintar('tblGastos',   gas, ['fecha','proveedor','categoria','descripcion','monto','metodo_pago','responsable']);
  pintar('tblProveedores', prov, ['nombre','nit','telefono','email','direccion']);
  pintar('tblCuentas', cta, ['tipo','cliente_proveedor','concepto','monto','fecha_vencimiento','estado']);
}

function pintar(idTabla, lista, cols) {
  const tbody = document.querySelector(`#${idTabla} tbody`);
  tbody.innerHTML = lista.map(it =>
    `<tr>${cols.map(c => `<td>${it[c]||''}</td>`).join('')}
     <td class="acciones"><button onclick="borrar(${it.id})">üóëÔ∏è</button></td></tr>`
  ).join('');
}

/* ==========  EXPORTAR / IMPORTAR  ========== */
async exportar() {
  if (!db) await abrirDB();
  const datos = {
    ingresos: await getTipo('ingreso'),
    gastos:   await getTipo('gasto'),
    proveedores: await getTipo('proveedor'),
    cuentas:  await getTipo('cuenta')
  };
  const blob = new Blob([JSON.stringify(datos, null, 2)], {type: 'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = 'respaldo_lista.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async importar(ev) {
  const file = ev.target.files[0];
  if (!file) return;
  const txt  = await file.text();
  try {
    const datos = JSON.parse(txt);
    if (!confirm('‚ö†Ô∏è  Reemplazar√° todos los datos. ¬øContinuar?')) return;
    if (!db) await abrirDB();
    const tx  = db.transaction(STORE, 'readwrite');
    const st  = tx.objectStore(STORE);
    await st.clear();
    for (const grupo of ['ingresos','gastos','proveedores','cuentas']) {
      for (const it of (datos[grupo]||[])) {
        it.tipo = grupo.slice(0, -1);   // quita la "s"
        await st.add(it);
      }
    }
    alert('‚úÖ Importado. Recargando...');
    location.reload();
  } catch (e) { alert('‚ùå Archivo no v√°lido'); }
}

/* ==========  ARRANQUE  ========== */
(async () => {
  await abrirDB();
  await refrescar();
})();
</script>
</body>
</html>
