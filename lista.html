<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LISTA - INGRESOS Y VENTAS</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --bg: #f4f6f8;
      --card: #ffffff;
      --primary: #1a73e8;
      --secondary: #0d47a1;
      --text: #2c3e50;
      --muted: #7f8c8d;
      --radius: 12px;
      --shadow: 0 3px 10px rgba(0,0,0,.05);
    }
    body.dark {
      --bg: #0f1116;
      --card: #1a1d24;
      --text: #e0e0e0;
      --muted: #8a8a8a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background .3s, color .3s;
    }
    header {
      background: var(--card);
      padding: 1.2rem 2rem;
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--primary);
      text-align: center;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header button {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      padding: .5rem 1rem;
      cursor: pointer;
      font-weight: 600;
    }
    main {
      padding: 2rem;
      max-width: 1200px;
      margin: auto;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax 200px, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .card {
      background: var(--card);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
      transition: transform .2s;
    }
    .card:hover { transform: translateY(-4px); }
    .card h3 { font-size: .9rem; color: var(--muted); margin-bottom: .5rem; }
    .card p { font-size: 1.5rem; font-weight: 600; color: var(--primary); }
    canvas { display: block; margin: 2rem auto; max-width: 350px; }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax 200px, 1fr);
      gap: 1rem;
      background: var(--card);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 1rem;
    }
    input, button {
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: var(--radius);
      background: var(--bg);
      color: var(--text);
      font-family: inherit;
      font-size: .9rem;
    }
    button {
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background .2s;
    }
    button:hover { background: var(--secondary); }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      font-size: .85rem;
    }
    body.dark th, body.dark td { border-color: #333; }
    th {
      background: #f8f9fa;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .5px;
      cursor: pointer;
    }
    body.dark th { background: #101217; }
    tr:nth-child(even) { background: #f9fafb; }
    body.dark tr:nth-child(even) { background: #15171c; }
    tr:hover td { background: #f3f6fa; }
    body.dark tr:hover td { background: #1f232a; }
    .acciones button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.1rem;
      margin: 0 4px;
    }
    .acciones .editar { color: var(--primary); }
    .acciones .eliminar { color: #e53935; }
    .excel-bar {
      display: flex;
      gap: .5rem;
      margin-bottom: .5rem;
    }
    .filtro {
      width: 100%;
      margin-bottom: .5rem;
    }
    .total-tabla {
      text-align: right;
      font-weight: 700;
      margin-top: .5rem;
      color: var(--primary);
    }
    #toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: var(--primary);
      color: #fff;
      padding: .7rem 1.2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: none;
      font-weight: 600;
      z-index: 999;
    }
  </style>
</head>
<body>
<header>
  <span>LISTA - INGRESOS Y VENTAS</span>
  <button id="toggleTheme">üåó Toggle</button>
</header>

<main>
  <!-- DASHBOARD -->
  <section id="dashboard">
    <h2>Dashboard</h2>
    <div class="dashboard">
      <div class="card"><h3>Total Ingresos</h3><p id="totalIngresos">$0.00</p></div>
    </div>
    <canvas id="chartResumen"></canvas>
  </section>

  <!-- INGRESOS -->
  <section id="ingresos">
    <h2>Ingresos</h2>
    <input class="filtro" id="filtroIngresos" placeholder="Filtrar por fecha, descripci√≥n, categor√≠a...">
    <table id="tablaIngresos">
      <thead>
        <tr>
          <th data-sort="numero">#</th>
          <th data-sort="fecha">Fecha</th>
          <th data-sort="descripcion">Descripci√≥n</th>
          <th data-sort="categoria">Categor√≠a</th>
          <th data-sort="monto">Monto</th>
          <th>M√©todo Pago</th>
          <th>Responsable</th>
          <th>Observaciones</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="total-tabla" id="totalIngresosTabla">Total: $0.00</div>
  </section>

  <!-- INVENTARIO -->
  <section id="inventario">
    <h2>Inventario</h2>
    <form id="formProducto">
      <input name="nombre" placeholder="Nombre del producto" required>
      <input name="codigo" placeholder="C√≥digo" required>
      <input name="cantidad" type="number" placeholder="Cantidad" required>
      <input name="precio" type="number" step="0.01" placeholder="Precio unitario" required>
      <button type="submit">Agregar</button>
    </form>

    <h3>Vender Producto</h3>
    <form id="formVenta">
      <input name="codigo" placeholder="C√≥digo de producto" required>
      <input name="cantidad" type="number" placeholder="Cantidad a vender" required>
      <button type="submit">Vender</button>
    </form>

    <h3>Lista de Productos</h3>
    <table id="tablaInventario">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>C√≥digo</th>
          <th>Cantidad</th>
          <th>Precio</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script>
/* ---------- UTILS ---------- */
const $ = q => document.querySelector(q);
const $$ = q => document.querySelectorAll(q);
function toast(msg) {
  const t = $('#toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 2000);
}

/* ---------- TEMA ---------- */
$('#toggleTheme').onclick = () => {
  document.body.classList.toggle('dark');
  toast('Tema cambiado');
};

/* ---------- DATOS ---------- */
let inventario = JSON.parse(localStorage.getItem('inventario')) || [];
let ventas = JSON.parse(localStorage.getItem('soldInventory')) || [];

/* ---------- DASHBOARD ---------- */
function actualizarDashboard() {
  const total = ventas.reduce((a, v) => a + parseFloat(v.total), 0);
  $('#totalIngresos').textContent = '$' + total.toFixed(2);
}

/* ---------- INGRESOS ---------- */
function renderIngresos() {
  const tbody = $('#tablaIngresos tbody');
  tbody.innerHTML = ventas.map((v, idx) => `
    <tr>
      <td>${idx + 1}</td>
      <td>${new Date().toISOString().split('T')[0]}</td>
      <td>Venta: ${v.name} (C√≥d: ${v.code})</td>
      <td>Venta</td>
      <td>$${v.total.toFixed(2)}</td>
      <td>Efectivo</td>
      <td>Sistema</td>
      <td>Cantidad: ${v.quantity}</td>
      <td>Solo lectura</td>
    </tr>`).join('');
  const total = ventas.reduce((a, v) => a + parseFloat(v.total), 0);
  $('#totalIngresosTabla').textContent = 'Total: $' + total.toFixed(2);
}

/* ---------- INVENTARIO ---------- */
function renderInventario() {
  const tbody = $('#tablaInventario tbody');
  tbody.innerHTML = inventario.map((p, i) => `
    <tr>
      <td>${p.nombre}</td>
      <td>${p.codigo}</td>
      <td>${p.cantidad}</td>
      <td>$${p.precio.toFixed(2)}</td>
      <td class="acciones">
        <button class="editar" data-index="${i}">‚úèÔ∏è</button>
        <button class="eliminar" data-index="${i}">üóëÔ∏è</button>
      </td>
    </tr>`).join('');
}

$('#formProducto').addEventListener('submit', e => {
  e.preventDefault();
  const f = e.target;
  inventario.push({
    nombre: f.nombre.value,
    codigo: f.codigo.value,
    cantidad: parseInt(f.cantidad.value),
    precio: parseFloat(f.precio.value)
  });
  localStorage.setItem('inventario', JSON.stringify(inventario));
  renderInventario();
  f.reset();
  toast('Producto agregado');
});

$('#formVenta').addEventListener('submit', e => {
  e.preventDefault();
  const f = e.target;
  const codigo = f.codigo.value;
  const cantidad = parseInt(f.cantidad.value);
  const prod = inventario.find(p => p.codigo === codigo);
  if (!prod) {
    toast('Producto no encontrado');
    return;
  }
  if (prod.cantidad < cantidad) {
    toast('Stock insuficiente');
    return;
  }
  prod.cantidad -= cantidad;
  const venta = {
    name: prod.nombre,
    code: codigo,
    quantity: cantidad,
    total: cantidad * prod.precio
  };
  ventas.push(venta);
  localStorage.setItem('soldInventory', JSON.stringify(ventas));
  localStorage.setItem('inventario', JSON.stringify(inventario));
  renderInventario();
  renderIngresos();
  actualizarDashboard();
  f.reset();
  toast('Venta registrada');
});

$('#tablaInventario').addEventListener('click', e => {
  if (e.target.classList.contains('eliminar')) {
    const i = e.target.dataset.index;
    if (confirm('¬øEliminar producto?')) {
      inventario.splice(i, 1);
      localStorage.setItem('inventario', JSON.stringify(inventario));
      renderInventario();
    }
  }
  if (e.target.classList.contains('editar')) {
    const i = e.target.dataset.index;
    const p = inventario[i];
    const nuevoNombre = prompt('Nombre:', p.nombre);
    const nuevaCantidad = prompt('Cantidad:', p.cantidad);
    const nuevoPrecio = prompt('Precio:', p.precio);
    if (nuevoNombre !== null && nuevaCantidad !== null && nuevoPrecio !== null) {
      p.nombre = nuevoNombre;
      p.cantidad = parseInt(nuevaCantidad);
      p.precio = parseFloat(nuevoPrecio);
      localStorage.setItem('inventario', JSON.stringify(inventario));
      renderInventario();
    }
  }
});

/* ---------- FILTROS Y ORDEN ---------- */
let sortDirection = {};

function filterTable(id, arr, keys) {
  const filtro = $('#filtro' + id.replace('tabla', '')).value.toLowerCase();
  const filtrado = arr.filter(it =>
    keys.some(k => String(it[k] || '').toLowerCase().includes(filtro))
  );
  renderIngresosFiltered(filtrado);
}

function sortTable(key) {
  sortDirection[key] = sortDirection[key] === 'asc' ? 'desc' : 'asc';
  ventas.sort((a, b) => {
    const va = String(a[key] || '').toLowerCase();
    const vb = String(b[key] || '').toLowerCase();
    return sortDirection[key] === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
  });
  renderIngresos();
}

function renderIngresosFiltered(filtered) {
  const tbody = $('#tablaIngresos tbody');
  tbody.innerHTML = filtered.map((v, idx) => `
    <tr>
      <td>${idx + 1}</td>
      <td>${new Date().toISOString().split('T')[0]}</td>
      <td>Venta: ${v.name} (C√≥d: ${v.code})</td>
      <td>Venta</td>
      <td>$${v.total.toFixed(2)}</td>
      <td>Efectivo</td>
      <td>Sistema</td>
      <td>Cantidad: ${v.quantity}</td>
      <td>Solo lectura</td>
    </tr>`).join('');
  const total = filtered.reduce((a, v) => a + parseFloat(v.total), 0);
  $('#totalIngresosTabla').textContent = 'Total: $' + total.toFixed(2);
}

$('#filtroIngresos').addEventListener('input', () => filterTable('tablaIngresos', ventas, ['name', 'code', 'total']));
$$('#tablaIngresos thead th').forEach(th => {
  if (th.dataset.sort) {
    th.addEventListener('click', () => sortTable(th.dataset.sort));
  }
});

/* ---------- EXCEL ---------- */
$('#exportIngresosExcel').onclick = () => {
  const ws = XLSX.utils.json_to_sheet(ventas);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Ingresos');
  XLSX.writeFile(wb, 'ingresos.xlsx');
};

/* ---------- PDF ---------- */
$('#exportIngresosPDF').onclick = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text('Ingresos desde Ventas', 14, 10);
  doc.autoTable({
    head: [['#', 'Nombre', 'C√≥digo', 'Cantidad', 'Total']],
    body: ventas.map((v, i) => [i + 1, v.name, v.code, v.quantity, v.total.toFixed(2)])
  });
  doc.save('ingresos.pdf');
};

/* ---------- INICIALIZAR ---------- */
renderInventario();
renderIngresos();
actualizarDashboard();
</script>
</body>
</html>
