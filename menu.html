<script>
  const CONFIG = { DB_NAME: 'menuDB', STORE_SESSION: 'userSession', DEFAULT_AVATAR: 'user2005.jpg', DEFAULT_USER: 'Usuario', REDIRECT_PAGE: 'index.html' };
  const Logger = { warn: (...args) => console.warn('[Dashboard]', ...args) };

  class StorageManager {
    static #instance = null;
    static getInstance() { if (!this.#instance) this.#instance = new StorageManager(); return this.#instance; }
    constructor() { this.db = null; this.#open(); }
    async #open() { return new Promise((res, rej) => { const req = indexedDB.open(CONFIG.DB_NAME, 1); req.onerror = () => rej(req.error); req.onsuccess = () => { this.db = req.result; res(); }; req.onupgradeneeded = () => { const d = req.result; if (!d.objectStoreNames.contains(CONFIG.STORE_SESSION)) d.createObjectStore(CONFIG.STORE_SESSION, { keyPath: 'id', autoIncrement: true }); }; }); }
    async getLastSession() { if (!this.db) await this.#open(); const tx = this.db.transaction([CONFIG.STORE_SESSION], 'readonly'); return new Promise(res => { tx.objectStore(CONFIG.STORE_SESSION).openCursor(null, 'prev').onsuccess = (e) => res(e.target.result?.value || null); }); }
    async clear() { if (!this.db) await this.#open(); this.db.transaction([CONFIG.STORE_SESSION], 'readwrite').objectStore(CONFIG.STORE_SESSION).clear(); }
  }

  const AuthManager = {
    check: () => { if (sessionStorage.getItem('loggedIn') !== 'true') { location.replace(CONFIG.REDIRECT_PAGE); return false; } return true; },
    logout: async () => { await StorageManager.getInstance().clear(); sessionStorage.clear(); location.replace(CONFIG.REDIRECT_PAGE); }
  };

  const UIManager = {
    async init() { const [photo, name] = [sessionStorage.getItem('foto'), sessionStorage.getItem('nombre')]; if (photo && name) this.update(photo, name); else { const session = await StorageManager.getInstance().getLastSession(); if (session?.foto && session?.nombre) { sessionStorage.setItem('foto', session.foto); sessionStorage.setItem('nombre', session.nombre); this.update(session.foto, session.nombre); } else this.update(CONFIG.DEFAULT_AVATAR, CONFIG.DEFAULT_USER); } },
    update(foto, nombre) { const imgEl = document.getElementById('userPhoto'); const nameEl = document.getElementById('userName'); if (imgEl) { imgEl.src = foto; imgEl.onerror = () => imgEl.src = CONFIG.DEFAULT_AVATAR; } if (nameEl) nameEl.textContent = nombre || CONFIG.DEFAULT_USER; }
  };

  const NavManager = { init() { const current = location.pathname.split('/').pop(); document.querySelectorAll('.nav-link').forEach(link => { if (link.getAttribute('href') === current) { link.classList.add('active'); link.setAttribute('aria-current', 'page'); } }); } };

  /* ----------  EXPORTAR / IMPORTAR ZIP  ---------- */
  async function exportLocalForageBlobs(zipFolder) {
    const keys = await localforage.keys();
    for (const key of keys) {
      if (key.startsWith('img_compra_')) continue; // ❌ Excluye imágenes de compra
      if (key.startsWith('img_')) {
        try {
          const blob = await localforage.getItem(key);
          if (blob) zipFolder.file(`${key}.jpg`, blob);
        } catch (e) {
          console.warn('No se pudo leer', key, e);
        }
      }
    }
  }

  async function importLocalForageBlobs(zip) {
    const imgFolder = zip.folder('localforage');
    if (!imgFolder) return;
    for (const [fileName, zipEntry] of Object.entries(imgFolder.files)) {
      if (!zipEntry.dir && fileName.startsWith('img_')) {
        try {
          const blob = await zipEntry.async('blob');
          const key = fileName.replace('.jpg', '');
          await localforage.setItem(key, blob);
        } catch (e) {
          console.warn('Error al restaurar', fileName, e);
        }
      }
    }
  }

  async function exportZIP() {
    const zip = new JSZip();

    // Filtrar localStorage
    for (let key in localStorage) {
      if (key.startsWith('compra_')) continue; // ❌ Excluye claves de compra
      try {
        zip.file(`localStorage/${key}`, localStorage.getItem(key));
      } catch {}
    }

    // Filtrar indexedDB
    const dbs = await window.indexedDB.databases?.() || [];
    for (const dbInfo of dbs) {
      const db = await new Promise((res, rej) => {
        const req = indexedDB.open(dbInfo.name);
        req.onsuccess = () => res(req.result);
        req.onerror = () => rej(req.error);
      });
      const tx = db.transaction(db.objectStoreNames, 'readonly');
      for (const storeName of db.objectStoreNames) {
        if (storeName.toLowerCase().includes('compra')) continue; // ❌ Excluye tiendas de compra
        const store = tx.objectStore(storeName);
        const all = await store.getAll();
        zip.file(`indexedDB/${dbInfo.name}/${storeName}.json`, JSON.stringify(all));
      }
    }

    await exportLocalForageBlobs(zip.folder('localforage'));

    const blob = await zip.generateAsync({ type: 'blob' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `backup-${new Date().toISOString().split('T')[0]}.zip`;
    a.click();
  }

  async function importZIP(file) {
    const zip = await JSZip.loadAsync(file);
    for (const [path, zipEntry] of Object.entries(zip.files)) {
      if (path.startsWith('localStorage/')) {
        const key = path.replace('localStorage/', '');
        const content = await zipEntry.async('string');
        localStorage.setItem(key, content);
      }
      if (path.startsWith('indexedDB/')) {
        const json = await zipEntry.async('string');
        const parts = path.split('/');
        const dbName = parts[1];
        const storeName = parts[2].replace('.json', '');
        const data = JSON.parse(json);
        const req = indexedDB.open(dbName, 1);
        req.onsuccess = () => {
          const db = req.result;
          const tx = db.transaction(storeName, 'readwrite');
          const store = tx.objectStore(storeName);
          data.forEach(item => store.put(item));
        };
      }
    }
    await importLocalForageBlobs(zip);
    alert('✅ Datos importados correctamente. Refresca las páginas para ver los cambios.');
  }

  document.getElementById('exportBtn').addEventListener('click', exportZIP);
  document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFile').click());
  document.getElementById('importFile').addEventListener('change', e => { const file = e.target.files[0]; if (file) importZIP(file); });

  (function () {
    'use strict';
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init, { passive: true }); else init();
    async function init() {
      if (!AuthManager.check()) return;
      UIManager.init().catch(Logger.warn); NavManager.init();
      const logoutBtn = document.getElementById('logoutBtn'); if (logoutBtn) logoutBtn.addEventListener('click', (e) => { e.preventDefault(); AuthManager.logout(); }, { passive: false });
    }
  })();
</script>
