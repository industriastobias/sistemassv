<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; script-src 'self' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline';">
  <title>CONTABILIDAD A FAMILY COMPANY</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>

  <style>
    /* Modo kiosco */
    body.kiosk:-webkit-full-screen,
    body.kiosk:-moz-full-screen,
    body.kiosk:fullscreen {
      background: var(--color-bg);
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin: 0;
      overflow: hidden;
    }
    body.kiosk header {
      font-size: 1.2rem;
      padding: .6rem;
    }
    body.kiosk nav {
      font-size: .9rem;
    }
    body.kiosk main {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 1rem;
    }
    body.kiosk footer {
      display: none;
    }

    html.dark{
      --color-bg:#121212;
      --color-card:#1e1e1e;
      --color-text:#e0e0e0;
      --color-primary:#90caf9;
      --color-secondary:#64b5f6;
    }
    :root{
      --color-bg:#f4f6f8;
      --color-primary:#1a73e8;
      --color-secondary:#0d47a1;
      --color-text:#2c3e50;
      --color-card:#ffffff;
      --radius:12px;
      --shadow:0 3px 10px rgba(0,0,0,.05);
    }
    body{
      font-family:'Inter',Arial,sans-serif;
      background:var(--color-bg);
      color:var(--color-text);
      margin:0;padding:0;
      transition:background .25s,color .25s;
    }
    header{
      background:var(--color-primary);
      color:#fff;
      padding:1rem 2rem;
      text-align:center;
      font-size:1.5rem;
      font-weight:600;
      letter-spacing:.5px;
      box-shadow:var(--shadow);
    }
    nav{
      display:flex;
      justify-content:center;
      background:#fff;
      border-bottom:1px solid #ddd;
      flex-wrap:wrap;
      overflow-x:auto;
      scroll-snap-type:x mandatory;
    }
    .tab{
      padding:1rem 1.5rem;
      cursor:pointer;
      font-weight:500;
      color:#666;
      transition:all .2s;
      scroll-snap-align:start;
    }
    .tab.active{
      color:var(--color-primary);
      border-bottom:3px solid var(--color-primary);
      background:#f9fafc;
    }
    main{
      padding:2rem;
      max-width:1200px;
      margin:auto;
    }
    section{
      display:none;
      opacity:0;
      transform:translateY(10px);
      transition:opacity .25s ease,transform .25s ease;
    }
    section.active{
      display:block;
      opacity:1;
      transform:translateY(0);
    }
    .dashboard{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:1.5rem;
      margin-bottom:2rem;
    }
    .card{
      background:var(--color-card);
      padding:1.5rem;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      text-align:center;
      transition:transform .2s;
    }
    .card:hover{transform:translateY(-3px)}
    .card h3{font-size:1rem;color:#888;margin-bottom:.5rem}
    .card p{font-size:1.4rem;font-weight:600;color:var(--color-secondary)}
    canvas{display:block;margin:2rem auto;width:100%;max-width:400px;aspect-ratio:1/1}
    form{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:1rem;
      background:#fff;
      padding:1.5rem;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      margin-bottom:1rem;
    }
    input,select,textarea{
      width:100%;
      padding:8px 10px;
      border:1px solid #ccc;
      border-radius:var(--radius);
      font-family:inherit;font-size:.9rem;
    }
    textarea{resize:vertical;min-height:60px}
    button{
      background:var(--color-primary);
      color:#fff;
      border:none;
      border-radius:var(--radius);
      padding:10px 16px;
      cursor:pointer;
      font-weight:500;
      transition:background .2s;
    }
    button:hover{background:var(--color-secondary)}
    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      overflow:hidden;
    }
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:.9rem}
    th{background:#f8f9fa;color:#555;font-weight:600;cursor:pointer}
    tr:hover td{background:#f3f6fa}
    tr.selected{background:#e3f2fd}
    .acciones button{background:none;border:none;cursor:pointer;font-size:1rem;margin:0 5px}
    .acciones .editar{color:#1a73e8}
    .acciones .eliminar{color:#e53935}
    footer{text-align:center;padding:1rem;color:#999;font-size:.85rem}
    .excel-bar{display:flex;gap:.5rem;margin-bottom:.5rem}
    .excel-bar button{background:#388e3c}
    .excel-bar button:hover{background:#2e7d32}
    .toast{position:fixed;bottom:1rem;right:1rem;background:#43a047;color:#fff;padding:.5rem 1rem;border-radius:var(--radius);opacity:0;transition:opacity .3s}
    .toast.show{opacity:1}
    body.negative-balance .card{background:#ffebee}
    @media(max-width:600px){nav{justify-content:flex-start}}
  </style>
</head>
<body>
<header>üìä FINANZAS</header>

<nav>
  <div class="tab active" data-tab="dashboard">Dashboard</div>
  <div class="tab" data-tab="ingresos">Ingresos</div>
  <div class="tab" data-tab="gastos">Gastos</div>
  <div class="tab" data-tab="gastosDesdeIngresos">Gastos desde Ingresos</div>
  <div class="tab" data-tab="proveedores">Proveedores</div>
  <div class="tab" data-tab="cuentas">Cuentas Pendientes</div>
</nav>

<main>
  <section id="dashboard" class="active">
    <h2>Resumen General</h2>
    <div class="dashboard">
      <div class="card"><h3>Total Ingresos</h3><p id="totalIngresos">$0.00</p></div>
      <div class="card"><h3>Gastos desde Ingresos</h3><p id="totalGastosDesdeIngresos">$0.00</p></div>
      <div class="card"><h3>Ingreso Neto</h3><p id="ingresoNeto">$0.00</p></div>
      <div class="card"><h3>Total Gastos</h3><p id="totalGastos">$0.00</p></div>
      <div class="card"><h3>Saldo Neto Final</h3><p id="balance">$0.00</p></div>
    </div>
    <canvas id="chartResumen"></canvas>
    <canvas id="chartLine"></canvas>
  </section>

  <section id="ingresos">
    <h2>Ingresos</h2>
    <input id="searchIngresos" placeholder="Buscar ingresos..." style="width:100%;max-width:300px;margin-bottom:1rem">
    <table id="tablaIngresos">
      <thead>
        <tr>
          <th data-sort="fecha">Fecha</th><th data-sort="descripcion">Descripci√≥n</th><th data-sort="categoria">Categor√≠a</th><th data-sort="monto">Monto</th><th>M√©todo Pago</th><th>Responsable</th><th>Observaciones</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="gastos">
    <h2>Gastos</h2>
    <input id="searchGastos" placeholder="Buscar gastos..." style="width:100%;max-width:300px;margin-bottom:1rem">
    <form id="formGasto">
      <input name="fecha" type="date" required>
      <input name="proveedor" placeholder="Proveedor">
      <input name="categoria" placeholder="Categor√≠a">
      <input name="descripcion" placeholder="Descripci√≥n">
      <input name="monto" type="number" step="0.01" min="0" placeholder="Monto" required>
      <input name="metodo_pago" placeholder="M√©todo de pago">
      <input name="responsable" placeholder="Responsable">
      <textarea name="observaciones" placeholder="Observaciones"></textarea>
      <button type="submit">Guardar</button>
    </form>
    <div class="excel-bar">
      <button id="exportGastos" title="Exportar datos a Excel">Exportar Excel</button>
      <label for="importGastos" title="Importar datos desde Excel" style="display:inline-block;background:#388e3c;color:#fff;padding:10px 16px;border-radius:var(--radius);cursor:pointer">Importar Excel</label>
      <input type="file" id="importGastos" accept=".xlsx,.xls" style="display:none">
    </div>
    <table id="tablaGastos">
      <thead>
        <tr>
          <th data-sort="fecha">Fecha</th><th data-sort="proveedor">Proveedor</th><th data-sort="categoria">Categor√≠a</th><th data-sort="descripcion">Descripci√≥n</th><th data-sort="monto">Monto</th><th>M√©todo Pago</th><th>Responsable</th><th>Observaciones</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="gastosDesdeIngresos">
    <h2>Gastos desde Ingresos</h2>
    <input id="searchGastosDesdeIngresos" placeholder="Buscar..." style="width:100%;max-width:300px;margin-bottom:1rem">
    <form id="formGastosDesdeIngresos">
      <input name="fecha" type="date" required>
      <input name="descripcion" placeholder="Descripci√≥n" required>
      <input name="categoria" placeholder="Categor√≠a">
      <input name="monto" type="number" step="0.01" min="0" placeholder="Monto" required>
      <input name="responsable" placeholder="Responsable">
      <textarea name="observaciones" placeholder="Observaciones"></textarea>
      <button type="submit">Guardar</button>
    </form>
    <div class="excel-bar">
      <button id="exportGastosDesdeIngresos" title="Exportar datos a Excel">Exportar Excel</button>
      <label for="importGastosDesdeIngresos" title="Importar datos desde Excel" style="display:inline-block;background:#388e3c;color:#fff;padding:10px 16px;border-radius:var(--radius);cursor:pointer">Importar Excel</label>
      <input type="file" id="importGastosDesdeIngresos" accept=".xlsx,.xls" style="display:none">
    </div>
    <table id="tablaGastosDesdeIngresos">
      <thead>
        <tr>
          <th data-sort="fecha">Fecha</th><th data-sort="descripcion">Descripci√≥n</th><th data-sort="categoria">Categor√≠a</th><th data-sort="monto">Monto</th><th>Responsable</th><th>Observaciones</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="proveedores">
    <h2>Proveedores</h2>
    <input id="searchProveedores" placeholder="Buscar proveedores..." style="width:100%;max-width:300px;margin-bottom:1rem">
    <form id="formProveedor">
      <input name="nombre" placeholder="Nombre" required>
      <input name="nit" placeholder="NIT" pattern="[0-9]{9}-[0-9]{1}">
      <input name="telefono" placeholder="Tel√©fono">
      <input name="email" type="email" placeholder="Email">
      <input name="direccion" placeholder="Direcci√≥n">
      <textarea name="observaciones" placeholder="Observaciones"></textarea>
      <button type="submit">Guardar</button>
    </form>
    <div class="excel-bar">
      <button id="exportProveedores" title="Exportar datos a Excel">Exportar Excel</button>
      <label for="importProveedores" title="Importar datos desde Excel" style="display:inline-block;background:#388e3c;color:#fff;padding:10px 16px;border-radius:var(--radius);cursor:pointer">Importar Excel</label>
      <input type="file" id="importProveedores" accept=".xlsx,.xls" style="display:none">
    </div>
    <table id="tablaProveedores">
      <thead>
        <tr>
          <th data-sort="nombre">Nombre</th><th data-sort="nit">NIT</th><th data-sort="telefono">Tel√©fono</th><th data-sort="email">Email</th><th data-sort="direccion">Direcci√≥n</th><th>Observaciones</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="cuentas">
    <h2>Cuentas Pendientes</h2>
    <input id="searchCuentas" placeholder="Buscar cuentas..." style="width:100%;max-width:300px;margin-bottom:1rem">
    <form id="formCuenta">
      <select name="tipo"><option>Por cobrar</option><option>Por pagar</option></select>
      <input name="cliente_proveedor" placeholder="Cliente / Proveedor">
      <input name="concepto" placeholder="Concepto">
      <input name="monto" type="number" step="0.01" min="0" placeholder="Monto" required>
      <input name="fecha_vencimiento" type="date">
      <select name="estado"><option>Pendiente</option><option>Pagado</option></select>
      <textarea name="observaciones" placeholder="Observaciones"></textarea>
      <button type="submit">Guardar</button>
    </form>
    <div class="excel-bar">
      <button id="exportCuentas" title="Exportar datos a Excel">Exportar Excel</button>
      <label for="importCuentas" title="Importar datos desde Excel" style="display:inline-block;background:#388e3c;color:#fff;padding:10px 16px;border-radius:var(--radius);cursor:pointer">Importar Excel</label>
      <input type="file" id="importCuentas" accept=".xlsx,.xls" style="display:none">
    </div>
    <table id="tablaCuentas">
      <thead>
        <tr>
          <th data-sort="tipo">Tipo</th><th data-sort="cliente_proveedor">Cliente/Proveedor</th><th data-sort="concepto">Concepto</th><th data-sort="monto">Monto</th><th data-sort="fecha_vencimiento">Fecha Vencimiento</th><th data-sort="estado">Estado</th><th>Observaciones</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<footer>¬© 2025 Panel Financiero Empresarial</footer>
<div id="toast" class="toast">‚úî Guardado</div>

<script>
/* ---------- FIX COMPATIBILIDAD COMPRESI√ìN ---------- */
function compress(key, value) {
  try {
    const raw = JSON.stringify(value);
    const zipped = LZString.compress(raw);
    localStorage.setItem(key, zipped);
  } catch (e) {
    localStorage.setItem(key, JSON.stringify(value));
  }
}
function decompress(key) {
  try {
    const item = localStorage.getItem(key);
    if (!item) return [];
    const unzipped = LZString.decompress(item);
    return JSON.parse(unzipped !== null ? unzipped : item);
  } catch (e) {
    return [];
  }
}

/* ---------- DATOS ---------- */
const data = {
  ingresos: [],
  gastos: decompress('gastos'),
  proveedores: decompress('proveedores'),
  cuentas: decompress('cuentas')
};
let gastosDesdeIngresos = decompress('gastosDesdeIngresos');

function saveData() {
  for (const k in data) compress(k, data[k]);
  compress('gastosDesdeIngresos', gastosDesdeIngresos);
  actualizarDashboard();
  showToast();
}

/* ---------- NAVEGACI√ìN ---------- */
const tabs = document.querySelectorAll('.tab'), sections = document.querySelectorAll('section');
tabs.forEach(btn => {
  btn.addEventListener('click', () => {
    tabs.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const id = btn.dataset.tab;
    sections.forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  });
});

/* ---------- GR√ÅFICOS ---------- */
const ctx = document.getElementById('chartResumen').getContext('2d');
const chart = new Chart(ctx, {
  type: 'doughnut',
  data: { labels: ['Ingreso Neto', 'Gastos', 'Saldo Neto'], datasets: [{ data: [0, 0, 0], backgroundColor: ['#1a73e8', '#e53935', '#43a047'], hoverOffset: 10 }] },
  options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
});
const ctxLine = document.getElementById('chartLine').getContext('2d');
const chartLine = new Chart(ctxLine, {
  type: 'line',
  data: { labels: [], datasets: [{ label: 'Ingresos', data: [], borderColor: '#1a73e8', fill: false }, { label: 'Gastos', data: [], borderColor: '#e53935', fill: false }] },
  options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
});

const fmt = num => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(num);

function actualizarDashboard() {
  const ti = data.ingresos.reduce((a, i) => a + parseFloat(i.monto || 0), 0);
  const tg = data.gastos.reduce((a, g) => a + parseFloat(g.monto || 0), 0);
  const gdi = gastosDesdeIngresos.reduce((a, g) => a + parseFloat(g.monto || 0), 0);
  const ingresoNeto = ti - gdi;
  const balance = ingresoNeto - tg;

  document.getElementById('totalIngresos').textContent = fmt(ti);
  document.getElementById('totalGastosDesdeIngresos').textContent = fmt(gdi);
  document.getElementById('ingresoNeto').textContent = fmt(ingresoNeto);
  document.getElementById('totalGastos').textContent = fmt(tg);
  document.getElementById('balance').textContent = fmt(balance);

  chart.data.datasets[0].data = [ingresoNeto, tg, Math.abs(balance)];
  chart.update();

  document.body.classList.toggle('negative-balance', balance < 0);

  const mensual = {};
  data.ingresos.forEach(i => {
    const m = i.fecha.slice(0, 7);
    mensual[m] = mensual[m] || { ing: 0, gas: 0 };
    mensual[m].ing += parseFloat(i.monto);
  });
  data.gastos.forEach(g => {
    const m = g.fecha.slice(0, 7);
    mensual[m] = mensual[m] || { ing: 0, gas: 0 };
    mensual[m].gas += parseFloat(g.monto);
  });
  const labels = Object.keys(mensual).sort();
  chartLine.data.labels = labels;
  chartLine.data.datasets[0].data = labels.map(l => mensual[l].ing);
  chartLine.data.datasets[1].data = labels.map(l => mensual[l].gas);
  chartLine.update();
}

/* ---------- CARGAR VENTAS COMO INGRESOS ---------- */
function cargarVentasComoIngresos() {
  const ventas = JSON.parse(localStorage.getItem('soldInventory')) || [];
  data.ingresos = ventas.map(v => ({
    fecha: new Date().toISOString().split('T')[0],
    descripcion: `Venta: ${v.name} (C√≥d: ${v.code})`,
    categoria: 'Venta',
    monto: parseFloat(v.total).toFixed(2),
    metodo_pago: 'Efectivo',
    responsable: 'Sistema',
    observaciones: `Cantidad vendida: ${v.quantity}`
  }));
  saveData();
  renderTable('tablaIngresos', data.ingresos, ['fecha', 'descripcion', 'categoria', 'monto', 'metodo_pago', 'responsable', 'observaciones'], 'ingresos');
}

/* ---------- RENDER TABLA + ORDEN + SEARCH ---------- */
let sortDirs = {};
function renderTable(id, arr, keys, keyName) {
  const tbody = document.querySelector(`#${id} tbody`);
  tbody.innerHTML = '';
  lazyRender(id, arr, keys, keyName);
}
function sortTable(id, arr, keys, keyName, col) {
  const dir = (sortDirs[col] = !sortDirs[col]) ? 1 : -1;
  arr.sort((a, b) => (a[col] > b[col] ? dir : -dir));
  renderTable(id, arr, keys, keyName);
}
function liveSearch(inputId, tableId, arr, keys, keyName) {
  document.getElementById(inputId).addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    const filtered = arr.filter(it => keys.some(k => String(it[k] || '').toLowerCase().includes(q)));
    renderTable(tableId, filtered, keys, keyName);
  });
}
function lazyRender(table, array, keys, keyName) {
  const step = 50;
  let idx = 0;
  function batch() {
    const tbody = document.querySelector(`#${table} tbody`);
    const end = Math.min(idx + step, array.length);
    const html = array.slice(idx, end).map((it, i) => `
      <tr>
        ${keys.map(k => `<td>${it[k] || ''}</td>`).join('')}
        <td class="acciones">${keyName === 'ingresos' ? 'Solo lectura' : `
          <button class="editar" data-key="${keyName}" data-index="${idx + i}" title="Editar">‚úèÔ∏è</button>
          <button class="eliminar" data-key="${keyName}" data-index="${idx + i}" title="Eliminar">üóëÔ∏è</button>`}
        </td>
      </tr>`).join('');
    tbody.insertAdjacentHTML('beforeend', html);
    idx = end;
    if (idx < array.length) setTimeout(batch, 16);
  }
  batch();
}

/* ---------- FORMULARIOS ---------- */
const forms = [
  { id: 'formGasto', key: 'gastos', table: 'tablaGastos', fields: ['fecha', 'proveedor', 'categoria', 'descripcion', 'monto', 'metodo_pago', 'responsable', 'observaciones'] },
  { id: 'formProveedor', key: 'proveedores', table: 'tablaProveedores', fields: ['nombre', 'nit', 'telefono', 'email', 'direccion', 'observaciones'] },
  { id: 'formCuenta', key: 'cuentas', table: 'tablaCuentas', fields: ['tipo', 'cliente_proveedor', 'concepto', 'monto', 'fecha_vencimiento', 'estado', 'observaciones'] }
];

forms.forEach(f => {
  const form = document.getElementById(f.id);
  form.addEventListener('submit', e => {
    e.preventDefault();
    const item = {};
    f.fields.forEach(k => item[k] = form[k].value);
    data[f.key].push(item);
    saveData();
    renderTable(f.table, data[f.key], f.fields, f.key);
    form.reset();
    const btn = form.querySelector('button');
    btn.disabled = true; setTimeout(() => btn.disabled = false, 1000);
  });
  renderTable(f.table, data[f.key], f.fields, f.key);
  liveSearch(`search${f.key[0].toUpperCase() + f.key.slice(1)}`, f.table, data[f.key], f.fields, f.key);
});

/* ---------- GASTOS DESDE INGRESOS ---------- */
const formGDI = document.getElementById('formGastosDesdeIngresos');
formGDI.addEventListener('submit', e => {
  e.preventDefault();
  const item = {
    fecha: formGDI.fecha.value,
    descripcion: formGDI.descripcion.value,
    categoria: formGDI.categoria.value,
    monto: parseFloat(formGDI.monto.value),
    responsable: formGDI.responsable.value,
    observaciones: formGDI.observaciones.value
  };
  gastosDesdeIngresos.push(item);
  saveData();
  renderTable('tablaGastosDesdeIngresos', gastosDesdeIngresos, ['fecha', 'descripcion', 'categoria', 'monto', 'responsable', 'observaciones'], 'gastosDesdeIngresos');
  formGDI.reset();
  const btn = formGDI.querySelector('button');
  btn.disabled = true; setTimeout(() => btn.disabled = false, 1000);
});
renderTable('tablaGastosDesdeIngresos', gastosDesdeIngresos, ['fecha', 'descripcion', 'categoria', 'monto', 'responsable', 'observaciones'], 'gastosDesdeIngresos');
liveSearch('searchGastosDesdeIngresos', 'tablaGastosDesdeIngresos', gastosDesdeIngresos, ['fecha', 'descripcion', 'categoria', 'monto', 'responsable', 'observaciones'], 'gastosDesdeIngresos');

/* ---------- ORDENAR TABLAS ---------- */
document.addEventListener('click', e => {
  if (e.target.dataset.sort) {
    const { sort } = e.target.dataset;
    const table = e.target.closest('table').id;
    const keyName = table.replace('tabla', '').toLowerCase();
    if (keyName === 'ingresos') sortTable(table, data.ingresos, Object.keys(data.ingresos[0] || {}), keyName, sort);
    else if (keyName === 'gastos') sortTable(table, data.gastos, forms[0].fields, keyName, sort);
    else if (keyName === 'gastosdesdeingresos') sortTable(table, gastosDesdeIngresos, ['fecha', 'descripcion', 'categoria', 'monto', 'responsable', 'observaciones'], keyName, sort);
    else if (keyName === 'proveedores') sortTable(table, data.proveedores, forms[1].fields, keyName, sort);
    else if (keyName === 'cuentas') sortTable(table, data.cuentas, forms[2].fields, keyName, sort);
  }
});

/* ---------- SELECCIONAR FILA ---------- */
let selectedRow = null;
document.addEventListener('click', e => {
  const tr = e.target.closest('tr');
  if (tr && tr.parentElement.tagName === 'TBODY') {
    if (selectedRow) selectedRow.classList.remove('selected');
    tr.classList.add('selected');
    selectedRow = tr;
  }
});

/* ---------- EDITAR / ELIMINAR ---------- */
document.addEventListener('click', e => {
  if (e.target.classList.contains('eliminar')) {
    const { key, index } = e.target.dataset;
    if (key === 'ingresos') return;
    if (confirm('¬øEliminar este registro?')) {
      if (key === 'gastosDesdeIngresos') {
        gastosDesdeIngresos.splice(index, 1);
        compress('gastosDesdeIngresos', gastosDesdeIngresos);
        renderTable('tablaGastosDesdeIngresos', gastosDesdeIngresos, ['fecha', 'descripcion', 'categoria', 'monto', 'responsable', 'observaciones'], 'gastosDesdeIngresos');
      } else {
        data[key].splice(index, 1);
        saveData();
        const f = forms.find(x => x.key === key);
        renderTable(f.table, data[key], f.fields, key);
      }
      actualizarDashboard();
    }
  }
  if (e.target.classList.contains('editar')) {
    const { key, index } = e.target.dataset;
    if (key === 'ingresos') return;
    if (key === 'gastosDesdeIngresos') {
      const item = gastosDesdeIngresos[index];
      formGDI.fecha.value = item.fecha;
      formGDI.descripcion.value = item.descripcion;
      formGDI.categoria.value = item.categoria;
      formGDI.monto.value = item.monto;
      formGDI.responsable.value = item.responsable;
      formGDI.observaciones.value = item.observaciones;
      gastosDesdeIngresos.splice(index, 1);
      compress('gastosDesdeIngresos', gastosDesdeIngresos);
      renderTable('tablaGastosDesdeIngresos', gastosDesdeIngresos, ['fecha', 'descripcion', 'categoria', 'monto', 'responsable', 'observaciones'], 'gastosDesdeIngresos');
    } else {
      const f = forms.find(x => x.key === key);
      const form = document.getElementById(f.id);
      const item = data[key][index];
      f.fields.forEach(k => form[k].value = item[k] || '');
      data[key].splice(index, 1);
      saveData();
      renderTable(f.table, data[key], f.fields, key);
    }
    actualizarDashboard();
  }
});

/* ---------- EXCEL ---------- */
function exportExcel(key, filename) {
  let source = key === 'gastosDesdeIngresos' ? gastosDesdeIngresos : data[key];
  const ws = XLSX.utils.json_to_sheet(source);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, key);
  const fname = prompt('Nombre del archivo:', filename) || filename;
  XLSX.writeFile(wb, fname);
}
function importExcel(file, key, fields) {
  const reader = new FileReader();
  reader.onload = function (e) {
    const wb = XLSX.read(e.target.result, { type: 'binary' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
    rows.forEach(r => {
      const item = {};
      fields.forEach(f => item[f] = r[f] || '');
      if (key === 'gastosDesdeIngresos') gastosDesdeIngresos.push(item);
      else data[key].push(item);
    });
    saveData();
    if (key === 'gastosDesdeIngresos') {
      renderTable('tablaGastosDesdeIngresos', gastosDesdeIngresos, fields, key);
    } else {
      const f = forms.find(x => x.key === key);
      renderTable(f.table, data[key], fields, key);
    }
  };
  reader.readAsBinaryString(file);
}

/* ---------- BOTONES EXPORTAR / IMPORTAR ---------- */
document.getElementById('exportGastos').onclick = () => exportExcel('gastos', 'gastos.xlsx');
document.getElementById('exportGastosDesdeIngresos').onclick = () => exportExcel('gastosDesdeIngresos', 'gastos_desde_ingresos.xlsx');
document.getElementById('exportProveedores').onclick = () => exportExcel('proveedores', 'proveedores.xlsx');
document.getElementById('exportCuentas').onclick = () => exportExcel('cuentas', 'cuentas.xlsx');

document.getElementById('importGastos').onchange = function (e) {
  importExcel(e.target.files[0], 'gastos', ['fecha', 'proveedor', 'categoria', 'descripcion', 'monto', 'metodo_pago', 'responsable', 'observaciones']);
  this.value = '';
};
document.getElementById('importGastosDesdeIngresos').onchange = function (e) {
  importExcel(e.target.files[0], 'gastosDesdeIngresos', ['fecha', 'descripcion', 'categoria', 'monto', 'responsable', 'observaciones']);
  this.value = '';
};
document.getElementById('importProveedores').onchange = function (e) {
  importExcel(e.target.files[0], 'proveedores', ['nombre', 'nit', 'telefono', 'email', 'direccion', 'observaciones']);
  this.value = '';
};
document.getElementById('importCuentas').onchange = function (e) {
  importExcel(e.target.files[0], 'cuentas', ['tipo', 'cliente_proveedor', 'concepto', 'monto', 'fecha_vencimiento', 'estado', 'observaciones']);
  this.value = '';
};

/* ---------- MODO KIOSCO ---------- */
const kioskBtn = document.createElement('button');
kioskBtn.textContent = 'üñ•Ô∏è Pantalla completa';
kioskBtn.style.cssText = `
  position:fixed; bottom:.5rem; left:.5rem; z-index:9999;
  background:var(--color-primary); color:#fff; border:none;
  border-radius:var(--radius); padding:.5rem .8rem; font-size:.8rem;
  cursor:pointer;
`;
document.body.appendChild(kioskBtn);

function activarKiosk() {
  document.documentElement.requestFullscreen?.() || document.documentElement.webkitRequestFullscreen?.() || document.documentElement.mozRequestFullScreen?.();
  document.body.classList.add('kiosk');
  localStorage.setItem('kioskMode', '1');
}
function desactivarKiosk() {
  document.exitFullscreen?.() || document.webkitExitFullscreen?.() || document.mozCancelFullScreen?.();
  document.body.classList.remove('kiosk');
  localStorage.removeItem('kioskMode');
}
kioskBtn.onclick = () => {
  if (!document.fullscreenElement) activarKiosk();
  else desactivarKiosk();
};
document.addEventListener('keydown', e => {
  if (e.key === 'F11') {
    e.preventDefault();
    kioskBtn.click();
  }
});
window.addEventListener('load', () => {
  if (localStorage.getItem('kioskMode') === '1') activarKiosk();
});
document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement) {
    document.body.classList.remove('kiosk');
    localStorage.removeItem('kioskMode');
  }
});

/* ---------- THEME TOGGLE ---------- */
const themeBtn = document.createElement('button');
themeBtn.textContent = 'üåô';
themeBtn.style.position = 'fixed'; themeBtn.style.top = '.5rem'; themeBtn.style.right = '.5rem'; themeBtn.style.zIndex = 9999;
themeBtn.onclick = () => {
  document.documentElement.classList.toggle('dark');
  localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
  themeBtn.textContent = document.documentElement.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
};
document.body.appendChild(themeBtn);
(function () {
  const saved = localStorage.getItem('theme');
  if (saved === 'dark') { document.documentElement.classList.add('dark'); themeBtn.textContent = '‚òÄÔ∏è'; }
})();

/* ---------- TOAST ---------- */
function showToast() {
  const t = document.getElementById('toast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 1000);
}

/* ---------- INICIALIZAR ---------- */
cargarVentasComoIngresos();
actualizarDashboard();

window.addEventListener('storage', () => {
  cargarVentasComoIngresos();
  actualizarDashboard();
});
</script>
</body>
</html>
