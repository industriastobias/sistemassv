<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventario</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    /* ---------- tus estilos originales (sin cambios) ---------- */
    :root{--bg:#f5f7fa;--card:#ffffff;--text:#1f2937;--accent:#3b82f6;--accent-hover:#2563eb;--danger:#ef4444;--success:#10b981;--radius:16px;--shadow:0 6px 20px rgba(0,0,0,.08);--shadow-hover:0 8px 24px rgba(0,0,0,.12);--transition:.3s ease;--highlight:#fef08a;}
    body.dark{--bg:#111;--card:#1e1e1e;--text:#eee;--highlight:#fde047;}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',system-ui,sans-serif}
    html{scroll-behavior:smooth}
    body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;padding:2rem 1rem}
    h1{font-size:2rem;font-weight:700;margin-bottom:1rem;letter-spacing:-.5px}
    mark{background:var(--highlight);padding:.05rem .2rem;border-radius:4px;color:var(--text)}
    #themeToggle{position:fixed;top:1rem;right:1rem;background:var(--accent);color:#fff;border:none;padding:.5rem .7rem;border-radius:50%;font-size:1rem;cursor:pointer;box-shadow:var(--shadow);}
    .price-range{display:flex;gap:.5rem;align-items:center;margin-bottom:1rem;width:100%;max-width:960px}
    .price-range input{width:100%;padding:.5rem;border:1px solid #e5e7eb;border-radius:8px;background:#f9fafb;font-size:.9rem}
    .summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1.5rem;width:100%;max-width:960px;}
    .summary-card{background:var(--card);border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow);text-align:center;}
    .summary-card h3{font-size:.8rem;color:#6b7280;margin-bottom:.25rem}
    .summary-card p{font-size:1.5rem;font-weight:700;color:var(--accent);margin:0}
    .search-bar{width:100%;max-width:960px;margin-bottom:1.5rem;}
    .search-bar input{width:100%;padding:.75rem 1rem;border:1px solid #e5e7eb;border-radius:12px;background:#f9fafb;font-size:1rem;}
    .search-bar input:focus{outline:none;background:#fff;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.2);}
    .table-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:1.5rem;width:100%;max-width:1200px;}
    @media(max-width:1200px){.table-grid{grid-template-columns:repeat(4,1fr)}}
    @media(max-width:900px){.table-grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:600px){.table-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:400px){.table-grid{grid-column:1fr}}
    .line-item{background:var(--card);border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:.5rem;transition:transform var(--transition),box-shadow var(--transition);}
    .line-item:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover)}
    .line-item img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;cursor:zoom-in}
    .line-item h3{font-size:1rem;color:var(--accent)}
    .line-item p{margin:0;font-size:.75rem;color:#6b7280}
    .stock-line{font-weight:600;color:var(--success)}
    .actions{display:flex;gap:.5rem;margin-top:auto}
    button{padding:.4rem .8rem;border:none;border-radius:12px;font-weight:600;cursor:pointer;transition:transform .2s,box-shadow .2s;font-size:.75rem;}
    button:hover{transform:translateY(-2px)}
    .btn-primary{background:var(--accent);color:#fff;box-shadow:0 4px 14px rgba(59,130,246,.4);}
    .btn-danger{background:var(--danger);color:#fff;box-shadow:0 4px 14px rgba(239,68,68,.4);}
    .total-box{background:var(--card);padding:1.2rem 2rem;border-radius:var(--radius);box-shadow:var(--shadow);text-align:center;margin-top:2rem;}
    .total-box h2{font-size:1rem;color:var(--accent);margin:0}
    .total-box p{font-size:2rem;font-weight:700;margin:0;color:var(--accent)}
    .copy-barcode{cursor:pointer;margin-left:.3rem;color:var(--accent)}
    .copy-barcode:hover{color:var(--accent-hover)}
    .edit-form{display:flex;flex-direction:column;gap:.4rem;margin-top:.5rem;font-size:.75rem;}
    .edit-form input{padding:.4rem .5rem;border:1px solid #e5e7eb;border-radius:6px;font-size:.75rem;}
    .edit-form button{padding:.3rem .6rem;font-size:.7rem;}
    @media print{body *{visibility:hidden} #printArea,#printArea *{visibility:visible} #printArea{position:absolute;top:0;left:0;width:100%}}
    #lightbox{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:9999;}
    #lightbox img{max-width:90%;max-height:90%;border-radius:12px;}
    #spinner{position:fixed;bottom:1rem;right:1rem;background:var(--accent);color:#fff;padding:.5rem 1rem;border-radius:8px;display:none;}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
  </style>
</head>
<body>

<button id="themeToggle" title="Cambiar tema"><i class="fa fa-moon"></i></button>
<div id="spinner">Guardando…</div>

<h1><i class="fa fa-boxes"></i> Inventario – Sincronizado con Compras</h1>

<!-- Resumen -->
<div class="summary-cards">
  <div class="summary-card"><h3>Total de productos</h3><p id="totalProducts">0</p></div>
  <div class="summary-card"><h3>Stock total</h3><p id="totalStock">0</p></div>
</div>

<!-- Rango de precio -->
<div class="price-range">
  <label><span class="sr-only">Precio mínimo</span><input id="minPrice" type="number" placeholder="Precio mínimo" min="0" step="0.01"></label>
  <label><span class="sr-only">Precio máximo</span><input id="maxPrice" type="number" placeholder="Precio máximo" min="0" step="0.01"></label>
</div>

<!-- Filtro sin stock -->
<label style="display:flex;align-items:center;gap:.3rem;margin-bottom:1rem;width:100%;max-width:960px">
  <input type="checkbox" id="zeroStock"> Solo sin stock</label>

<!-- Buscador -->
<div class="search-bar">
  <label><span class="sr-only">Buscar</span><input id="searchInput" type="text" placeholder="Buscar por nombre, código, barras o categoría…"></label>
</div>

<!-- Grid -->
<div id="inventoryTable" class="table-grid"></div>

<!-- Total USD -->
<div class="total-box"><h2>Total en USD</h2><p id="totalAmount">$0.00</p></div>

<!-- Área impresión -->
<div id="printArea" style="display:none;"></div>

<!-- Lightbox -->
<div id="lightbox" onclick="closeLightbox()"><img id="lightboxImg" src="" alt="Imagen ampliada"></div>

<script type="module">
/* ---------- MÓDULO inventory.js (inline) ---------- */
export const CATEGORY_ORDER = [
  "Carteras","Aritos","Billeteras","Chokers","Collares","Lentes de sol","Pulseras","Relojes","Anillos","Accesorios para el cabello","Otros","Case teléfonos","Case audífonos","General"
];
export const sortByCustomCategory = (list) => {
  return [...list].sort((a, b) => {
    const catA = (a.category || "Otros").trim();
    const catB = (b.category || "Otros").trim();
    const indexA = CATEGORY_ORDER.indexOf(catA);
    const indexB = CATEGORY_ORDER.indexOf(catB);
    const posA = indexA === -1 ? 999 : indexA;
    const posB = indexB === -1 ? 999 : indexB;
    return posA - posB || a.name.localeCompare(b.name);
  });
};
export const calculateTotal = (list) => list.reduce((sum,item)=>{
  const price = parseFloat(item.price)||0;
  const qty   = parseFloat(item.quantity)||0;
  const disc  = parseFloat(item.discount)||0;
  return sum + (price * (1 - disc/100)) * qty;
},0);
export const getUniqueCode = () => 'P' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
/* ---------- FIN MÓDULO ---------- */

/* ---------- UTILS ---------- */
const escapeHTML = str => String(str)
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
  .replace(/"/g,'&quot;').replace(/'/g,'&#039;');

const debounce = (fn,ms=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

const sp = document.getElementById('spinner');
const showSpinner = ()=> sp.style.display='block';
const hideSpinner = ()=> sp.style.display='none';

/* ---------- VARIABLES GLOBALES ---------- */
let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
let filtered   = [...inventory];
let searchTerm = '';
let offlineQueue = [];

/* ---------- TEMA OSCURO ---------- */
const themeToggle = document.getElementById('themeToggle');
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  themeToggle.innerHTML = document.body.classList.contains('dark') ? '<i class="fa fa-sun"></i>' : '<i class="fa fa-moon"></i>';
});

/* ---------- CÁLCULOS ---------- */
const stockTotal = list => list.reduce((s,i)=>s+((parseInt(i.quantity))||0),0);

/* ---------- RESALTADO / COPIAR ---------- */
const highlight = (text, query) => {
  if(!query) return escapeHTML(text);
  const re = new RegExp(`(${query})`, 'gi');
  return escapeHTML(text).replace(re, '<mark>$1</mark>');
};
const copyToClipboard = text => navigator.clipboard.writeText(text)
  .then(()=>alert('Copiado: '+text));

/* ---------- LIGHTBOX ---------- */
window.openLightbox = src => {
  const lb = document.getElementById('lightbox');
  document.getElementById('lightboxImg').src = src;
  lb.style.display='flex';
};
window.closeLightbox = () => document.getElementById('lightbox').style.display='none';

/* ---------- RENDER ---------- */
const PAGE = 50; let page = 0;
const renderTable = ()=>{
  const container = document.getElementById('inventoryTable');
  document.getElementById('totalProducts').textContent = inventory.length;
  document.getElementById('totalStock').textContent = stockTotal(inventory);

  filtered = sortByCustomCategory(filtered);
  if(!filtered.length){
    container.innerHTML = '<p style="text-align:center;color:#6b7280;grid-column:1/-1">No hay productos que coincidan con la búsqueda.</p>';
    document.getElementById('totalAmount').textContent = '$0.00';
    return;
  }
  /* Virtualización simple */
  const renderChunk = ()=>{
    const slice = filtered.slice(page*PAGE,(page+1)*PAGE);
    container.insertAdjacentHTML('beforeend', slice.map((item,idx)=>{
      const globalIdx = page*PAGE+idx;
      return `
        <div class="line-item" id="card-${globalIdx}">
          <img id="invImg${globalIdx}" loading="lazy" src="" alt="${escapeHTML(item.name)}" onclick="openLightbox(this.src)">
          <h3>${highlight(item.name, searchTerm)}</h3>
          <p>Código: ${highlight(item.code, searchTerm)}</p>
          <p class="stock-line"><i class="fa fa-box"></i> Stock: ${item.quantity} u.</p>
          ${typeof item.discount==='number' && item.discount>0 ? `
            <p style="color:#ef4444;font-weight:600;">${item.discount}% OFF</p>
            <p>Precio: <del style="color:#9ca3af;">$${item.price}</del> <strong>$${(item.price*(1-item.discount/100)).toFixed(2)}</strong></p>
          `:`<p>Precio: $${item.price}</p>`}
          <p>Categoría: ${highlight(item.category, searchTerm)}</p>
          <p style="font-size:.7rem;">Barras: ${highlight(item.barcode, searchTerm)}
            <i class="fa fa-copy copy-barcode" onclick="copyToClipboard('${escapeHTML(item.barcode)}')" title="Copiar código"></i>
          </p>
          <div class="actions">
            <button onclick="viewItem(${globalIdx})" class="btn-primary">Ver</button>
            <button onclick="deleteItem(${globalIdx})" class="btn-danger">Eliminar</button>
            <button onclick="editItem(${globalIdx})" class="btn-primary">Editar</button>
            <button onclick="printLabel('${escapeHTML(item.code)}','${escapeHTML(item.name)}')" class="btn-primary">Etiqueta</button>
          </div>
        </div>`;
    }).join(''));
    slice.forEach((p,i)=>{
      const img=document.getElementById(`invImg${page*PAGE+i}`);
      localforage.getItem(`img_${p.code}`).then(blob=>{
        if(blob){ img.src=URL.createObjectURL(blob); }
      });
    });
  };
  container.innerHTML=''; page=0; renderChunk();
  window.onscroll=()=>{
    if(window.innerHeight+window.scrollY>=document.body.offsetHeight-200 && (page+1)*PAGE<filtered.length){
      page++; renderChunk();
    }
  };
  document.getElementById('totalAmount').textContent = `$${calculateTotal(filtered).toFixed(2)}`;
};

/* ---------- ACCIONES ---------- */
window.viewItem = idx => alert(`Detalles:\n\n${JSON.stringify(filtered[idx],null,2)}`);

window.deleteItem = idx => {
  if(!confirm('¿Eliminar producto?')) return;
  const realIdx = inventory.findIndex(it=>it.code===filtered[idx].code);
  const item = inventory[realIdx];
  localforage.removeItem(`img_${item.code}`);
  inventory.splice(realIdx,1);
  try{ localStorage.setItem('inventory', JSON.stringify(inventory)); }catch(e){ alert('Espacio lleno.'); }
  doFilter();
};

window.printLabel = (code,name) => {
  const w=window.open('','etiqueta','width=300,height=150');
  w.document.write(`<html><body style="text-align:center;font-family:sans-serif">
    <h4>${name}</h4><svg id="barcode"></svg>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
    <script>JsBarcode("#barcode","${code}",{height:40});window.print();<\/script>
    </body></html>`);
  w.document.close();
};

window.editItem = idx => {
  const card = document.getElementById(`card-${idx}`);
  const p    = filtered[idx];
  const realIdx = inventory.findIndex(it=>it.code===p.code);
  if(card.querySelector('.edit-form')) return;
  const form = document.createElement('div');
  form.className='edit-form';
  form.innerHTML=`
    <input id="editName${idx}" value="${escapeHTML(p.name)}" placeholder="Nombre">
    <input id="editPrice${idx}" type="number" step="0.01" value="${p.price}" placeholder="Precio">
    <input id="editQty${idx}" type="number" value="${p.quantity}" placeholder="Stock">
    <input id="editCat${idx}" value="${escapeHTML(p.category)}" placeholder="Categoría">
    <input id="editBar${idx}" value="${escapeHTML(p.barcode)}" placeholder="Código de barras">
    <div style="display:flex;gap:.3rem">
      <button onclick="saveEdit(${idx},${realIdx})" class="btn-primary">Guardar</button>
      <button onclick="cancelEdit(${idx})" class="btn-danger">Cancelar</button>
    </div>`;
  card.appendChild(form);
};
window.cancelEdit = idx => document.getElementById(`card-${idx}`).querySelector('.edit-form').remove();

window.saveEdit = (filterIdx,invIdx) => {
  showSpinner();
  const newData = {
    name:     document.getElementById(`editName${filterIdx}`).value.trim(),
    price:    document.getElementById(`editPrice${filterIdx}`).value.trim(),
    quantity: document.getElementById(`editQty${filterIdx}`).value.trim(),
    category: document.getElementById(`editCat${filterIdx}`).value.trim(),
    barcode:  document.getElementById(`editBar${filterIdx}`).value.trim(),
    code:     filtered[filterIdx].code,
    discount: filtered[filterIdx].discount || 0
  };
  const priceN = parseFloat(newData.price);
  const qtyN   = parseInt(newData.quantity);
  if(isNaN(priceN)||priceN<0||isNaN(qtyN)||qtyN<0){ hideSpinner(); return alert('Precio y cantidad deben ser ≥ 0'); }
  if(!inventory[invIdx].history) inventory[invIdx].history=[];
  inventory[invIdx].history.push({date:new Date().toISOString(), price:priceN, quantity:qtyN});
  inventory[invIdx]=newData;
  try{ localStorage.setItem('inventory', JSON.stringify(inventory)); }catch(e){ alert('Espacio lleno.'); }
  hideSpinner(); doFilter();
};

/* ---------- FILTROS ---------- */
const doFilter = ()=>{
  searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
  const minP = parseFloat(document.getElementById('minPrice').value) || 0;
  const maxP = parseFloat(document.getElementById('maxPrice').value) || Infinity;
  const zeroOnly = document.getElementById('zeroStock').checked;

  filtered = inventory.filter(p=>{
    const price = parseFloat(p.price)||0;
    const matchText = !searchTerm ||
      p.name.toLowerCase().includes(searchTerm) ||
      p.code.toLowerCase().includes(searchTerm) ||
      p.barcode.toLowerCase().includes(searchTerm) ||
      p.category.toLowerCase().includes(searchTerm);
    const matchPrice = price >= minP && price <= maxP;
    const matchZero  = !zeroOnly || (parseInt(p.quantity)||0)===0;
    return matchText && matchPrice && matchZero;
  });
  renderTable();
};
document.getElementById('searchInput').addEventListener('input', debounce(doFilter,300));
document.getElementById('minPrice').addEventListener('input',doFilter);
document.getElementById('maxPrice').addEventListener('input',doFilter);
document.getElementById('zeroStock').addEventListener('change',doFilter);

/* ---------- ATAJO CTRL+F ---------- */
window.addEventListener('keydown', e=>{
  if(e.ctrlKey && e.key==='f'){ e.preventDefault(); document.getElementById('searchInput').focus(); }
});

/* ---------- SINCRONIZACIÓN ---------- */
window.addEventListener('storage', e=>{
  if(e.key==='inventory'||e.key==='inventario'){
    inventory=JSON.parse(e.newValue)||[];
    try{ localStorage.setItem('inventory',JSON.stringify(inventory)); }catch(e){}
    doFilter();
  }
});
const originalSetItem = localStorage.setItem;
localStorage.setItem = function(key,value){
  originalSetItem.call(this,key,value);
  if(key==='inventory'){ originalSetItem.call(this,'inventario',value); }
  offlineQueue.push({key,value,ts:Date.now()});
};

/* ---------- ON-LINE / OFF-LINE ---------- */
window.addEventListener('online',()=>{
  while(offlineQueue.length){
    const {key,value}=offlineQueue.shift();
    navigator.sendBeacon('/sync',JSON.stringify({key,value}));
  }
});

/* ---------- INICIO ---------- */
window.addEventListener('DOMContentLoaded',doFilter);
</script>
</body>
</html>
