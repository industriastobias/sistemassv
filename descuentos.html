<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Descuentos</title>
  <style>
    :root {
      --primary: #0052d4;
      --primary-light: #4f83cc;
      --bg: #f5f7fa;
      --card: #ffffff;
      --text: #222;
      --green: #00c853;
      --red: #ff5252;
      --shadow: 0 4px 12px rgba(0,0,0,.08);
    }
    * { box-sizing: border-box; font-family: "Segoe UI", sans-serif; }
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
    body { background: var(--bg); color: var(--text); display: flex; flex-direction: column; }
    header {
      background: var(--primary);
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      box-shadow: var(--shadow);
      flex-shrink: 0;
    }
    .wrap {
      flex: 1 1 auto;
      width: 100%;
      padding: 1rem;
      overflow-y: auto;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .filters input, .filters select, .filters button {
      padding: .6rem .8rem;
      border: 1px solid #bbb;
      border-radius: 6px;
      font-size: 1rem;
    }
    .filters button {
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer;
    }
    .filters button:hover { background: var(--primary-light); }
    table {
      width: 100%;
      background: var(--card);
      border-collapse: collapse;
      box-shadow: var(--shadow);
      border-radius: 8px;
      overflow: hidden;
      font-size: 1rem;
    }
    th, td { padding: .8rem 1rem; text-align: left; border-bottom: 1px solid #e5e5e5; }
    th { background: #f2f5ff; font-weight: 600; }
    tr:hover { background: #fafbfc; }
    .thumb { width: 70px; height: 70px; object-fit: cover; border-radius: 6px; }
    .counters {
      margin: .5rem 0;
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }
    @media (max-width: 900px) {
      table { font-size: .9rem; }
      th, td { padding: .5rem .6rem; }
      .thumb { width: 50px; height: 50px; }
    }
  </style>
</head>
<body>

<header>Sistema de Descuentos</header>

<div class="wrap">
  <!-- Filtros -->
  <div class="filters">
    <input id="searchBarcode" placeholder="Código de barras (ENTER)" autocomplete="off">
    <select id="catFilter">
      <option value="">-- Categoría --</option>
      <option value="Accesorios para el cabello">Accesorios para el cabello</option>
      <option value="Anillos">Anillos</option>
      <option value="Aritos">Aritos</option>
      <option value="Billeteras">Billeteras</option>
      <option value="Carteras">Carteras</option>
      <option value="Case audífonos">Case audífonos</option>
      <option value="Case teléfonos">Case teléfonos</option>
      <option value="Chokers">Chokers</option>
      <option value="Collares">Collares</option>
      <option value="General">General</option>
      <option value="Lentes de sol">Lentes de sol</option>
      <option value="Otros">Otros</option>
      <option value="Pulseras">Pulseras</option>
      <option value="Relojes">Relojes</option>
    </select>
    <input id="globalDisc" type="number" min="0" max="100" placeholder="Dto global %">
    <button onclick="applyGlobal()">Aplicar</button>
    <button onclick="removeGlobal()">Quitar</button>
  </div>

  <div class="counters" id="counters"></div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Imagen</th>
        <th>Nombre</th>
        <th>Código</th>
        <th>Cód.Barras</th>
        <th>Precio</th>
        <th>Dto %</th>
        <th>Final</th>
        <th>Categoría</th>
        <th>Stock</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody id="list"></tbody>
  </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<script>
/* ---------- 0.  Migración 1-OFF ---------- */
(async () => {
  const old = localStorage.getItem('inventory');
  if (old) {
    try {
      await localforage.setItem('inventory', JSON.parse(old));
      localStorage.removeItem('inventory');
      localStorage.removeItem('inventario');
      console.log('Migración descuentos -> IndexedDB ✅');
    } catch (e) {
      console.error('Falló migración descuentos', e);
    }
  }
})();

/* ---------- 1.  Variables ---------- */
let inv = [];
const qs = (s) => document.querySelector(s);

/* ---------- 2.  Carga inicial ---------- */
(async () => {
  inv = await localforage.getItem('inventory') || [];
  render();
})();

/* ---------- 3.  Render ---------- */
function render(arr = inv) {
  const tb = qs('#list');
  tb.innerHTML = '';
  arr.forEach((it, idx) => {
    const final = (+it.price * (1 - (it.discount || 0) / 100)).toFixed(2);
    const tr = document.createElement('tr');
    tr.dataset.line = idx + 1;
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td><img class="thumb" id="img-${it.code}" alt="img"></td>
      <td>${it.name}</td>
      <td>${it.code}</td>
      <td>${it.barcode || ''}</td>
      <td>
        <span style="text-decoration: line-through; opacity: .7;">$${(+it.price).toFixed(2)}</span>
        <strong>$${final}</strong>
      </td>
      <td><input type="number" min="0" max="100" value="${it.discount || 0}"
                 onchange="startSave('${it.code}', this.value)"></td>
      <td>$${final}</td>
      <td>${it.category}</td>
      <td>${it.quantity}</td>
      <td><button onclick="removeDiscount('${it.code}')">Quitar descuento</button></td>`;
    tb.appendChild(tr);
  });
  loadImages();
  updateCounters();
}

/* ---------- 4.  Imágenes ---------- */
async function loadImages() {
  for (const it of inv) {
    const imgEl = qs(`#img-${it.code}`);
    if (!imgEl) continue;
    try {
      const blob = await localforage.getItem(`img_${it.code}`);
      imgEl.src = blob ? URL.createObjectURL(blob) : 'https://via.placeholder.com/70?text=Sin+img';
    } catch {
      imgEl.src = 'https://via.placeholder.com/70?text=Sin+img';
    }
  }
}

/* ---------- 5.  Descuentos ---------- */
let saveTimeout = {};
function startSave(code, val) {
  clearTimeout(saveTimeout[code]);
  saveTimeout[code] = setTimeout(() => setDisc(code, val), 500);
}
async function setDisc(code, val) {
  const it = inv.find(i => i.code === code);
  if (!it) return;
  it.discount = Math.max(0, Math.min(100, parseFloat(val) || 0));
  await save();
  render();
}
async function removeDiscount(code) {
  await setDisc(code, 0);
}
async function applyGlobal() {
  const v = parseFloat(qs('#globalDisc').value);
  if (isNaN(v) || v < 0 || v > 100) return alert('Descuento inválido');
  inv.forEach(i => i.discount = v);
  await save();
  render();
}
async function removeGlobal() {
  inv.forEach(i => i.discount = 0);
  await save();
  render();
}

/* ---------- 6.  Guardar ---------- */
async function save() {
  await localforage.setItem('inventory', inv);
  localStorage.setItem('inventario_sync', Date.now());
}

/* ---------- 7.  Contadores ---------- */
function updateCounters() {
  const withDisc = inv.filter(i => (i.discount || 0) > 0).length;
  const normal = inv.length - withDisc;
  const normalTotal = inv.reduce((s, i) => (i.discount || 0) === 0 ? s + (i.price * i.quantity) : s, 0);
  const discTotal = inv.reduce((s, i) => (i.discount || 0) > 0 ? s + (i.price * (1 - (i.discount || 0) / 100) * i.quantity) : s, 0);
  qs('#counters').innerHTML = `
    Con descuento: ${withDisc} | Precio normal: ${normal} |
    Normal: <strong>$${normalTotal.toFixed(2)}</strong> |
    Con dto: <strong>$${discTotal.toFixed(2)}</strong>
  `;
}

/* ---------- 8.  Filtros ---------- */
function filterAndRender() {
  const barcode = qs('#searchBarcode').value.trim();
  const cat = qs('#catFilter').value;
  let aux = inv;
  if (barcode) aux = aux.filter(i => i.barcode === barcode);
  if (cat) aux = aux.filter(i => i.category === cat);
  render(aux);
}
qs('#searchBarcode').addEventListener('input', filterAndRender);
qs('#catFilter').addEventListener('change', filterAndRender);
qs('#searchBarcode').addEventListener('keydown', e => {
  if (e.key === 'Enter') { e.preventDefault(); filterAndRender(); qs('#searchBarcode').select(); }
});

/* ---------- 9.  Escuchar cambios de otras pestañas ---------- */
window.addEventListener('storage', async (e) => {
  if (e.key === 'inventario_sync') {
    inv = await localforage.getItem('inventory') || [];
    render();
  }
});
</script>
</body>
</html>
