<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compra</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css "/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js "></script>

  <style>
    :root{--bg:#f5f7fa;--card:#ffffff;--text:#1f2937;--accent:#3b82f6;--accent-hover:#2563eb;--danger:#ef4444;--success:#10b981;--radius:16px;--shadow:0 6px 20px rgba(0,0,0,.08);--shadow-hover:0 8px 24px rgba(0,0,0,.12);--transition:.3s ease;}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',system-ui,sans-serif}
    body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;padding:2rem 1rem}
    .sticky-menu{position:fixed;top:1rem;right:1rem;z-index:9999;}
    .menu-toggle{background:var(--card);border:none;border-radius:var(--radius);width:48px;height:48px;font-size:1.4rem;cursor:pointer;box-shadow:var(--shadow-hover);transition:transform .2s;}
    .menu-toggle:hover{transform:scale(1.1)}
    .menu-icons{display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem;background:var(--card);padding:.75rem;border-radius:var(--radius);box-shadow:var(--shadow-hover);display:none;}
    .menu-icons.show{display:flex}
    .menu-icons a{color:var(--text);font-size:1.3rem;text-align:center;padding:.4rem;border-radius:8px;transition:background .2s, color .2s;}
    .menu-icons a:hover{background:var(--accent);color:#fff}
    body.kiosco .sticky-menu{top:unset; bottom:1rem; right:1rem}
    body.kiosco .menu-toggle{background:rgba(0,0,0,.5); color:#fff}
    body.kiosco .menu-icons{background:rgba(0,0,0,.5)}
    body.kiosco .menu-icons a{color:#fff}
    body.kiosco .menu-icons a:hover{background:var(--accent)}
    h1{font-size:2rem;font-weight:700;margin-bottom:1rem;letter-spacing:-.5px}
    .tipo-compra{display:flex;gap:.75rem;margin-bottom:1.2rem}
    .tipo-compra label{cursor:pointer;font-weight:500}
    .tipo-compra input{margin-right:.25rem}
    form, .table-cards, .mini-lote, .total-box, #editLoteBubble > div{width:95%;max-width:1200px;margin:0 auto 2rem;}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.2rem}
    label{font-size:.9rem;font-weight:500;margin-bottom:.25rem;display:block}
    input,select,textarea{width:100%;padding:.75rem 1rem;border:1px solid #e5e7eb;border-radius:12px;background:#f9fafb;color:var(--text);transition:background .3s,border-color .3s;}
    input:focus,select:focus,textarea:focus{outline:none;background:#fff;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.2);}
    button{padding:.75rem 1.5rem;border:none;border-radius:12px;font-weight:600;cursor:pointer;transition:transform .2s,box-shadow .2s;}
    button:hover{transform:translateY(-2px)}
    .btn-primary{background:var(--accent);color:#fff;box-shadow:0 4px 14px rgba(59,130,246,.4)}
    .btn-primary:hover{background:var(--accent-hover)}
    .btn-danger{background:var(--danger);color:#fff;box-shadow:0 4px 14px rgba(239,68,68,.4)}
    .btn-success{background:var(--success);color:#fff;box-shadow:0 4px 14px rgba(16,185,129,.4)}
    .actions{display:flex;gap:1rem;flex-wrap:wrap;margin-top:1.2rem}
    #imagePreview{max-height:200px;border-radius:12px;margin-top:.5rem;display:none;box-shadow:var(--shadow)}
    .table-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem;place-content:center;}
    .card-item{background:var(--card);border-radius:var(--radius);padding:1.5rem;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:.75rem;transition:transform var(--transition),box-shadow var(--transition);}
    .card-item:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover)}
    .card-item img{width:100%;height:160px;object-fit:cover;border-radius:12px}
    .card-item h3{font-size:1.1rem;color:var(--accent)}
    .card-item p{margin:0;font-size:.85rem;color:#6b7280}
    .card-item .actions{margin-top:auto;display:flex;gap:.5rem}
    .mini-lote{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:1rem;margin-top:1rem;max-height:320px;overflow-y:auto;}
    .mini-item{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:.75rem;text-align:center;font-size:.75rem;box-shadow:0 2px 6px rgba(0,0,0,.04);}
    .mini-item img{width:100%;height:90px;object-fit:cover;border-radius:8px;margin-bottom:.5rem}
    .mini-item input{width:100%;padding:.4rem;font-size:.7rem;margin-top:.2rem;border-radius:8px}
    .total-box{background:var(--card);padding:1.2rem 2rem;border-radius:var(--radius);box-shadow:var(--shadow);text-align:center;margin:1rem auto;width:95%;max-width:1200px}
    .total-box h2{font-size:1rem;color:var(--accent);margin:0}
    .total-box p{font-size:2rem;font-weight:700;margin:0;color:var(--accent)}
    @media(max-width:1024px){.table-cards{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:768px){.table-cards{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:480px){.table-cards{grid-template-columns:1fr}}
    .lote-block{margin-top:1.5rem;padding:1.5rem;border:2px dashed var(--accent);border-radius:var(--radius);background:#f0f9ff;}
    #barcodeCanvas{margin-top:.5rem;width:100%;height:80px;display:none;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
    #loadingOverlay{position:fixed;inset:0;background:rgba(255,255,255,.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:99999;}
    #loadingOverlay.show{display:flex}
    .spinner{width:60px;height:60px;border:6px solid #e5e7eb;border-top-color:var(--success);border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

<script>
  (function () {
    const kiosco = localStorage.getItem('kiosco') === 'true';
    if (kiosco) {
      document.body.classList.add('kiosco');
      document.documentElement.requestFullscreen?.().catch(() => {});
    }
  })();
</script>

<nav class="sticky-menu" aria-label="Navegaci√≥n principal">
  <button class="menu-toggle" id="menuToggle"><i class="fa-solid fa-bars"></i></button>
  <div class="menu-icons" id="menuIcons">
    <a href="compra.html" title="Compra"><i class="fa-solid fa-cart-plus"></i></a>
    <a href="almacenamiento.html" title="Almacenamiento"><i class="fa-solid fa-warehouse"></i></a>
    <a href="finanzas.html" title="Finanzas"><i class="fa-solid fa-dollar-sign"></i></a>
    <a href="inventario.html" title="Inventario"><i class="fa-solid fa-boxes-stacked"></i></a>
    <a href="catalogo.html" title="Cat√°logo"><i class="fa-solid fa-book"></i></a>
    <a href="clientes.html" title="Clientes"><i class="fa-solid fa-users"></i></a>
    <a href="descuentos.html" title="Descuentos"><i class="fa-solid fa-percent"></i></a>
    <a href="facturas.html" title="Facturas"><i class="fa-solid fa-file-invoice"></i></a>
    <a href="traslados.html" title="Traslados"><i class="fa-solid fa-truck-fast"></i></a>
    <a href="venta.html" title="Venta"><i class="fa-solid fa-cash-register"></i></a>
    <a href="#" onclick="salirKiosco()" title="Salir modo kiosco"><i class="fa-solid fa-xmark"></i></a>
  </div>
</nav>

<div id="loadingOverlay">
  <div style="display:flex;flex-direction:column;align-items:center;gap:.75rem">
    <div style="color:#10b981;font-weight:600;font-size:1.1rem">Guardado en el sistema</div>
    <div class="spinner"></div>
  </div>
</div>

<!-- =========  TOTAL ARRIBA  ========= -->
<div class="total-box">
  <h2>Total en USD</h2>
  <p id="totalAmount">$0.00</p>
</div>

<h1>Compra</h1>

<div class="tipo-compra">
  <label><input type="radio" name="tipoCompra" value="normal" checked> Producto normal</label>
  <label><input type="radio" name="tipoCompra" value="lote"> Producto por lote / mayoreo</label>
</div>

<form id="purchaseForm" class="form-grid">
  <div><label>Nombre *</label><input type="text" id="name" name="name" required></div>
  <div><label>C√≥digo *</label><input type="text" id="code" name="code" required></div>
  <div>
    <label>C√≥digo de Barras *</label>
    <input type="text" id="barcode" name="barcode" required>
    <canvas id="barcodeCanvas"></canvas>
  </div>

  <!-- Precio de venta -->
  <div><label>Precio de venta *</label><input type="number" id="price" name="price" step="0.01" required></div>

  <!-- Valor real (costo) ‚Äì OPCIONAL -->
  <div><label>Valor real (costo)</label><input type="number" id="valorReal" name="valorReal" step="0.01"></div>

  <!-- % de ganancia (editable) -->
  <div>
    <label>% ganancia sugerida</label>
    <input type="number" id="porcentajeGanancia" value="60" step="1" min="0" max="999">
  </div>

  <!-- Sugerencia venta ‚Äì solo lectura -->
  <div>
    <label>Sugerencia venta</label>
    <input type="number" id="sugerenciaVenta" step="0.01" readonly style="background:#e5e7eb;color:#333">
  </div>

  <!-- Fecha de compra -->
  <div><label>Fecha de compra *</label><input type="date" id="fechaCompra" name="fechaCompra" required></div>

  <div><label>Descuento (%)</label><input type="number" id="discount" name="discount" step="0.01" value="0"></div>
  <div><label>Cantidad en Stock *</label><input type="number" id="quantity" name="quantity" required></div>
  <div style="grid-column:1/-1"><label>Descripci√≥n *</label><textarea id="description" name="description" rows="2" required></textarea></div>
  <div><label>Categor√≠a *</label>
    <select id="category" name="category" required>
      <option value="">-- Seleccione --</option>
      <option value="Accesorios para el cabello">Accesorios para el cabello</option>
      <option value="Anillos">Anillos</option>
      <option value="Aritos">Aritos</option>
      <option value="Billeteras">Billeteras</option>
      <option value="Carteras">Carteras</option>
      <option value="Case aud√≠fonos">Case aud√≠fonos</option>
      <option value="Case tel√©fonos">Case tel√©fonos</option>
      <option value="Chokers">Chokers</option>
      <option value="Collares">Collares</option>
      <option value="General">General</option>
      <option value="Lentes de sol">Lentes de sol</option>
      <option value="Otros">Otros</option>
      <option value="Pulseras">Pulseras</option>
      <option value="Relojes">Relojes</option>
    </select>
  </div>
  <div style="grid-column:1/-1">
    <label>Imagen del producto:</label>
    <input type="file" id="imageFile" accept="image/*" onchange="previewImage(event)">
    <div style="margin-top:.5rem"><img id="imagePreview" src="" alt="Vista previa"></div>
  </div>
  <div style="grid-column:1/-1" class="actions">
    <button type="submit" class="btn-primary">Guardar producto</button>
    <button type="button" class="btn-primary" onclick="exportToZip()">Exportar ZIP</button>
    <button type="button" class="btn-primary" onclick="exportToPDF()">Exportar PDF con Im√°genes</button>
    <button type="button" class="btn-primary" onclick="resetAndOpenImport()">Importar ZIP</button>
    <input type="file" id="importFile" accept=".zip" style="display:none" onchange="importFromZip(event)">
    <button type="button" class="btn-danger" onclick="vaciarInventario()">Vaciar Inventario</button>
  </div>
</form>

<!-- CARGA MASIVA -->
<div>
  <h2><i class="fa fa-images"></i> Carga im√°genes</h2>
  <p>Selecciona entre <strong>1 y 130 im√°genes</strong>. Se crear√°n productos solo con c√≥digo √∫nico. Luego podr√°s editar el resto de datos.</p>
  <div style="margin-bottom:1rem">
    <label>Prefijo de lote (ej: LOTE001, LOTE2025, etc.)</label>
    <input type="text" id="lotePrefix" value="LOTE" maxlength="20" style="max-width:200px">
  </div>
  <input type="file" id="loteFiles" accept="image/*" multiple>
  <div class="actions">
    <button class="btn-primary" onclick="procesarLote()">Crear productos en lote</button>
    <button class="btn-danger" onclick="vaciarLote()">Vaciar lote actual</button>
  </div>
  <div id="loteStatus"></div>
  <div class="mini-lote" id="lotePreview"></div>
</div>

<!-- EDITOR DE LOTE -->
<div id="editLoteBubble" style="display:none">
  <h2><i class="fa fa-edit"></i> Editar productos del lote</h2>
  <div class="table-cards" id="editLoteGrid"></div>
  <div class="actions">
    <button class="btn-success" onclick="guardarLoteCompleto()">üíæ Guardar lote completo</button>
  </div>
</div>

<!-- ============  FILTROS  ============ -->
<div style="width:95%;max-width:1200px;margin:0 auto 1rem;display:flex;gap:.75rem;flex-wrap:wrap">
  <!-- Filtro por c√≥digo de barras -->
  <input id="searchBox" type="text" placeholder="üîç Buscar por c√≥digo de barras‚Ä¶" style="flex:1 1 260px">
  <!-- Filtro por categor√≠a -->
  <select id="categoryFilter" style="flex:1 1 200px">
    <option value="">Todas las categor√≠as</option>
    <option value="Accesorios para el cabello">Accesorios para el cabello</option>
    <option value="Anillos">Anillos</option>
    <option value="Aritos">Aritos</option>
    <option value="Billeteras">Billeteras</option>
    <option value="Carteras">Carteras</option>
    <option value="Case aud√≠fonos">Case aud√≠fonos</option>
    <option value="Case tel√©fonos">Case tel√©fonos</option>
    <option value="Chokers">Chokers</option>
    <option value="Collares">Collares</option>
    <option value="General">General</option>
    <option value="Lentes de sol">Lentes de sol</option>
    <option value="Otros">Otros</option>
    <option value="Pulseras">Pulseras</option>
    <option value="Relojes">Relojes</option>
  </select>
</div>

<div>
  <h2><i class="fa fa-boxes"></i> Inventario actual</h2>
  <div class="table-cards" id="inventoryList"></div>
</div>

<script>
/* ----------  Men√∫  ---------- */
const menuToggle = document.getElementById('menuToggle');
const menuIcons = document.getElementById('menuIcons');
menuToggle.addEventListener('click', () => menuIcons.classList.toggle('show'));
function salirKiosco() {
  localStorage.setItem('kiosco', 'false');
  document.body.classList.remove('kiosco');
  document.exitFullscreen?.();
  location.reload();
}

/* ----------  Globales  ---------- */
let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
let editIndex = -1;
let loteTemporal = [];

/* ----------  Total inventario  ---------- */
function calculateTotal() {
  const total = inventory.reduce((sum, item) => {
    const price = Number(item.price) || 0;
    const quantity = Number(item.quantity) || 0;
    const discount = Number(item.discount) || 0;
    const finalPrice = price * (1 - discount / 100);
    return sum + finalPrice * quantity;
  }, 0);
  document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
}

/* ----------  Render tabla  ---------- */
function renderTable() {
  const list = document.getElementById('inventoryList');
  list.innerHTML = inventory.map((item, idx) => `
    <div class="card-item" data-barcode="${item.barcode.toLowerCase()}" data-category="${item.category}">
      <img id="invImg${idx}" src="" alt="${escapeHtml(item.name)}"/>
      <h3>${escapeHtml(item.name)}</h3>
      <p>C√≥digo: ${escapeHtml(item.code)}</p>
      <p>C√≥d.Barras: ${escapeHtml(item.barcode)}</p>
      <img id="barcodeImg${idx}" src="" alt="C√≥digo de barras" style="display:none;width:100%;margin-top:.5rem"/>
      <p>Precio: $${Number(item.price).toFixed(2)}</p>
      ${item.valorReal ? `<p style="color:#10b981;font-size:.8rem">Costo: $${Number(item.valorReal).toFixed(2)}</p>` : ''}
      <p>Stock: ${Number(item.quantity)}</p>
      <p style="font-size:.7rem;color:#999;margin-top:auto">A√±adido: ${item.addedAt || '‚Äî'}</p>
      <div class="actions">
        <button class="btn-primary" onclick="editProduct(${idx})"><i class="fa fa-edit"></i> Editar</button>
        <button class="btn-danger" onclick="deleteProduct(${idx})"><i class="fa fa-trash"></i> Eliminar</button>
      </div>
    </div>
  `).join('');

  inventory.forEach((p, i) => {
    localforage.getItem(`img_${p.code}`).then(blob => {
      if (blob && document.getElementById(`invImg${i}`)) {
        document.getElementById(`invImg${i}`).src = URL.createObjectURL(blob);
      }
    }).catch(() => {});
    if (p.barcode) {
      const canvas = document.createElement('canvas');
      JsBarcode(canvas, p.barcode, { format: "CODE128", width: 2, height: 40, displayValue: true, fontSize: 12 });
      const img = document.getElementById(`barcodeImg${i}`);
      if (img) {
        img.src = canvas.toDataURL('image/png');
        img.style.display = 'block';
      }
    }
  });
}

function escapeHtml(text) {
  return String(text || '').replace(/[&<>"'`]/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '`': '&#96;' })[s]);
}

/* ----------  Preview imagen  ---------- */
function previewImage(evt) {
  const file = evt.target.files[0];
  if (!file) return;
  new Compressor(file, {
    quality: 0.6, maxWidth: 800, maxHeight: 800,
    success(result) {
      const reader = new FileReader();
      reader.onload = e => {
        document.getElementById('imagePreview').src = e.target.result;
        document.getElementById('imagePreview').style.display = 'block';
      };
      reader.readAsDataURL(result);
    },
    error(err) { console.error(err); }
  });
}

/* ----------  C√°lculo sugerencia con % editable  ---------- */
const valorRealInput = document.getElementById('valorReal');
const porcentajeInput = document.getElementById('porcentajeGanancia');
const sugerenciaInput = document.getElementById('sugerenciaVenta');
function calcularSugerencia() {
  const costo = parseFloat(valorRealInput.value) || 0;
  const porcentaje = parseFloat(porcentajeInput.value) || 60;
  const sugerencia = costo * (1 + porcentaje / 100);
  sugerenciaInput.value = sugerencia.toFixed(2);
}
valorRealInput.addEventListener('input', calcularSugerencia);
porcentajeInput.addEventListener('input', calcularSugerencia);

/* ============================================================
   VALIDACI√ìN #9 ANTES DE GUARDAR
============================================================ */
function validarAntesDeGuardar(item) {
  // 1. Valor real > precio venta
  if (item.valorReal && item.price && Number(item.valorReal) > Number(item.price)) {
    if (!confirm('‚ö†Ô∏è El costo es MAYOR que el precio de venta. ¬øSeguro de guardar?')) return false;
  }
  // 2. Fecha futura
  const hoy = new Date().toISOString().slice(0, 10);
  if (item.fechaCompra > hoy) {
    alert('‚ùå No puedes guardar una fecha futura.');
    return false;
  }
  return true;
}

/* ----------  Guardar producto  ---------- */
document.getElementById('purchaseForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const form = new FormData(e.target);
  const esLote = document.querySelector('input[name="tipoCompra"]:checked').value === 'lote';
  const item = {
    name: form.get('name') || '',
    code: form.get('code') || '',
    barcode: form.get('barcode') || '',
    price: Number(form.get('price')) || 0,
    valorReal: Number(form.get('valorReal')) || 0,
    fechaCompra: form.get('fechaCompra') || '',
    discount: Number(form.get('discount')) || 0,
    quantity: Number(form.get('quantity')) || 0,
    description: form.get('description') || '',
    category: form.get('category') || '',
    addedAt: new Date().toLocaleString('es-ES'),
    tipoCompra: esLote ? 'lote' : 'normal'
  };

  // VALIDACI√ìN
  if (!validarAntesDeGuardar(item)) return;

  document.getElementById('loadingOverlay').classList.add('show');
  setTimeout(() => {
    if (editIndex === -1) {
      const exists = inventory.find(i => i.code === item.code);
      if (exists) {
        if (!confirm('C√≥digo ya existe. ¬øSumar stock al existente? (Aceptar = sumar, Cancelar = crear igualmente)')) {
          item.code = `${item.code}_${Date.now()}`;
        } else {
          exists.quantity = Number(exists.quantity) + Number(item.quantity);
          localStorage.setItem('inventory', JSON.stringify(inventory));
          renderTable(); calculateTotal();
          e.target.reset();
          document.getElementById('imagePreview').style.display = 'none';
          barcodeCanvas.style.display = 'none';
          document.getElementById('loadingOverlay').classList.remove('show');
          return;
        }
      }
      inventory.push(item);
    } else {
      inventory[editIndex] = item;
      editIndex = -1;
    }
    localStorage.setItem('inventory', JSON.stringify(inventory));
    const imgFile = document.getElementById('imageFile').files[0];
    if (imgFile) {
      new Compressor(imgFile, {
        quality: 0.6, maxWidth: 800, maxHeight: 800,
        success(result) {
          localforage.setItem(`img_${item.code}`, result).catch(() => {});
        }
      });
    }
    e.target.reset();
    document.getElementById('imagePreview').style.display = 'none';
    barcodeCanvas.style.display = 'none';
    renderTable(); calculateTotal();
    document.getElementById('loadingOverlay').classList.remove('show');
  }, 500);
});

/* ----------  Eliminar producto  ---------- */
function deleteProduct(idx) {
  if (!confirm('¬øEliminar este producto?')) return;
  const code = inventory[idx].code;
  inventory.splice(idx, 1);
  localStorage.setItem('inventory', JSON.stringify(inventory));
  localforage.removeItem(`img_${code}`).catch(() => {});
  renderTable(); calculateTotal();
}

/* ----------  Vaciar inventario  ---------- */
function vaciarInventario() {
  if (!confirm('¬øVaciar todo el inventario?')) return;
  inventory.forEach(p => localforage.removeItem(`img_${p.code}`).catch(() => {}));
  inventory = [];
  localStorage.setItem('inventory', JSON.stringify(inventory));
  renderTable(); calculateTotal();
}

/* ----------  Exportar ZIP  ---------- */
async function exportToZip() {
  try {
    const zip = new JSZip();
    zip.file('inventory.json', JSON.stringify(inventory, null, 2));
    const imgFolder = zip.folder('images');
    for (const p of inventory) {
      try {
        const blob = await localforage.getItem(`img_${p.code}`);
        if (blob) imgFolder.file(`${p.code}.jpg`, blob);
      } catch (e) {}
    }
    const blobZip = await zip.generateAsync({ type: 'blob' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blobZip);
    a.download = 'inventario.zip';
    a.click();
  } catch (e) {
    alert('Error exportando ZIP: ' + (e.message || e));
  }
}

/* ----------  Importar ZIP  ---------- */
async function importFromZip(evt) {
  const file = evt.target.files[0];
  if (!file || !file.name.toLowerCase().endsWith('.zip')) { alert('Selecciona un archivo .zip'); evt.target.value = ''; return; }
  try {
    const arrayBuffer = await file.arrayBuffer();
    const zip = await JSZip.loadAsync(arrayBuffer);
    const jsonFile = zip.file('inventory.json');
    if (!jsonFile) { alert('El ZIP no contiene inventory.json'); evt.target.value = ''; return; }
    const jsonText = await jsonFile.async('string');
    let imported = JSON.parse(jsonText);
    if (!Array.isArray(imported)) imported = [];
    for (const p of imported) {
      p.price = Number(p.price) || 0;
      p.quantity = Number(p.quantity) || 0;
      p.discount = Number(p.discount) || 0;
      const imgEntry = zip.file(`images/${p.code}.jpg`) || zip.file(`images/${p.code}.jpeg`);
      if (imgEntry) {
        try {
          const blob = await imgEntry.async('blob');
          await localforage.setItem(`img_${p.code}`, blob);
        } catch (e) {}
      }
      const idx = inventory.findIndex(x => x.code === p.code);
      if (idx > -1) {
        inventory[idx].quantity = Number(inventory[idx].quantity || 0) + Number(p.quantity || 0);
        if (!inventory[idx].name && p.name) inventory[idx].name = p.name;
        if (!inventory[idx].barcode && p.barcode) inventory[idx].barcode = p.barcode;
        if ((!inventory[idx].price || inventory[idx].price === 0) && p.price) inventory[idx].price = p.price;
        if (!inventory[idx].description && p.description) inventory[idx].description = p.description;
        if (!inventory[idx].category && p.category) inventory[idx].category = p.category;
        if (!inventory[idx].addedAt && p.addedAt) inventory[idx].addedAt = p.addedAt;
      } else {
        const nuevo = {
          name: p.name || p.code,
          code: p.code,
          barcode: p.barcode || '',
          price: Number(p.price) || 0,
          valorReal: Number(p.valorReal) || 0,
          fechaCompra: p.fechaCompra || '',
          discount: Number(p.discount) || 0,
          quantity: Number(p.quantity) || 0,
          description: p.description || '',
          category: p.category || '',
          addedAt: p.addedAt || new Date().toLocaleString('es-ES'),
          tipoCompra: p.tipoCompra || 'normal'
        };
        inventory.push(nuevo);
      }
    }
    localStorage.setItem('inventory', JSON.stringify(inventory));
    renderTable(); calculateTotal();
    alert('Importaci√≥n ZIP completada y fusionada correctamente ‚úÖ');
  } catch (e) {
    console.error(e);
    alert('Error leyendo ZIP: ' + (e.message || e));
  } finally {
    evt.target.value = '';
  }
}

function resetAndOpenImport() {
  const inp = document.getElementById('importFile');
  inp.value = '';
  inp.click();
}

/* ----------  Exportar PDF  ---------- */
async function exportToPDF() {
  try {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const margin = 15; let y = margin;
    pdf.setFontSize(16);
    pdf.text('Inventario con im√°genes', margin, y); y += 10;
    for (let i = 0; i < inventory.length; i++) {
      const p = inventory[i];
      let blob = null;
      try { blob = await localforage.getItem(`img_${p.code}`); } catch (e) { blob = null; }
      if (blob) {
        const dataUrl = await blobToDataURL(blob);
        try { pdf.addImage(dataUrl, 'JPEG', margin, y, 40, 40); } catch (e) {}
      }
      pdf.setFontSize(11);
      pdf.text(`C√≥digo: ${p.code}`, 60, y + 7);
      pdf.text(`Nombre: ${p.name}`, 60, y + 14);
      pdf.text(`Precio: $${Number(p.price).toFixed(2)}`, 60, y + 21);
      pdf.text(`Stock: ${Number(p.quantity)}`, 60, y + 28);
      y += 48;
      if (y > 250) { pdf.addPage(); y = margin; }
    }
    pdf.save('inventario.pdf');
  } catch (e) {
    console.error(e);
    alert('Error generando PDF: ' + (e.message || e));
  }
}

function blobToDataURL(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

/* ----------  Editar producto  ---------- */
function editProduct(idx) {
  window.scrollTo({ top: 0, behavior: 'smooth' });
  const p = inventory[idx];
  document.getElementById('name').value = p.name;
  document.getElementById('code').value = p.code;
  document.getElementById('barcode').value = p.barcode;
  document.getElementById('price').value = p.price;
  document.getElementById('valorReal').value = p.valorReal || '';
  document.getElementById('fechaCompra').value = p.fechaCompra || '';
  document.getElementById('porcentajeGanancia').value = 60;
  calcularSugerencia();
  document.getElementById('discount').value = p.discount;
  document.getElementById('quantity').value = p.quantity;
  document.getElementById('description').value = p.description;
  document.getElementById('category').value = p.category;
  editIndex = idx;
  document.querySelector(`input[name="tipoCompra"][value="${p.tipoCompra || 'normal'}"]`).checked = true;
  localforage.getItem(`img_${p.code}`).then(blob => {
    if (blob) {
      document.getElementById('imagePreview').src = URL.createObjectURL(blob);
      document.getElementById('imagePreview').style.display = 'block';
    }
  }).catch(() => {});
  generarBarcode(p.barcode);
}

/* ----------  C√≥digo de barras  ---------- */
const barcodeInput = document.getElementById('barcode');
const barcodeCanvas = document.getElementById('barcodeCanvas');
function generarBarcode(value) {
  if (!value || value.trim() === '') { barcodeCanvas.style.display = 'none'; return; }
  barcodeCanvas.style.display = 'block';
  JsBarcode(barcodeCanvas, value, { format: "CODE128", lineColor: "#000", width: 2, height: 60, displayValue: true, fontSize: 14, margin: 5 });
}
barcodeInput.addEventListener('input', () => generarBarcode(barcodeInput.value));

/* ============================================================
   C A R G A   M A S I V A  (1-130 im√°genes)  ‚Äì  100 % funcional
============================================================ */
async function procesarLote() {
  const files = document.getElementById('loteFiles').files;
  if (!files.length) { alert('Selecciona im√°genes'); return; }
  if (files.length < 1 || files.length > 130) { alert('Elige entre 1 y 130 im√°genes'); return; }
  const prefix = document.getElementById('lotePrefix').value.trim() || 'LOTE';
  loteTemporal = [];
  const preview = document.getElementById('lotePreview');
  preview.innerHTML = '';
  document.getElementById('loteStatus').textContent = 'Comprimiendo y guardando...';

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const codigo = `${prefix}${Date.now()}${i}`;
    await new Promise(res => {
      new Compressor(file, {
        quality: 0.6, maxWidth: 800, maxHeight: 800,
        success(result) {
          const reader = new FileReader();
          reader.onload = e => {
            const mini = document.createElement('div');
            mini.className = 'mini-item';
            mini.innerHTML = `<img src="${e.target.result}" alt="img"><div>C√≥digo: <b>${codigo}</b></div>`;
            preview.appendChild(mini);
            localforage.setItem(`img_${codigo}`, result);
            loteTemporal.push({
              name: '', code: codigo, barcode: '', price: 0, valorReal: 0, fechaCompra: '',
              discount: 0, quantity: 0, description: '', category: '',
              addedAt: new Date().toLocaleString('es-ES'), tipoCompra: 'lote'
            });
            res();
          };
          reader.readAsDataURL(result);
        },
        error(err) { console.error(err); res(); }
      });
    });
  }
  document.getElementById('loteStatus').textContent = `Listo: ${loteTemporal.length} productos creados. Ahora ed√≠talos.`;
  mostrarEditorLote();
}

function vaciarLote() {
  if (!confirm('¬øVaciar lote actual?')) return;
  loteTemporal.forEach(p => localforage.removeItem(`img_${p.code}`).catch(() => {}));
  loteTemporal = [];
  document.getElementById('lotePreview').innerHTML = '';
  document.getElementById('loteStatus').textContent = '';
  document.getElementById('editLoteBubble').style.display = 'none';
}

/* ----------  Editor de lote con labels arriba de cada campo  ---------- */
function mostrarEditorLote() {
  const grid = document.getElementById('editLoteGrid');
  grid.innerHTML = '';
  document.getElementById('editLoteBubble').style.display = 'block';

  loteTemporal.forEach((p, i) => {
    const card = document.createElement('div');
    card.className = 'card-item';
    card.innerHTML = `
      <img id="loteImg${i}" src="" alt="img" style="height:160px;object-fit:cover;border-radius:12px;">
      <h3>${p.code}</h3>

      <!-- 1. Nombre -->
      <label style="font-size:.75rem;font-weight:500;margin-top:.5rem;display:block">Nombre *</label>
      <input id="loteName${i}" value="${escapeHtml(p.name)}">

      <!-- 2. C√≥digo (solo lectura) -->
      <label style="font-size:.75rem;font-weight:500;margin-top:.5rem;display:block">C√≥digo</label>
      <input value="${p.code}" readonly style="background:#e5e7eb">

      <!-- 3. Barras -->
      <label style="font-size:.75rem;font-weight:500;margin-top:.5rem;display:block">C√≥digo de Barras *</label>
      <input id="loteBarcode${i}" value="${escapeHtml(p.barcode)}">

      <!-- 4. Precio venta -->
      <label style="font-size:.75rem;font-weight:500;margin-top:.5rem;display:block">Precio de venta *</label>
      <input id="lotePrice${i}" type="number" step="0.01" value="${Number(p.price)}">

      <!-- 5. Costo -->
      <label style="font-size:.75rem;font-weight:500;margin-top:.5rem;display:block">Valor real (costo)</label>
      <input id="loteValorReal${i}" type="number" step="0.01" value="${Number(p.valorReal)}">

      <!-- 6. Fecha compra -->
      <label style="font-size:.75rem;font-weight:500;margin-top:.5rem;display:block">Fecha de compra *</label>
      <input id="loteFecha${i}" type="text" placeholder="dd/mm/aaaa" onfocus="this.type='date'" onblur="if(!this.value)this.type='text'" value="${p.fechaCompra}">

      <!-- 7. % Ganancia -->
      <label style="font-size:.75rem;font-weight:500;margin-top:.5rem;display:block">% ganancia</label>
      <input id="lotePorcentaje${i}" type="number" value="60" step="1" min="0" max="999" oninput="calcSugLote(${i})">

      <!-- 8. Sugerencia venta -->
      <label style="font-size:.75rem;font-weight:500;margin-top:.5rem;display:block">Sugerencia venta</label>
      <input id="loteSug${i}" type="number" step="0.01" readonly style="background:#e5e7eb;color:#333">

      <!-- 9. Descuento -->
      <label style="font-size:.75rem;font-weight:500;margin-top:.5rem;display:block">Descuento (%)</label>
      <input id="loteDiscount${i}" type="number" step="0.01" value="${Number(p.discount)}">

      <!-- 10. Stock -->
      <label style="font-size:.75rem;font-weight:500;margin-top:.5rem;display:block">Cantidad en Stock *</label>
      <input id="loteQuantity${i}" type="number" value="${Number(p.quantity)}">

      <!-- 11. Descripci√≥n -->
      <label style="font-size:.75rem;font-weight:500;margin-top:.5rem;display:block">Descripci√≥n *</label>
      <textarea id="loteDescription${i}" rows="2">${escapeHtml(p.description)}</textarea>

      <!-- 12. Categor√≠a -->
      <label style="font-size:.75rem;font-weight:500;margin-top:.5rem;display:block">Categor√≠a *</label>
      <select id="loteCategory${i}">
        <option value="">-- Seleccione --</option>
        <option value="Accesorios para el cabello">Accesorios para el cabello</option>
        <option value="Anillos">Anillos</option>
        <option value="Aritos">Aritos</option>
        <option value="Billeteras">Billeteras</option>
        <option value="Carteras">Carteras</option>
        <option value="Case aud√≠fonos">Case aud√≠fonos</option>
        <option value="Case tel√©fonos">Case tel√©fonos</option>
        <option value="Chokers">Chokers</option>
        <option value="Collares">Collares</option>
        <option value="General">General</option>
        <option value="Lentes de sol">Lentes de sol</option>
        <option value="Otros">Otros</option>
        <option value="Pulseras">Pulseras</option>
        <option value="Relojes">Relojes</option>
      </select>
    `;
    grid.appendChild(card);

    // Cargar mini-imagen
    localforage.getItem(`img_${p.code}`).then(blob => {
      if (blob) document.getElementById(`loteImg${i}`).src = URL.createObjectURL(blob);
    }).catch(() => {});

    // Calcula sugerencia inicial
    calcSugLote(i);
  });
}

/* ----------  Calcula sugerencia por item del lote  ---------- */
function calcSugLote(i) {
  const costo = parseFloat(document.getElementById(`loteValorReal${i}`).value) || 0;
  const porc = parseFloat(document.getElementById(`lotePorcentaje${i}`).value) || 60;
  document.getElementById(`loteSug${i}`).value = (costo * (1 + porc / 100)).toFixed(2);
}

/* ----------  Guardar lote completo con validaci√≥n  ---------- */
function guardarLoteCompleto() {
  if (!confirm(`¬øGuardar ${loteTemporal.length} productos en el inventario?`)) return;

  // Validaci√≥n por item
  for (let i = 0; i < loteTemporal.length; i++) {
    const costo = parseFloat(document.getElementById(`loteValorReal${i}`).value) || 0;
    const precio = parseFloat(document.getElementById(`lotePrice${i}`).value) || 0;
    const fecha = document.getElementById(`loteFecha${i}`).value;
    const hoy = new Date().toISOString().slice(0, 10);
    if (costo > precio) {
      if (!confirm(`‚ö†Ô∏è Producto ${i + 1}: el costo es mayor que el precio de venta. ¬øSigues?`)) return;
    }
    if (fecha > hoy) {
      alert(`‚ùå Producto ${i + 1}: fecha futura no permitida.`);
      return;
    }
  }

  document.getElementById('loadingOverlay').classList.add('show');
  setTimeout(() => {
    loteTemporal.forEach((p, i) => {
      p.name = document.getElementById(`loteName${i}`).value.trim() || p.code;
      p.barcode = document.getElementById(`loteBarcode${i}`).value.trim();
      p.price = Number(document.getElementById(`lotePrice${i}`).value) || 0;
      p.valorReal = Number(document.getElementById(`loteValorReal${i}`).value) || 0;
      p.fechaCompra = document.getElementById(`loteFecha${i}`).value;
      p.discount = Number(document.getElementById(`loteDiscount${i}`).value) || 0;
      p.quantity = Number(document.getElementById(`loteQuantity${i}`).value) || 0;
      p.description = document.getElementById(`loteDescription${i}`).value.trim();
      p.category = document.getElementById(`loteCategory${i}`).value;
      if (!p.addedAt) p.addedAt = new Date().toLocaleString('es-ES');
    });
    inventory = inventory.concat(loteTemporal);
    localStorage.setItem('inventory', JSON.stringify(inventory));
    alert('Lote guardado ‚úÖ');
    loteTemporal = [];
    document.getElementById('editLoteBubble').style.display = 'none';
    renderTable(); calculateTotal();
    document.getElementById('loadingOverlay').classList.remove('show');
  }, 500);
}

/* ----------  Filtros  ---------- */
const searchBox = document.getElementById('searchBox');
const categoryFilter = document.getElementById('categoryFilter');

function aplicarFiltros() {
  const q = searchBox.value.trim().toLowerCase();
  const cat = categoryFilter.value;
  const cards = document.querySelectorAll('#inventoryList .card-item');
  cards.forEach(card => {
    const barcode = card.dataset.barcode;
    const categoria = card.dataset.category;
    const okBarcode = !q || barcode.includes(q);
    const okCat = !cat || categoria === cat;
    card.style.display = (okBarcode && okCat) ? '' : 'none';
  });
}

searchBox.addEventListener('input', aplicarFiltros);
categoryFilter.addEventListener('change', aplicarFiltros);

/* ----------  Inicializar  ---------- */
window.addEventListener('DOMContentLoaded', () => {
  renderTable(); calculateTotal();
});
</script>
</body>
</html>
