<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventario</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#fff;--text:#1f2937;--border:#e5e7eb;--accent:#3b82f6;--accent-hover:#2563eb;--highlight:#f3f4f6;--white:#fff;--danger:#f87171;--card-shadow:0 2px 8px rgba(0,0,0,.08)}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Courier Prime',monospace}
    body{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;font-size:16px;background:var(--bg);color:var(--text)}
    h1{font-size:1.8rem;font-weight:700;text-align:center;margin:.8rem 0 .6rem;letter-spacing:1px;text-transform:uppercase}
    .container{width:100vw;height:100vh;background:var(--white);padding:1.2rem;display:flex;flex-direction:column;overflow:hidden}
    .top-bar{display:flex;flex-wrap:wrap;align-items:center;gap:.6rem;margin-bottom:.6rem;font-size:.9rem}
    #lowStockBox{background:var(--danger);color:#fff;padding:.3rem .6rem;border-radius:6px;font-weight:700;font-size:.8rem;min-width:40px;text-align:center;display:none}
    #reader{width:320px;margin:.6rem auto}
    .search-block{display:flex;flex-wrap:wrap;gap:.8rem;margin-bottom:1rem;align-items:flex-end}
    label{font-weight:700;font-size:.9rem}
    input,select{padding:.55rem .65rem;border:1px solid var(--border);border-radius:6px;font-size:.95rem}
    button.stamp{padding:.55rem 1rem;border:1px solid var(--accent);background:var(--accent);color:var(--white);font-weight:700;font-size:.9rem;text-transform:uppercase;cursor:pointer;border-radius:6px;transition:background .2s ease;white-space:nowrap}
    button.stamp:hover{background:var(--accent-hover)}
    table{width:100%;border-collapse:collapse;margin-top:.6rem}
    thead{background:var(--highlight)}
    th,td{padding:.55rem .65rem;border:1px solid var(--border);text-align:left;font-size:.9rem}
    th{font-weight:700;letter-spacing:.5px}
    tbody tr:nth-child(odd){background:var(--highlight)}
    td img{max-height:48px;border-radius:4px;object-fit:cover;cursor:pointer}
    .no-results,.result-message{font-weight:700;text-align:center;margin-top:.6rem;font-size:.9rem}
    .no-results{color:var(--danger)}
    .result-message{color:var(--text)}
    tr.highlight td{background:#fef08a!important;color:#1f2937!important}
    .cards-view{display:none;flex-wrap:wrap;gap:1rem;overflow-y:auto;padding-right:.4rem;margin-top:.6rem}
    .card{background:var(--white);border:1px solid var(--border);border-radius:12px;box-shadow:var(--card-shadow);width:260px;display:flex;flex-direction:column;padding:.8rem;gap:.5rem}
    .card img{width:100%;height:160px;object-fit:cover;border-radius:8px;cursor:pointer}
    .card-footer{margin-top:auto;display:flex;justify-content:space-between;align-items:center}
    .card-footer span{font-weight:700}
    .card.highlight{background:#fef08a!important}
    .full-image-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:9999;cursor:pointer}
    .full-image-overlay img{max-width:90vw;max-height:90vh;border-radius:12px}
    .modal{display:none;position:fixed;z-index:20;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);backdrop-filter:blur(4px)}
    .modal-content{position:relative;margin:5vh auto;background:#fff;border-radius:16px;width:90vw;max-width:400px;padding:1.5rem;display:flex;flex-direction:column;gap:.8rem}
    .close{position:absolute;top:12px;right:12px;color:#6b7280;font-size:24px;font-weight:300;cursor:pointer;line-height:1}
    .close:hover{color:#111827}
    .btn-edit{background:#9ca3af;border:none;color:#fff;padding:.15rem .3rem;font-size:.65rem;border-radius:4px;cursor:pointer;margin-left:.25rem}
    .btn-edit:hover{background:#6b7280}
    #salesPanel{display:none;flex-direction:column;gap:.8rem;margin-top:1rem;flex:1 1 auto;min-height:0}
    #salesTableWrapper{overflow:auto;border:1px solid var(--border);border-radius:8px;background:var(--white);flex:1 1 auto}
    #salesTable{margin:0}
    mark{background-color:#fef08a;color:#1f2937;padding:2px 4px;border-radius:3px;font-weight:700}
    #sideMenu{position:fixed;top:0;right:-200px;width:200px;height:100vh;background:var(--highlight);border-left:1px solid var(--border);box-shadow:-2px 0 8px rgba(0,0,0,.1);transition:right .3s ease;z-index:1000;padding:1rem;display:flex;flex-direction:column;gap:.6rem}
    #sideMenu.show{right:0}
    #sideMenu a{color:var(--text);text-decoration:none;font-weight:700;font-size:.9rem;padding:.4rem .6rem;border-radius:6px;transition:background .2s ease;display:flex;align-items:center;gap:.5rem}
    #sideMenu a:hover{background:var(--white)}
    #menuToggleBtn{position:fixed;bottom:1.2rem;right:1.2rem;width:3rem;height:3rem;border-radius:50%;border:none;background:var(--accent);color:var(--white);font-size:1.4rem;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.25);z-index:1001}
    #cashRegisterFullscreen{position:fixed;inset:0;z-index:9999;background:#fff;color:#1f2937;overflow-y:auto;padding:1.2rem;display:flex;flex-direction:column;gap:1rem}
    #cashRegisterFullscreen .header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--border);padding-bottom:.6rem}
    #cashRegisterFullscreen .filters{display:flex;flex-wrap:wrap;gap:1rem;align-items:center}
    #cashRegisterFullscreen .filters select,#cashRegisterFullscreen .filters input{padding:.4rem .6rem;font-size:1rem}
    #cashRegisterFullscreen .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:1rem;flex:1 1 auto;overflow-y:auto}
    #cashRegisterFullscreen .prod-card{border:1px solid var(--border);border-radius:8px;padding:.6rem;display:flex;flex-direction:column;gap:.4rem;text-align:center;transition:background .3s}
    #cashRegisterFullscreen .prod-card img{width:100%;height:160px;object-fit:cover;border-radius:6px;cursor:pointer}
    #cashRegisterFullscreen .stock-low{color:#dc2626;font-weight:700}
    @keyframes flash{0%{background:#fef08a}100%{background:transparent}}
    .flash{animation:flash .6s ease}
    #cashRegisterFullscreen table{width:100%;border-collapse:collapse;font-size:1rem}
    #cashRegisterFullscreen th,#cashRegisterFullscreen td{padding:.4rem .5rem;border:1px solid var(--border)}
    #cashRegisterFullscreen th{background:var(--highlight)}
    #cashFloatList{position:fixed;top:1rem;right:1rem;width:320px;max-height:400px;background:#fff;border:2px solid var(--accent);border-radius:12px;padding:1rem;box-shadow:0 4px 20px rgba(0,0,0,.25);z-index:10000;display:none;flex-direction:column;gap:.5rem}
    #cashFloatList h4{margin:0 0 .5rem 0;font-size:1.1rem}
    #cashFloatList ul{list-style:none;margin:0;padding:0;overflow-y:auto}
    #cashFloatList li{display:flex;justify-content:space-between;align-items:center;padding:.3rem 0;font-size:.9rem}
    #cashFloatList button{margin-top:.5rem;width:100%}
    #cashHelpKeys{display:none}
    /* virtual table viewport */
    .virtual-tbody{display:block;overflow:auto;max-height:60vh;position:relative}
    .virtual-tr{position:absolute;width:100%;display:flex}
    .virtual-td{flex:1;padding:.55rem .65rem;border-bottom:1px solid var(--border)}
  </style>
</head>

<body>
  <div id="notExistModal" style="display:none;">Producto no existente</div>
  <button id="menuToggleBtn" onclick="App.toggleMenu()" title="Men√∫">‚ò∞</button>
  <nav id="sideMenu">
    <a href="menu.html"><i class="fa-solid fa-bars"></i></a>
    <a href="compra.html"><i class="fa-solid fa-cart-shopping"></i></a>
    <a href="almacenamiento.html"><i class="fa-solid fa-warehouse"></i></a>
    <a href="lista.html"><i class="fa-solid fa-list"></i></a>
    <a href="inventario.html"><i class="fa-solid fa-boxes-stacked"></i></a>
    <a href="gastos.html"><i class="fa-solid fa-money-bill-trend-up"></i></a>
    <a href="clientes.html"><i class="fa-solid fa-users"></i></a>
    <a href="descuentos.html"><i class="fa-solid fa-percent"></i></a>
    <a href="facturas.html"><i class="fa-solid fa-file-invoice"></i></a>
    <a href="traslados.html"><i class="fa-solid fa-truck"></i></a>
    <a href="venta.html"><i class="fa-solid fa-cash-register"></i></a>
  </nav>

  <div class="container">
    <div class="top-bar">
      <div id="lowStockBox" title="Productos con stock bajo">‚ö†Ô∏è <span id="dashLow">-</span></div>
      <button class="stamp" onclick="App.startCameraScan()" title="Escanear con c√°mara">üì∑ C√°mara</button>
      <button class="stamp" id="usbBtn" onclick="App.initUSBReader()" title="Lector USB HID">üîå Lector USB</button>
      <button class="stamp" onclick="App.downloadLabelsPDF()" title="Descargar etiquetas">üìá Etiquetas PDF</button>
      <button class="stamp" id="cancelScanBtn" onclick="App.cancelScan()" style="display:none;background:var(--danger);border-color:var(--danger);">‚ùå Cancelar</button>
      <button class="stamp" id="salesBtn" onclick="App.toggleSalesPanel()" title="Ver historial de ventas">üìã Historial</button>
      <button class="stamp" onclick="App.openSalesHistoryModal()" title="Ventas con imagen y filtros">üñºÔ∏è Ventas Detalle</button>
      <button class="stamp" id="kioscoBtn" onclick="App.toggleKiosco()" title="Activar/desactivar pantalla completa">üñ•Ô∏è Kiosco</button>
      <button class="stamp" onclick="App.openCashRegister()" title="Caja registradora">üßæ Caja Registradora</button>
      <!-- BACKUP MANUAL (OPCIONAL) -->
      <button class="stamp" onclick="App.backup()" title="Descargar respaldo manual" style="display:none">üíæ Backup</button>
    </div>

    <div id="reader"></div>

    <div id="normalSearchBlock" class="search-block">
      <div><label for="searchName">Buscar por nombre:</label><input type="text" id="searchName" placeholder="Parte del nombre"></div>
      <div><label for="searchCategory">Categor√≠a:</label><select id="searchCategory"><option value="">Todas</option><option>Accesorios para el cabello</option><option>Anillos</option><option>Aritos</option><option>Billeteras</option><option>Carteras</option><option>Case aud√≠fonos</option><option>Case tel√©fonos</option><option>Chokers</option><option>Collares</option><option>General</option><option>Lentes de sol</option><option>Otros</option><option>Pulseras</option><option>Relojes</option></select></div>
      <div style="position:relative;"><label for="searchCode">C√≥digo barras:</label><input type="text" id="searchCode" placeholder="Ej: 123456" style="padding-right:3rem;"><span style="position:absolute; right:8px; top:50%; transform:translateY(-50%); font-size:.7rem; color:#9ca3af; pointer-events:none;">Ctrl+B</span></div>
      <div><label for="minPrice">Precio m√≠n:</label><input type="number" id="minPrice" placeholder="0" min="0" step="0.01"></div>
      <div><label for="maxPrice">Precio m√°x:</label><input type="number" id="maxPrice" placeholder="999999" min="0" step="0.01"></div>
      <div style="display:flex;align-items:flex-end;gap:.5rem;"><label for="lowStockOnly">Stock bajo</label><input type="checkbox" id="lowStockOnly"></div>
      <button class="stamp" onclick="App.applyFilters()">Buscar</button><button class="stamp" onclick="App.clearAllFilters()">Limpiar</button>
      <button class="stamp" id="toggleViewBtn" onclick="App.toggleView()" style="margin-left:auto;">Ver Tarjetas</button>
    </div>

    <div id="salesPanel">
      <div style="display:flex;gap:.8rem;flex-wrap: wrap;align-items:flex-end;">
        <div><label for="salesSearchName">Filtrar por nombre:</label><input type="text" id="salesSearchName" placeholder="Escribe parte del nombre" /></div>
        <button class="stamp" onclick="App.filterSales()">Buscar</button><button class="stamp" onclick="App.exportSalesCSV()">Exportar CSV</button><button class="stamp" onclick="App.clearSalesFilter()">Limpiar</button>
      </div>
      <div id="salesTableWrapper"><table id="salesTable"><thead><tr><th>#</th><th>Nombre</th><th>C√≥digo</th><th>Cantidad</th><th>Precio Unit.</th><th>Total</th></tr></thead><tbody id="salesList"></tbody></table></div>
    </div>

    <div style="display:flex; gap:.6rem; align-items:center; flex-wrap: wrap;">
      <label for="goToRow">Ir a fila:</label><input type="number" id="goToRow" min="1" style="width:80px;"><button class="stamp" onclick="App.goToRow()">Ir</button><button class="stamp" onclick="App.clearAllFilters()">Limpiar filtros</button>
    </div>

    <div id="tableView" style="flex:1 1 auto; overflow:auto; margin-top:.5rem;">
      <table><thead><tr><th>#</th><th>Imagen</th><th>Nombre</th><th>C√≥digo de Barras</th><th>C√≥digo de Barras (img)</th><th>Precio</th><th>Desc(%)</th><th>Precio c/Desc</th><th>Fecha / Hora</th><th>Categor√≠a</th><th>Stock</th><th>Acciones</th></tr></thead>
      <tbody id="inventoryList" class="virtual-tbody"></tbody></table>
      <div id="noResultsMessage" class="no-results" style="display:none;">No se encontraron productos.</div><div id="resultMessage" class="result-message" style="display:none;"></div>
    </div>
    <div id="cardsView" class="cards-view"></div>
  </div>

  <!-- MODAL REGISTRAR VENTA -->
  <div id="soldModal" class="modal"><div class="modal-content"><span class="close" onclick="App.closeSoldModal()">&times;</span><h2>Registrar Venta</h2>
    <label for="soldQuantity">Cantidad vendida:</label><input type="number" id="soldQuantity" min="1">
    <label id="originalPriceLabel" style="font-weight:700;color:#555;margin-bottom:.5rem;display:block;">Precio establecido: $0</label>
    <label for="soldPrice" style="margin-top:1rem;display:block;">Precio de venta (fijo):</label><input type="number" id="soldPrice" min="0" step="0.01" readonly style="background-color:#f0f0f0;color:#666;">
    <button class="stamp" onclick="App.processSale()">Registrar</button><div id="confirmationMessage" class="result-message" style="display:none; margin-top:1rem;">¬°Venta registrada!</div>
  </div></div>

  <!-- MODAL EDITAR PRECIO -->
  <div id="priceModal" class="modal"><div class="modal-content"><span class="close" onclick="App.closePriceModal()">&times;</span><h2>Editar precio</h2>
    <label>Nuevo precio:</label><input type="number" id="newPrice" min="0" step="0.01" placeholder="Ej: 1990"><button class="stamp" onclick="App.saveNewPrice()">Guardar</button>
  </div></div>

  <!-- MODAL VENTAS DETALLADO -->
  <div id="salesHistoryModal" class="modal" style="backdrop-filter:none;background:#000a;"><div class="modal-content" style="width:100vw; height:100vh; max-width:none; border-radius:0; margin:0; overflow-y:auto;">
    <span class="close" onclick="App.closeSalesHistoryModal()">&times;</span><h2>Historial de Ventas Detallado</h2>
    <div style="display:flex;gap:.5rem;margin-bottom:1rem;">
      <button class="stamp" onclick="App.setQuickFilter(0)">Hoy</button><button class="stamp" onclick="App.setQuickFilter(1)">Ayer</button>
      <button class="stamp" onclick="App.setQuickFilter(7)">7 d√≠as</button><button class="stamp" onclick="App.setQuickFilter(30)">30 d√≠as</button>
      <button class="stamp" onclick="App.downloadSalesDetailPDF()">üìÑ PDF</button>
    </div>
    <input type="text" id="liveSearchSales" placeholder="üîç Nombre o c√≥digo" style="width:100%;margin-bottom:.8rem;">
    <div style="display:flex;gap:.8rem;flex-wrap: wrap;align-items:flex-end;margin-bottom:1rem;">
      <div><label for="filterMonth">Mes:</label><input type="month" id="filterMonth"></div>
      <div><label for="filterSeller">Vendedor:</label><select id="filterSeller"><option value="">Todos</option><option value="paola">Paola</option><option value="ernesto">Ernesto</option></select></div>
      <div><label for="filterDateFrom">Desde:</label><input type="date" id="filterDateFrom"></div>
      <div><label for="filterDateTo">Hasta:</label><input type="date" id="filterDateTo"></div>
      <button class="stamp" onclick="App.applySalesFilters()">Filtrar</button><button class="stamp" onclick="App.clearSalesFilters()">Limpiar</button>
    </div>
    <div id="salesHistoryContent" style="max-height: 60vh; overflow-y: auto;"></div>
  </div></div>

  <script>
    /***************  CONSTANTES  ****************/
    const CONST = {
      PASSWORD_EDIT: 'admin123',
      PASSWORD_DELETE: 'admin123',
      STOCK_MIN_ALERT: 0,
      FILTER_DEBOUNCE: 300,
      CURRENCY_LOCALE: 'es-ES',
      BACKUP_EVERY_MS: 60000, // 1 min (AHORA DESACTIVADO)
      VIRTUAL_ROW_HEIGHT: 34,
      VIRTUAL_VIEWPORT_ROWS: 20,
    };

    /***************  MODULO APP  ****************/
    const App = (() => {
      let inventory = [], currentSoldIndex = -1, currentPriceIndex = -1, currentView = localStorage.getItem('preferredView') || 'table';
      let soldInventory = [], html5QrCode, usbReaderReady = false, usbBuffer = '', usbTimer = null;
      let cashItems = [], cashViewMode = 'grid';
      let auditLog = JSON.parse(localStorage.getItem('auditLog') || '[]');

      /* ---------- UTILS ---------- */
      const el = id => document.getElementById(id);
      const beepOK = () => { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); osc.connect(ctx.destination); osc.frequency.value = 880; osc.start(); osc.stop(ctx.currentTime + 0.08); };
      const beepError = () => { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); osc.connect(ctx.destination); osc.frequency.value = 400; osc.start(); osc.stop(ctx.currentTime + 0.25); };
      const hash = str => { let h = 0; for (let i = 0; i < str.length; i++) { h = Math.imul(31, h) + str.charCodeAt(i) | 0; } return '' + h; };
      const saveJSON = (key, data) => {
        if (!Array.isArray(data)) throw new Error('No es array');
        data.forEach((it, i) => {
          if (typeof it.name !== 'string' || typeof it.barcode !== 'string' || typeof it.price !== 'number' || typeof it.quantity !== 'number') throw new Error(`√çtem ${i} inv√°lido`);
        });
        localStorage.setItem(key, JSON.stringify(data));
        localStorage.setItem(key + '_ts', Date.now());
      };
      const backup = () => {
        const blob = new Blob([JSON.stringify({ inventory, soldInventory, auditLog, version: 1 })], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement('a'), { href: url, download: 'backup_' + new Date().toISOString().slice(0, 10) + '.json' });
        a.click(); URL.revokeObjectURL(url);
      };
      const audit = (action, before, after) => {
        auditLog.push({ action, before, after, user: 'admin', date: new Date().toISOString() });
        localStorage.setItem('auditLog', JSON.stringify(auditLog));
      };

      /* ---------- INICIO ---------- */
      const init = () => {
        try {
          inventory = JSON.parse(localStorage.getItem('inventory') || '[]').map(ensureDateTime);
          soldInventory = JSON.parse(localStorage.getItem('soldInventory') || '[]');
        } catch (e) { alert('Datos corruptos, se inicializan vac√≠os'); inventory = []; soldInventory = []; }
        updateDash();
        attachEvents();
        filterInventory();
        // setInterval(backup, CONST.BACKUP_EVERY_MS);  // <-- DESACTIVADO
      };
      const ensureDateTime = item => { if (!item.date) item.date = new Date().toISOString(); return item; };
      const updateDash = () => {
        const low = inventory.filter(p => p.quantity <= (p.stockMin || CONST.STOCK_MIN_ALERT)).length;
        el('dashLow').textContent = low;
        el('lowStockBox').style.display = low > 0 ? 'inline-block' : 'none';
      };

      /* ---------- VIRTUAL TABLE ---------- */
      let virtualRows = [], virtualScrollTop = 0, virtualStart = 0, virtualEnd = 0;
      const renderVirtual = filtered => {
        const tbody = el('inventoryList');
        if (!filtered.length) { tbody.innerHTML = ''; el('noResultsMessage').style.display = 'block'; return; }
        el('noResultsMessage').style.display = 'none';
        virtualRows = filtered;
        const totalHeight = virtualRows.length * CONST.VIRTUAL_ROW_HEIGHT;
        tbody.style.height = totalHeight + 'px';
        tbody.innerHTML = '';
        const frag = document.createDocumentFragment();
        const visible = CONST.VIRTUAL_VIEWPORT_ROWS;
        for (let i = 0; i < visible; i++) {
          const tr = document.importNode(el('rowTemplate').content, true).querySelector('tr');
          tr.style.top = (i * CONST.VIRTUAL_ROW_HEIGHT) + 'px';
          frag.appendChild(tr);
        }
        tbody.appendChild(frag);
        tbody.onscroll = e => {
          virtualScrollTop = e.target.scrollTop;
          paintVirtual();
        };
        paintVirtual();
      };
      const paintVirtual = () => {
        const start = Math.floor(virtualScrollTop / CONST.VIRTUAL_ROW_HEIGHT);
        const end = Math.min(start + CONST.VIRTUAL_VIEWPORT_ROWS, virtualRows.length);
        const rows = el('inventoryList').querySelectorAll('tr');
        for (let i = 0; i < rows.length; i++) {
          const idx = start + i;
          const tr = rows[i];
          if (idx >= virtualRows.length) { tr.style.display = 'none'; continue; }
          tr.style.display = '';
          const item = virtualRows[idx];
          const priceWithDiscount = (item.price * (1 - item.discount / 100)).toFixed(0);
          tr.querySelector('.idx').textContent = idx + 1;
          tr.querySelector('.name').innerHTML = App.highlightText(item.name, el('searchName').value);
          tr.querySelector('.barcode').textContent = item.barcode;
          tr.querySelector('.price').textContent = '$' + item.price;
          tr.querySelector('.discount').textContent = item.discount + '%';
          tr.querySelector('.final').textContent = '$' + priceWithDiscount;
          tr.querySelector('.date').textContent = new Date(item.date).toLocaleString(CONST.CURRENCY_LOCALE);
          tr.querySelector('.category').textContent = item.category;
          tr.querySelector('.stock').textContent = item.quantity;
          const actions = tr.querySelector('.actions');
          actions.innerHTML = `<button class="stamp" onclick="App.markSold(${inventory.indexOf(item)})">Vender</button>
                               <button class="btn-edit" onclick="App.openPriceModal(${inventory.indexOf(item)})" title="Editar precio">‚úèÔ∏è</button>
                               <button class="btn-edit" onclick="App.showProductHistory('${item.code}')" title="Historial">üìà</button>`;
          const imgCell = tr.querySelector('.img');
          const img = document.createElement('img');
          img.style.maxHeight = '48px';
          img.src = '';
          localforage.getItem(`img_${item.code}`).then(blob => { if (blob) img.src = URL.createObjectURL(blob); });
          imgCell.innerHTML = '';
          imgCell.appendChild(img);
          const bcImg = tr.querySelector('.barcodeimg');
          const bc = document.createElement('img');
          bc.style.maxHeight = '48px';
          localforage.getItem(`barcodeimg_${item.barcode}`).then(blob => {
            if (blob) bc.src = URL.createObjectURL(blob);
            else {
              const canvas = document.createElement('canvas');
              JsBarcode(canvas, item.barcode, { format: 'CODE128', width: 2, height: 60, displayValue: false });
              canvas.toBlob(barcodeBlob => {
                if (barcodeBlob) {
                  localforage.setItem(`barcodeimg_${item.barcode}`, barcodeBlob);
                  bc.src = URL.createObjectURL(barcodeBlob);
                }
              });
            }
          });
          bcImg.innerHTML = '';
          bcImg.appendChild(bc);
        }
      };

      /* ---------- FILTROS ---------- */
      let filterT;
      const attachEvents = () => {
        ['searchName', 'searchCategory', 'searchCode', 'minPrice', 'maxPrice', 'lowStockOnly'].forEach(id => {
          const elm = el(id);
          elm.addEventListener('input', () => { clearTimeout(filterT); filterT = setTimeout(filterInventory, CONST.FILTER_DEBOUNCE); });
          if (id === 'searchCategory') elm.addEventListener('change', filterInventory);
        });
        el('searchCode').addEventListener('keydown', e => { if (e.ctrlKey && e.key === 'b') { e.preventDefault(); el('searchCode').focus(); } });
        document.addEventListener('keydown', e => {
          if (e.ctrlKey && e.key === 'd') { e.preventDefault(); App.openSalesHistoryModal(); }
          if (e.key === 'F1') { if (el('cashRegisterFullscreen')) App.closeCashRegister(); }
          if (e.key === 'F12') { if (el('cashRegisterFullscreen')) App.confirmCashSaleFull(); }
        });
      };
      const filterInventory = () => {
        const name = el('searchName').value.trim().toLowerCase();
        const category = el('searchCategory').value;
        const code = el('searchCode').value.trim().toLowerCase();
        const minPrice = parseFloat(el('minPrice').value) || 0;
        const maxPrice = parseFloat(el('maxPrice').value) || Infinity;
        const lowStock = el('lowStockOnly').checked;
        let filtered = inventory.filter(it => {
          const okName = !name || it.name.toLowerCase().includes(name);
          const okCat = !category || it.category === category;
          const okCode = !code || it.barcode.toLowerCase().includes(code);
          const price = it.price * (1 - it.discount / 100);
          const okPrice = price >= minPrice && price <= maxPrice;
          const okStock = !lowStock || it.quantity <= (it.stockMin || CONST.STOCK_MIN_ALERT);
          return okName && okCat && okCode && okPrice && okStock;
        });
        if (currentView === 'table') renderVirtual(filtered);
        else renderCards(filtered);
        el('resultMessage').style.display = 'none';
      };
      const renderCards = filtered => {
        const box = el('cardsView');
        if (!filtered.length) { box.innerHTML = ''; el('noResultsMessage').style.display = 'block'; return; }
        el('noResultsMessage').style.display = 'none';
        box.innerHTML = filtered.map((item, idx) => {
          const priceWithDiscount = (item.price * (1 - item.discount / 100)).toFixed(0);
          return `<div class="card" data-real-index="${inventory.indexOf(item)}">
            <img onclick="App.openImageModal(this.src)" />
            <div><strong>${App.highlightText(item.name, el('searchName').value)}</strong></div>
            <div>Barras: ${item.barcode}</div>
            <div><img style="height:60px;cursor:pointer" onclick="App.openImageModal(this.src)" /></div>
            <div>Precio: $${priceWithDiscount} <small>(${item.discount}% dto)</small></div>
            <div>Stock: <strong>${item.quantity}</strong></div>
            <div>Cat: ${item.category}</div>
            <div>Fecha: ${new Date(item.date).toLocaleString(CONST.CURRENCY_LOCALE)}</div>
            <div class="card-footer">
              <button class="stamp" onclick="App.markSold(${inventory.indexOf(item)})">Vender</button>
              <button class="btn-edit" onclick="App.openPriceModal(${inventory.indexOf(item)})" title="Editar precio">‚úèÔ∏è</button>
              <button class="btn-edit" onclick="App.showProductHistory('${item.code}')" title="Historial">üìà</button>
            </div>
          </div>`;
        }).join('');
        filtered.forEach((item, idx) => {
          localforage.getItem(`img_${item.code}`).then(blob => {
            if (blob) {
              const url = URL.createObjectURL(blob);
              const imgCard = box.children[idx].querySelector('img');
              if (imgCard) imgCard.src = url;
            }
          });
          localforage.getItem(`barcodeimg_${item.barcode}`).then(blob => {
            if (blob) {
              const url = URL.createObjectURL(blob);
              const bcImg = box.children[idx].querySelectorAll('img')[1];
              if (bcImg) bcImg.src = url;
            }
          });
        });
        updateDash();
      };
      const clearAllFilters = () => {
        ['searchName', 'searchCategory', 'searchCode', 'minPrice', 'maxPrice', 'lowStockOnly', 'goToRow'].forEach(id => {
          const e = el(id);
          if (e.type === 'checkbox') e.checked = false; else e.value = '';
        });
        filterInventory();
      };
      const applyFilters = filterInventory;

      /* ---------- VENTA AT√ìMICA ---------- */
      const markSold = index => {
        currentSoldIndex = index;
        const item = inventory[index];
        el('originalPriceLabel').textContent = `Precio establecido: $${item.price}`;
        el('soldPrice').value = item.price;
        el('soldQuantity').value = 1;
        el('soldModal').style.display = 'block';
      };
      const closeSoldModal = () => {
        el('soldModal').style.display = 'none';
        el('confirmationMessage').style.display = 'none';
      };
      const processSale = () => {
        const soldQty = parseInt(el('soldQuantity').value);
        const soldPrice = parseFloat(el('soldPrice').value);
        const item = inventory[currentSoldIndex];
        if (isNaN(soldQty) || soldQty <= 0) return alert('Cantidad inv√°lida');
        if (soldQty > item.quantity) return alert('Stock insuficiente');
        // Transacci√≥n at√≥mica
        const invClone = JSON.parse(JSON.stringify(inventory));
        const soldClone = JSON.parse(JSON.stringify(soldInventory));
        try {
          invClone[currentSoldIndex].quantity -= soldQty;
          const soldItem = { name: item.name, code: item.code, price: soldPrice, quantity: soldQty, total: soldPrice * soldQty, seller: 'Sistema', date: new Date().toISOString() };
          soldClone.push(soldItem);
          saveJSON('inventory', invClone);
          saveJSON('soldInventory', soldClone);
          inventory = invClone;
          soldInventory = soldClone;
          audit('VENTA', item, soldItem);
          filterInventory();
          closeSoldModal();
          el('resultMessage').textContent = '¬°Venta registrada!';
          el('resultMessage').style.display = 'block';
          setTimeout(() => el('resultMessage').style.display = 'none', 3000);
          beepOK();
        } catch (e) { alert('Error al guardar: ' + e.message); }
      };

      /* ---------- EDICI√ìN CON CLAVE ---------- */
      const openPriceModal = index => {
        const pwd = prompt('Ingrese la contrase√±a para editar precios:');
        if (hash(pwd) !== hash(CONST.PASSWORD_EDIT)) return alert('Contrase√±a incorrecta');
        currentPriceIndex = index;
        const item = inventory[index];
        el('newPrice').value = item.price;
        el('priceModal').style.display = 'block';
      };
      const closePriceModal = () => el('priceModal').style.display = 'none';
      const saveNewPrice = () => {
        const newPrice = parseFloat(el('newPrice').value);
        if (isNaN(newPrice) || newPrice < 0) return alert('Precio inv√°lido');
        const before = inventory[currentPriceIndex].price;
        inventory[currentPriceIndex].price = newPrice;
        try { saveJSON('inventory', inventory); } catch (e) { return alert(e.message); }
        audit('EDIT_PRECIO', { code: inventory[currentPriceIndex].code, before }, { after: newPrice });
        closePriceModal();
        filterInventory();
        el('resultMessage').textContent = 'Precio actualizado';
        el('resultMessage').style.display = 'block';
        setTimeout(() => el('resultMessage').style.display = 'none', 2000);
      };

      /* ---------- HISTORIAL POR PRODUCTO ---------- */
      const showProductHistory = code => {
        const sales = soldInventory.filter(s => s.code === code);
        if (!sales.length) return alert('Sin ventas para este producto');
        const total = sales.reduce((a, s) => a + s.total, 0);
        const msg = sales.map((s, i) => `${i + 1}. ${new Date(s.date).toLocaleDateString(CONST.CURRENCY_LOCALE)} ‚Äì ${s.quantity} u √ó $${s.price} = $${s.total}`).join('\n') + `\n\nTotal vendido: $${total}`;
        alert(msg);
      };

      /* ---------- CAMARA / USB ---------- */
      const startCameraScan = () => {
        if (html5QrCode && html5QrCode.getState() === 2) return;
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 5, qrbox: 300 }, barcode => {
          const found = inventory.some(p => p.barcode.trim() === barcode.trim());
          if (!found) { beepError(); return; }
          beepOK();
          el('searchCode').value = barcode;
          filterInventory();
        }, () => {}, { formatsToSupport: [Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.CODE_39, Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.EAN_8, Html5QrcodeSupportedFormats.UPC_A, Html5QrcodeSupportedFormats.UPC_E], useBarCodeDetectorIfSupported: true, showTorchButtonIfSupported: true }).catch(err => console.log(err));
        el('reader').style.display = 'block';
        el('cancelScanBtn').style.display = 'inline-block';
      };
      const cancelScan = () => {
        if (html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear()).catch(() => {});
        el('reader').style.display = 'none';
        el('cancelScanBtn').style.display = 'none';
      };
      const initUSBReader = () => {
        if (usbReaderReady) {
          window.removeEventListener('keydown', handleUSBreader);
          usbReaderReady = false;
          el('usbBtn').style.background = 'var(--accent)';
          el('usbBtn').textContent = 'üîå Lector USB';
          return;
        }
        window.addEventListener('keydown', handleUSBreader);
        usbReaderReady = true;
        el('usbBtn').style.background = 'var(--danger)';
        el('usbBtn').textContent = '‚úÖ USB Activo';
        el('searchCode').focus();
      };
      const handleUSBreader = e => {
        if (e.key === 'Enter') {
          if (usbBuffer.trim()) {
            const found = inventory.some(p => p.barcode.trim() === usbBuffer.trim());
            if (!found) { beepError(); usbBuffer = ''; return; }
            beepOK();
            el('searchCode').value = usbBuffer.trim();
            filterInventory();
          }
          usbBuffer = '';
          clearTimeout(usbTimer);
          return;
        }
        if (/^[a-zA-Z0-9]$/.test(e.key)) {
          usbBuffer += e.key;
          clearTimeout(usbTimer);
          usbTimer = setTimeout(() => usbBuffer = '', 150);
        }
      };

      /* ---------- PDF ETIQUETAS ---------- */
      const downloadLabelsPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        const w = 45, h = 21, margLeft = 12, margTop = 10, dx = w + 3, dy = h + 3;
        const list = inventory.filter(p => p.quantity > 0);
        let col = 0, fil = 0;
        list.forEach((p, i) => {
          if (i > 0 && i % 40 === 0) { doc.addPage(); col = 0; fil = 0; }
          const x = margLeft + col * dx, y = margTop + fil * dy;
          doc.setFontSize(8);
          doc.text(p.name.slice(0, 16), x + w / 2, y + 3, { align: 'center' });
          doc.text(`$${(p.price * (1 - p.discount / 100)).toFixed(0)}`, x + w / 2, y + 6, { align: 'center' });
          const canvas = document.createElement('canvas');
          const scale = 300 / 25.4;
          canvas.width = w * scale;
          canvas.height = h * scale * 0.45;
          JsBarcode(canvas, p.barcode, { format: 'CODE128', width: 1.3, height: h * scale * 0.45, fontSize: 0 });
          const imgData = canvas.toDataURL('image/png');
          doc.addImage(imgData, 'PNG', x, y + 7, w, h * 0.45);
          col++;
          if (col === 4) { col = 0; fil++; }
        });
        doc.save('etiquetas.pdf');
      };

      /* ---------- CAMBIO VISTA ---------- */
      const toggleView = () => {
        const btn = el('toggleViewBtn'), table = el('tableView'), cards = el('cardsView');
        if (currentView === 'table') {
          currentView = 'cards';
          table.style.display = 'none';
          cards.style.display = 'flex';
          btn.textContent = 'Ver Tabla';
        } else {
          currentView = 'table';
          table.style.display = 'block';
          cards.style.display = 'none';
          btn.textContent = 'Ver Tarjetas';
        }
        localStorage.setItem('preferredView', currentView);
        filterInventory();
      };

      /* ---------- SALES PANEL ---------- */
      const toggleSalesPanel = () => {
        const panel = el('salesPanel'), normalBlock = el('normalSearchBlock'), tableView = el('tableView'), cardsView = el('cardsView'), toggleBtn = el('toggleViewBtn');
        if (panel.style.display === 'flex') {
          panel.style.display = 'none';
          normalBlock.style.display = 'flex';
          tableView.style.display = currentView === 'table' ? 'block' : 'none';
          cardsView.style.display = currentView === 'cards' ? 'flex' : 'none';
          toggleBtn.style.display = 'inline-block';
        } else {
          panel.style.display = 'flex';
          normalBlock.style.display = 'none';
          tableView.style.display = 'none';
          cardsView.style.display = 'none';
          toggleBtn.style.display = 'none';
          loadSalesHistory();
        }
      };
      const loadSalesHistory = () => {
        const sales = JSON.parse(localStorage.getItem('soldInventory') || '[]');
        renderSalesTable(sales);
      };
      const filterSales = () => {
        const name = el('salesSearchName').value.trim().toLowerCase();
        const sales = JSON.parse(localStorage.getItem('soldInventory') || '[]');
        const filtered = name ? sales.filter(s => s.name.toLowerCase().includes(name)) : sales;
        renderSalesTable(filtered);
      };
      const clearSalesFilter = () => {
        el('salesSearchName').value = '';
        loadSalesHistory();
      };
      const renderSalesTable = sales => {
        const tbody = el('salesList');
        if (!sales.length) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Sin ventas registradas</td></tr>';
          return;
        }
        tbody.innerHTML = sales.map((s, i) => `<tr>
          <td>${i + 1}</td><td>${s.name}</td><td>${s.code}</td><td>${s.quantity}</td>
          <td>$${s.price}</td><td>$${s.total}</td>
        </tr>`).join('');
      };
      const exportSalesCSV = () => {
        const sales = JSON.parse(localStorage.getItem('soldInventory') || '[]');
        if (!sales.length) return alert('No hay ventas para exportar');
        const headers = ['Nombre', 'C√≥digo', 'Cantidad', 'Precio Unitario', 'Total'];
        const rows = sales.map(s => [s.name, s.code, s.quantity, s.price, s.total]);
        let csv = '\ufeff' + headers.join(',') + '\n';
        rows.forEach(r => csv += r.join(',') + '\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement('a'), { href: url, download: 'ventas.csv' });
        a.click(); URL.revokeObjectURL(url);
      };

      /* ---------- SALES HISTORY MODAL ---------- */
      const openSalesHistoryModal = () => {
        el('salesHistoryModal').style.display = 'block';
        renderSalesHistory();
      };
      const closeSalesHistoryModal = () => el('salesHistoryModal').style.display = 'none';
      const setQuickFilter = days => {
        const hoy = new Date();
        const desde = new Date(hoy);
        desde.setDate(hoy.getDate() - days);
        el('filterDateFrom').value = desde.toLocaleDateString('sv-SE');
        el('filterDateTo').value = hoy.toLocaleDateString('sv-SE');
        applySalesFilters();
      };
      const downloadSalesDetailPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const sales = JSON.parse(localStorage.getItem('soldInventory') || '[]');
        let y = 20;
        doc.setFontSize(14);
        doc.text('Detalle de ventas', 14, y);
        y += 10;
        sales.slice(-30).reverse().forEach(s => {
          doc.setFontSize(10);
          doc.text(`${s.name}  (${s.quantity})  $${s.total}`, 14, y);
          y += 6;
        });
        doc.save('ventas-detalle.pdf');
      };
      const renderSalesHistory = (filtered = null) => {
        const sales = filtered || JSON.parse(localStorage.getItem('soldInventory') || '[]');
        const container = el('salesHistoryContent');
        if (!sales.length) {
          container.innerHTML = '<p style="text-align:center;">No hay ventas registradas.</p>';
          return;
        }
        container.innerHTML = sales.map((s, i) => {
          const img = localStorage.getItem(`img_${s.code}`);
          return `<div style="display:flex;gap:1rem;border:1px solid #ccc;border-radius:8px;padding:.8rem;margin-bottom:.8rem;align-items:center;">
            <img src="${img || ''}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;" onerror="this.style.display='none'">
            <div style="flex:1;"><strong>#${i + 1} ‚Äì ${s.name}</strong><br>C√≥digo: ${s.code}<br>Cantidad: ${s.quantity} | Precio: $${s.price} | Total: $${s.total}<br><small>Fecha: ${new Date(s.date).toLocaleString(CONST.CURRENCY_LOCALE)} | Vendedor: ${s.seller || 'Desconocido'}</small>
              <button onclick="App.deleteSale(${i})" style="margin-left:.4rem;background:var(--danger);border:none;color:#fff;padding:.1rem .3rem;border-radius:3px;font-size:.7rem;">üóëÔ∏è</button>
            </div>
          </div>`;
        }).join('');
      };
      const applySalesFilters = () => {
        const month = el('filterMonth').value;
        const seller = el('filterSeller').value;
        const from = el('filterDateFrom').value;
        const to = el('filterDateTo').value;
        let sales = JSON.parse(localStorage.getItem('soldInventory') || '[]');
        if (month) {
          const [y, m] = month.split('-');
          sales = sales.filter(s => {
            const d = new Date(s.date);
            return d.getFullYear() == y && String(d.getMonth() + 1).padStart(2, '0') === m;
          });
        }
        if (seller) sales = sales.filter(s => (s.seller || '').toLowerCase() === seller);
        if (from) {
          const fromDate = new Date(from + 'T00:00:00');
          sales = sales.filter(s => new Date(s.date) >= fromDate);
        }
        if (to) {
          const toDate = new Date(to + 'T23:59:59.999');
          sales = sales.filter(s => new Date(s.date) <= toDate);
        }
        renderSalesHistory(sales);
      };
      const clearSalesFilters = () => {
        el('filterMonth').value = '';
        el('filterSeller').value = '';
        el('filterDateFrom').value = '';
        el('filterDateTo').value = '';
        renderSalesHistory();
      };
      const deleteSale = index => {
        const pwd = prompt('Contrase√±a para anular venta:');
        if (hash(pwd) !== hash(CONST.PASSWORD_DELETE)) return;
        const sales = JSON.parse(localStorage.getItem('soldInventory') || '[]');
        const sale = sales[index];
        const inv = JSON.parse(localStorage.getItem('inventory') || '[]');
        const item = inv.find(p => p.code === sale.code);
        if (item) item.quantity += sale.quantity;
        try { saveJSON('inventory', inv); } catch (e) { return alert(e.message); }
        sales.splice(index, 1);
        localStorage.setItem('soldInventory', JSON.stringify(sales));
        audit('ANULA_VENTA', sale, {});
        applySalesFilters();
        filterInventory();
      };

      /* ---------- IMAGEN MODAL ---------- */
      const openImageModal = src => {
        const overlay = document.createElement('div');
        overlay.className = 'full-image-overlay';
        const img = document.createElement('img');
        img.src = src;
        overlay.appendChild(img);
        document.body.appendChild(overlay);
        overlay.addEventListener('click', () => document.body.removeChild(overlay));
      };

      /* ---------- MENU LATERAL ---------- */
      const toggleMenu = () => el('sideMenu').classList.toggle('show');

      /* ---------- KIOSCO ---------- */
      const toggleKiosco = () => {
        const body = document.body, btn = el('kioscoBtn');
        if (!document.fullscreenElement) {
          body.requestFullscreen().then(() => {
            body.classList.add('kiosco');
            btn.textContent = 'üî≤ Salir Kiosco';
          }).catch(err => alert('No se pudo activar pantalla completa: ' + err.message));
        } else {
          document.exitFullscreen().then(() => {
            body.classList.remove('kiosco');
            btn.textContent = 'üñ•Ô∏è Kiosco';
          });
        }
      };

      /* ---------- CAJA REGISTRADORA ---------- */
      const cashBeep = () => {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        osc.frequency.value = 1200;
        osc.connect(ctx.destination);
        osc.start(); osc.stop(ctx.currentTime + 0.05);
      };
      const buildCashRegisterUI = () => {
        const prev = el('cashRegisterFullscreen');
        if (prev) prev.remove();
        inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        const div = document.createElement('div');
        div.id = 'cashRegisterFullscreen';
        div.innerHTML = `<div class="header">
          <h2>üßæ Caja Registradora</h2>
          <div style="display:flex;gap:.5rem;">
            <button class="stamp" onclick="App.toggleCashView()" id="cashToggleViewBtn">Ver Lista</button>
            <button class="stamp" onclick="App.closeCashRegister()" style="background:var(--danger);border-color:var(--danger);">‚ùå Cerrar</button>
          </div>
        </div>
        <div class="filters">
          <input type="text" id="cashSearchLive" placeholder="üîç Buscar nombre o c√≥digo" />
          <select id="cashCatFilter"><option value="">Todas las categor√≠as</option></select>
          <button class="stamp" onclick="App.clearCashFilters()">Limpiar</button>
        </div>
        <div id="cashProductsContainer" style="flex:1 1 auto;overflow-y:auto;"></div>
        <div class="footer" style="border-top:2px solid var(--border);padding-top:.6rem;">
          <div class="total">Total: $<span id="cashTotal">0</span></div>
          <label>Descuento adicional (%):</label><input type="number" id="cashExtraDiscount" min="0" max="100" value="0" step="1">
          <label>Paga con:</label><input type="number" id="cashPayment" min="0" step="0.01" placeholder="0.00">
          <button class="stamp" onclick="App.calcCashChangeFull()">Calcular vuelto</button>
          <button class="stamp" id="cashConfirmBtn" style="display:none;background:#10b981;border-color:#10b981;" onclick="App.confirmCashSaleFull()">‚úÖ Confirmar venta (F12)</button>
          <button class="stamp" onclick="App.cancelCashSale()" style="background:var(--danger);border-color:var(--danger);">Cancelar venta</button>
          <div id="cashChangeBig" class="big-change" style="display:none;"></div>
        </div>`;
        const catSet = [...new Set(inventory.map(p => p.category))].sort();
        const catSelect = div.querySelector('#cashCatFilter');
        catSet.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          catSelect.appendChild(opt);
        });
        const container = div.querySelector('#cashProductsContainer');
        renderCashProducts(container);
        document.body.appendChild(div);
        const fl = document.createElement('div');
        fl.id = 'cashFloatList';
        fl.innerHTML = `<h4>Lista de venta</h4><ul></ul>
          <button class="stamp" onclick="App.cancelCashSale()" style="background:var(--danger);border-color:var(--danger);width:100%;">Cancelar venta</button>`;
        document.body.appendChild(fl);
        div.querySelector('#cashSearchLive').addEventListener('input', applyCashLiveFilter);
        div.querySelector('#cashCatFilter').addEventListener('change', applyCashLiveFilter);
        updateCashList();
      };
      const renderCashProducts = container => {
        container.innerHTML = '';
        const sorted = [...inventory].sort((a, b) => {
          if (a.quantity === 0 && b.quantity > 0) return 1;
          if (a.quantity > 0 && b.quantity === 0) return -1;
          return a.name.localeCompare(b.name);
        });
        if (cashViewMode === 'grid') {
          const grid = document.createElement('div');
          grid.id = 'cashProductsGrid';
          grid.className = 'products-grid';
          sorted.forEach((it, idx) => {
            const realIdx = inventory.indexOf(it);
            const card = document.createElement('div');
            card.className = 'prod-card';
            card.dataset.search = (it.name + ' ' + it.barcode).toLowerCase();
            card.dataset.category = it.category;
            card.innerHTML = `<img id="cashimg-${realIdx}" />
              <div><strong>${it.name}</strong></div>
              <div>C√≥d: ${it.barcode}</div>
              <div>Cat: ${it.category}</div>
              <div>$${it.price}</div>
              <div class="${it.quantity <= (it.stockMin || CONST.STOCK_MIN_ALERT) ? 'stock-low' : ''}">Stock: ${it.quantity}</div>
              <div style="display:flex;justify-content:center;margin-top:.3rem;">
                <button class="stamp" onclick="App.quickAdd('cashqty-${realIdx}',1)" style="padding:.2rem .4rem;font-size:.7rem;">+1</button>
              </div>
              <input type="number" id="cashqty-${realIdx}" min="0" max="${it.quantity}" value="0" style="width:70px;margin-top:.4rem;" oninput="App.handleManualInput(this, ${it.quantity})">`;
            const img = card.querySelector(`#cashimg-${realIdx}`);
            localforage.getItem(`img_${it.code}`).then(blob => { if (blob) img.src = URL.createObjectURL(blob); });
            img.onclick = () => openImageModal(img.src);
            grid.appendChild(card);
          });
          container.appendChild(grid);
        } else {
          const tbl = document.createElement('table');
          tbl.innerHTML = `<thead><tr>
            <th>#</th><th>Imagen</th><th>Nombre</th><th>C√≥digo</th><th>Cat</th>
            <th>Precio</th><th>Stock</th><th>+1</th><th>Cant</th>
          </tr></thead><tbody></tbody></table>`;
          const tbody = tbl.querySelector('tbody');
          sorted.forEach((it, idx) => {
            const realIdx = inventory.indexOf(it);
            const tr = document.createElement('tr');
            tr.dataset.search = (it.name + ' ' + it.barcode).toLowerCase();
            tr.dataset.category = it.category;
            tr.innerHTML = `<td>${idx + 1}</td>
              <td><img id="cashimg-${realIdx}" style="max-height:40px;border-radius:4px;" /></td>
              <td>${it.name}</td><td>${it.barcode}</td><td>${it.category}</td>
              <td>$${it.price}</td>
              <td class="${it.quantity <= (it.stockMin || CONST.STOCK_MIN_ALERT) ? 'stock-low' : ''}">${it.quantity}</td>
              <td><button class="stamp" onclick="App.quickAdd('cashqty-${realIdx}',1)" style="padding:.2rem .4rem;font-size:.7rem;">+1</button></td>
              <td><input type="number" id="cashqty-${realIdx}" min="0" max="${it.quantity}" value="0" style="width:60px;" oninput="App.handleManualInput(this, ${it.quantity})"></td>`;
            const img = tr.querySelector(`#cashimg-${realIdx}`);
            localforage.getItem(`img_${it.code}`).then(blob => { if (blob) img.src = URL.createObjectURL(blob); });
            img.onclick = () => openImageModal(img.src);
            tbody.appendChild(tr);
          });
          container.appendChild(tbl);
        }
      };
      const handleManualInput = (input, maxStock) => {
        let val = parseInt(input.value) || 0;
        if (val > maxStock) { alert('Cantidad insuficiente en stock'); input.value = maxStock; }
        updateCashList();
      };
      const applyCashLiveFilter = () => {
        const kw = el('cashSearchLive').value.trim().toLowerCase();
        const cat = el('cashCatFilter').value;
        if (cashViewMode === 'grid') {
          document.querySelectorAll('#cashProductsGrid .prod-card').forEach(card => {
            const okSearch = !kw || card.dataset.search.includes(kw);
            const okCat = !cat || card.dataset.category === cat;
            card.style.display = (okSearch && okCat) ? 'flex' : 'none';
          });
        } else {
          document.querySelectorAll('#cashProductsContainer tbody tr').forEach(tr => {
            const okSearch = !kw || tr.dataset.search.includes(kw);
            const okCat = !cat || tr.dataset.category === cat;
            tr.style.display = (okSearch && okCat) ? '' : 'none';
          });
        }
      };
      const clearCashFilters = () => {
        el('cashSearchLive').value = '';
        el('cashCatFilter').value = '';
        applyCashLiveFilter();
      };
      const toggleCashView = () => {
        cashViewMode = cashViewMode === 'grid' ? 'list' : 'grid';
        el('cashToggleViewBtn').textContent = cashViewMode === 'grid' ? 'Ver Lista' : 'Ver Tarjetas';
        const container = document.querySelector('#cashProductsContainer');
        renderCashProducts(container);
        applyCashLiveFilter();
      };
      const updateCashList = () => {
        cashItems = [];
        inventory.forEach((it, realIdx) => {
          const input = el(`cashqty-${realIdx}`);
          if (!input) return;
          const qty = parseInt(input.value) || 0;
          if (qty > 0) cashItems.push({ realIdx, qty, name: it.name, price: it.price, rowId: `cashqty-${realIdx}` });
        });
        const ul = document.querySelector('#cashFloatList ul');
        ul.innerHTML = cashItems.map((x, i) => `<li>
          <span>${i + 1}. ${x.name} (x${x.qty})</span>
          <span>$${(x.qty * x.price).toFixed(2)} <button onclick="App.removeFromCash(${i})" style="margin-left:.4rem;background:var(--danger);border:none;color:#fff;padding:.1rem .3rem;border-radius:3px;font-size:.7rem;">‚úñ</button></span>
        </li>`).join('');
        const extraDisc = parseFloat(el('cashExtraDiscount').value) || 0;
        let total = cashItems.reduce((a, x) => a + x.qty * x.price, 0);
        if (extraDisc > 0) total = total * (1 - extraDisc / 100);
        el('cashTotal').textContent = total.toFixed(2);
        el('cashChangeBig').style.display = 'none';
        el('cashConfirmBtn').style.display = 'none';
        const fl = el('cashFloatList');
        fl.style.display = cashItems.length ? 'flex' : 'none';
      };
      const removeFromCash = index => {
        const x = cashItems[index];
        const input = el(x.rowId);
        if (input) input.value = 0;
        cashItems.splice(index, 1);
        updateCashList();
      };
      const cancelCashSale = () => {
        if (!confirm('¬øCancelar toda la venta?')) return;
        cashItems = [];
        inventory.forEach((it, realIdx) => {
          const input = el(`cashqty-${realIdx}`);
          if (input) input.value = 0;
        });
        updateCashList();
      };
      const calcCashChangeFull = () => {
        const total = parseFloat(el('cashTotal').textContent);
        const pay = parseFloat(el('cashPayment').value) || 0;
        if (pay < total) { alert('Pago insuficiente'); return; }
        const change = pay - total;
        const big = el('cashChangeBig');
        big.textContent = 'Vuelto: $' + change.toFixed(2);
        big.style.display = 'inline-block';
        el('cashConfirmBtn').style.display = 'inline-block';
      };
      const confirmCashSaleFull = () => {
        const invClone = JSON.parse(JSON.stringify(inventory));
        const soldClone = JSON.parse(JSON.stringify(soldInventory));
        const extraDisc = parseFloat(el('cashExtraDiscount').value) || 0;
        try {
          cashItems.forEach(x => {
            const item = invClone[x.realIdx];
            if (x.qty > item.quantity) throw new Error(`Stock insuficiente para ${item.name}`);
            item.quantity -= x.qty;
            const totalLine = x.qty * x.price * (1 - extraDisc / 100);
            soldClone.push({ name: x.name, code: item.code, price: x.price, quantity: x.qty, total: totalLine, seller: 'CajaRegistradora', date: new Date().toISOString() });
          });
          saveJSON('inventory', invClone);
          saveJSON('soldInventory', soldClone);
          inventory = invClone;
          soldInventory = soldClone;
          audit('VENTA_CAJA', {}, { items: cashItems.length, total: parseFloat(el('cashTotal').textContent) });
          beepOK();
          el('cashFloatList').style.display = 'none';
          alert('Venta realizada ‚úÖ');
          closeCashRegister();
          filterInventory();
        } catch (e) { alert('Error: ' + e.message); }
      };
      const openCashRegister = () => {
        document.documentElement.requestFullscreen().catch(() => {});
        buildCashRegisterUI();
      };
      const closeCashRegister = () => {
        if (document.fullscreenElement) document.exitFullscreen();
        const div = el('cashRegisterFullscreen');
        if (div) div.remove();
        const fl = el('cashFloatList');
        if (fl) fl.remove();
        cashItems = [];
      };

      /* ---------- PUBLIC API ---------- */
      return {
        init,
        toggleMenu,
        toggleKiosco,
        toggleView,
        toggleSalesPanel,
        applyFilters,
        clearAllFilters,
        filterInventory,
        goToRow: () => {
          const row = parseInt(el('goToRow').value);
          if (currentView === 'table') {
            if (row >= 1 && row <= virtualRows.length) {
              const y = (row - 1) * CONST.VIRTUAL_ROW_HEIGHT;
              el('inventoryList').scrollTop = y;
              paintVirtual();
              const tr = el('inventoryList').querySelector('tr');
              if (tr) tr.classList.add('highlight');
            } else alert('Fila fuera de rango.');
          } else {
            const cards = document.querySelectorAll('.card');
            cards.forEach(c => c.classList.remove('highlight'));
            if (row >= 1 && row <= cards.length) {
              const target = cards[row - 1];
              target.classList.add('highlight');
              target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else alert('Fila fuera de rango.');
          }
        },
        highlightText: (text, search) => {
          if (!search) return text;
          const regex = new RegExp(`(${search})`, 'gi');
          return text.replace(regex, '<mark>$1</mark>');
        },
        startCameraScan,
        cancelScan,
        initUSBReader,
        downloadLabelsPDF,
        backup,
        markSold,
        closeSoldModal,
        processSale,
        openPriceModal,
        closePriceModal,
        saveNewPrice,
        showProductHistory,
        openImageModal,
        openSalesHistoryModal,
        closeSalesHistoryModal,
        setQuickFilter,
        downloadSalesDetailPDF,
        applySalesFilters,
        clearSalesFilters,
        deleteSale,
        filterSales,
        clearSalesFilter,
        exportSalesCSV,
        openCashRegister,
        closeCashRegister,
        quickAdd: (rowId, qty) => {
          const input = el(rowId);
          if (!input) return;
          const max = parseInt(input.max);
          let val = parseInt(input.value) || 0;
          const newVal = val + qty;
          if (newVal > max) { alert('Cantidad insuficiente en stock'); return; }
          input.value = newVal;
          const tr = el(rowId).closest('tr') || el(rowId).closest('.prod-card');
          if (tr) tr.classList.add('flash');
          setTimeout(() => { if (tr) tr.classList.remove('flash'); }, 600);
          cashBeep();
          updateCashList();
        },
        handleManualInput,
        applyCashLiveFilter,
        clearCashFilters,
        toggleCashView,
        removeFromCash,
        cancelCashSale,
        calcCashChangeFull,
        confirmCashSaleFull,
        renderCashProducts,
        updateCashList,
        buildCashRegisterUI,
        cashBeep,
      };
    })();

    /* ---------- SINGLE ENTRYPOINT ---------- */
    document.addEventListener('DOMContentLoaded', () => {
      App.init();
      document.addEventListener('click', e => {
        const menu = el('sideMenu');
        const btn = el('menuToggleBtn');
        if (menu.classList.contains('show') && !menu.contains(e.target)
