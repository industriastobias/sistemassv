<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compra</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css  "/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js  "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js  "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js  "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js  "></script>
  <style>
    :root{
      --bg:#f5f7fa;
      --card:#ffffff;
      --text:#1f2937;
      --accent:#3b82f6;
      --accent-hover:#2563eb;
      --danger:#ef4444;
      --success:#10b981;
      --radius:16px;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --shadow-hover:0 8px 24px rgba(0,0,0,.12);
      --transition:.3s ease;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',system-ui,sans-serif}
    body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;padding:2rem 1rem}
    h1{font-size:2rem;font-weight:700;margin-bottom:2rem;letter-spacing:-.5px}
    .bubble{
      background:var(--card);
      border-radius:var(--radius);
      padding:2rem;
      box-shadow:var(--shadow);
      width:100%;
      max-width:1200px;
      margin-bottom:2rem;
      transition:transform var(--transition),box-shadow var(--transition);
    }
    .bubble:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover)}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.2rem}
    label{font-size:.9rem;font-weight:500;margin-bottom:.25rem;display:block}
    input,select,textarea{
      width:100%;
      padding:.75rem 1rem;
      border:1px solid #e5e7eb;
      border-radius:12px;
      background:#f9fafb;
      color:var(--text);
      transition:background .3s,border-color .3s;
    }
    input:focus,select:focus,textarea:focus{
      outline:none;
      background:#fff;
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(59,130,246,.2);
    }
    button{
      padding:.75rem 1.5rem;
      border:none;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      transition:transform .2s,box-shadow .2s;
    }
    button:hover{transform:translateY(-2px)}
    .btn-primary{background:var(--accent);color:#fff;box-shadow:0 4px 14px rgba(59,130,246,.4)}
    .btn-primary:hover{background:var(--accent-hover)}
    .btn-danger{background:var(--danger);color:#fff;box-shadow:0 4px 14px rgba(239,68,68,.4)}
    .btn-success{background:var(--success);color:#fff;box-shadow:0 4px 14px rgba(16,185,129,.4)}
    .actions{display:flex;gap:1rem;flex-wrap:wrap;margin-top:1.2rem}
    #imagePreview{max-height:200px;border-radius:12px;margin-top:.5rem;display:none;box-shadow:var(--shadow)}
    .table-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem;}
    .card-item{
      background:var(--card);
      border-radius:var(--radius);
      padding:1.5rem;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:.75rem;
      transition:transform var(--transition),box-shadow var(--transition);
    }
    .card-item:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover)}
    .card-item img{width:100%;height:160px;object-fit:cover;border-radius:12px}
    .card-item h3{font-size:1.1rem;color:var(--accent)}
    .card-item p{margin:0;font-size:.85rem;color:#6b7280}
    .card-item .actions{margin-top:auto;display:flex;gap:.5rem}
    .mini-lote{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:1rem;margin-top:1rem;max-height:320px;overflow-y:auto;}
    .mini-item{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:.75rem;text-align:center;font-size:.75rem;box-shadow:0 2px 6px rgba(0,0,0,.04);}
    .mini-item img{width:100%;height:90px;object-fit:cover;border-radius:8px;margin-bottom:.5rem}
    .mini-item input{width:100%;padding:.4rem;font-size:.7rem;margin-top:.2rem;border-radius:8px}
    .total-box{background:var(--card);padding:1.2rem 2rem;border-radius:var(--radius);box-shadow:var(--shadow);text-align:center;margin-top:2rem}
    .total-box h2{font-size:1rem;color:var(--accent);margin:0}
    .total-box p{font-size:2rem;font-weight:700;margin:0;color:var(--accent)}
    @media(max-width:1024px){.table-cards{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:768px){.table-cards{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:480px){.table-cards{grid-template-columns:1fr}}
  </style>
</head>
<body>

  <h1>Compra</h1>

  <div class="bubble" id="formularioBubble">
    <h2><i class="fa fa-edit"></i> rápida de producto</h2>
    <form id="purchaseForm" class="form-grid">
      <div><label>Nombre *</label><input type="text" id="name" name="name" required></div>
      <div><label>Código *</label><input type="text" id="code" name="code" required></div>
      <div><label>Código de Barras *</label><input type="text" id="barcode" name="barcode" required></div>
      <div><label>Precio *</label><input type="number" id="price" name="price" step="0.01" required></div>
      <div><label>Descuento (%)</label><input type="number" id="discount" name="discount" step="0.01" value="0"></div>
      <div><label>Cantidad en Stock *</label><input type="number" id="quantity" name="quantity" required></div>
      <div style="grid-column:1/-1"><label>Descripción *</label><textarea id="description" name="description" rows="2" required></textarea></div>
      <div><label>Categoría *</label>
        <select id="category" name="category" required>
          <option value="">-- Seleccione --</option>
          <option value="Aritos">Aritos</option>
          <option value="Billeteras">Billeteras</option>
          <option value="Carteras">Carteras</option>
          <option value="Chokers">Chokers</option>
          <option value="Collares">Collares</option>
          <option value="Lentes de sol">Lentes de sol</option>
          <option value="Pulseras">Pulseras</option>
          <option value="Relojes">Relojes</option>
          <option value="Anillos">Anillos</option>
          <option value="Accesorios para el cabello">Accesorios para el cabello</option>
          <option value="Otros">Otros</option>
        </select>
      </div>
      <div style="grid-column:1/-1">
        <label>Imagen del producto:</label>
        <input type="file" id="imageFile" accept="image/*" onchange="previewImage(event)">
        <div style="margin-top:.5rem"><img id="imagePreview" src="" alt="Vista previa"></div>
      </div>
      <div style="grid-column:1/-1" class="actions">
        <button type="submit" class="btn-primary">Guardar producto</button>
        <button type="button" class="btn-primary" onclick="exportToZip()">Exportar ZIP</button>
        <button type="button" class="btn-primary" onclick="exportToPDF()">Exportar PDF con Imágenes</button>
        <button type="button" class="btn-primary" onclick="resetAndOpenImport()">Importar ZIP</button>
        <input type="file" id="importFile" accept=".zip" style="display:none" onchange="importFromZip(event)">
        <button type="button" class="btn-danger" onclick="vaciarInventario()">Vaciar Inventario</button>
      </div>
    </form>
  </div>

  <div class="bubble">
    <h2><i class="fa fa-boxes"></i> Inventario actual</h2>
    <div class="table-cards" id="inventoryList"></div>
  </div>

  <div class="total-box">
    <h2>Total en USD</h2>
    <p id="totalAmount">$0.00</p>
  </div>

  <script>
  // GLOBAL
  let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
  let editIndex = -1;

  // RENDER + TOTAL
  function calculateTotal(){
    const total = inventory.reduce((sum,item)=>{
      const price = Number(item.price) || 0;
      const quantity = Number(item.quantity) || 0;
      const discount = Number(item.discount) || 0;
      const finalPrice = price * (1 - discount/100);
      return sum + finalPrice * quantity;
    },0);
    document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
  }

  function renderTable(){
    const list = document.getElementById('inventoryList');
    list.innerHTML = inventory.map((item,idx)=>`
      <div class="card-item">
        <img id="invImg${idx}" src="" alt="${escapeHtml(item.name)}"/>
        <h3>${escapeHtml(item.name)}</h3>
        <p>Código: ${escapeHtml(item.code)}</p>
        <p>Cód.Barras: ${escapeHtml(item.barcode)}</p>
        <p>Precio: $${Number(item.price).toFixed(2)}</p>
        <p>Stock: ${Number(item.quantity)}</p>
        <div class="actions">
          <button class="btn-primary" onclick="editProduct(${idx})"><i class="fa fa-edit"></i> Editar</button>
          <button class="btn-danger" onclick="deleteProduct(${idx})"><i class="fa fa-trash"></i> Eliminar</button>
        </div>
      </div>
    `).join('');
    // Cargar imágenes desde localforage
    inventory.forEach((p,i)=>{
      localforage.getItem(`img_${p.code}`).then(blob=>{
        if(blob && document.getElementById(`invImg${i}`)){
          document.getElementById(`invImg${i}`).src = URL.createObjectURL(blob);
        }
      }).catch(()=>{});
    });
  }

  function escapeHtml(text){
    return String(text||'').replace(/[&<>"'`]/g, s => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;'
    })[s]);
  }

  // PREVIEW + GUARDADO INDIVIDUAL
  function previewImage(evt){
    const file = evt.target.files[0];
    if(!file) return;
    new Compressor(file,{quality:0.6,maxWidth:800,maxHeight:800,
      success(result){
        const reader = new FileReader();
        reader.onload = e=>{
          document.getElementById('imagePreview').src = e.target.result;
          document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(result);
      },
      error(err){ console.error(err); }
    });
  }

  document.getElementById('purchaseForm').addEventListener('submit',function(e){
    e.preventDefault();
    const form = new FormData(e.target);
    const item = {
      name: form.get('name') || '',
      code: form.get('code') || '',
      barcode: form.get('barcode') || '',
      price: Number(form.get('price')) || 0,
      discount: Number(form.get('discount')) || 0,
      quantity: Number(form.get('quantity')) || 0,
      description: form.get('description') || '',
      category: form.get('category') || ''
    };
    if(editIndex === -1){
      // evitar duplicados de código
      const exists = inventory.find(i=>i.code === item.code);
      if(exists){
        if(!confirm('Código ya existe. ¿Sumar stock al existente? (Aceptar = sumar, Cancelar = crear igualmente)')){
          // crear igualmente con sufijo
          item.code = `${item.code}_${Date.now()}`;
        } else {
          exists.quantity = Number(exists.quantity) + Number(item.quantity);
          localStorage.setItem('inventory', JSON.stringify(inventory));
          renderTable(); calculateTotal();
          e.target.reset();
          document.getElementById('imagePreview').style.display = 'none';
          return;
        }
      }
      inventory.push(item);
    } else {
      inventory[editIndex] = item;
      editIndex = -1;
    }
    localStorage.setItem('inventory', JSON.stringify(inventory));

    // Guardar imagen después de tener el código definitivo
    const imgFile = document.getElementById('imageFile').files[0];
    if(imgFile){
      new Compressor(imgFile,{quality:0.6,maxWidth:800,maxHeight:800,
        success(result){
          localforage.setItem(`img_${item.code}`, result).catch(()=>{});
        }
      });
    }

    e.target.reset();
    document.getElementById('imagePreview').style.display = 'none';
    renderTable(); calculateTotal();
  });

  // VACIAR INVENTARIO
  function vaciarInventario(){
    if(!confirm('¿Vaciar todo el inventario?')) return;
    inventory.forEach(p => localforage.removeItem(`img_${p.code}`).catch(()=>{}));
    inventory = [];
    localStorage.setItem('inventory', JSON.stringify(inventory));
    renderTable(); calculateTotal();
  }

  // EXPORTAR ZIP (inventory.json + images/)
  async function exportToZip(){
    try{
      const zip = new JSZip();
      zip.file('inventory.json', JSON.stringify(inventory, null, 2));
      const imgFolder = zip.folder('images');
      for(const p of inventory){
        try{
          const blob = await localforage.getItem(`img_${p.code}`);
          if(blob) imgFolder.file(`${p.code}.jpg`, blob);
        }catch(e){ /* skip */ }
      }
      const blobZip = await zip.generateAsync({type:'blob'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blobZip);
      a.download = 'inventario.zip';
      a.click();
    }catch(e){
      alert('Error exportando ZIP: ' + (e.message || e));
    }
  }

  // IMPORTAR ZIP (fusiona correctamente)
  async function importFromZip(evt){
    const file = evt.target.files[0];
    if(!file){ return; }
    if(!file.name.toLowerCase().endsWith('.zip')){ alert('Selecciona un archivo .zip'); evt.target.value=''; return; }
    try{
      const arrayBuffer = await file.arrayBuffer();
      const zip = await JSZip.loadAsync(arrayBuffer);
      const jsonFile = zip.file('inventory.json');
      if(!jsonFile){ alert('El ZIP no contiene inventory.json'); evt.target.value=''; return; }
      const jsonText = await jsonFile.async('string');
      let imported = JSON.parse(jsonText);
      if(!Array.isArray(imported)) imported = [];

      // Merge: existing inventory is in variable 'inventory'
      // For each imported product: save image if exists, then merge by code (sum quantity)
      for(const p of imported){
        // ensure types
        p.price = Number(p.price) || 0;
        p.quantity = Number(p.quantity) || 0;
        p.discount = Number(p.discount) || 0;
        // save image if present
        const imgEntry = zip.file(`images/${p.code}.jpg`) || zip.file(`images/${p.code}.jpeg`);
        if(imgEntry){
          try{
            const blob = await imgEntry.async('blob');
            await localforage.setItem(`img_${p.code}`, blob);
          }catch(e){ console.warn('No se pudo guardar imagen para', p.code); }
        }
        const idx = inventory.findIndex(x => x.code === p.code);
        if(idx > -1){
          // sumar stock, y actualizar datos no vacíos
          inventory[idx].quantity = Number(inventory[idx].quantity || 0) + Number(p.quantity || 0);
          // actualizamos otros campos sólo si el import trae valor y el actual está vacío o es 0
          if(!inventory[idx].name && p.name) inventory[idx].name = p.name;
          if(!inventory[idx].barcode && p.barcode) inventory[idx].barcode = p.barcode;
          if((!inventory[idx].price || inventory[idx].price===0) && p.price) inventory[idx].price = p.price;
          if(!inventory[idx].description && p.description) inventory[idx].description = p.description;
          if(!inventory[idx].category && p.category) inventory[idx].category = p.category;
        } else {
          // nuevo producto: asegurarse de campos típicos
          const nuevo = {
            name: p.name || p.code,
            code: p.code,
            barcode: p.barcode || '',
            price: Number(p.price) || 0,
            discount: Number(p.discount) || 0,
            quantity: Number(p.quantity) || 0,
            description: p.description || '',
            category: p.category || ''
          };
          inventory.push(nuevo);
        }
      }
      // guardar y actualizar UI
      localStorage.setItem('inventory', JSON.stringify(inventory));
      renderTable(); calculateTotal();
      alert('Importación ZIP completada y fusionada correctamente ✅');
    }catch(e){
      console.error(e);
      alert('Error leyendo ZIP: ' + (e.message || e));
    } finally {
      evt.target.value = '';
    }
  }

  function resetAndOpenImport(){
    const inp = document.getElementById('importFile');
    inp.value = '';
    inp.click();
  }

  // EXPORTAR A PDF con imágenes (usa localforage para recuperar blobs)
  async function exportToPDF(){
    try{
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const margin = 15;
      let y = margin;

      pdf.setFontSize(16);
      pdf.text('Inventario con imágenes', margin, y);
      y += 10;

      for(let i=0;i<inventory.length;i++){
        const p = inventory[i];
        // obtener imagen blob si existe
        let blob = null;
        try{ blob = await localforage.getItem(`img_${p.code}`); }catch(e){ blob = null; }
        if(blob){
          // convertir blob a dataURL
          const dataUrl = await blobToDataURL(blob);
          try {
            pdf.addImage(dataUrl, 'JPEG', margin, y, 40, 40);
          } catch(e){
            // fallback: ignorar imagen si hay problemas
          }
        }
        pdf.setFontSize(11);
        pdf.text(`Código: ${p.code}`, 60, y + 7);
        pdf.text(`Nombre: ${p.name}`, 60, y + 14);
        pdf.text(`Precio: $${Number(p.price).toFixed(2)}`, 60, y + 21);
        pdf.text(`Stock: ${Number(p.quantity)}`, 60, y + 28);
        y += 48;
        if(y > 250){ pdf.addPage(); y = margin; }
      }
      pdf.save('inventario.pdf');
    }catch(e){
      console.error(e);
      alert('Error generando PDF: ' + (e.message || e));
    }
  }

  function blobToDataURL(blob){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = ()=> resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  function editProduct(idx){
    const p = inventory[idx];
    document.getElementById('name').value = p.name;
    document.getElementById('code').value = p.code;
    document.getElementById('barcode').value = p.barcode;
    document.getElementById('price').value = p.price;
    document.getElementById('discount').value = p.discount;
    document.getElementById('quantity').value = p.quantity;
    document.getElementById('description').value = p.description;
    document.getElementById('category').value = p.category;
    editIndex = idx;
    // mostrar imagen si existe
    localforage.getItem(`img_${p.code}`).then(blob=>{
      if(blob){
        document.getElementById('imagePreview').src = URL.createObjectURL(blob);
        document.getElementById('imagePreview').style.display = 'block';
      }
    }).catch(()=>{});
    // scroll suave al formulario
    document.getElementById('formularioBubble').scrollIntoView({behavior:'smooth'});
  }

  function deleteProduct(idx){
    if(!confirm('¿Eliminar este producto?')) return;
    const code = inventory[idx].code;
    inventory.splice(idx,1);
    localStorage.setItem('inventory', JSON.stringify(inventory));
    localforage.removeItem(`img_${code}`).catch(()=>{});
    renderTable(); calculateTotal();
  }

  window.addEventListener('DOMContentLoaded',()=>{
    renderTable(); calculateTotal();
  });
  </script>
</body>
</html>
