<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Descuentos</title>
  <style>
    :root {
      --primary: #0052d4;
      --primary-light: #4f83cc;
      --bg: #f5f7fa;
      --card: #ffffff;
      --text: #222;
      --green: #00c853;
      --red: #ff5252;
      --shadow: 0 4px 12px rgba(0,0,0,.08);
    }
    * { box-sizing: border-box; font-family: "Segoe UI", sans-serif; }
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
    body { background: var(--bg); color: var(--text); display: flex; flex-direction: column; }
    header {
      background: var(--primary);
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.3rem;
      font-weight: 600;
      box-shadow: var(--shadow);
      flex-shrink: 0;
    }
    .wrap {
      flex: 1 1 auto;
      width: 100%;
      max-width: 1200px;
      margin: auto;
      padding: 1rem;
      overflow-y: auto;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: .8rem;
      margin-bottom: 1.2rem;
    }
    .filters input, .filters select, .filters button {
      padding: .55rem .7rem;
      border: 1px solid #bbb;
      border-radius: 6px;
      font-size: .95rem;
    }
    .filters button {
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer;
    }
    .filters button:hover { background: var(--primary-light); }
    table {
      width: 100%;
      background: var(--card);
      border-collapse: collapse;
      box-shadow: var(--shadow);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td { padding: .7rem .8rem; text-align: left; border-bottom: 1px solid #e5e5e5; }
    th { background: #f2f5ff; }
    tr.highlight { background: var(--green); color: #fff; }
    .thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; }
    .summary {
      position: fixed;
      bottom: 1rem; right: 1rem;
      background: var(--card);
      padding: 1rem 1.2rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
      font-size: .95rem;
      line-height: 1.4;
      z-index: 999;
    }
    .summary b { display: block; margin-bottom: .3rem; }
    .info { margin: .5rem 0; font-weight: 600; }
  </style>
</head>
<body>

<header>Sistema de Descuentos</header>

<div class="wrap">
  <!-- Filtros -->
  <div class="filters">
    <input id="searchCode" placeholder="Código de barras (ENTER)" autocomplete="off">
    <select id="catFilter">
      <option value="">-- Categoría --</option>
      <option value="Accesorios para el cabello">Accesorios para el cabello</option>
      <option value="Anillos">Anillos</option>
      <option value="Aritos">Aritos</option>
      <option value="Billeteras">Billeteras</option>
      <option value="Carteras">Carteras</option>
      <option value="Case audífonos">Case audífonos</option>
      <option value="Case teléfonos">Case teléfonos</option>
      <option value="Chokers">Chokers</option>
      <option value="Collares">Collares</option>
      <option value="General">General</option>
      <option value="Lentes de sol">Lentes de sol</option>
      <option value="Otros">Otros</option>
      <option value="Pulseras">Pulseras</option>
      <option value="Relojes">Relojes</option>
    </select>
    <input id="globalDisc" type="number" min="0" max="100" placeholder="Dto global %">
    <button onclick="applyGlobal()">Aplicar</button>
    <button onclick="removeGlobal()">Quitar</button>
  </div>

  <div class="info" id="info"></div>

  <table>
    <thead>
      <tr>
        <th>#</th><th>Imagen</th><th>Nombre</th><th>Código</th><th>Cód.Barras</th><th>Precio</th>
        <th>Dto %</th><th>Final</th><th>Categoría</th><th>Stock</th><th>Acción</th>
      </tr>
    </thead>
    <tbody id="list"></tbody>
  </table>
</div>

<div class="summary">
  <div>Normal: $<span id="totN">0.00</span></div>
  <div>Con dto: $<span id="totD">0.00</span></div>
</div>

<!-- localforage para imágenes -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<script>
/* ----------  DATOS  ---------- */
const inv = JSON.parse(localStorage.getItem('inventory')) || [];
const qs  = (s) => document.querySelector(s);

/* ----------  PINTAR  ---------- */
function render(arr = inv) {
  const tb = qs('#list');
  tb.innerHTML = '';
  arr.forEach((it, idx) => {
    const tr = document.createElement('tr');
    tr.dataset.line = idx + 1;
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td><img class="thumb" id="img-${it.code}" alt="img"></td>
      <td>${it.name}</td>
      <td>${it.code}</td>
      <td>${it.barcode || ''}</td>
      <td>$${(+it.price).toFixed(2)}</td>
      <td><input type="number" min="0" max="100" value="${it.discount||0}"
                 onchange="setDisc('${it.code}',this.value)"></td>
      <td>$${(+it.price * (1 - (it.discount||0)/100)).toFixed(2)}</td>
      <td>${it.category}</td>
      <td>${it.quantity}</td>
      <td><button onclick="setDisc('${it.code}',0)">Quitar</button></td>`;
    tb.appendChild(tr);
  });
  loadImages(); // ⬅️ carga imágenes después de pintar
  totals();
}

/* ----------  CARGAR IMAGENES DESDE LOCALFORAGE (compra.html)  ---------- */
function loadImages() {
  inv.forEach(it => {
    const imgEl = document.getElementById(`img-${it.code}`);
    if (!imgEl) return;
    localforage.getItem(`img_${it.code}`).then(blob => {
      if (blob) {
        imgEl.src = URL.createObjectURL(blob);
      } else {
        imgEl.src = 'https://via.placeholder.com/60?text=Sin+img';
      }
    }).catch(() => {
      imgEl.src = 'https://via.placeholder.com/60?text=Sin+img';
    });
  });
}

/* ----------  LÓGICA  ---------- */
function setDisc(code, val) {
  const it = inv.find(i => i.code === code);
  if (it) { it.discount = Math.max(0, Math.min(100, parseFloat(val) || 0)); save(); filterAndRender(); }
}
function applyGlobal() {
  const v = parseFloat(qs('#globalDisc').value);
  if (isNaN(v) || v < 0 || v > 100) return alert('Descuento inválido');
  inv.forEach(i => i.discount = v); save(); filterAndRender();
}
function removeGlobal() { inv.forEach(i => i.discount = 0); save(); filterAndRender(); }

function totals() {
  let norm = 0, desc = 0;
  inv.forEach(i => {
    const q = +i.quantity, p = +i.price, d = (+i.discount||0);
    norm += p * q;
    desc += p * (1 - d/100) * q;
  });
  qs('#totN').textContent = norm.toFixed(2);
  qs('#totD').textContent = desc.toFixed(2);
}
function save() { localStorage.setItem('inventory', JSON.stringify(inv)); }

/* ----------  FILTRAR  ---------- */
function filterAndRender() {
  const code = qs('#searchCode').value.trim();
  const cat  = qs('#catFilter').value;
  let aux = inv;
  if (code) aux = aux.filter(i => i.code === code);
  if (cat)  aux = aux.filter(i => i.category === cat);
  render(aux);
}

/* ----------  EVENTOS  ---------- */
qs('#searchCode').addEventListener('input', filterAndRender);
qs('#catFilter').addEventListener('change', filterAndRender);
qs('#searchCode').addEventListener('keydown', e => {
  if (e.key === 'Enter') { e.preventDefault(); filterAndRender(); qs('#searchCode').select(); }
});

/* ----------  INICIO  ---------- */
render();
</script>
</body>
</html>
