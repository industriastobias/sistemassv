<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <!-- Meta tags optimizados -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="robots" content="noindex,nofollow">
  <meta name="description" content="Dashboard TOBIAS PALACIOS">
  
  <!-- Security Headers Meta -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' *.googleapis.com; style-src 'self' 'unsafe-inline' *.googleapis.com; font-src 'self' *.gstatic.com; img-src 'self' data: blob:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  
  <!-- Preconnect para fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Preload critical fonts -->
  <link rel="preload" href="https://fonts.googleapis.com/icon?family=Material+Icons" as="style" crossorigin>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" as="style" crossorigin>
  
  <title>Dashboard – TOBIAS PALACIOS</title>

  <!-- Google Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" crossorigin="anonymous">

  <!-- Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet" crossorigin="anonymous">

  <style>
    /* ============== VARIABLES ============== */
    :root{
      --color-bg: #ffffff;
      --color-panel: #ffffff;
      --color-accent: #DBB8BC;
      --color-text: #1F2937;
      --color-muted: #9CA3AF;
      --color-danger: #EF4444;
      --color-border: #DBB8BC;
      --radius: 12px;
      --card-radius: 12px;
      --sidebar-width: 280px;
      --shadow-soft: 0 6px 18px rgba(31,41,55,0.06);
      --shadow-tight: 0 2px 8px rgba(31,41,55,0.04);
      --font-family: 'Inter', system-ui, -apple-system, sans-serif;
      --transition: 180ms cubic-bezier(.2,.9,.2,1);
    }

    /* Reset ligero */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:var(--font-family);
      background:var(--color-bg);
      color:var(--color-text);
      display:flex;
      min-height:100vh;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow:hidden;
    }

    /* Layout: sidebar + contenido */
    .sidebar{
      width:var(--sidebar-width);
      min-width:var(--sidebar-width);
      padding:1.25rem;
      background:linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,0.98));
      border-right:1px solid rgba(219,184,188,0.12);
      height:100vh;
      display:flex;
      flex-direction:column;
      gap:1rem;
      align-items:stretch;
    }

    /* Brand area */
    .brand {
      display:flex;
      align-items:center;
      gap:.75rem;
      padding:.35rem .5rem;
      border-radius:10px;
    }
    .brand .logo {
      width:44px;
      height:44px;
      border-radius:8px;
      background:linear-gradient(135deg, rgba(219,184,188,0.12), rgba(219,184,188,0.06));
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      color:var(--color-accent);
      border:1px solid rgba(219,184,188,0.08);
      font-size:18px;
    }
    .brand .title {
      font-weight:800;
      font-size:14px;
      color:var(--color-text);
      letter-spacing:.3px;
    }
    .brand .tag {
      font-size:11px;
      color:var(--color-muted);
    }

    /* NAV: tarjetas (A2) */
    .nav {
      display:flex;
      flex-direction:column;
      gap:.6rem;
      overflow-y:auto;
      padding-right:.25rem;
    }

    .nav-link {
      display:flex;
      align-items:center;
      gap:12px;
      padding:.9rem 1rem;
      border-radius:var(--card-radius);
      text-decoration:none;
      color:var(--color-text);
      background: linear-gradient(180deg, rgba(250,250,250,1), rgba(250,250,250,0.96));
      border:1px solid rgba(31,41,55,0.04);
      box-shadow: var(--shadow-tight);
      transition:transform var(--transition), box-shadow var(--transition), border-color var(--transition), background var(--transition);
      cursor:pointer;
      align-items:center;
    }
    .nav-link .material-icons {
      font-size:20px;
      color:var(--color-accent);
      min-width:22px;
      display:inline-flex;
      justify-content:center;
      align-items:center;
    }
    .nav-link span { font-weight:600; font-size:0.98rem; }

    .nav-link:hover{
      transform: translateY(-3px);
      box-shadow: var(--shadow-soft);
      border-color: rgba(219,184,188,0.18);
      background: linear-gradient(180deg, rgba(255,255,255,1), rgba(250,245,246,0.98));
    }

    .nav-link.active{
      background: linear-gradient(180deg, var(--color-accent), rgba(219,184,188,0.95));
      color:#ffffff;
      border:1px solid rgba(219,184,188,0.18);
      box-shadow: 0 8px 22px rgba(219,184,188,0.12);
    }
    .nav-link.active .material-icons { color:#fff; opacity:0.95 }

    /* Scrollbar ligero */
    .nav::-webkit-scrollbar{ width:8px }
    .nav::-webkit-scrollbar-thumb{ background: rgba(219,184,188,0.22); border-radius:8px }

    /* Right / top user panel (tarjeta) */
    .right-panel{
      position:fixed;
      right:1.75rem;
      top:1.25rem;
      display:flex;
      flex-direction:column;
      gap:.8rem;
      align-items:flex-end;
      z-index:60;
    }

    .user-card{
      display:flex;
      align-items:center;
      gap:.75rem;
      padding:.6rem .85rem;
      background: linear-gradient(180deg, #fff, #fff);
      border-radius:14px;
      border:1px solid rgba(31,41,55,0.04);
      box-shadow: var(--shadow-tight);
      min-width:220px;
      transition:box-shadow var(--transition), transform var(--transition);
    }
    .user-card:hover{ box-shadow: var(--shadow-soft); transform: translateY(-3px) }

    .user-avatar{
      width:64px;
      height:64px;
      border-radius:10px;
      object-fit:cover;
      border:2px solid rgba(219,184,188,0.18);
      display:block;
      background:var(--color-panel);
    }

    .user-info { display:flex; flex-direction:column; gap:2px; align-items:flex-start; text-align:left; }
    .user-name { font-weight:700; font-size:0.98rem; color:var(--color-text); }
    .user-role { font-size:0.82rem; color:var(--color-muted); letter-spacing:0.2px }

    .logout-btn{
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      background:var(--color-danger);
      color:#fff;
      border:none;
      padding:.5rem .9rem;
      border-radius:10px;
      font-weight:700;
      box-shadow:0 6px 14px rgba(239,68,68,0.12);
      cursor:pointer;
      transition: transform var(--transition);
      height:40px;
    }
    .logout-btn:active{ transform:translateY(1px) }

    /* Main area */
    main{
      flex:1;
      margin-left:calc(var(--sidebar-width) + 1rem);
      padding:2.25rem;
      overflow:auto;
      min-height:100vh;
    }

    .top-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
      margin-bottom:1.25rem;
    }

    .welcome {
      font-size:1.9rem;
      font-weight:800;
      color:var(--color-text);
      letter-spacing:0.2px;
    }
    .subtitle {
      color:var(--color-muted);
      font-weight:600;
      font-size:0.95rem;
      margin-top:6px;
    }

    /* Cards container ejemplo (visual) */
    .card-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:1rem;
      margin-top:1rem;
    }
    .card {
      padding:1rem;
      border-radius:12px;
      background:linear-gradient(180deg,#fff,#fff);
      border:1px solid rgba(31,41,55,0.04);
      box-shadow:var(--shadow-tight);
    }
    .card h3 { font-size:1rem; margin-bottom:.5rem; color:var(--color-text) }
    .card p { color:var(--color-muted); font-size:.9rem }

    /* Responsive */
    @media (max-width: 1100px){
      :root{ --sidebar-width: 240px }
      .sidebar{ width:var(--sidebar-width); min-width:var(--sidebar-width) }
      main{ margin-left:calc(var(--sidebar-width) + 0.75rem) }
    }
    @media (max-width: 820px){
      body{ flex-direction:column; overflow:auto }
      .sidebar{
        width:100%;
        position:sticky;
        top:0;
        height:auto;
        display:flex;
        flex-direction:row;
        gap:.6rem;
        padding:.6rem;
        overflow-x:auto;
        border-right:none;
        border-bottom:1px solid rgba(219,184,188,0.08);
        background: rgba(255,255,255,0.95);
        -webkit-backdrop-filter: blur(6px);
        backdrop-filter: blur(6px);
      }
      .brand{ display:none } /* reducir espacio en móvil */
      .nav{ flex-direction:row; gap:.6rem; align-items:center }
      .nav-link{ min-width:120px; flex:0 0 auto; padding:.65rem .75rem }
      .right-panel{ position:static; width:100%; padding:.6rem; flex-direction:row; justify-content:space-between; margin-top:.35rem }
      main{ margin-left:0; padding:1rem }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important }
    }

    /* Accessibility helpers */
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }
  </style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar" aria-label="Navegación principal">
  <div class="brand" aria-hidden="true">
    <div class="logo" aria-hidden="true">TP</div>
    <div>
      <div class="title">TOBIAS PALACIOS</div>
      <div class="tag">A FAMILY COMPANY</div>
    </div>
  </div>

  <nav class="nav" id="main-nav" role="navigation" aria-label="Menú principal">
    <a class="nav-link" href="almacenamiento.html" data-page="almacenamiento">
      <span class="material-icons" aria-hidden="true">warehouse</span>
      <span>Almacenamiento</span>
    </a>
    <a class="nav-link" href="clientes.html" data-page="clientes">
      <span class="material-icons" aria-hidden="true">groups</span>
      <span>Clientes</span>
    </a>
    <a class="nav-link" href="compra.html" data-page="compra">
      <span class="material-icons" aria-hidden="true">shopping_cart</span>
      <span>Compra</span>
    </a>
    <a class="nav-link" href="descuentos.html" data-page="descuentos">
      <span class="material-icons" aria-hidden="true">local_offer</span>
      <span>Descuentos</span>
    </a>
    <a class="nav-link" href="facturas.html" data-page="facturas">
      <span class="material-icons" aria-hidden="true">receipt_long</span>
      <span>Facturas</span>
    </a>
    <a class="nav-link" href="gastos.html" data-page="gastos">
      <span class="material-icons" aria-hidden="true">store</span>
      <span>Catálogo</span>
    </a>
    <a class="nav-link" href="inventario.html" data-page="inventario">
      <span class="material-icons" aria-hidden="true">inventory_2</span>
      <span>Inventario</span>
    </a>
    <a class="nav-link" href="lista.html" data-page="lista">
      <span class="material-icons" aria-hidden="true">account_balance</span>
      <span>Finanzas</span>
    </a>
    <a class="nav-link" href="traslados.html" data-page="traslados">
      <span class="material-icons" aria-hidden="true">local_shipping</span>
      <span>Traslados</span>
    </a>
    <a class="nav-link" href="venta.html" data-page="venta">
      <span class="material-icons" aria-hidden="true">point_of_sale</span>
      <span>Venta</span>
    </a>
    <a class="nav-link" href="Verificasion.html" data-page="Verificasion">
      <span class="material-icons" aria-hidden="true">verified</span>
      <span>Verificación</span>
    </a>
  </nav>
</aside>

<!-- User Panel -->
<div class="right-panel" role="complementary" aria-label="Panel de usuario">
  <div class="user-card" role="group" aria-label="Usuario actual">
    <img id="userPhoto" class="user-avatar" 
         src="user2005.jpg" 
         alt="Avatar del usuario ERNESTO TOBIAS" 
         loading="lazy"
         width="64"
         height="64">
    <div class="user-info">
      <div id="userName" class="user-name">ERNESTO TOBIAS</div>
      <div class="user-role">Administrador</div>
    </div>
  </div>

  <button id="logoutBtn" class="logout-btn" aria-label="Cerrar sesión">
    <span class="material-icons" aria-hidden="true">logout</span>
    <span>Exit</span>
  </button>
</div>

<!-- Main -->
<main role="main" aria-live="polite">
  <div class="top-row">
    <div>
      <h1 class="welcome">TOBIAS PALACIOS</h1>
      <div class="subtitle">A FAMILY COMPANY</div>
    </div>
    <!-- espacio para futuras acciones / filtros -->
    <div aria-hidden="true"></div>
  </div>

  <!-- Ejemplo visual de paneles (NO modifica lógica) -->
  <section class="card-grid" aria-hidden="true">
    <div class="card">
      <h3>Bienvenido</h3>
      <p>Panel corporativo moderno — navegación alineada en tarjetas. No se cambió ninguna funcionalidad.</p>
    </div>
    <div class="card">
      <h3>Accesos rápidos</h3>
      <p>Los enlaces en el sidebar mantienen las mismas rutas e IDs originales.</p>
    </div>
    <div class="card">
      <h3>Perfil</h3>
      <p>Foto y nombre cargados desde sessionStorage / IndexedDB (igual que antes).</p>
    </div>
  </section>
</main>

<!-- JavaScript Optimizado (sin cambios estructurales) -->
<script>
// Configuración ultraligera
const CONFIG = {
  DB_NAME: 'menuDB',
  STORE_SESSION: 'userSession',
  DEFAULT_AVATAR: 'user2005.jpg',
  DEFAULT_USER: 'Usuario',
  REDIRECT_PAGE: 'index.html'
};

// Logger minimalista
const Logger = {
  warn: (...args) => console.warn('[Dashboard]', ...args)
};

// IndexedDB Manager - Singleton
class StorageManager {
  static #instance = null;
  static getInstance() {
    if (!this.#instance) this.#instance = new StorageManager();
    return this.#instance;
  }

  constructor() {
    this.db = null;
    this.#open();
  }

  async #open() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(CONFIG.DB_NAME, 1);
      req.onerror = () => reject(req.error);
      req.onsuccess = () => {
        this.db = req.result;
        resolve();
      };
      req.onupgradeneeded = () => {
        const d = req.result;
        if (!d.objectStoreNames.contains(CONFIG.STORE_SESSION)) {
          d.createObjectStore(CONFIG.STORE_SESSION, { keyPath: 'id', autoIncrement: true });
        }
      };
    });
  }

  async getLastSession() {
    if (!this.db) await this.#open();
    const tx = this.db.transaction([CONFIG.STORE_SESSION], 'readonly');
    return new Promise(resolve => {
      tx.objectStore(CONFIG.STORE_SESSION).openCursor(null, 'prev').onsuccess = (e) => {
        resolve(e.target.result?.value || null);
      };
    });
  }

  async clear() {
    if (!this.db) await this.#open();
    this.db.transaction([CONFIG.STORE_SESSION], 'readwrite').objectStore(CONFIG.STORE_SESSION).clear();
  }
}

// Auth Manager
const AuthManager = {
  check: () => {
    if (sessionStorage.getItem('loggedIn') !== 'true') {
      location.replace(CONFIG.REDIRECT_PAGE);
      return false;
    }
    return true;
  },
  
  logout: async () => {
    await StorageManager.getInstance().clear();
    sessionStorage.clear();
    location.replace(CONFIG.REDIRECT_PAGE);
  }
};

// UI Manager
const UIManager = {
  async init() {
    const [photo, name] = [sessionStorage.getItem('foto'), sessionStorage.getItem('nombre')];
    
    if (photo && name) {
      this.update(photo, name);
    } else {
      const session = await StorageManager.getInstance().getLastSession();
      if (session?.foto && session?.nombre) {
        sessionStorage.setItem('foto', session.foto);
        sessionStorage.setItem('nombre', session.nombre);
        this.update(session.foto, session.nombre);
      } else {
        this.update(CONFIG.DEFAULT_AVATAR, CONFIG.DEFAULT_USER);
      }
    }
  },
  
  update(foto, nombre) {
    const imgEl = document.getElementById('userPhoto');
    const nameEl = document.getElementById('userName');
    if (imgEl) {
      imgEl.src = foto;
      imgEl.onerror = () => { imgEl.src = CONFIG.DEFAULT_AVATAR; };
    }
    if (nameEl) nameEl.textContent = nombre || CONFIG.DEFAULT_USER;
  }
};

// Navigation Manager
const NavManager = {
  init() {
    const current = location.pathname.split('/').pop();
    document.querySelectorAll('.nav-link').forEach(link => {
      // Marcar activo comparando href exacto o data-page (manteniendo compatibilidad)
      const href = link.getAttribute('href');
      const page = link.dataset.page;
      if (href === current || page === current || page === href) {
        link.classList.add('active');
        link.setAttribute('aria-current', 'page');
      }
    });
  }
};

// ==================== INICIALIZACIÓN ULTRA-RÁPIDA ====================
(function() {
  'use strict';
  
  // Si el DOM ya está listo, iniciar inmediatamente
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { passive: true });
  } else {
    init();
  }

  async function init() {
    // 1. Auth primero (bloqueante y rápido)
    if (!AuthManager.check()) return;

    // 2. UI en paralelo (no bloqueante)
    UIManager.init().catch(Logger.warn);
    NavManager.init();

    // 3. Event listeners con passive: true
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        AuthManager.logout();
      }, { passive: false });
    }
  }
})();
</script>
</body>
</html>
