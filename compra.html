<script>
  // ===== GLOBAL =====
  let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
  let editIndex = -1;
  let loteTemporal = [];

  // ===== FUNCIONES EXISTENTES (sin cambios) =====
  function calculateTotal(){
    const total = inventory.reduce((sum,item)=>{
      const price = Number(item.price) || 0;
      const quantity = Number(item.quantity) || 0;
      const discount = Number(item.discount) || 0;
      const finalPrice = price * (1 - discount/100);
      return sum + finalPrice * quantity;
    },0);
    document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
  }

  function renderTable(){
    const list = document.getElementById('inventoryList');
    list.innerHTML = inventory.map((item,idx)=>`
      <div class="card-item">
        <img id="invImg${idx}" src="" alt="${escapeHtml(item.name)}"/>
        <h3>${escapeHtml(item.name)}</h3>
        <p>Código: ${escapeHtml(item.code)}</p>
        <p>Cód.Barras: ${escapeHtml(item.barcode)}</p>
        <p>Precio: $${Number(item.price).toFixed(2)}</p>
        <p>Stock: ${Number(item.quantity)}</p>
        <div class="actions">
          <button class="btn-primary" onclick="editProduct(${idx})"><i class="fa fa-edit"></i> Editar</button>
          <button class="btn-danger" onclick="deleteProduct(${idx})"><i class="fa fa-trash"></i> Eliminar</button>
        </div>
      </div>
    `).join('');
    inventory.forEach((p,i)=>{
      localforage.getItem(`img_${p.code}`).then(blob=>{
        if(blob && document.getElementById(`invImg${i}`)){
          document.getElementById(`invImg${i}`).src = URL.createObjectURL(blob);
        }
      }).catch(()=>{});
    });
  }

  function escapeHtml(text){
    return String(text||'').replace(/[&<>"'`]/g, s => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;'
    })[s]);
  }

  function previewImage(evt){
    const file = evt.target.files[0];
    if(!file) return;
    new Compressor(file,{quality:0.6,maxWidth:800,maxHeight:800,
      success(result){
        const reader = new FileReader();
        reader.onload = e=>{
          document.getElementById('imagePreview').src = e.target.result;
          document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(result);
      },
      error(err){ console.error(err); }
    });
  }

  document.getElementById('purchaseForm').addEventListener('submit',function(e){
    e.preventDefault();
    const form = new FormData(e.target);
    const item = {
      name: form.get('name') || '',
      code: form.get('code') || '',
      barcode: form.get('barcode') || '',
      price: Number(form.get('price')) || 0,
      discount: Number(form.get('discount')) || 0,
      quantity: Number(form.get('quantity')) || 0,
      description: form.get('description') || '',
      category: form.get('category') || ''
    };
    if(editIndex === -1){
      const exists = inventory.find(i=>i.code === item.code);
      if(exists){
        if(!confirm('Código ya existe. ¿Sumar stock al existente? (Aceptar = sumar, Cancelar = crear igualmente)')){
          item.code = `${item.code}_${Date.now()}`;
        } else {
          exists.quantity = Number(exists.quantity) + Number(item.quantity);
          localStorage.setItem('inventory', JSON.stringify(inventory));
          renderTable(); calculateTotal();
          e.target.reset();
          document.getElementById('imagePreview').style.display = 'none';
          barcodeCanvas.style.display = 'none';
          return;
        }
      }
      inventory.push(item);
    } else {
      inventory[editIndex] = item;
      editIndex = -1;
    }
    localStorage.setItem('inventory', JSON.stringify(inventory));
    const imgFile = document.getElementById('imageFile').files[0];
    if(imgFile){
      new Compressor(imgFile,{quality:0.6,maxWidth:800,maxHeight:800,
        success(result){
          localforage.setItem(`img_${item.code}`, result).catch(()=>{});
        }
      });
    }
    e.target.reset();
    document.getElementById('imagePreview').style.display = 'none';
    barcodeCanvas.style.display = 'none';
    renderTable(); calculateTotal();
  });

  function vaciarInventario(){
    if(!confirm('¿Vaciar todo el inventario?')) return;
    inventory.forEach(p => localforage.removeItem(`img_${p.code}`).catch(()=>{}));
    inventory = [];
    localStorage.setItem('inventory', JSON.stringify(inventory));
    renderTable(); calculateTotal();
  }

  async function exportToZip(){
    try{
      const zip = new JSZip();
      zip.file('inventory.json', JSON.stringify(inventory, null, 2));
      const imgFolder = zip.folder('images');
      for(const p of inventory){
        try{
          const blob = await localforage.getItem(`img_${p.code}`);
          if(blob) imgFolder.file(`${p.code}.jpg`, blob);
        }catch(e){}
      }
      const blobZip = await zip.generateAsync({type:'blob'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blobZip);
      a.download = 'inventario.zip';
      a.click();
    }catch(e){
      alert('Error exportando ZIP: ' + (e.message || e));
    }
  }

  async function importFromZip(evt){
    const file = evt.target.files[0];
    if(!file){ return; }
    if(!file.name.toLowerCase().endsWith('.zip')){ alert('Selecciona un archivo .zip'); evt.target.value=''; return; }
    try{
      const arrayBuffer = await file.arrayBuffer();
      const zip = await JSZip.loadAsync(arrayBuffer);
      const jsonFile = zip.file('inventory.json');
      if(!jsonFile){ alert('El ZIP no contiene inventory.json'); evt.target.value=''; return; }
      const jsonText = await jsonFile.async('string');
      let imported = JSON.parse(jsonText);
      if(!Array.isArray(imported)) imported = [];

      for(const p of imported){
        p.price = Number(p.price) || 0;
        p.quantity = Number(p.quantity) || 0;
        p.discount = Number(p.discount) || 0;
        const imgEntry = zip.file(`images/${p.code}.jpg`) || zip.file(`images/${p.code}.jpeg`);
        if(imgEntry){
          try{
            const blob = await imgEntry.async('blob');
            await localforage.setItem(`img_${p.code}`, blob);
          }catch(e){}
        }
        const idx = inventory.findIndex(x => x.code === p.code);
        if(idx > -1){
          inventory[idx].quantity = Number(inventory[idx].quantity || 0) + Number(p.quantity || 0);
          if(!inventory[idx].name && p.name) inventory[idx].name = p.name;
          if(!inventory[idx].barcode && p.barcode) inventory[idx].barcode = p.barcode;
          if((!inventory[idx].price || inventory[idx].price===0) && p.price) inventory[idx].price = p.price;
          if(!inventory[idx].description && p.description) inventory[idx].description = p.description;
          if(!inventory[idx].category && p.category) inventory[idx].category = p.category;
        } else {
          const nuevo = {
            name: p.name || p.code,
            code: p.code,
            barcode: p.barcode || '',
            price: Number(p.price) || 0,
            discount: Number(p.discount) || 0,
            quantity: Number(p.quantity) || 0,
            description: p.description || '',
            category: p.category || ''
          };
          inventory.push(nuevo);
        }
      }
      localStorage.setItem('inventory',JSON.stringify(inventory));
      renderTable(); calculateTotal();
      alert('Importación ZIP completada y fusionada correctamente ✅');
    }catch(e){
      console.error(e);
      alert('Error leyendo ZIP: ' + (e.message || e));
    } finally {
      evt.target.value = '';
    }
  }

  function resetAndOpenImport(){
    const inp = document.getElementById('importFile');
    inp.value = '';
    inp.click();
  }

  async function exportToPDF(){
    try{
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const margin = 15;
      let y = margin;

      pdf.setFontSize(16);
      pdf.text('Inventario con imágenes', margin, y);
      y += 10;

      for(let i=0;i<inventory.length;i++){
        const p = inventory[i];
        let blob = null;
        try{ blob = await localforage.getItem(`img_${p.code}`); }catch(e){ blob = null; }
        if(blob){
          const dataUrl = await blobToDataURL(blob);
          try {
            pdf.addImage(dataUrl, 'JPEG', margin, y, 40, 40);
          } catch(e){}
        }
        pdf.setFontSize(11);
        pdf.text(`Código: ${p.code}`, 60, y + 7);
        pdf.text(`Nombre: ${p.name}`, 60, y + 14);
        pdf.text(`Precio: $${Number(p.price).toFixed(2)}`, 60, y + 21);
        pdf.text(`Stock: ${Number(p.quantity)}`, 60, y + 28);
        y += 48;
        if(y > 250){ pdf.addPage(); y = margin; }
      }
      pdf.save('inventario.pdf');
    }catch(e){
      console.error(e);
      alert('Error generando PDF: ' + (e.message || e));
    }
  }

  function blobToDataURL(blob){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = ()=> resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  function editProduct(idx){
    const p = inventory[idx];
    document.getElementById('name').value = p.name;
    document.getElementById('code').value = p.code;
    document.getElementById('barcode').value = p.barcode;
    document.getElementById('price').value = p.price;
    document.getElementById('discount').value = p.discount;
    document.getElementById('quantity').value = p.quantity;
    document.getElementById('description').value = p.description;
    document.getElementById('category').value = p.category;
    editIndex = idx;
    localforage.getItem(`img_${p.code}`).then(blob=>{
      if(blob){
        document.getElementById('imagePreview').src = URL.createObjectURL(blob);
        document.getElementById('imagePreview').style.display = 'block';
      }
    }).catch(()=>{});
    document.getElementById('formularioBubble').scrollIntoView({behavior:'smooth'});
    generarBarcode(p.barcode);
  }

  function deleteProduct(idx){
    if(!confirm('¿Eliminar este producto?')) return;
    const code = inventory[idx].code;
    inventory.splice(idx,1);
    localStorage.setItem('inventory', JSON.stringify(inventory));
    localforage.removeItem(`img_${code}`).catch(()=>{});
    renderTable(); calculateTotal();
  }

  /* =========  CARGA MASIVA  ========= */
  async function procesarLote(){
    const files = document.getElementById('loteFiles').files;
    if(!files.length){ alert('Selecciona imágenes'); return; }
    if(files.length < 1 || files.length > 130){ alert('Elige entre 1 y 130 imágenes'); return; }
    const prefix = document.getElementById('lotePrefix').value.trim() || 'LOTE';
    loteTemporal = [];
    const preview = document.getElementById('lotePreview');
    preview.innerHTML = '';
    document.getElementById('loteStatus').textContent = 'Comprimiendo y guardando...';

    for(let i = 0; i < files.length; i++){
      const file = files[i];
      const codigo = `${prefix}${Date.now()}${i}`;
      await new Promise(res => {
        new Compressor(file,{ quality:0.6, maxWidth:800, maxHeight:800,
          success(result){
            const reader = new FileReader();
            reader.onload = e => {
              const mini = document.createElement('div');
              mini.className = 'mini-item';
              mini.innerHTML = `<img src="${e.target.result}" alt="img"><div>Código: <b>${codigo}</b></div>`;
              preview.appendChild(mini);
              localforage.setItem(`img_${codigo}`, result);
              loteTemporal.push({name:'',code:codigo,barcode:'',price:0,discount:0,quantity:0,description:'',category:''});
              res();
            };
            reader.readAsDataURL(result);
          },
          error(err){ console.error(err); res(); }
        });
      });
    }
    document.getElementById('loteStatus').textContent = `Listo: ${loteTemporal.length} productos creados. Ahora edítalos.`;
    mostrarEditorLote();
  }

  function vaciarLote(){
    if(!confirm('¿Vaciar lote actual?')) return;
    loteTemporal.forEach(p => localforage.removeItem(`img_${p.code}`).catch(()=>{}));
    loteTemporal = [];
    document.getElementById('lotePreview').innerHTML = '';
    document.getElementById('loteStatus').textContent = '';
    document.getElementById('editLoteBubble').style.display = 'none';
  }

  function mostrarEditorLote(){
    const grid = document.getElementById('editLoteGrid');
    grid.innerHTML = '';
    document.getElementById('editLoteBubble').style.display = 'block';
    loteTemporal.forEach((p,i)=>{
      const card = document.createElement('div');
      card.className = 'card-item';
      card.innerHTML = `
        <img id="loteImg${i}" src="" alt="img" style="height:160px;object-fit:cover;border-radius:12px;">
        <h3>${p.code}</h3>
        <input placeholder="Nombre" id="loteName${i}" value="${escapeHtml(p.name)}">
        <input placeholder="Barras" id="loteBarcode${i}" value="${escapeHtml(p.barcode)}">
        <input placeholder="Precio" id="lotePrice${i}" type="number" step="0.01" value="${Number(p.price)}">
        <input placeholder="Desc(%)" id="loteDiscount${i}" type="number" step="0.01" value="${Number(p.discount)}">
        <input placeholder="Stock" id="loteQuantity${i}" type="number" value="${Number(p.quantity)}">
        <input placeholder="Descripción" id="loteDescription${i}" value="${escapeHtml(p.description)}">
        <select id="loteCategory${i}">
          <option value="">-- Categoría --</option>
          <option value="Accesorios para el cabello">Accesorios para el cabello</option>
          <option value="Anillos">Anillos</option>
          <option value="Aritos">Aritos</option>
          <option value="Billeteras">Billeteras</option>
          <option value="Carteras">Carteras</option>
          <option value="Case audífonos">Case audífonos</option>
          <option value="Case teléfonos">Case teléfonos</option>
          <option value="Chokers">Chokers</option>
          <option value="Collares">Collares</option>
          <option value="General">General</option>
          <option value="Lentes de sol">Lentes de sol</option>
          <option value="Otros">Otros</option>
          <option value="Pulseras">Pulseras</option>
          <option value="Relojes">Relojes</option>
        </select>
      `;
      grid.appendChild(card);
      localforage.getItem(`img_${p.code}`).then(blob=>{
        if(blob) document.getElementById(`loteImg${i}`).src = URL.createObjectURL(blob);
      }).catch(()=>{});
    });
  }

  function guardarLoteCompleto(){
    if(!confirm(`¿Guardar ${loteTemporal.length} productos en el inventario?`)) return;
    loteTemporal.forEach((p,i)=>{
      p.name = document.getElementById(`loteName${i}`).value.trim() || p.code;
      p.barcode = document.getElementById(`loteBarcode${i}`).value.trim();
      p.price = Number(document.getElementById(`lotePrice${i}`).value) || 0;
      p.discount = Number(document.getElementById(`loteDiscount${i}`).value) || 0;
      p.quantity = Number(document.getElementById(`loteQuantity${i}`).value) || 0;
      p.description = document.getElementById(`loteDescription${i}`).value.trim();
      p.category = document.getElementById(`loteCategory${i}`).value;
    });
    inventory = inventory.concat(loteTemporal);
    localStorage.setItem('inventory', JSON.stringify(inventory));
    alert('Lote guardado ✅');
    loteTemporal = [];
    document.getElementById('editLoteBubble').style.display = 'none';
    renderTable(); calculateTotal();
  }

  // ===== CÓDIGO DE BARRAS EN TIEMPO REAL =====
  const barcodeInput = document.getElementById('barcode');
  const barcodeCanvas = document.getElementById('barcodeCanvas');

  function generarBarcode(value) {
    if (value.trim() === '') {
      barcodeCanvas.style.display = 'none';
      return;
    }

    // Mostrar canvas antes de dibujar
    barcodeCanvas.style.display = 'block';

    // Esperar a que el canvas esté visible
    setTimeout(() => {
      JsBarcode(barcodeCanvas, value, {
        format: "CODE128",
        lineColor: "#000",
        width: 2,
        height: 60,
        displayValue: true,
        fontSize: 14,
        margin: 5
      });
    }, 10);
  }

  barcodeInput.addEventListener('input', () => {
    generarBarcode(barcodeInput.value);
  });

  window.addEventListener('DOMContentLoaded',()=>{
    renderTable(); calculateTotal();
  });
</script>
