<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventario</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111827;
      --border: #e5e7eb;
      --accent: #000000;
      --highlight: #f9fafb;
      --danger: #ef4444;
      --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Inter", sans-serif; }
    body { display: flex; flex-direction: column; align-items: center; background: var(--bg); color: var(--text); }
    h1 { font-size: 1.5rem; font-weight: 600; text-align: center; margin: 1rem 0 0.5rem; }
    .container { width: 100vw; height: 100vh; background: var(--bg); padding: 1.5rem; display: flex; flex-direction: column; overflow: hidden; }
    .top-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
    #lowStockBox { background: var(--danger); color: #fff; padding: 0.3rem 0.6rem; border-radius: 4px; font-weight: 600; font-size: 0.8rem; display: none; }
    #reader { width: 320px; margin: 0.6rem auto; }
    .search-block { display: flex; flex-wrap: wrap; gap: 0.8rem; margin-bottom: 1rem; align-items: flex-end; }
    label { font-weight: 600; font-size: 0.9rem; }
    input, select { padding: 0.45rem 0.6rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem; background: var(--white); }
    button.stamp { padding: 0.45rem 0.9rem; border: 1px solid var(--accent); background: var(--white); color: var(--accent); font-weight: 500; font-size: 0.85rem; cursor: pointer; border-radius: 4px; transition: all 0.15s ease; }
    button.stamp:hover { background: var(--accent); color: var(--white); }
    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
    th, td { padding: 0.5rem 0.6rem; border: 1px solid var(--border); text-align: left; font-size: 0.85rem; }
    th { font-weight: 600; background: var(--highlight); }
    td img { max-height: 48px; border-radius: 4px; object-fit: cover; cursor: pointer; }
    .no-results { font-weight: 600; text-align: center; margin-top: 0.6rem; color: var(--danger); }
    .cards-view { display: none; flex-wrap: wrap; gap: 1rem; overflow-y: auto; justify-content: flex-start; }
    .card { background: var(--white); border: 1px solid var(--border); border-radius: 8px; box-shadow: var(--card-shadow); width: calc((100% - 4rem) / 5); display: flex; flex-direction: column; padding: 1rem; gap: 0.5rem; }
    .card img { width: 100%; height: 160px; object-fit: cover; border-radius: 6px; cursor: pointer; }
    .card-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; }
    .full-image-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-content: center; z-index: 9999; cursor: pointer; }
    .full-image-overlay img { max-width: 90vw; max-height: 90vh; border-radius: 8px; }
    #sideMenu { position: fixed; top: 0; right: -200px; width: 200px; height: 100vh; background: var(--highlight); border-left: 1px solid var(--border); box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1); transition: right 0.3s ease; z-index: 1000; padding: 1rem; display: flex; flex-direction: column; gap: 0.6rem; }
    #sideMenu.show { right: 0; }
    #menuToggleBtn { position: fixed; bottom: 1.2rem; right: 1.2rem; width: 3rem; height: 3rem; border-radius: 50%; border: none; background: var(--accent); color: var(--white); font-size: 1.4rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25); z-index: 1001; }
  </style>
</head>

<body>
  <button id="menuToggleBtn" onclick="toggleMenu()" title="Men√∫">‚ò∞</button>
  <nav id="sideMenu">
    <a href="menu.html"><i class="fa-solid fa-bars"></i> Men√∫</a>
    <a href="compra.html"><i class="fa-solid fa-cart-shopping"></i> Compra</a>
    <a href="almacenamiento.html"><i class="fa-solid fa-warehouse"></i> Inventario</a>
    <a href="lista.html"><i class="fa-solid fa-list"></i> Lista</a>
    <a href="inventario.html"><i class="fa-solid fa-boxes-stacked"></i> Inventario2</a>
    <a href="gastos.html"><i class="fa-solid fa-money-bill-trend-up"></i> Gastos</a>
    <a href="clientes.html"><i class="fa-solid fa-users"></i> Clientes</a>
    <a href="descuentos.html"><i class="fa-solid fa-percent"></i> Descuentos</a>
    <a href="facturas.html"><i class="fa-solid fa-file-invoice"></i> Facturas</a>
    <a href="traslados.html"><i class="fa-solid fa-truck"></i> Traslados</a>
    <a href="venta.html"><i class="fa-solid fa-cash-register"></i> Venta</a>
  </nav>

  <div class="container">
    <div class="top-bar">
      <div id="lowStockBox" title="Productos con stock bajo">‚ö†Ô∏è <span id="dashLow">-</span></div>
      <button class="stamp" onclick="startCameraScan()" title="Escanear con c√°mara">üì∑ C√°mara</button>
      <button class="stamp" onclick="applyFilters()">Buscar</button>
      <button class="stamp" onclick="clearAllFilters()">Limpiar</button>
      <button class="stamp" id="toggleViewBtn" onclick="toggleView()">Ver Tarjetas</button>
    </div>

    <div id="reader"></div>

    <div class="search-block">
      <div><label for="searchName">Buscar por nombre:</label><input type="text" id="searchName" placeholder="Parte del nombre"></div>
      <div><label for="searchCategory">Categor√≠a:</label>
        <select id="searchCategory">
          <option value="">Todas</option>
          <option>Accesorios para el cabello</option><option>Anillos</option><option>Aritos</option><option>Billeteras</option><option>Carteras</option><option>Case aud√≠fonos</option><option>Case tel√©fonos</option><option>Chokers</option><option>Collares</option><option>General</option><option>Lentes de sol</option><option>Otros</option><option>Pulseras</option><option>Relojes</option>
        </select>
      </div>
      <div><label for="searchCode">C√≥digo barras:</label><input type="text" id="searchCode" placeholder="Ej: 123456"></div>
      <div><label for="minPrice">Precio m√≠n:</label><input type="number" id="minPrice" placeholder="0" min="0" step="0.01"></div>
      <div><label for="maxPrice">Precio m√°x:</label><input type="number" id="maxPrice" placeholder="999999" min="0" step="0.01"></div>
      <div><label for="lowStockOnly">Stock bajo</label><input type="checkbox" id="lowStockOnly"></div>
    </div>

    <div style="display:flex; gap:.6rem; align-items:center; flex-wrap: wrap;">
      <label for="goToRow">Ir a fila:</label><input type="number" id="goToRow" min="1" style="width:80px;"><button class="stamp" onclick="goToRow()">Ir</button>
    </div>

    <div id="tableView" style="flex:1 1 auto; overflow:auto; margin-top:.5rem;">
      <table>
        <thead>
          <tr><th>#</th><th>Imagen</th><th>Nombre</th><th>C√≥digo de Barras</th><th>Precio</th><th>Desc(%)</th><th>Precio c/Desc</th><th>Categor√≠a</th><th>Stock</th><th>Acciones</th></tr>
        </thead>
        <tbody id="inventoryList"></tbody>
      </table>
      <div id="noResultsMessage" class="no-results" style="display:none;">No se encontraron productos.</div>
    </div>

    <div id="cardsView" class="cards-view"></div>
  </div>

  <script>
    /* ---------- IndexedDB Helper ---------- */
    const DB = {
      loadInventory: () => localforage.getItem('inventory').then(v => v || []),
      saveInventory: data => localforage.setItem('inventory', data)
    };

    let inventory = [];
    let currentView = localStorage.getItem('preferredView') || 'table';

    /* ---------- Escuchar cambios desde otras pesta√±as ---------- */
    window.addEventListener('storage', (e) => {
      if (e.key === 'inventory' && e.newValue) {
        location.reload(); // Recarga autom√°tica
      }
    });

    /* ---------- Cargar inventario al inicio ---------- */
    (function () {
      DB.loadInventory().then(function (data) {
        inventory = data;
        filterInventory();
        updateDash();
      });
    })();

    /* ---------- Utilidades ---------- */
    function updateDash() {
      const low = inventory.filter(p => (p.quantity || 0) <= (p.stockMin || 0)).length;
      document.getElementById('dashLow').textContent = low;
      document.getElementById('lowStockBox').style.display = low > 0 ? 'inline-block' : 'none';
    }

    function filterInventory() {
      const name = document.getElementById('searchName').value.trim().toLowerCase();
      const category = document.getElementById('searchCategory').value;
      const code = document.getElementById('searchCode').value.trim().toLowerCase();
      const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
      const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;
      const lowStock = document.getElementById('lowStockOnly').checked;

      let filtered = inventory.filter(it => {
        const okName = !name || it.name.toLowerCase().includes(name);
        const okCat = !category || it.category === category;
        const okCode = !code || it.barcode.toLowerCase().includes(code);
        const price = it.price * (1 - it.discount / 100);
        const okPrice = price >= minPrice && price <= maxPrice;
        const okStock = !lowStock || it.quantity <= (it.stockMin || 0);
        return okName && okCat && okCode && okPrice && okStock;
      });

      renderInventory(filtered);
    }

    function renderInventory(list) {
      const tbody = document.getElementById('inventoryList');
      const cards = document.getElementById('cardsView');
      const noResults = document.getElementById('noResultsMessage');

      if (!list.length) {
        tbody.innerHTML = '';
        cards.innerHTML = '';
        noResults.style.display = 'block';
        return;
      }

      noResults.style.display = 'none';

      tbody.innerHTML = list.map((item, idx) => {
        const priceWithDiscount = (item.price * (1 - item.discount / 100)).toFixed(2);
        return `<tr data-real-index="${inventory.indexOf(item)}">
          <td>${idx + 1}</td>
          <td><img id="img-${idx}" style="max-height:48px;border-radius:4px;cursor:pointer" onclick="openImageModal(this.src)" /></td>
          <td>${item.name}</td>
          <td>${item.barcode}</td>
          <td>$${item.price}</td>
          <td>${item.discount}%</td>
          <td>$${priceWithDiscount}</td>
          <td>${item.category}</td>
          <td>${item.quantity}</td>
          <td><button class="stamp" onclick="markSold(${inventory.indexOf(item)})">Vender</button></td>
        </tr>`;
      }).join('');

      cards.innerHTML = list.map((item, idx) => {
        const priceWithDiscount = (item.price * (1 - item.discount / 100)).toFixed(2);
        return `<div class="card" data-real-index="${inventory.indexOf(item)}">
          <img id="card-img-${idx}" onclick="openImageModal(this.src)" />
          <div><strong>${item.name}</strong></div>
          <div>Barras: ${item.barcode}</div>
          <div>Precio: $${priceWithDiscount} <small>(${item.discount}% dto)</small></div>
          <div>Stock: <strong>${item.quantity}</strong></div>
          <div>Cat: ${item.category}</div>
          <div class="card-footer">
            <button class="stamp" onclick="markSold(${inventory.indexOf(item)})">Vender</button>
          </div>
        </div>`;
      }).join('');

      list.forEach((item, idx) => {
        localforage.getItem(`img_${item.code}`).then(blob => {
          if (blob) {
            const url = URL.createObjectURL(blob);
            const imgTbl = document.getElementById(`img-${idx}`);
            const imgCard = document.getElementById(`card-img-${idx}`);
            if (imgTbl) imgTbl.src = url;
            if (imgCard) imgCard.src = url;
          }
        });
      });
    }

    function toggleView() {
      const btn = document.getElementById('toggleViewBtn');
      const table = document.getElementById('tableView');
      const cards = document.getElementById('cardsView');

      if (currentView === 'table') {
        currentView = 'cards';
        table.style.display = 'none';
        cards.style.display = 'flex';
        btn.textContent = 'Ver Tabla';
      } else {
        currentView = 'table';
        table.style.display = 'block';
        cards.style.display = 'none';
        btn.textContent = 'Ver Tarjetas';
      }

      localStorage.setItem('preferredView', currentView);
    }

    function openImageModal(src) {
      const overlay = document.createElement('div');
      overlay.className = 'full-image-overlay';
      const img = document.createElement('img');
      img.src = src;
      overlay.appendChild(img);
      document.body.appendChild(overlay);
      overlay.addEventListener('click', () => document.body.removeChild(overlay));
    }

    function clearAllFilters() {
      ['searchName', 'searchCategory', 'searchCode', 'minPrice', 'maxPrice', 'lowStockOnly'].forEach(id => {
        const el = document.getElementById(id);
        if (el.type === 'checkbox') el.checked = false; else el.value = '';
      });
      filterInventory();
    }

    function goToRow() {
      const row = parseInt(document.getElementById('goToRow').value);
      if (currentView === 'table') {
        const rows = document.querySelectorAll('#inventoryList tr');
        rows.forEach(r => r.classList.remove('highlight'));
        if (row >= 1 && row <= rows.length) {
          const target = rows[row - 1];
          target.classList.add('highlight');
          target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else alert('Fila fuera de rango.');
      } else {
        const cards = document.querySelectorAll('.card');
        cards.forEach(c => c.classList.remove('highlight'));
        if (row >= 1 && cards.length) {
          const target = cards[row - 1];
          target.classList.add('highlight');
          target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else alert('Fila fuera de rango.');
      }
    }

    function toggleMenu() {
      document.getElementById('sideMenu').classList.toggle('show');
    }

    document.addEventListener('click', e => {
      const menu = document.getElementById('sideMenu');
      const btn = document.getElementById('menuToggleBtn');
      if (menu.classList.contains('show') && !menu.contains(e.target) && e.target !== btn) {
        menu.classList.remove('show');
      }
    });

    /* ---------- Vista inicial ---------- */
    if (currentView === 'cards') {
      document.getElementById('tableView').style.display = 'none';
      document.getElementById('cardsView').style.display = 'flex';
      document.getElementById('toggleViewBtn').textContent = 'Ver Tabla';
    }

    /* ---------- Filtros en tiempo real ---------- */
    ['searchName', 'searchCategory', 'searchCode', 'minPrice', 'maxPrice', 'lowStockOnly'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', () => {
        clearTimeout(window.filterT);
        window.filterT = setTimeout(filterInventory, 300);
      });
      if (el.type === 'select-one') el.addEventListener('change', filterInventory);
    });
  </script>
</body>
</html>
