<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FINANZAS A FAMILY COMPANY</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --bg: #f4f6f8;
      --card: #ffffff;
      --primary: #1a73e8;
      --secondary: #0d47a1;
      --text: #2c3e50;
      --muted: #7f8c8d;
      --radius: 12px;
      --shadow: 0 3px 10px rgba(0,0,0,.05);
    }
    body.dark {
      --bg: #0f1116;
      --card: #1a1d24;
      --text: #e0e0e0;
      --muted: #8a8a8a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background .3s, color .3s;
    }
    header {
      background: var(--card);
      padding: 1.2rem 2rem;
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--primary);
      text-align: center;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header button {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      padding: .5rem 1rem;
      cursor: pointer;
      font-weight: 600;
    }
    nav {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      background: var(--card);
      border-bottom: 1px solid #ddd;
    }
    .tab {
      padding: 1rem 1.4rem;
      cursor: pointer;
      font-weight: 500;
      color: var(--muted);
      transition: color .2s;
    }
    .tab.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
    }
    main {
      padding: 2rem;
      max-width: 1200px;
      margin: auto;
    }
    section {
      display: none;
      animation: fadeIn .4s ease-in-out;
    }
    section.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax 200px, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .card {
      background: var(--card);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
      transition: transform .2s;
    }
    .card:hover { transform: translateY(-4px); }
    .card h3 { font-size: .9rem; color: var(--muted); margin-bottom: .5rem; }
    .card p { font-size: 1.5rem; font-weight: 600; color: var(--primary); }
    canvas { display: block; margin: 2rem auto; max-width: 350px; }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax 200px, 1fr);
      gap: 1rem;
      background: var(--card);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 1rem;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: var(--radius);
      background: var(--bg);
      color: var(--text);
      font-family: inherit;
      font-size: .9rem;
    }
    textarea { resize: vertical; min-height: 60px; }
    button {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
      transition: background .2s;
    }
    button:hover { background: var(--secondary); }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      font-size: .85rem;
    }
    body.dark th, body.dark td { border-color: #333; }
    th {
      background: #f8f9fa;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .5px;
      cursor: pointer;
    }
    body.dark th { background: #101217; }
    tr:nth-child(even) { background: #f9fafb; }
    body.dark tr:nth-child(even) { background: #15171c; }
    tr:hover td { background: #f3f6fa; }
    body.dark tr:hover td { background: #1f232a; }
    .acciones button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.1rem;
      margin: 0 4px;
    }
    .acciones .editar { color: var(--primary); }
    .acciones .eliminar { color: #e53935; }
    .excel-bar {
      display: flex;
      gap: .5rem;
      margin-bottom: .5rem;
    }
    .filtro {
      width: 100%;
      margin-bottom: .5rem;
    }
    .total-tabla {
      text-align: right;
      font-weight: 700;
      margin-top: .5rem;
      color: var(--primary);
    }
    .vencida {
      background: #ffe5e5 !important;
    }
    body.dark .vencida {
      background: #3a1e1e !important;
    }
    #toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: var(--primary);
      color: #fff;
      padding: .7rem 1.2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: none;
      font-weight: 600;
      z-index: 999;
    }
  </style>
</head>
<body>
<header>
  <span>üìä FINANZAS A FAMILY COMPANY</span>
  <button id="toggleTheme">üåó Toggle</button>
</header>

<nav>
  <div class="tab active" data-tab="dashboard">Dashboard</div>
  <div class="tab" data-tab="ingresos">Ingresos</div>
  <div class="tab" data-tab="gastos">Gastos</div>
  <div class="tab" data-tab="gastosDesdeIngresos">Gastos desde Ingresos</div>
  <div class="tab" data-tab="proveedores">Proveedores</div>
  <div class="tab" data-tab="cuentas">Cuentas Pendientes</div>
  <div class="tab" data-tab="inventario">Inventario</div>
</nav>

<main>
  <!-- DASHBOARD -->
  <section id="dashboard" class="active">
    <h2>Resumen General</h2>
    <div class="dashboard">
      <div class="card"><h3>Total Ingresos</h3><p id="totalIngresos">$0.00</p></div>
      <div class="card"><h3>Gastos desde Ingresos</h3><p id="totalGastosDesdeIngresos">$0.00</p></div>
      <div class="card"><h3>Ingreso Neto</h3><p id="ingresoNeto">$0.00</p></div>
      <div class="card"><h3>Total Gastos</h3><p id="totalGastos">$0.00</p></div>
      <div class="card"><h3>Saldo Neto Final</h3><p id="balance">$0.00</p></div>
    </div>
    <canvas id="chartResumen"></canvas>
    <canvas id="chartMensual"></canvas>
  </section>

  <!-- INGRESOS -->
  <section id="ingresos">
    <h2>Ingresos</h2>
    <input class="filtro" id="filtroIngresos" placeholder="Filtrar por fecha, descripci√≥n, categor√≠a...">
    <table id="tablaIngresos">
      <thead>
        <tr>
          <th data-sort="numero">#</th>
          <th data-sort="fecha">Fecha</th>
          <th data-sort="descripcion">Descripci√≥n</th>
          <th data-sort="categoria">Categor√≠a</th>
          <th data-sort="monto">Monto</th>
          <th>M√©todo Pago</th>
          <th>Responsable</th>
          <th>Observaciones</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="total-tabla" id="totalIngresosTabla">Total: $0.00</div>
  </section>

  <!-- GASTOS -->
  <section id="gastos">
    <h2>Gastos</h2>
    <form id="formGasto">
      <input name="fecha" type="date" required>
      <input name="proveedor" list="proveedoresList" placeholder="Proveedor">
      <datalist id="proveedoresList"></datalist>
      <input name="categoria" placeholder="Categor√≠a">
      <input name="descripcion" placeholder="Descripci√≥n">
      <input name="monto" type="number" step="0.01" placeholder="Monto" required>
      <input name="metodo_pago" placeholder="M√©todo de pago">
      <input name="responsable" placeholder="Responsable">
      <textarea name="observaciones" placeholder="Observaciones"></textarea>
      <button type="submit">Guardar</button>
    </form>
    <div class="excel-bar">
      <button id="exportGastos">Exportar Excel</button>
      <button id="exportGastosPDF">Exportar PDF</button>
      <label for="importGastos" style="display:inline-block;background:#388e3c;color:#fff;padding:10px 16px;border-radius:var(--radius);cursor:pointer">Importar Excel</label>
      <input type="file" id="importGastos" accept=".xlsx,.xls" style="display:none">
    </div>
    <input class="filtro" id="filtroGastos" placeholder="Filtrar...">
    <table id="tablaGastos">
      <thead>
        <tr>
          <th data-sort="fecha">Fecha</th>
          <th data-sort="proveedor">Proveedor</th>
          <th data-sort="categoria">Categor√≠a</th>
          <th data-sort="descripcion">Descripci√≥n</th>
          <th data-sort="monto">Monto</th>
          <th>M√©todo Pago</th>
          <th>Responsable</th>
          <th>Observaciones</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="total-tabla" id="totalGastosTabla">Total: $0.00</div>
  </section>

  <!-- GASTOS DESDE INGRESOS -->
  <section id="gastosDesdeIngresos">
    <h2>Gastos desde Ingresos</h2>
    <form id="formGastosDesdeIngresos">
      <input name="fecha" type="date" required>
      <input name="descripcion" placeholder="Descripci√≥n" required>
      <input name="categoria" placeholder="Categor√≠a">
      <input name="monto" type="number" step="0.01" placeholder="Monto" required>
      <input name="responsable" placeholder="Responsable">
      <textarea name="observaciones" placeholder="Observaciones"></textarea>
      <button type="submit">Guardar</button>
    </form>
    <div class="excel-bar">
      <button id="exportGastosDesdeIngresos">Exportar Excel</button>
      <button id="exportGastosDesdeIngresosPDF">Exportar PDF</button>
      <label for="importGastosDesdeIngresos" style="display:inline-block;background:#388e3c;color:#fff;padding:10px 16px;border-radius:var(--radius);cursor:pointer">Importar Excel</label>
      <input type="file" id="importGastosDesdeIngresos" accept=".xlsx,.xls" style="display:none">
    </div>
    <input class="filtro" id="filtroGastosDesdeIngresos" placeholder="Filtrar...">
    <table id="tablaGastosDesdeIngresos">
      <thead>
        <tr>
          <th data-sort="fecha">Fecha</th>
          <th data-sort="descripcion">Descripci√≥n</th>
          <th data-sort="categoria">Categor√≠a</th>
          <th data-sort="monto">Monto</th>
          <th>Responsable</th>
          <th>Observaciones</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="total-tabla" id="totalGastosDesdeIngresosTabla">Total: $0.00</div>
  </section>

  <!-- PROVEEDORES -->
  <section id="proveedores">
    <h2>Proveedores</h2>
    <form id="formProveedor">
      <input name="nombre" placeholder="Nombre" required>
      <input name="nit" placeholder="NIT">
      <input name="telefono" placeholder="Tel√©fono">
      <input name="email" type="email" placeholder="Email">
      <input name="direccion" placeholder="Direcci√≥n">
      <textarea name="observaciones" placeholder="Observaciones"></textarea>
      <button type="submit">Guardar</button>
    </form>
    <div class="excel-bar">
      <button id="exportProveedores">Exportar Excel</button>
      <button id="exportProveedoresPDF">Exportar PDF</button>
      <label for="importProveedores" style="display:inline-block;background:#388e3c;color:#fff;padding:10px 16px;border-radius:var(--radius);cursor:pointer">Importar Excel</label>
      <input type="file" id="importProveedores" accept=".xlsx,.xls" style="display:none">
    </div>
    <input class="filtro" id="filtroProveedores" placeholder="Filtrar...">
    <table id="tablaProveedores">
      <thead>
        <tr>
          <th data-sort="nombre">Nombre</th>
          <th data-sort="nit">NIT</th>
          <th data-sort="telefono">Tel√©fono</th>
          <th data-sort="email">Email</th>
          <th data-sort="direccion">Direcci√≥n</th>
          <th>Observaciones</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- CUENTAS -->
  <section id="cuentas">
    <h2>Cuentas Pendientes</h2>
    <form id="formCuenta">
      <select name="tipo"><option>Por cobrar</option><option>Por pagar</option></select>
      <input name="cliente_proveedor" placeholder="Cliente / Proveedor">
      <input name="concepto" placeholder="Concepto">
      <input name="monto" type="number" step="0.01" placeholder="Monto" required>
      <input name="fecha_vencimiento" type="date">
      <select name="estado"><option>Pendiente</option><option>Pagado</option></select>
      <textarea name="observaciones" placeholder="Observaciones"></textarea>
      <button type="submit">Guardar</button>
    </form>
    <div class="excel-bar">
      <button id="exportCuentas">Exportar Excel</button>
      <button id="exportCuentasPDF">Exportar PDF</button>
      <label for="importCuentas" style="display:inline-block;background:#388e3c;color:#fff;padding:10px 16px;border-radius:var(--radius);cursor:pointer">Importar Excel</label>
      <input type="file" id="importCuentas" accept=".xlsx,.xls" style="display:none">
    </div>
    <input class="filtro" id="filtroCuentas" placeholder="Filtrar...">
    <table id="tablaCuentas">
      <thead>
        <tr>
          <th>Tipo</th>
          <th>Cliente/Proveedor</th>
          <th>Concepto</th>
          <th>Monto</th>
          <th>Fecha Vencimiento</th>
          <th>Estado</th>
          <th>Observaciones</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- INVENTARIO -->
  <section id="inventario">
    <h2>Inventario</h2>
    <form id="formProducto">
      <input name="nombre" placeholder="Nombre del producto" required>
      <input name="codigo" placeholder="C√≥digo" required>
      <input name="cantidad" type="number" placeholder="Cantidad" required>
      <input name="precio" type="number" step="0.01" placeholder="Precio unitario" required>
      <button type="submit">Agregar</button>
    </form>

    <h3>Vender Producto</h3>
    <form id="formVenta">
      <input name="codigo" placeholder="C√≥digo de producto" required>
      <input name="cantidad" type="number" placeholder="Cantidad a vender" required>
      <button type="submit">Vender</button>
    </form>

    <h3>Lista de Productos</h3>
    <table id="tablaInventario">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>C√≥digo</th>
          <th>Cantidad</th>
          <th>Precio</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<footer style="text-align:center;padding:1rem;color:#999;font-size:.8rem;">¬© 2025 Panel Financiero Empresarial</footer>
<div id="toast"></div>

<script>
/* ---------- UTILS ---------- */
const $ = q => document.querySelector(q);
const $$ = q => document.querySelectorAll(q);
function toast(msg) {
  const t = $('#toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 2000);
}
function downloadObjectAsJson(obj, filename) {
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

/* ---------- TEMA ---------- */
$('#toggleTheme').onclick = () => {
  document.body.classList.toggle('dark');
  toast('Tema cambiado');
};

/* ---------- NAVEGACI√ìN ---------- */
$$('.tab').forEach(btn => {
  btn.addEventListener('click', () => {
    $$('.tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const id = btn.dataset.tab;
    $$('section').forEach(s => s.classList.remove('active'));
    $('#' + id).classList.add('active');
  });
});

/* ---------- DATOS ---------- */
const data = {
  ingresos: [],
  gastos: JSON.parse(localStorage.getItem('gastos') || '[]'),
  proveedores: JSON.parse(localStorage.getItem('proveedores') || '[]'),
  cuentas: JSON.parse(localStorage.getItem('cuentas') || '[]')
};
let gastosDesdeIngresos = JSON.parse(localStorage.getItem('gastosDesdeIngresos') || '[]');
let inventario = JSON.parse(localStorage.getItem('inventario')) || [];

function saveData() {
  for (const k in data) localStorage.setItem(k, JSON.stringify(data[k]));
  localStorage.setItem('gastosDesdeIngresos', JSON.stringify(gastosDesdeIngresos));
  localStorage.setItem('inventario', JSON.stringify(inventario));
  actualizarDashboard();
  downloadObjectAsJson({ ...data, gastosDesdeIngresos, inventario }, 'backup_' + Date.now() + '.json');
  toast('Guardado');
}

/* ---------- GR√ÅFICOS ---------- */
const ctx = $('#chartResumen').getContext('2d');
const chartResumen = new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: ['Ingreso Neto', 'Gastos', 'Saldo Neto'],
    datasets: [{
      data: [0, 0, 0],
      backgroundColor: ['#1a73e8', '#e53935', '#43a047'],
      hoverOffset: 10
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'bottom' }
    }
  }
});

const ctxMensual = $('#chartMensual').getContext('2d');
const chartMensual = new Chart(ctxMensual, {
  type: 'bar',
  data: {
    labels: [],
    datasets: [{
      label: 'Ingresos',
      data: [],
      backgroundColor: '#1a73e8'
    }, {
      label: 'Gastos',
      data: [],
      backgroundColor: '#e53935'
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'bottom' }
    }
  }
});

function actualizarDashboard() {
  const ti = data.ingresos.reduce((a, i) => a + parseFloat(i.monto || 0), 0);
  const tg = data.gastos.reduce((a, g) => a + parseFloat(g.monto || 0), 0);
  const gdi = gastosDesdeIngresos.reduce((a, g) => a + parseFloat(g.monto || 0), 0);
  const ingresoNeto = ti - gdi;
  const balance = ingresoNeto - tg;

  $('#totalIngresos').textContent = '$' + ti.toFixed(2);
  $('#totalGastosDesdeIngresos').textContent = '$' + gdi.toFixed(2);
  $('#ingresoNeto').textContent = '$' + ingresoNeto.toFixed(2);
  $('#totalGastos').textContent = '$' + tg.toFixed(2);
  $('#balance').textContent = '$' + balance.toFixed(2);

  chartResumen.data.datasets[0].data = [ingresoNeto, tg, Math.abs(balance)];
  chartResumen.update();

  const meses = {};
  data.ingresos.forEach(i => {
    const m = i.fecha.slice(0, 7);
    meses[m] = meses[m] || { ingresos: 0, gastos: 0 };
    meses[m].ingresos += parseFloat(i.monto);
  });
  data.gastos.forEach(g => {
    const m = g.fecha.slice(0, 7);
    meses[m] = meses[m] || { ingresos: 0, gastos: 0 };
    meses[m].gastos += parseFloat(g.monto);
  });
  const labels = Object.keys(meses).sort();
  chartMensual.data.labels = labels;
  chartMensual.data.datasets[0].data = labels.map(m => meses[m].ingresos);
  chartMensual.data.datasets[1].data = labels.map(m => meses[m].gastos);
  chartMensual.update();
}

/* ---------- INGRESOS DESDE VENTAS ---------- */
function cargarVentasComoIngresos() {
  const ventas = JSON.parse(localStorage.getItem('soldInventory')) || [];
  data.ingresos = ventas.map((v, idx) => ({
    numero: idx + 1,
    fecha: new Date().toISOString().split('T')[0],
    descripcion: `Venta: ${v.name} (C√≥d: ${v.code})`,
    categoria: 'Venta',
    monto: parseFloat(v.total).toFixed(2),
    metodo_pago: 'Efectivo',
    responsable: 'Sistema',
    observaciones: `Cantidad vendida: ${v.quantity}`
  }));
  saveData();
  renderTable('tablaIngresos', data.ingresos, ['numero','fecha','descripcion','categoria','monto','metodo_pago','responsable','observaciones'], 'ingresos');
}

/* ---------- RENDER + FILTRO + SORT ---------- */
let sortDirection = {};

function renderTable(id, arr, keys, keyName) {
  const tbody = $('#' + id + ' tbody');
  tbody.innerHTML = arr.map((it, i) => `
    <tr>
      ${keys.map(k => `<td>${it[k] || ''}</td>`).join('')}
      <td class="acciones">${keyName === 'ingresos' ? 'Solo lectura' : `
        <button class="editar" data-key="${keyName}" data-index="${i}">‚úèÔ∏è</button>
        <button class="eliminar" data-key="${keyName}" data-index="${i}">üóëÔ∏è</button>`}
      </td>
    </tr>`).join('');
  const total = arr.reduce((a, it) => a + parseFloat(it.monto || 0), 0);
  $('#total' + id.replace('tabla', '') + 'Tabla').textContent = 'Total: $' + total.toFixed(2);
}

function filterTable(id, arr, keys, keyName) {
  const filtro = $('#filtro' + id.replace('tabla', '')).value.toLowerCase();
  const filtrado = arr.filter(it =>
    keys.some(k => String(it[k] || '').toLowerCase().includes(filtro))
  );
  renderTable(id, filtrado, keys, keyName);
}

function sortTable(id, arr, keys, keyName, key) {
  const dir = sortDirection[key] === 'asc' ? 'desc' : 'asc';
  sortDirection[key] = dir;
  arr.sort((a, b) => {
    const va = String(a[key] || '').toLowerCase();
    const vb = String(b[key] || '').toLowerCase();
    return dir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
  });
  renderTable(id, arr, keys, keyName);
}

/* ---------- FORMULARIOS ---------- */
const forms = [
  { id: 'formGasto', key: 'gastos', table: 'tablaGastos', fields: ['fecha','proveedor','categoria','descripcion','monto','metodo_pago','responsable','observaciones'] },
  { id: 'formProveedor', key: 'proveedores', table: 'tablaProveedores', fields: ['nombre','nit','telefono','email','direccion','observaciones'] },
  { id: 'formCuenta', key: 'cuentas', table: 'tablaCuentas', fields: ['tipo','cliente_proveedor','concepto','monto','fecha_vencimiento','estado','observaciones'] }
];

forms.forEach(f => {
  const form = $('#' + f.id);
  form.addEventListener('submit', e => {
    e.preventDefault();
    const item = {};
    f.fields.forEach(k => item[k] = form[k].value);
    const duplicado = data[f.key].some(it =>
      it.descripcion === item.descripcion &&
      it.monto === item.monto &&
      it.fecha === item.fecha
    );
    if (duplicado) {
      toast('Duplicado detectado');
      return;
    }
    data[f.key].push(item);
    saveData();
    renderTable(f.table, data[f.key], f.fields, f.key);
    form.reset();
  });
  renderTable(f.table, data[f.key], f.fields, f.key);
  const filtroId = 'filtro' + f.table.replace('tabla', '');
  $('#' + filtroId).addEventListener('input', () => filterTable(f.table, data[f.key], f.fields, f.key));
  $$('#' + f.table + ' thead th').forEach(th => {
    if (th.dataset.sort) {
      th.addEventListener('click', () => sortTable(f.table, data[f.key], f.fields, f.key, th.dataset.sort));
    }
  });
});

/* ---------- INVENTARIO ---------- */
$('#formProducto').addEventListener('submit', e => {
  e.preventDefault();
  const f = e.target;
  inventario.push({
    nombre: f.nombre.value,
    codigo: f.codigo.value,
    cantidad: parseInt(f.cantidad.value),
    precio: parseFloat(f.precio.value)
  });
  saveData();
  renderInventario();
  f.reset();
});

$('#formVenta').addEventListener('submit', e => {
  e.preventDefault();
  const f = e.target;
  const codigo = f.codigo.value;
  const cantidad = parseInt(f.cantidad.value);
  const prod = inventario.find(p => p.codigo === codigo);
  if (!prod) {
    toast('Producto no encontrado');
    return;
  }
  if (prod.cantidad < cantidad) {
    toast('Stock insuficiente');
    return;
  }
  prod.cantidad -= cantidad;
  const venta = {
    name: prod.nombre,
    code: codigo,
    quantity: cantidad,
    total: cantidad * prod.precio
  };
  let ventas = JSON.parse(localStorage.getItem('soldInventory')) || [];
  ventas.push(venta);
  localStorage.setItem('soldInventory', JSON.stringify(ventas));
  saveData();
  renderInventario();
  cargarVentasComoIngresos();
  f.reset();
  toast('Venta registrada');
});

function renderInventario() {
  const tbody = $('#tablaInventario tbody');
  tbody.innerHTML = inventario.map((p, i) => `
    <tr>
      <td>${p.nombre}</td>
      <td>${p.codigo}</td>
      <td>${p.cantidad}</td>
      <td>$${p.precio.toFixed(2)}</td>
      <td class="acciones">
        <button class="editar" data-index="${i}">‚úèÔ∏è</button>
        <button class="eliminar" data-index="${i}">üóëÔ∏è</button>
      </td>
    </tr>`).join('');
}

$('#tablaInventario').addEventListener('click', e => {
  if (e.target.classList.contains('eliminar')) {
    const i = e.target.dataset.index;
    if (confirm('¬øEliminar producto?')) {
      inventario.splice(i, 1);
      saveData();
      renderInventario();
    }
  }
  if (e.target.classList.contains('editar')) {
    const i = e.target.dataset.index;
    const p = inventario[i];
    const nuevoNombre = prompt('Nombre:', p.nombre);
    const nuevaCantidad = prompt('Cantidad:', p.cantidad);
    const nuevoPrecio = prompt('Precio:', p.precio);
    if (nuevoNombre !== null && nuevaCantidad !== null && nuevoPrecio !== null) {
      p.nombre = nuevoNombre;
      p.cantidad = parseInt(nuevaCantidad);
      p.precio = parseFloat(nuevoPrecio);
      saveData();
      renderInventario();
    }
  }
});

/* ---------- GASTOS DESDE INGRESOS ---------- */
const formGDI = $('#formGastosDesdeIngresos');
formGDI.addEventListener('submit', e => {
  e.preventDefault();
  const item = {
    fecha: formGDI.fecha.value,
    descripcion: formGDI.descripcion.value,
    categoria: formGDI.categoria.value,
    monto: parseFloat(formGDI.monto.value),
    responsable: formGDI.responsable.value,
    observaciones: formGDI.observaciones.value
  };
  gastosDesdeIngresos.push(item);
  saveData();
  renderTable('tablaGastosDesdeIngresos', gastosDesdeIngresos, ['fecha','descripcion','categoria','monto','responsable','observaciones'], 'gastosDesdeIngresos');
  formGDI.reset();
});
renderTable('tablaGastosDesdeIngresos', gastosDesdeIngresos, ['fecha','descripcion','categoria','monto','responsable','observaciones'], 'gastosDesdeIngresos');
$('#filtroGastosDesdeIngresos').addEventListener('input', () => filterTable('tablaGastosDesdeIngresos', gastosDesdeIngresos, ['fecha','descripcion','categoria','monto','responsable','observaciones'], 'gastosDesdeIngresos'));
$$('#tablaGastosDesdeIngresos thead th').forEach(th => {
  if (th.dataset.sort) {
    th.addEventListener('click', () => sortTable('tablaGastosDesdeIngresos', gastosDesdeIngresos, ['fecha','descripcion','categoria','monto','responsable','observaciones'], 'gastosDesdeIngresos', th.dataset.sort));
  }
});

/* ---------- EDITAR / ELIMINAR ---------- */
document.addEventListener('click', e => {
  if (e.target.classList.contains('eliminar')) {
    const { key, index } = e.target.dataset;
    if (key === 'ingresos') return;
    if (confirm('¬øEliminar este registro?')) {
      if (key === 'gastosDesdeIngresos') {
        gastosDesdeIngresos.splice(index, 1);
        localStorage.setItem('gastosDesdeIngresos', JSON.stringify(gastosDesdeIngresos));
        renderTable('tablaGastosDesdeIngresos', gastosDesdeIngresos, ['fecha','descripcion','categoria','monto','responsable','observaciones'], 'gastosDesdeIngresos');
      } else {
        data[key].splice(index, 1);
        saveData();
        const f = forms.find(x => x.key === key);
        renderTable(f.table, data[key], f.fields, key);
      }
      actualizarDashboard();
    }
  }
  if (e.target.classList.contains('editar')) {
    const { key, index } = e.target.dataset;
    if (key === 'ingresos') return;
    if (key === 'gastosDesdeIngresos') {
      const item = gastosDesdeIngresos[index];
      formGDI.fecha.value = item.fecha;
      formGDI.descripcion.value = item.descripcion;
      formGDI.categoria.value = item.categoria;
      formGDI.monto.value = item.monto;
      formGDI.responsable.value = item.responsable;
      formGDI.observaciones.value = item.observaciones;
      gastosDesdeIngresos.splice(index, 1);
      saveData();
      renderTable('tablaGastosDesdeIngresos', gastosDesdeIngresos, ['fecha','descripcion','categoria','monto','responsable','observaciones'], 'gastosDesdeIngresos');
    } else {
      const f = forms.find(x => x.key === key);
      const form = $('#' + f.id);
      const item = data[key][index];
      f.fields.forEach(k => form[k].value = item[k] || '');
      data[key].splice(index, 1);
      saveData();
      renderTable(f.table, data[key], f.fields, key);
    }
    actualizarDashboard();
  }
});

/* ---------- EXCEL ---------- */
function exportExcel(key, filename) {
  let source = key === 'gastosDesdeIngresos' ? gastosDesdeIngresos : data[key];
  const ws = XLSX.utils.json_to_sheet(source);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, key);
  XLSX.writeFile(wb, filename);
}
function importExcel(file, key, fields) {
  const reader = new FileReader();
  reader.onload = function (e) {
    const wb = XLSX.read(e.target.result, { type: 'binary' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
    rows.forEach(r => {
      const item = {};
      fields.forEach(f => item[f] = r[f] || '');
      if (key === 'gastosDesdeIngresos') gastosDesdeIngresos.push(item);
      else data[key].push(item);
    });
    saveData();
    if (key === 'gastosDesdeIngresos') {
      renderTable('tablaGastosDesdeIngresos', gastosDesdeIngresos, fields, key);
    } else {
      const f = forms.find(x => x.key === key);
      renderTable(f.table, data[key], fields, key);
    }
  };
  reader.readAsBinaryString(file);
}

/* ---------- PDF ---------- */
function exportPDF(key, filename, cols, rows) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text(filename, 14, 10);
  doc.autoTable({
    head: [cols],
    body: rows
  });
  doc.save(filename + '.pdf');
}
$('#exportGastosPDF').onclick = () => {
  const cols = ['Fecha','Proveedor','Categor√≠a','Descripci√≥n','Monto','M√©todo Pago','Responsable','Observaciones'];
  const rows = data.gastos.map(g => cols.map(c => g[c.toLowerCase().replace(' ', '_')] || ''));
  exportPDF('gastos', 'gastos', cols, rows);
};
$('#exportGastosDesdeIngresosPDF').onclick = () => {
  const cols = ['Fecha','Descripci√≥n','Categor√≠a','Monto','Responsable','Observaciones'];
  const rows = gastosDesdeIngresos.map(g => cols.map(c => g[c.toLowerCase().replace(' ', '_')] || ''));
  exportPDF('gastosDesdeIngresos', 'gastos_desde_ingresos', cols, rows);
};
$('#exportProveedoresPDF').onclick = () => {
  const cols = ['Nombre','NIT','Tel√©fono','Email','Direcci√≥n','Observaciones'];
  const rows = data.proveedores.map(p => cols.map(c => p[c.toLowerCase().replace(' ', '_')] || ''));
  exportPDF('proveedores', 'proveedores', cols, rows);
};
$('#exportCuentasPDF').onclick = () => {
  const cols = ['Tipo','Cliente/Proveedor','Concepto','Monto','Fecha Vencimiento','Estado','Observaciones'];
  const rows = data.cuentas.map(c => cols.map(col => c[col.toLowerCase().replace(/ /g, '_')] || ''));
  exportPDF('cuentas', 'cuentas_pendientes', cols, rows);
};

/* ---------- BOTONES EXPORTAR EXCEL ---------- */
$('#exportGastos').onclick = () => exportExcel('gastos', 'gastos.xlsx');
$('#exportGastosDesdeIngresos').onclick = () => exportExcel('gastosDesdeIngresos', 'gastos_desde_ingresos.xlsx');
$('#exportProveedores').onclick = () => exportExcel('proveedores', 'proveedores.xlsx');
$('#exportCuentas').onclick = () => exportExcel('cuentas', 'cuentas.xlsx');

/* ---------- BOTONES IMPORTAR EXCEL ---------- */
$('#importGastos').onchange = function (e) { importExcel(e.target.files[0], 'gastos', ['fecha','proveedor','categoria','descripcion','monto','metodo_pago','responsable','observaciones']); this.value = ''; };
$('#importGastosDesdeIngresos').onchange = function (e) { importExcel(e.target.files[0], 'gastosDesdeIngresos', ['fecha','descripcion','categoria','monto','responsable','observaciones']); this.value = ''; };
$('#importProveedores').onchange = function (e) { importExcel(e.target.files[0], 'proveedores', ['nombre','nit','telefono','email','direccion','observaciones']); this.value = ''; };
$('#importCuentas').onchange = function (e) { importExcel(e.target.files[0], 'cuentas', ['tipo','cliente_proveedor','concepto','monto','fecha_vencimiento','estado','observaciones']); this.value = ''; };

/* ---------- INICIALIZAR ---------- */
cargarVentasComoIngresos();
actualizarDashboard();
renderInventario();
document.title = 'üí∞ Finanzas - ' + new Date().toLocaleDateString();
window.addEventListener('storage', () => {
  cargarVentasComoIngresos();
  actualizarDashboard();
  renderInventario();
});
</script>
</body>
</html>
