<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex,nofollow">
  <title>Dashboard – TOBIAS PALACIOS</title>

  <!-- Google Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    /* Variables de diseño */
    :root {
      --bg: #ffffff;
      --panel: #ffffff;
      --accent: #DBB8BC;
      --text: #1F2937;
      --muted: #9CA3AF;
      --danger: #EF4444;
      --border: #DBB8BC;
      --transition-speed: 0.2s;
    }

    /* Reset y base */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      display: flex;
      min-height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--panel);
      display: flex;
      flex-direction: column;
      padding: 1.5rem 1rem;
      border-right: 1px solid var(--border);
      height: 100vh;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: .6rem;
      flex-grow: 1;
      overflow-y: auto;
      list-style: none; /* Mejor semántica si usas <ul> */
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: .8rem;
      padding: .8rem 1rem;
      border-radius: 10px;
      text-decoration: none;
      color: var(--text);
      font-size: 1rem;
      font-weight: 500;
      transition: background var(--transition-speed) ease,
                  transform var(--transition-speed) ease,
                  color var(--transition-speed) ease;
      white-space: nowrap;
      border: none;
      background: transparent;
      cursor: pointer;
      width: 100%;
    }

    .nav-link:hover {
      background: rgba(219, 184, 188, .15);
      transform: translateX(5px);
    }

    .nav-link.active {
      background: var(--accent);
      color: #fff;
    }

    .nav-link:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Iconos */
    .nav-link .material-icons {
      font-size: 22px;
      flex-shrink: 0; /* Evita que los iconos se deformen */
    }

    /* Main content */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem clamp(1rem, 4vw, 2.5rem); /* Padding responsivo */
    }

    .welcome {
      font-size: clamp(1.8rem, 5vw, 2.4rem); /* Texto fluido */
      font-weight: 800;
      color: var(--accent);
      margin-bottom: .3rem;
    }

    .subtitle {
      font-size: clamp(1rem, 2.5vw, 1.1rem);
      color: var(--muted);
    }

    /* Panel derecho */
    .right-panel {
      position: absolute;
      right: 1.5rem;
      top: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      height: calc(100% - 2rem);
      min-height: 120px; /* Evita colapso en pantallas pequeñas */
    }

    .user-section {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .user-avatar {
      width: 85px;
      height: 85px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--accent);
      background: #fff;
    }

    .user-name {
      margin-top: .5rem;
      font-weight: 700;
      font-size: 1rem;
    }

    .logout-btn {
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: .8rem 1.5rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background var(--transition-speed) ease,
                  transform var(--transition-speed) ease;
      display: inline-flex;
      align-items: center;
      gap: .5rem;
    }

    .logout-btn:hover {
      background: #DC2626;
      transform: scale(1.05);
    }

    .logout-btn:focus-visible {
      outline: 2px solid var(--danger);
      outline-offset: 2px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        width: 220px;
      }

      .nav-link {
        font-size: .95rem;
        padding: .7rem .9rem;
      }

      .user-avatar {
        width: 75px;
        height: 75px;
      }
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
        overflow: auto; /* Permite scroll en móvil */
      }

      .sidebar {
        width: 100%;
        height: auto;
        flex-direction: row;
        overflow-x: auto;
        border-right: none;
        border-bottom: 1px solid var(--border);
        padding: 1rem;
      }

      .nav {
        flex-direction: row;
        gap: .4rem;
        flex-wrap: nowrap;
      }

      .nav-link {
        flex: 0 0 auto;
        padding: .7rem .9rem;
        font-size: .9rem;
      }

      .nav-link:hover {
        transform: none; /* Desactiva hover en touch */
      }

      .right-panel {
        position: static;
        flex-direction: row;
        justify-content: space-between;
        width: 100%;
        padding: 1rem;
        height: auto;
      }

      .logout-btn {
        margin-bottom: 0;
        padding: .7rem 1.2rem;
      }

      .user-avatar {
        width: 65px;
        height: 65px;
      }
    }

    /* Scrollbar personalizado (opcional) */
    .nav::-webkit-scrollbar {
      width: 6px;
    }

    .nav::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 3px;
    }
  </style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar" aria-label="Navegación principal">
  <nav class="nav" id="main-nav">
    <a class="nav-link" href="almacenamiento.html">
      <span class="material-icons" aria-hidden="true">warehouse</span>Almacenamiento
    </a>
    <a class="nav-link" href="clientes.html">
      <span class="material-icons" aria-hidden="true">groups</span>Clientes
    </a>
    <a class="nav-link" href="compra.html">
      <span class="material-icons" aria-hidden="true">shopping_cart</span>Compra
    </a>
    <a class="nav-link" href="descuentos.html">
      <span class="material-icons" aria-hidden="true">local_offer</span>Descuentos
    </a>
    <a class="nav-link" href="facturas.html">
      <span class="material-icons" aria-hidden="true">receipt_long</span>Facturas
    </a>
    <a class="nav-link" href="gastos.html">
      <span class="material-icons" aria-hidden="true">store</span>Catálogo
    </a>
    <a class="nav-link" href="inventario.html">
      <span class="material-icons" aria-hidden="true">inventory_2</span>Inventario
    </a>
    <a class="nav-link" href="lista.html">
      <span class="material-icons" aria-hidden="true">account_balance</span>Finanzas
    </a>
    <a class="nav-link" href="traslados.html">
      <span class="material-icons" aria-hidden="true">local_shipping</span>Traslados
    </a>
    <a class="nav-link" href="venta.html">
      <span class="material-icons" aria-hidden="true">point_of_sale</span>Venta
    </a>
    <a class="nav-link" href="Verificasion.html">
      <span class="material-icons" aria-hidden="true">verified</span>Verificación
    </a>
  </nav>
</aside>

<!-- Panel derecho -->
<div class="right-panel">
  <div class="user-section">
    <!-- Imagen con manejo de error limpio -->
    <img id="userPhoto" class="user-avatar" src="user2005.jpg" alt="Avatar del usuario">
    <div id="userName" class="user-name">ERNESTO TOBIAS</div>
  </div>
  <button id="logoutBtn" class="logout-btn" aria-label="Cerrar sesión">
    <span class="material-icons" aria-hidden="true">logout</span> Exit
  </button>
</div>

<!-- Contenido principal -->
<main>
  <h1 class="welcome">TOBIAS PALACIOS</h1>
  <p class="subtitle">A FAMILY COMPANY</p>
</main>

<script>
/* ========== CONFIGURACIÓN ========== */
const CONFIG = {
  DB_NAME: 'menuDB',
  STORE_SESSION: 'userSession',
  DEFAULT_AVATAR: 'user2005.jpg',
  DEFAULT_USER: 'Usuario',
  LOGIN_PAGE: 'index.html',
  SESSION_KEYS: {
    LOGGED_IN: 'loggedIn',
    FOTO: 'foto',
    NOMBRE: 'nombre'
  }
};

/* ========== BASE DE DATOS ========== */
let db = null;

/**
 * Abre la base de datos IndexedDB
 * @returns {Promise<IDBDatabase>}
 */
async function openDB() {
  if (db) return db;

  return new Promise((resolve, reject) => {
    const request = indexedDB.open(CONFIG.DB_NAME, 1);

    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };

    request.onupgradeneeded = () => {
      const database = request.result;
      if (!database.objectStoreNames.contains(CONFIG.STORE_SESSION)) {
        database.createObjectStore(CONFIG.STORE_SESSION, { keyPath: 'id', autoIncrement: true });
      }
    };
  });
}

/**
 * Obtiene la última sesión guardada
 * @returns {Promise<Object|null>}
 */
async function getLastSession() {
  await openDB();
  const tx = db.transaction([CONFIG.STORE_SESSION], 'readonly');
  const store = tx.objectStore(CONFIG.STORE_SESSION);

  return new Promise((resolve) => {
    // Más eficiente: abrir cursor en orden inverso
    const request = store.openCursor(null, 'prev');
    request.onsuccess = () => {
      resolve(request.result ? request.result.value : null);
    };
  });
}

/**
 * Limpia todas las sesiones
 * @returns {Promise<void>}
 */
async function clearSessions() {
  await openDB();
  const tx = db.transaction([CONFIG.STORE_SESSION], 'readwrite');
  await new Promise((resolve) => {
    tx.objectStore(CONFIG.STORE_SESSION).clear().onsuccess = resolve;
  });
}

/* ========== AUTENTICACIÓN ========== */
/**
 * Verifica si el usuario está autenticado
 */
function checkAuthentication() {
  const isLoggedIn = sessionStorage.getItem(CONFIG.SESSION_KEYS.LOGGED_IN) === 'true';
  if (!isLoggedIn) {
    // Redirige sin añadir al historial
    window.location.replace(CONFIG.LOGIN_PAGE);
  }
}

/**
 * Cierra sesión del usuario
 */
async function logout() {
  try {
    await clearSessions();
    sessionStorage.clear();
  } catch (error) {
    console.warn('Error al limpiar sesión:', error);
  } finally {
    window.location.replace(CONFIG.LOGIN_PAGE);
  }
}

/* ========== UI DE USUARIO ========== */
/**
 * Configura la interfaz de usuario con datos de sesión
 */
async function configureUserUI() {
  const foto = sessionStorage.getItem(CONFIG.SESSION_KEYS.FOTO) || CONFIG.DEFAULT_AVATAR;
  const nombre = sessionStorage.getItem(CONFIG.SESSION_KEYS.NOMBRE) || CONFIG.DEFAULT_USER;

  // Solo busca en IndexedDB si no hay datos en sessionStorage
  if (!sessionStorage.getItem(CONFIG.SESSION_KEYS.FOTO) || !sessionStorage.getItem(CONFIG.SESSION_KEYS.NOMBRE)) {
    try {
      const session = await getLastSession();
      if (session) {
        if (session.foto && !sessionStorage.getItem(CONFIG.SESSION_KEYS.FOTO)) {
          sessionStorage.setItem(CONFIG.SESSION_KEYS.FOTO, session.foto);
        }
        if (session.nombre && !sessionStorage.getItem(CONFIG.SESSION_KEYS.NOMBRE)) {
          sessionStorage.setItem(CONFIG.SESSION_KEYS.NOMBRE, session.nombre);
        }
      }
    } catch (error) {
      console.warn('No se pudo cargar sesión de IndexedDB:', error);
    }
  }

  // Actualiza DOM
  const imgElement = document.getElementById('userPhoto');
  const nameElement = document.getElementById('userName');

  if (imgElement) {
    imgElement.src = foto;
    // Manejo de error de imagen
    imgElement.onerror = () => {
      imgElement.src = CONFIG.DEFAULT_AVATAR;
    };
  }

  if (nameElement) {
    nameElement.textContent = nombre;
  }
}

/* ========== NAVEGACIÓN ========== */
/**
 * Resalta el enlace de la página actual
 */
function highlightCurrentPage() {
  const currentPage = window.location.pathname.split('/').pop().toLowerCase();
  
  document.querySelectorAll('.nav-link').forEach(link => {
    const href = link.getAttribute('href').toLowerCase();
    const isActive = href === currentPage || (currentPage === '' && href === 'index.html');
    
    if (isActive) {
      link.classList.add('active');
      link.setAttribute('aria-current', 'page');
    } else {
      link.classList.remove('active');
      link.removeAttribute('aria-current');
    }
  });
}

/* ========== INICIALIZACIÓN ========== */
document.addEventListener('DOMContentLoaded', async () => {
  checkAuthentication();
  
  try {
    await openDB();
  } catch (error) {
    console.warn('Error al abrir IndexedDB:', error);
  }

  // Configurar UI
  await configureUserUI();
  highlightCurrentPage();

  // Event listener para logout
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', logout);
  }
});
</script>
</body>
</html>
