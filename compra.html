<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compra</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    :root{
      --bg:#f5f7fa;
      --card:#ffffff;
      --text:#1f2937;
      --accent:#3b82f6;
      --accent-hover:#2563eb;
      --danger:#ef4444;
      --success:#10b981;
      --radius:16px;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --shadow-hover:0 8px 24px rgba(0,0,0,.12);
      --transition:.3s ease;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',system-ui,sans-serif}
    body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;padding:2rem 1rem}
    h1{font-size:2rem;font-weight:700;margin-bottom:2rem;letter-spacing:-.5px}

    .bubble{
      background:var(--card);
      border-radius:var(--radius);
      padding:2rem;
      box-shadow:var(--shadow);
      width:100%;
      max-width:1200px;
      margin-bottom:2rem;
      transition:transform var(--transition),box-shadow var(--transition);
    }
    .bubble:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover)}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.2rem}
    label{font-size:.9rem;font-weight:500;margin-bottom:.25rem;display:block}
    input,select,textarea{
      width:100%;
      padding:.75rem 1rem;
      border:1px solid #e5e7eb;
      border-radius:12px;
      background:#f9fafb;
      color:var(--text);
      transition:background .3s,border-color .3s;
    }
    input:focus,select:focus,textarea:focus{
      outline:none;
      background:#fff;
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(59,130,246,.2);
    }
    button{
      padding:.75rem 1.5rem;
      border:none;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      transition:transform .2s,box-shadow .2s;
    }
    button:hover{transform:translateY(-2px)}
    .btn-primary{background:var(--accent);color:#fff;box-shadow:0 4px 14px rgba(59,130,246,.4)}
    .btn-primary:hover{background:var(--accent-hover)}
    .btn-danger{background:var(--danger);color:#fff;box-shadow:0 4px 14px rgba(239,68,68,.4)}
    .btn-success{background:var(--success);color:#fff;box-shadow:0 4px 14px rgba(16,185,129,.4)}
    .actions{display:flex;gap:1rem;flex-wrap:wrap;margin-top:1.2rem}
    #imagePreview{max-height:200px;border-radius:12px;margin-top:.5rem;display:none;box-shadow:var(--shadow)}

    .table-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem;}
    .card-item{
      background:var(--card);
      border-radius:var(--radius);
      padding:1.5rem;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:.75rem;
      transition:transform var(--transition),box-shadow var(--transition);
    }
    .card-item:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover)}
    .card-item img{width:100%;height:160px;object-fit:cover;border-radius:12px}
    .card-item h3{font-size:1.1rem;color:var(--accent)}
    .card-item p{margin:0;font-size:.85rem;color:#6b7280}
    .card-item .actions{margin-top:auto;display:flex;gap:.5rem}

    .mini-lote{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:1rem;margin-top:1rem;max-height:320px;overflow-y:auto;
    }
    .mini-item{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:.75rem;text-align:center;font-size:.75rem;box-shadow:0 2px 6px rgba(0,0,0,.04);}
    .mini-item img{width:100%;height:90px;object-fit:cover;border-radius:8px;margin-bottom:.5rem}
    .mini-item input{width:100%;padding:.4rem;font-size:.7rem;margin-top:.2rem;border-radius:8px}
    .total-box{background:var(--card);padding:1.2rem 2rem;border-radius:var(--radius);box-shadow:var(--shadow);text-align:center;margin-top:2rem}
    .total-box h2{font-size:1rem;color:var(--accent);margin:0}
    .total-box p{font-size:2rem;font-weight:700;margin:0;color:var(--accent)}
    @media(max-width:1024px){.table-cards{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:768px){.table-cards{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:480px){.table-cards{grid-template-columns:1fr}}
  </style>
</head>
<body>

  <h1>Compra</h1>

  <!-- =================== FORMULARIO =================== -->
  <div class="bubble" id="formularioBubble">
    <h2><i class="fa fa-edit"></i> rápida de producto</h2>
    <form id="purchaseForm" class="form-grid">
      <div><label>Nombre *</label><input type="text" id="name" name="name" required></div>
      <div><label>Código *</label><input type="text" id="code" name="code" required></div>
      <div><label>Código de Barras *</label><input type="text" id="barcode" name="barcode" required></div>
      <div><label>Precio *</label><input type="number" id="price" name="price" step="0.01" required></div>
      <div><label>Descuento (%)</label><input type="number" id="discount" name="discount" step="0.01" value="0"></div>
      <div><label>Cantidad en Stock *</label><input type="number" id="quantity" name="quantity" required></div>
      <div style="grid-column:1/-1"><label>Descripción *</label><textarea id="description" name="description" rows="2" required></textarea></div>
      <div><label>Categoría *</label>
        <select id="category" name="category" required>
          <option value="">-- Seleccione --</option>
          <option value="Aritos">Aritos</option>
          <option value="Billeteras">Billeteras</option>
          <option value="Carteras">Carteras</option>
          <option value="Chokers">Chokers</option>
          <option value="Collares">Collares</option>
          <option value="Lentes de sol">Lentes de sol</option>
          <option value="Pulseras">Pulseras</option>
          <option value="Relojes">Relojes</option>
          <option value="Anillos">Anillos</option>
          <option value="Accesorios para el cabello">Accesorios para el cabello</option>
          <option value="Otros">Otros</option>
        </select>
      </div>
      <div style="grid-column:1/-1">
        <label>Imagen del producto:</label>
        <input type="file" id="imageFile" accept="image/*" onchange="previewImage(event)">
        <div style="margin-top:.5rem"><img id="imagePreview" src="" alt="Vista previa"></div>
      </div>
      <div style="grid-column:1/-1" class="actions">
        <button type="submit" class="btn-primary">Guardar producto</button>
        <button type="button" class="btn-primary" onclick="exportToExcel()">Exportar ZIP</button>
        <button type="button" class="btn-primary" onclick="exportToPDF()">Exportar PDF con Imágenes</button>
        <button type="button" class="btn-primary" onclick="resetAndOpenImport()">Importar ZIP</button>
        <input type="file" id="importFile" accept=".zip" style="display:none" onchange="importFromExcel(event)">
        <button type="button" class="btn-danger" onclick="vaciarInventario()">Vaciar Inventario</button>
      </div>
    </form>
  </div>

  <!-- =================== INVENTARIO =================== -->
  <div class="bubble">
    <h2><i class="fa fa-boxes"></i> Inventario actual</h2>
    <div class="table-cards" id="inventoryList"></div>
  </div>

  <div class="total-box">
    <h2>Total en USD</h2>
    <p id="totalAmount">$0.00</p>
  </div>

  <!-- =================== SCRIPT PRINCIPAL =================== -->
  <script>
  let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
  let editIndex = -1;

  function calculateTotal(){
    const total = inventory.reduce((sum,item)=>{
      const price = parseFloat(item.price)||0;
      const quantity = parseFloat(item.quantity)||0;
      const discount = parseFloat(item.discount)||0;
      const finalPrice = price * (1 - discount/100);
      return sum + finalPrice * quantity;
    },0);
    document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
  }

  function renderTable(){
    const list = document.getElementById('inventoryList');
    list.innerHTML = inventory.map((item,idx)=>`
      <div class="card-item">
        <img id="invImg${idx}" src="" alt="${item.name}"/>
        <h3>${item.name}</h3>
        <p>Código: ${item.code}</p>
        <p>Cód.Barras: ${item.barcode}</p>
        <p>Precio: $${item.price}</p>
        <p>Stock: ${item.quantity}</p>
      </div>
    `).join('');
    inventory.forEach((p,i)=>{
      localforage.getItem(`img_${p.code}`).then(blob=>{
        if(blob) document.getElementById(`invImg${i}`).src = URL.createObjectURL(blob);
      });
    });
  }

  function previewImage(evt){
    const file = evt.target.files[0];
    if(!file)return;
    new Compressor(file,{quality:0.6,maxWidth:800,maxHeight:800,
      success(result){
        const reader = new FileReader();
        reader.onload = e=>{
          document.getElementById('imagePreview').src = e.target.result;
          document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(result);
        const code = document.getElementById('code').value || 'temp';
        localforage.setItem(`img_${code}`, result);
      }
    });
  }

  document.getElementById('purchaseForm').addEventListener('submit',function(e){
    e.preventDefault();
    const newItem = Object.fromEntries(new FormData(e.target).entries());
    editIndex === -1 ? inventory.push(newItem) : (inventory[editIndex] = newItem);
    localStorage.setItem('inventory', JSON.stringify(inventory));
    e.target.reset();
    document.getElementById('imagePreview').style.display = 'none';
    editIndex = -1;
    renderTable(); calculateTotal();
  });

  function vaciarInventario(){
    if(!confirm('¿Vaciar todo el inventario?'))return;
    inventory.forEach(p=>localforage.removeItem(`img_${p.code}`));
    inventory = [];
    localStorage.setItem('inventory', JSON.stringify(inventory));
    renderTable(); calculateTotal();
  }

  async function exportToExcel(){
    const zip = new JSZip();
    zip.file('inventory.json', JSON.stringify(inventory, null, 2));
    const imgFolder = zip.folder('images');
    for(const p of inventory){
      const blob = await localforage.getItem(`img_${p.code}`);
      if(blob) imgFolder.file(`${p.code}.jpg`, blob);
    }
    const blobZip = await zip.generateAsync({type:'blob'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blobZip);
    a.download = 'inventario.zip';
    a.click();
  }

  async function importFromExcel(evt){
    const file = evt.target.files[0];
    if(!file || !file.name.endsWith('.zip')){alert('Selecciona un ZIP');return;}
    const reader = new FileReader();
    reader.onload = async () => {
      try{
        const zip = await JSZip.loadAsync(reader.result);
        const jsonFile = zip.file('inventory.json');
        if(!jsonFile){alert('No se encontró inventory.json');return;}
        const json = await jsonFile.async('string');
        const imported = JSON.parse(json);

        for(const p of imported){
          const img = zip.file(`images/${p.code}.jpg`);
          if(img){
            const blob = await img.async('blob');
            await localforage.setItem(`img_${p.code}`, blob);
          }
          const idx = inventory.findIndex(x=>x.code===p.code);
          idx>-1 ? inventory[idx]=p : inventory.push(p);
        }
        localStorage.setItem('inventory', JSON.stringify(inventory));
        renderTable(); calculateTotal();
        alert('Importación ZIP completada ✅');
      }catch(e){alert('Error leyendo ZIP: '+e.message);}
      finally{ evt.target.value = ''; }
    };
    reader.readAsArrayBuffer(file);
  }

  function resetAndOpenImport(){
    const inp = document.getElementById('importFile');
    inp.value = '';
    inp.click();
  }

  window.addEventListener('DOMContentLoaded',()=>{renderTable();calculateTotal();});
  </script>

  <!-- =================== BLOQUE CORREGIDO =================== -->
  <script>
  (function(){
    const original = window.importFromExcel;
    window.importFromExcel = async function(evt){
      await original.call(this, evt);
      await new Promise(res => setTimeout(res, 200));

      const imported = JSON.parse(localStorage.getItem('inventory')) || [];
      const current  = JSON.parse(localStorage.getItem('inventory')) || [];
      const merged   = [];
      const map      = new Map();

      current.forEach(item => map.set(item.code, {...item}));
      imported.forEach(item => {
        if (map.has(item.code)) {
          const exist = map.get(item.code);
          exist.quantity = String(Number(exist.quantity) + Number(item.quantity));
          map.set(item.code, exist);
        } else {
          map.set(item.code, item);
        }
      });

      map.forEach(v => merged.push(v));
      localStorage.setItem('inventory', JSON.stringify(merged));
      window.inventory = merged;
      window.renderTable();
      window.calculateTotal();
      alert('Importación completada y fusionada correctamente ✅');
    };
  })();
  </script>
</body>
</html>
