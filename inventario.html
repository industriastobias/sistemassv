<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventario – Sincronizado con Compras</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <style>
    :root{--bg:#f5f7fa;--card:#ffffff;--text:#1f2937;--accent:#3b82f6;--accent-hover:#2563eb;--danger:#ef4444;--success:#10b981;--radius:16px;--shadow:0 6px 20px rgba(0,0,0,.08);--shadow-hover:0 8px 24px rgba(0,0,0,.12);--highlight:#fef08a;}
    body.dark{--bg:#111;--card:#1e1e1e;--text:#eee;--highlight:#fde047;}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',system-ui,sans-serif}
    html{scroll-behavior:smooth}
    body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;padding:2rem 1rem}

    /* INDICADOR DE NUEVOS PRODUCTOS */
    #newIndicator{
      position:fixed;
      top:1rem;
      right:1rem;
      z-index:10001;
      background:var(--success);
      color:#fff;
      padding:.5rem .8rem;
      border-radius:20px;
      font-size:.8rem;
      display:none;
      align-items:center;
      gap:.5rem;
      box-shadow:var(--shadow-hover);
    }
    #newIndicator.show{display:flex}
    #newIndicator button{
      background:#fff;
      color:var(--success);
      border:none;
      padding:.3rem .6rem;
      border-radius:12px;
      font-size:.7rem;
      cursor:pointer;
    }

    /* RESTO DE ESTILOS (IGUAL QUE ANTES) */
    #menuToggle{position:fixed;top:1rem;left:1rem;background:var(--accent);color:#fff;border:none;padding:.5rem .7rem;border-radius:50%;font-size:1rem;cursor:pointer;box-shadow:var(--shadow);}
    #kioskoBar{position:fixed;top:0;right:0;z-index:9999;background:var(--card);box-shadow:var(--shadow);border-radius:0 0 0 var(--radius);padding:.4rem .6rem;display:flex;gap:.5rem;flex-wrap:wrap;transform:translateX(100%);transition:transform .3s ease;}
    #kioskoBar.show{transform:translateX(0)}
    #kioskoBar a{color:var(--accent);font-size:1.3rem;padding:.4rem;border-radius:50%;transition:background .2s;}
    #kioskoBar a:hover{background:var(--highlight);}
    h1{font-size:2rem;font-weight:700;margin-bottom:1rem;letter-spacing:-.5px}
    .summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1.5rem;width:100%;max-width:960px;}
    .summary-card{background:var(--card);border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow);text-align:center;}
    .summary-card h3{font-size:.8rem;color:#6b7280;margin-bottom:.25rem}
    .summary-card p{font-size:1.5rem;font-weight:700;color:var(--accent);margin:0}
    .search-bar{width:100%;max-width:960px;margin-bottom:1.5rem;}
    .search-bar input{width:100%;padding:.75rem 1rem;border:1px solid #e5e7eb;border-radius:12px;background:#f9fafb;font-size:1rem;}
    .search-bar input:focus{outline:none;background:#fff;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.2);}
    .table-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:1.5rem;width:100%;max-width:1200px;}
    @media(max-width:1200px){.table-grid{grid-template-columns:repeat(4,1fr)}}
    @media(max-width:900px){.table-grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:600px){.table-grid{grid-template-columns:repeat(2,1fr)}}
    .line-item{background:var(--card);border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:.5rem;transition:transform var(--transition),box-shadow var(--transition);}
    .line-item:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover)}
    .line-item img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;cursor:zoom-in}
    .line-item h3{font-size:1rem;color:var(--accent)}
    .line-item p{margin:0;font-size:.75rem;color:#6b7280}
    .stock-line{font-weight:600;color:var(--success)}
    .actions{display:flex;gap:.5rem;margin-top:auto}
    button{padding:.4rem .8rem;border:none;border-radius:12px;font-weight:600;cursor:pointer;transition:transform .2s,box-shadow .2s;font-size:.75rem;}
    button:hover{transform:translateY(-2px)}
    .btn-primary{background:var(--accent);color:#fff;box-shadow:0 4px 14px rgba(59,130,246,.4);}
    .btn-danger{background:var(--danger);color:#fff;box-shadow:0 4px 14px rgba(239,68,68,.4);}
    .total-box{background:var(--card);padding:1.2rem 2rem;border-radius:var(--radius);box-shadow:var(--shadow);text-align:center;margin-top:2rem;}
    .total-box h2{font-size:1rem;color:var(--accent);margin:0}
    .total-box p{font-size:2rem;font-weight:700;margin:0;color:var(--accent)}
    .copy-barcode{cursor:pointer;margin-left:.3rem;color:var(--accent)}
    .copy-barcode:hover{color:var(--accent-hover)}
    #lightbox{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:9999;}
    #lightbox img{max-width:90%;max-height:90%;border-radius:12px;}
  </style>
</head>
<body>

<!-- INDICADOR DE NUEVOS PRODUCTOS -->
<div id="newIndicator">
  <i class="fa fa-bell"></i> <span id="newText">Hay productos nuevos</span>
  <button onclick="recargarInventario()">Refrescar</button>
</div>

<!-- NAVEGACIÓN -->
<button id="menuToggle" title="Abrir menú"><i class="fa fa-bars"></i></button>
<nav id="kioskoBar">
  <a href="compra.html" title="Compra"><i class="fa fa-shopping-cart"></i></a>
  <a href="almacenamiento.html" title="Almacenamiento"><i class="fa fa-warehouse"></i></a>
  <a href="finanzas.html" title="Finanzas"><i class="fa fa-chart-line"></i></a>
  <a href="inventario.html" title="Inventario"><i class="fa fa-boxes"></i></a>
  <a href="catalogo.html" title="Catálogo"><i class="fa fa-book"></i></a>
  <a href="clientes.html" title="Clientes"><i class="fa fa-users"></i></a>
  <a href="descuentos.html" title="Descuentos"><i class="fa fa-percent"></i></a>
  <a href="facturas.html" title="Facturas"><i class="fa fa-file-invoice"></i></a>
  <a href="traslados.html" title="Traslados"><i class="fa fa-truck"></i></a>
  <a href="venta.html" title="Venta"><i class="fa fa-cash-register"></i></a>
  <a href="menu.html" title="Menú"><i class="fa fa-bars"></i></a>
</nav>

<h1><i class="fa fa-boxes"></i> Inventario – Sincronizado con Compras</h1>

<div class="summary-cards">
  <div class="summary-card"><h3>Total de productos</h3><p id="totalProducts">0</p></div>
  <div class="summary-card"><h3>Stock total</h3><p id="totalStock">0</p></div>
</div>

<div class="search-bar">
  <input id="searchInput" type="text" placeholder="Buscar por nombre, código, barras o categoría..."/>
</div>

<div id="inventoryTable" class="table-grid"></div>

<div class="total-box"><h2>Total en USD</h2><p id="totalAmount">$0.00</p></div>

<div id="lightbox" onclick="closeLightbox()">
  <img id="lightboxImg" src="" alt="Imagen ampliada"/>
</div>

<script>
/* ===== ENTRAR KIOSKO ===== */
function entrarKiosko(){
  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen().catch(()=>{});
  }
}
window.addEventListener('load', entrarKiosco);

/* ===== MENÚ ===== */
const menuToggle = document.getElementById('menuToggle');
const kioskoBar  = document.getElementById('kioskoBar');
menuToggle.addEventListener('click', () => kioskoBar.classList.toggle('show'));

/* ===== INDICADOR DE NUEVOS PRODUCTOS ===== */
let lastInventoryLength = 0;
function mostrarIndicadorNuevos() {
  const indicador = document.getElementById('newIndicator');
  const nuevo = inventory.length > lastInventoryLength;
  if (nuevo) {
    document.getElementById('newText').textContent = `Hay ${inventory.length - lastInventoryLength} producto(s) nuevo(s)`;
    indicador.classList.add('show');
  } else {
    indicador.classList.remove('show');
  }
}
function recargarInventario() {
  lastInventoryLength = inventory.length;
  doFilter();
  mostrarIndicadorNuevos();
}

/* ===== BASE DE DATOS ===== */
let inventory = [];
let filtered   = [];
let searchTerm = '';

async function loadInventory() {
  inventory = (await localforage.getItem('inventory')) || [];
  filtered = [...inventory];
  lastInventoryLength = inventory.length;
}

/* ===== FUNCIONES AUX ===== */
function highlight(text, query){
  if(!query) return text;
  const re = new RegExp(`(${query})`, 'gi');
  return text.replace(re, '<mark>$1</mark>');
}
function copyToClipboard(text){
  navigator.clipboard.writeText(text).then(()=>{
    alert('Código de barras copiado: ' + text);
  });
}
function openLightbox(src) {
  const lightbox = document.getElementById('lightbox');
  const img = document.getElementById('lightboxImg');
  img.src = src;
  lightbox.style.display = 'flex';
}
function closeLightbox() {
  document.getElementById('lightbox').style.display = 'none';
}

/* ===== RENDER TABLA ===== */
async function renderTable(){
  const container = document.getElementById('inventoryTable');
  document.getElementById('totalProducts').textContent = inventory.length;
  document.getElementById('totalStock').textContent = inventory.reduce((s, p) => s + (parseInt(p.quantity) || 0), 0);
  document.getElementById('totalAmount').textContent = '$' + calculateTotal(inventory).toFixed(2);

  if(!filtered.length){
    container.innerHTML = '<p style="text-align:center;color:#6b7280;grid-column:1/-1">No hay productos que coincidan con la búsqueda.</p>';
    return;
  }

  container.innerHTML = filtered.map((item,idx)=>`
    <div class="line-item" id="card-${idx}">
      <img id="invImg${idx}" src="" alt="${item.name}" onclick="openLightbox(this.src)" style="cursor:zoom-in"/>
      <h3>${highlight(item.name, searchTerm)}</h3>
      <p>Código: ${highlight(item.code, searchTerm)}</p>
      <p class="stock-line"><i class="fa fa-box"></i> Stock: ${item.quantity} u.</p>
      <p>Precio: $${item.price}</p>
      <p>Categoría: ${highlight(item.category, searchTerm)}</p>
      <p style="font-size:.7rem;">Barras: ${highlight(item.barcode, searchTerm)}
        <i class="fa fa-copy copy-barcode" onclick="copyToClipboard('${item.barcode}')" title="Copiar código"></i>
      </p>
      <div class="actions">
        <button onclick="viewItem(${idx})" class="btn-primary">Ver</button>
        <button onclick="deleteItem(${idx})" class="btn-danger">Eliminar</button>
      </div>
    </div>
  `).join('');

  for (let i = 0; i < filtered.length; i++) {
    const p = filtered[i];
    const blob = await localforage.getItem(`img_${p.code}`);
    const img = document.getElementById(`invImg${i}`);
    if (blob && img) {
      img.src = URL.createObjectURL(blob);
    }
  }

  mostrarIndicadorNuevos();
}

/* ===== ACCIONES ===== */
function viewItem(index){
  alert(`Detalles:\n\n${JSON.stringify(filtered[index],null,2)}`);
}
async function deleteItem(index){
  if(!confirm('¿Eliminar producto?'))return;
  const realIndex = inventory.findIndex(it=> it.code === filtered[index].code);
  const item = inventory[realIndex];
  await localforage.removeItem(`img_${item.code}`);
  inventory.splice(realIndex,1);
  await saveInventory();
  lastInventoryLength = inventory.length;
  renderTable();
}
function calculateTotal(list){
  return list.reduce((sum,item)=>{
    const price = parseFloat(item.price)||0;
    const qty   = parseFloat(item.quantity)||0;
    const disc  = parseFloat(item.discount)||0;
    return sum + (price * (1 - disc/100)) * qty;
  },0);
}

/* ===== FILTROS ===== -->
function doFilter(){
  searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
  filtered = inventory.filter(p=>{
    const match = !searchTerm ||
      p.name.toLowerCase().includes(searchTerm) ||
      p.code.toLowerCase().includes(searchTerm) ||
      p.barcode.toLowerCase().includes(searchTerm) ||
      p.category.toLowerCase().includes(searchTerm);
    return match;
  });
  renderTable();
}
document.getElementById('searchInput').addEventListener('input',doFilter);

/* ===== SINCRONIZACIÓN CRUZADA ===== */
window.addEventListener('storage', async (e) => {
  if (e.key === 'inventory') {
    await loadInventory();
    doFilter();
  }
});

/* ===== AL CARGAR ===== -->
window.addEventListener('DOMContentLoaded', async () => {
  await loadInventory();
  renderTable();
});
</script>
</body>
</html>
