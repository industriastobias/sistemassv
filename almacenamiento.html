<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventario — sincronizado</title>

  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- localForage para blobs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

  <!-- JSZip y FileSaver para import/export ZIP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    :root{
      --crema: #f7f3e9;
      --rosa: #DBB8BC;
      --texto: #2e2e2e;
      --borde: #e0e0e0;
      --resaltado: #fffaf0;
      --blanco: #ffffff;
      --danger: #e63946;
      --sombra: rgba(0,0,0,0.08);
    }
    *{box-sizing:border-box;font-family:Poppins,system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:var(--crema);color:var(--texto);margin:0;padding:18px;display:flex;align-items:center;flex-direction:column;min-height:100vh;}
    header{width:100%;max-width:1200px;display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{color:var(--rosa);margin:0;font-size:1.6rem;display:flex;gap:.6rem;align-items:center}
    .top-actions{display:flex;gap:8px;align-items:center}

    .container{width:100%;max-width:1200px;background:var(--blanco);border-radius:12px;padding:18px;box-shadow:0 10px 30px var(--sombra)}
    .search-block{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;margin-bottom:12px}
    label{font-weight:600;font-size:.9rem}
    select,input[type=text],input[type=number]{padding:.55rem .7rem;border:1px solid var(--borde);border-radius:8px;font-size:.95rem}
    button.btn{background:var(--rosa);color:#fff;border:none;padding:.6rem .9rem;border-radius:8px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid var(--borde);padding:.5rem .7rem;border-radius:8px;cursor:pointer}

    .tools-row{display:flex;gap:10px;align-items:center;margin-bottom:8px;flex-wrap:wrap}

    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse;min-width:960px}
    thead th{background:var(--rosa);color:#fff;padding:10px;text-align:left;font-weight:600}
    th,td{padding:10px;border:1px solid var(--borde);vertical-align:middle}
    tbody tr:nth-child(odd){background:var(--resaltado)}
    tbody tr:hover{background:#fdeff1}
    img.thumb{height:48px;width:48px;object-fit:cover;border-radius:6px;cursor:pointer}

    .no-results{color:var(--danger);font-weight:700;text-align:center;margin-top:10px}
    .result-message{text-align:center;color:var(--texto);margin-top:8px;font-weight:700}

    /* modales */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(3px);align-items:center;justify-content:center;z-index:120}
    .modal .panel{background:var(--blanco);padding:18px;border-radius:12px;max-width:760px;width:92%;max-height:86vh;overflow:auto;box-shadow:0 14px 40px var(--sombra)}
    .close{float:right;cursor:pointer;color:#666;font-size:20px}
    #modalImage{width:100%;height:auto;max-height:70vh;object-fit:contain;border-radius:10px}

    .highlight{outline:2px solid var(--rosa)}
    .no-desc{color:#777;font-style:italic}

    .flex{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .small{font-size:.85rem}
    @media (max-width:880px){
      table{min-width:700px}
    }
  </style>
</head>
<body>

  <header>
    <h1><i class="fa-solid fa-boxes-stacked"></i> Inventario</h1>
    <div class="top-actions">
      <button class="btn" onclick="openSalesHistory()"><i class="fa-solid fa-clock-rotate-left"></i> Historial (Ventas)</button>
      <button class="ghost" onclick="exportJSON()">Exportar JSON</button>
      <button class="ghost" onclick="exportZip()">Exportar ZIP</button>
      <label class="ghost" style="cursor:pointer;padding:.4rem .6rem;border-radius:8px">
        Importar ZIP <input id="importZipInput" type="file" accept=".zip" style="display:none" onchange="handleImportZip(event)">
      </label>
      <label class="ghost" style="cursor:pointer;padding:.4rem .6rem;border-radius:8px">
        Importar JSON <input id="importJsonInput" type="file" accept=".json" style="display:none" onchange="handleImportJson(event)">
      </label>
    </div>
  </header>

  <div class="container">

    <div class="search-block">
      <div>
        <label for="searchCategory">Filtrar por categoría</label><br>
        <select id="searchCategory">
          <option value="">Todas las categorías</option>
          <option value="Aritos">Aritos</option>
          <option value="Billeteras">Billeteras</option>
          <option value="Carteras">Carteras</option>
          <option value="Chokers">Chokers</option>
          <option value="Collares">Collares</option>
          <option value="Lentes de sol">Lentes de sol</option>
          <option value="Pulseras">Pulseras</option>
          <option value="Relojes">Relojes</option>
          <option value="Anillos">Anillos</option>
          <option value="Accesorios para el cabello">Accesorios para el cabello</option>
          <option value="Otros">Otros</option>
        </select>
      </div>

      <div>
        <label for="searchCode">Buscar (nombre / código / barcode)</label><br>
        <input id="searchText" type="text" placeholder="Ej: arito / AR-001 / 0001001">
      </div>

      <div class="flex" style="align-self:flex-end">
        <button class="btn" onclick="filterInventory()">Buscar</button>
        <button class="ghost" onclick="clearFilters()">Limpiar</button>
      </div>
    </div>

    <div class="tools-row">
      <div class="flex">
        <label for="goToRow">Ir a fila</label>
        <input id="goToRow" type="number" min="1" style="width:90px;padding:.45rem;border-radius:6px;border:1px solid var(--borde)">
        <button class="btn" onclick="goToRow()">Ir</button>
      </div>
      <div class="right small">Offline • datos en local (LocalStorage) y blobs en LocalForage</div>
    </div>

    <div class="table-wrap">
      <table aria-describedby="descTable">
        <caption id="descTable" style="text-align:left;font-size:.85rem;color:#666;margin-bottom:8px">Haz clic sobre la imagen para verla grande. Usa icono de caja registradora para registrar venta.</caption>
        <thead>
          <tr>
            <th>#</th>
            <th>Imagen</th>
            <th>Nombre</th>
            <th>Código</th>
            <th>Barcode</th>
            <th>Precio</th>
            <th>Desc(%)</th>
            <th>Precio final</th>
            <th>Descripción</th>
            <th>Categoría</th>
            <th>Stock</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="inventoryList"></tbody>
      </table>

      <div id="noResults" class="no-results" style="display:none">No se encontraron productos.</div>
      <div id="resultMessage" class="result-message" style="display:none"></div>
    </div>
  </div>

  <!-- SELL MODAL -->
  <div id="sellModal" class="modal" role="dialog" aria-modal="true">
    <div class="panel">
      <span class="close" onclick="closeSellModal()">&times;</span>
      <h3>Registrar Venta</h3>
      <div id="sellInfo" style="margin:.6rem 0;color:#444"></div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:.5rem">
        <label>Cantidad</label>
        <input id="sellQty" type="number" min="1" value="1" style="width:100px;padding:.45rem;border-radius:6px;border:1px solid var(--borde)">
        <label>Precio U.</label>
        <input id="sellPrice" type="number" min="0" step="0.01" style="width:140px;padding:.45rem;border-radius:6px;border:1px solid var(--borde)">
        <div style="margin-left:auto"><button class="btn" onclick="confirmSell()"><i class="fa-solid fa-cash-register"></i> Registrar</button></div>
      </div>
      <div id="sellMsg" style="margin-top:.6rem;color:#666"></div>
    </div>
  </div>

  <!-- IMAGE MODAL -->
  <div id="imageModal" class="modal" role="dialog" aria-modal="true">
    <div class="panel">
      <span class="close" onclick="closeImageModal()">&times;</span>
      <img id="modalImage" src="" alt="Imagen grande">
    </div>
  </div>

  <!-- HISTORY MODAL -->
  <div id="historyModal" class="modal" role="dialog" aria-modal="true">
    <div class="panel">
      <span class="close" onclick="closeSalesHistory()">&times;</span>
      <h3>Historial de Ventas</h3>
      <div style="margin-top:8px;overflow:auto;max-height:55vh">
        <table style="width:100%;border-collapse:collapse">
          <thead><tr style="background:var(--rosa);color:#fff">
            <th>Fecha</th><th>Producto</th><th>Código</th><th>Cantidad</th><th>Precio U.</th><th>Total</th>
          </tr></thead>
          <tbody id="salesHistoryList"></tbody>
        </table>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn" onclick="clearSalesHistory()">Limpiar historial</button>
        <button class="ghost right" onclick="closeSalesHistory()">Cerrar</button>
      </div>
    </div>
  </div>

<script>
/* ========== Config y utilidades ========== */
localforage.config({name:'inventario_app', storeName:'images'});

function safeLoad(key, fallback){
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
  catch(e){ console.error('safeLoad', e); return fallback; }
}
function safeSave(key, data){
  try { localStorage.setItem(key, JSON.stringify(data)); } catch(e){ console.error('safeSave', e); }
}

let inventory = safeLoad('inventory', []); // array de productos
let sales = safeLoad('soldInventory', []);  // historial ventas

// map de objectURLs para revocar despues
const urlMap = new Map();

/* ================== Helpers UI ================== */
const $ = id => document.getElementById(id);
function formatMoney(n){
  if (n === undefined || n === null) return '';
  return Number(n).toLocaleString('es-ES',{style:'currency',currency:'USD',maximumFractionDigits:2});
}

/* Ordena: productos con quantity === 0 van al final */
function orderByStock(arr){
  return [...arr].sort((a,b)=>{
    if ((a.quantity||0) === 0 && (b.quantity||0) !== 0) return 1;
    if ((b.quantity||0) === 0 && (a.quantity||0) !== 0) return -1;
    return 0;
  });
}

/* Render: tabla principal */
function renderTable(list){
  const tbody = $('inventoryList');
  const ordered = orderByStock(list);
  if(!ordered.length){
    tbody.innerHTML = '';
    $('noResults').style.display = 'block';
    $('resultMessage').style.display = 'none';
    return;
  }
  $('noResults').style.display = 'none';
  $('resultMessage').style.display = 'none';

  tbody.innerHTML = ordered.map((p, i) => {
    const desc = (p.description && p.description.toString().trim()) ? escapeHtml(p.description) : '<span class="no-desc">---</span>';
    const price = Number(p.price || 0);
    const discount = Number(p.discount || 0);
    const final = (price * (1 - discount/100)).toFixed(2);
    // Use data-code attribute so we can load image blob by code
    return `<tr data-index="${i}" id="row-${i}">
      <td>${i+1}</td>
      <td><img class="thumb" id="img-${i}" data-code="${escapeHtml(p.code)}" alt="${escapeHtml(p.name)}" onclick="openImageByCode('${escapeHtml(p.code)}')"></td>
      <td>${escapeHtml(p.name)}</td>
      <td>${escapeHtml(p.code)}</td>
      <td>${escapeHtml(p.barcode || '')}</td>
      <td>${price.toFixed(2)}</td>
      <td>${discount}</td>
      <td>${Number(final).toFixed(2)}</td>
      <td>${desc}</td>
      <td>${escapeHtml(p.category || '')}</td>
      <td>${Number(p.quantity || 0)}</td>
      <td><button class="btn" onclick="openSellModalByIndex(${i})" title="Vender"><i class="fa-solid fa-cash-register"></i></button></td>
    </tr>`;
  }).join('');

  // load images from localforage; if not present, show placeholder
  ordered.forEach((p, idx)=>{
    const imgEl = document.getElementById(`img-${idx}`);
    if(!imgEl) return;
    imgEl.src = ''; // reset while loading
    const key = `img_${p.code}`;
    localforage.getItem(key).then(blob=>{
      if(blob){
        const url = URL.createObjectURL(blob);
        imgEl.src = url;
        // revoke prev if existed
        if(urlMap.has(imgEl.id)){ try{ URL.revokeObjectURL(urlMap.get(imgEl.id)); } catch(e){} }
        urlMap.set(imgEl.id, url);
      } else {
        imgEl.src = placeholderDataURL(p.name || p.code);
      }
    }).catch(err=>{
      console.error('error loading image', err);
      imgEl.src = placeholderDataURL(p.name || p.code);
    });
  });
}

/* Placeholder SVG dataURL when no image present */
function placeholderDataURL(text){
  const label = String(text || '').slice(0,10);
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'>
    <rect width='100%' height='100%' fill='#f0e5e6'/>
    <text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' font-size='20' fill='#b08b8f'>${label}</text>
  </svg>`;
  return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
}

/* escape HTML simple */
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ================== Buscar / Filtrar / Navegar ================== */
function filterInventory(){
  const cat = $('searchCategory').value.trim().toLowerCase();
  const q = $('searchText').value.trim().toLowerCase();

  const filtered = inventory.filter(p=>{
    const catOk = !cat || (String(p.category||'').toLowerCase() === cat);
    const qOk = !q || (String(p.name||'').toLowerCase().includes(q) || String(p.code||'').toLowerCase() === q || String(p.barcode||'').toLowerCase() === q);
    return catOk && qOk;
  });
  renderTable(filtered);
}

/* go to row (index based on current table) */
function goToRow(){
  const r = Number($('goToRow').value);
  const rows = document.querySelectorAll('#inventoryList tr');
  rows.forEach(tr => tr.classList.remove('highlight'));
  if(!r || r < 1 || r > rows.length){ alert('Fila fuera de rango'); return; }
  const tr = rows[r-1];
  tr.scrollIntoView({behavior:'smooth', block:'center'});
  tr.classList.add('highlight');
}

/* limpiar filtros */
function clearFilters(){
  $('searchCategory').value = '';
  $('searchText').value = '';
  $('goToRow').value = '';
  renderTable(inventory);
}

/* ================== Vender / Historial ================== */
let currentSellIdx = null;
function openSellModalByIndex(idx){
  currentSellIdx = idx;
  const p = orderByStock(inventory)[idx]; // because table shows ordered list
  if(!p){ alert('Producto no encontrado'); return; }
  $('sellInfo').textContent = `${p.name} — stock: ${p.quantity || 0}`;
  $('sellQty').value = 1;
  $('sellPrice').value = (Number(p.price) || 0).toFixed(2);
  $('sellMsg').textContent = '';
  $('sellModal').style.display = 'flex';
}

/* confirmar venta */
function confirmSell(){
  const qty = Number($('sellQty').value);
  const price = Number($('sellPrice').value);
  if(isNaN(qty) || qty <= 0){ $('sellMsg').textContent = 'Cantidad inválida'; return; }
  if(isNaN(price) || price < 0){ $('sellMsg').textContent = 'Precio inválido'; return; }

  // Find product object in inventory by code because table is ordered view
  const ordered = orderByStock(inventory);
  const p = ordered[currentSellIdx];
  if(!p){ $('sellMsg').textContent = 'Producto no encontrado'; return; }
  if(qty > (p.quantity || 0)){ $('sellMsg').textContent = 'Stock insuficiente'; return; }

  // Mutate original inventory: locate index by unique code
  const origIndex = inventory.findIndex(x => String(x.code) === String(p.code));
  if(origIndex === -1){ $('sellMsg').textContent = 'Producto no encontrado en inventario'; return; }

  inventory[origIndex].quantity = Number(inventory[origIndex].quantity || 0) - qty;
  safeSave('inventory', inventory);

  const sale = { date: new Date().toISOString(), name: p.name, code: p.code, quantity: qty, price: price, total: qty*price };
  sales.push(sale);
  safeSave('soldInventory', sales);

  // actualizar vista
  renderTable(inventory);
  $('sellMsg').textContent = 'Venta registrada';
  setTimeout(()=>{ $('sellModal').style.display = 'none'; $('sellMsg').textContent = ''; }, 700);
}

/* abrir historial */
function openSalesHistory(){
  const tbody = $('salesHistoryList');
  const saved = safeLoad('soldInventory', []);
  if(!saved.length){
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:12px;color:#666">No hay ventas registradas.</td></tr>';
  } else {
    tbody.innerHTML = saved.map(s=>{
      const dt = new Date(s.date).toLocaleString();
      return `<tr>
        <td style="padding:8px;border:1px solid var(--borde)">${escapeHtml(dt)}</td>
        <td style="padding:8px;border:1px solid var(--borde)">${escapeHtml(s.name)}</td>
        <td style="padding:8px;border:1px solid var(--borde)">${escapeHtml(s.code)}</td>
        <td style="padding:8px;border:1px solid var(--borde)">${s.quantity}</td>
        <td style="padding:8px;border:1px solid var(--borde)">${Number(s.price).toFixed(2)}</td>
        <td style="padding:8px;border:1px solid var(--borde)">${Number(s.total).toFixed(2)}</td>
      </tr>`;
    }).join('');
  }
  $('historyModal').style.display = 'flex';
}
function closeSalesHistory(){ $('historyModal').style.display = 'none'; }
function clearSalesHistory(){
  if(!confirm('¿Eliminar todo el historial de ventas?')) return;
  sales = [];
  safeSave('soldInventory', sales);
  openSalesHistory();
}

/* ================== Imagenes modal ================== */
function openImageByCode(code){
  const key = `img_${code}`;
  localforage.getItem(key).then(blob=>{
    if(blob){
      const url = URL.createObjectURL(blob);
      if(urlMap.has('modal')){ try{ URL.revokeObjectURL(urlMap.get('modal')) }catch(e){} }
      urlMap.set('modal', url);
      $('modalImage').src = url;
    } else {
      $('modalImage').src = placeholderDataURL(code);
    }
    $('imageModal').style.display = 'flex';
  }).catch(err=>{
    console.error('openImageByCode', err);
    $('modalImage').src = placeholderDataURL(code);
    $('imageModal').style.display = 'flex';
  });
}
function closeImageModal(){
  $('imageModal').style.display = 'none';
  if(urlMap.has('modal')){ try{ URL.revokeObjectURL(urlMap.get('modal')); }catch(e){} urlMap.delete('modal'); }
}

/* cerrar sell modal */
function closeSellModal(){ $('sellModal').style.display = 'none'; }

/* cerrar modales al click fuera */
window.addEventListener('click', (e)=>{
  if(e.target === $('imageModal')) closeImageModal();
  if(e.target === $('sellModal')) closeSellModal();
  if(e.target === $('historyModal')) closeSalesHistory();
});

/* escape Enter key for search */
$('searchText').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') filterInventory(); });

/* ================== Import / Export ================== */

/* Export JSON (simple) */
function exportJSON(){
  const dataStr = JSON.stringify(inventory, null, 2);
  const blob = new Blob([dataStr], {type: 'application/json'});
  saveAs(blob, 'inventory.json');
}

/* Export ZIP: inventory.json + images/ */
async function exportZip(){
  try{
    const zip = new JSZip();
    zip.file('inventory.json', JSON.stringify(inventory, null, 2));
    // gather images keys from inventory
    const promises = inventory.map(async p=>{
      const key = `img_${p.code}`;
      const blob = await localforage.getItem(key);
      if(blob){
        // put in folder images as img_<code> with original type if possible
        let ext = 'png';
        if (blob.type){
          const m = blob.type.split('/')[1];
          if(m) ext = m.split('+')[0];
        }
        zip.file(`images/img_${p.code}.${ext}`, blob);
      }
    });
    await Promise.all(promises);
    const content = await zip.generateAsync({type:'blob'});
    saveAs(content, 'inventory_export.zip');
  } catch(err){
    console.error('exportZip', err);
    alert('Error al exportar ZIP. Revisa la consola.');
  }
}

/* Handle import JSON */
function handleImportJson(evt){
  const f = evt.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const data = JSON.parse(e.target.result);
      if(!Array.isArray(data)) throw new Error('Formato inválido: se esperaba array');
      inventory = data;
      safeSave('inventory', inventory);
      renderTable(inventory);
      alert('Inventario importado correctamente (JSON).');
    } catch(err){
      alert('JSON inválido: ' + err.message);
    }
  };
  reader.readAsText(f);
  evt.target.value = '';
}

/* Handle import ZIP */
async function handleImportZip(evt){
  const f = evt.target.files[0];
  if(!f) return;
  try{
    const zip = await JSZip.loadAsync(f);
    // read inventory.json
    const invFile = zip.file('inventory.json');
    if(!invFile){ alert('ZIP inválido: falta inventory.json en la raíz'); evt.target.value = ''; return; }
    const invText = await invFile.async('string');
    const data = JSON.parse(invText);
    if(!Array.isArray(data)) throw new Error('inventory.json debe ser un array de productos');

    // store inventory
    inventory = data;
    safeSave('inventory', inventory);

    // import images folder if exists
    const imageFiles = Object.keys(zip.files).filter(name => name.startsWith('images/'));
    await Promise.all(imageFiles.map(async name=>{
      const file = zip.files[name];
      if(!file.dir){
        const blob = await file.async('blob');
        // derive code from filename: images/img_<code>.<ext>
        const base = name.split('/').pop();
        // remove img_ prefix and extension
        const match = base.match(/^img_(.+?)\.[^.]+$/);
        if(match){
          const code = match[1];
          await localforage.setItem(`img_${code}`, blob);
        }
      }
    }));

    renderTable(inventory);
    alert('Importación ZIP completada.');
  } catch(err){
    console.error('handleImportZip', err);
    alert('Error al importar ZIP: ' + (err.message || err));
  } finally {
    evt.target.value = '';
  }
}

/* Provide file pick for import when label clicked */
$('importZipInput').addEventListener('click', ()=>{}); // just to ensure element exists
$('importJsonInput').addEventListener('click', ()=>{});

/* ================== Init / load ================== */
function initialLoad(){
  // create sample structure if empty? DO NOT auto-add real demo data to avoid overwriting user's dataset.
  renderTable(inventory);
}

/* page load */
window.addEventListener('load', ()=>{ initialLoad(); });

/* beforeunload revoke objectURLs */
window.addEventListener('beforeunload', ()=>{
  urlMap.forEach(u=>{ try{ URL.revokeObjectURL(u); }catch(e){} });
});
</script>
</body>
</html>
