<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ACCESO – Ventas</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<style>
:root{
  --blanco:#ffffff;
  --negro:#000000;
  --gris:#f5f5f5;
  --radio:2px;
  --fuente:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:var(--fuente)}
body{background:var(--blanco);color:var(--negro);display:flex;justify-content:center;padding:40px 20px}
.oculto{display:none}
input,select,button{padding:10px;border:1px solid var(--negro);border-radius:var(--radio);background:var(--blanco);color:var(--negro);font-size:.85rem}
button{cursor:pointer}
button:hover{opacity:.7}
#login{width:280px;text-align:center}
#app{width:100%;max-width:900px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.row{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:15px}
.card{background:var(--gris);padding:15px;border-radius:var(--radio);position:relative}
.card img{width:100%;height:120px;object-fit:contain;margin-bottom:8px;cursor:pointer}
.barcode{font-size:.65rem;text-align:center;margin-top:4px;opacity:.7}
.check{position:absolute;top:8px;right:8px;width:16px;height:16px}
.fab{position:fixed;bottom:20px;right:20px;width:48px;height:48px;border-radius:50%;background:var(--negro);color:var(--blanco);border:none;cursor:pointer}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:999}
.modal>div{background:var(--blanco);padding:24px;border:1px solid var(--negro);border-radius:var(--radio);width:90%;max-width:400px}
.close{float:right;font-size:1.2rem;cursor:pointer}
.ticket{font-family:Courier;font-size:11px;line-height:1.3;white-space:pre-wrap}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
  <h1>ACESSO</h1>
  <input id="pin" type="password" placeholder="PIN" autocomplete="off">
  <button onclick="entrar()">Entrar</button>
</div>

<!-- APP -->
<div id="app" class="oculto">
  <div class="header">
    <h1>Ventas</h1>
    <div>
      <button onclick="kiosko()">Kiosko</button>
    </div>
  </div>

  <div class="row">
    <input id="buscar" placeholder="Buscar nombre / código / barcode" oninput="filtrar()">
    <select id="filas" onchange="filtrar()">
      <option value="10">10</option>
      <option value="25">25</option>
      <option value="50">50</option>
      <option value="100" selected>100</option>
    </select>
    <button onclick="ordenar('name')">Nombre</button>
    <button onclick="ordenar('price')">Precio</button>
    <button onclick="ordenar('date')">Fecha</button>
    <button onclick="toggleAntiguo()">Antiguo→Nuevo</button>
  </div>

  <div class="row">
    <button onclick="generarFactura()">Generar Factura</button>
    <button onclick="location.href='lista.html'">Ver Ingresos</button>
  </div>

  <div class="grid" id="lista"></div>

  <div class="row" style="justify-content:center;margin-top:20px">
    <button onclick="pagina(-1)">‹ Anterior</button>
    <button onclick="pagina(1)">Siguiente ›</button>
  </div>
</div>

<!-- MODAL TOTALES -->
<button id="fab" class="fab oculto" onclick="abrirTotales()">0</button>
<div id="modalTotales" class="modal" onclick="cierraTotales()">
  <div onclick="event.stopPropagation()">
    <span class="close" onclick="cierraTotales()">×</span>
    <h2>Totales</h2>
    <p>Unidades: <strong id="tUnidades">0</strong></p>
    <p>Total: <strong id="tTotal">$0.00</strong></p>
  </div>
</div>

<!-- MODAL FACTURA -->
<div id="modalFactura" class="modal" onclick="cierraFactura()">
  <div onclick="event.stopPropagation()">
    <span class="close" onclick="cierraFactura()">×</span>
    <h2>Factura</h2>
    <label>Número</label><input id="fNum" value="00015" oninput="actualizaTicket()">
    <label>Fecha</label><input id="fFecha" readonly>
    <label>Cliente</label><input id="fCliente" value="Consumidor Final" oninput="actualizaTicket()">
    <div id="ticket" class="ticket"></div>
    <div class="row">
      <button onclick="imprimir()">Imprimir</button>
      <button onclick="pdf()">PDF</button>
    </div>
  </div>
</div>

<!-- MODAL IMAGEN -->
<div id="modalImg" class="modal" onclick="cierraImg()">
  <img id="imgGrande" style="max-width:90vw;max-height:90vh">
</div>

<script>
let ventas = JSON.parse(localStorage.getItem('soldInventory'))||[];
let paginaActual = 1;
let filasPorPag = 100;
let orden = {name:1,price:1,date:-1};
let antiguoPrimero = -1;   // -1 = nuevo primero (por defecto)

function $(q){return document.querySelector(q)}
function mostrar(el){$(el).classList.remove('oculto')}
function ocultar(el){$(el).classList.add('oculto')}

/* login */
function entrar(){
  if($('#pin').value==='132412'){
    ocultar('#login');
    mostrar('#app');
    mostrar('#fab');
    filtrar();
  }else{
    alert('PIN incorrecto');
    $('#pin').value='';
  }
}

/* tema (solo claro al inicio) */
function aplicarTema(){
  document.documentElement.style.setProperty('--blanco', '#ffffff');
  document.documentElement.style.setProperty('--negro', '#000000');
  document.documentElement.style.setProperty('--gris', '#f5f5f5');
}
aplicarTema(); // blanco predeterminado

/* kiosko */
function kiosko(){
  if(!document.fullscreenElement)document.documentElement.requestFullscreen();
  else document.exitFullscreen();
}

/* filtros y paginación */
function filtrar(){
  const txt = $('#buscar').value.toLowerCase();
  filasPorPag = parseInt($('#filas').value);
  const filtradas = ventas.filter(v=>
    v.name.toLowerCase().includes(txt)||
    v.code.toLowerCase().includes(txt)||
    v.barcode.toLowerCase().includes(txt)
  );
  paginaActual = 1;
  render(filtradas);
}
function pagina(dir){
  const max = Math.ceil(ventas.length/filasPorPag);
  if(dir<0 && paginaActual>1)paginaActual--;
  if(dir>0 && paginaActual<max)paginaActual++;
  render(ventas);
}

/* orden */
function ordenar(campo){
  orden[campo]*=-1;
  ventas.sort((a,b)=>{
    if(campo==='name')return a.name.localeCompare(b.name)*orden[campo];
    if(campo==='price')return (Number(a.price)-Number(b.price))*orden[campo];
    if(campo==='date')return (new Date(a.soldAt)-new Date(b.soldAt))*orden[campo];
  });
  filtrar();
}
function toggleAntiguo(){
  antiguoPrimero*=-1;
  ventas.sort((a,b)=>(new Date(a.soldAt)-new Date(b.soldAt))*antiguoPrimero);
  filtrar();
}

/* renderizado */
async function render(lista){
  const filtradas = lista||ventas;
  const totalU = filtradas.reduce((s,v)=>s+Number(v.quantity),0);
  const total$ = filtradas.reduce((s,v)=>s+Number(v.total),0);
  $('#fab').textContent = totalU;
  $('#tUnidades').textContent = totalU;
  $('#tTotal').textContent = '$'+total$.toFixed(2);

  const ini = (paginaActual-1)*filasPorPag;
  const trozo = filtradas.slice(ini, ini+filasPorPag);
  const html = await Promise.all(trozo.map(async v=>{
    const img = await localforage.getItem(`img_${v.code}`);
    const url = img ? URL.createObjectURL(img) : '';
    return `
      <div class="card">
        <input type="checkbox" class="check" value='${JSON.stringify(v)}'>
        ${url?`<img src="${url}" onclick="verImg('${url}')">`:''}
        <div><strong>${v.name}</strong></div>
        <div>$${Number(v.price).toFixed(2)} × ${v.quantity}</div>
        <div>Total: $${Number(v.total).toFixed(2)}</div>
        <div class="barcode">${v.barcode}</div>
        <button onclick="eliminar('${v.code}')">Eliminar</button>
      </div>`;
  }));
  $('#lista').innerHTML = html.join('');
}

/* eliminar */
function eliminar(code){
  if(!confirm('¿Eliminar esta venta?'))return;
  ventas = ventas.filter(v=>v.code!==code);
  localStorage.setItem('soldInventory',JSON.stringify(ventas));
  filtrar();
}

/* factura */
function generarFactura(){
  const checks = [...document.querySelectorAll('.check:checked')];
  if(!checks.length){alert('Selecciona al menos un producto');return;}
  $('#fFecha').value = new Date().toLocaleDateString('es-SV');
  mostrar('#modalFactura');
  actualizaTicket();
}
function actualizaTicket(){
  const checks = [...document.querySelectorAll('.check:checked')];
  let filas=''; let sum=0;
  checks.forEach(ch=>{
    const v=JSON.parse(ch.value);
    filas+=`${v.name}\n  ${v.quantity} × $${Number(v.price).toFixed(2)} = $${Number(v.total).toFixed(2)}\n`;
    sum+=Number(v.total);
  });
  const txt = `
KLOHESV
San Salvador, El Salvador
industriastobias@gmail.com
IG: @Klohesv
----------------------------
Factura N°: ${$('#fNum').value}
Fecha: ${$('#fFecha').value}
Cliente: ${$('#fCliente').value}
----------------------------
${filas}
----------------------------
TOTAL: $${sum.toFixed(2)}
¡Gracias por su compra!
No se aceptan cambios ni devoluciones, a menos que el producto esté dañado. Se aceptará dentro de los 5 días posteriores a la fecha de compra.
`;
  $('#ticket').textContent = txt;
}
function imprimir(){
  const ventana = window.open('','','width=360,height=600');
  ventana.document.write(`<pre style="font:11px/1.3 Courier">${$('#ticket').textContent}</pre>`);
  ventana.document.close();
  ventana.focus();
  ventana.print();
  ventana.close();
}
function pdf(){
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF({unit:'mm',format:[80,190]});
  const lineas = $('#ticket').textContent.split('\n');
  let y=6;
  lineas.forEach(l=>{
    if(y>180){doc.addPage([80,190]);y=6;}
    doc.text(l.trim(),4,y);
    y+=3.5;
  });
  doc.save(`ticket_${$('#fNum').value}.pdf`);
}
function cierraFactura(){ocultar('#modalFactura')}

/* totales */
function abrirTotales(){mostrar('#modalTotales')}
function cierraTotales(){ocultar('#modalTotales')}

/* img */
function verImg(src){
  $('#imgGrande').src=src;
  mostrar('#modalImg');
}
function cierraImg(){ocultar('#modalImg')}

/* atajos */
addEventListener('keydown',e=>{
  if(e.ctrlKey && e.key==='k'){e.preventDefault();$('#buscar').focus()}
  if(e.ctrlKey && e.key==='p'){e.preventDefault();imprimir()}
  if(e.ctrlKey && e.key==='n'){e.preventDefault();generarFactura()}
});

/* init */
// orden inicial: más nuevo primero
ventas.sort((a,b)=>new Date(b.soldAt)-new Date(a.soldAt));
</script>
</body>
</html>
