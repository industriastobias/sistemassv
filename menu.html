<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KLOHE – Dashboard Empresarial</title>

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">

  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --bg-900: #050607;
      --panel: rgba(255,255,255,0.03);
      --glass: rgba(255,255,255,0.04);
      --muted: #9aa3ad;
      --text: #f6f6f6;
      --gold: #c9a84b;
      --gold-2: #d8b85f;
      --accent: #bfa25a;
      --soft: rgba(255,255,255,0.02);
      --border: rgba(255,255,255,0.06);
      --radius: 14px;
      --shadow: 0 10px 30px rgba(2,4,6,0.6);
      --font-sans: "Inter", system-ui, sans-serif;
      --font-serif: "Playfair Display", serif;
    }
    body[data-theme="light"]{
      --bg-900: #fbf7f2;
      --panel: rgba(11,12,14,0.02);
      --glass: rgba(255,255,255,0.85);
      --muted: #6b7280;
      --text: #0b1220;
      --gold: #5b3b12;
      --gold-2: #7a5b2b;
      --accent: #7a5b2b;
      --soft: rgba(11,12,14,0.03);
      --border: rgba(11,12,14,0.06);
      --shadow: 0 10px 30px rgba(11,12,14,0.06);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:var(--font-sans);
      background: radial-gradient(1200px 600px at 10% 10%, rgba(191,162,90,0.06), transparent),
                  radial-gradient(900px 500px at 90% 90%, rgba(0,0,0,0.15), transparent),
                  var(--bg-900);
      color:var(--text);
      padding:28px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      transition: background .25s, color .25s;
      display:flex;
      justify-content:center;
    }

    /* Shell */
    .shell{
      width:100%;
      max-width:1280px;
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:24px;
      align-items:start;
    }

    /* Sidebar */
    .sidebar{
      height:calc(100vh - 56px);
      position:sticky;
      top:28px;
      border-radius:var(--radius);
      padding:18px;
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.01));
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:16px;
      min-width:240px;
      backdrop-filter: blur(6px) saturate(120%);
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .brand__mark{
      width:64px;height:64px;border-radius:12px;
      background:linear-gradient(180deg,var(--gold),var(--gold-2));
      display:grid;place-items:center;font-family:var(--font-serif);
      color:var(--bg-900); font-weight:700; font-size:1.5rem;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }
    .brand__title{font-family:var(--font-serif); font-size:1.25rem; color:var(--text); letter-spacing:0.6px}
    .brand__sub{font-size:0.78rem;color:var(--muted)}

    nav.nav{ display:flex; flex-direction:column; gap:8px; margin-top:4px; overflow:auto; padding-right:6px }
    nav.nav a{
      display:flex; align-items:center; gap:12px;
      padding:12px; border-radius:12px;
      text-decoration:none; color:var(--text);
      font-weight:600; font-size:0.95rem;
      background:transparent; border:1px solid transparent;
      transition: transform .12s ease, background .12s, box-shadow .12s;
    }
    nav.nav a i{ width:26px; text-align:center; color:var(--gold) }
    nav.nav a:hover{ transform: translateY(-4px); background: linear-gradient(90deg, rgba(191,162,90,0.06), rgba(255,255,255,0.01)); box-shadow: 0 8px 30px rgba(0,0,0,0.45) }
    nav.nav a.active{ background: linear-gradient(90deg, rgba(191,162,90,0.12), rgba(255,255,255,0.02)); border:1px solid rgba(191,162,90,0.09) }

    .sidebar__meta{
      margin-top:auto;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding-top:8px; border-top:1px dashed var(--border); color:var(--muted); font-size:0.9rem;
    }
    .btn-ghost{
      background:transparent; border:1px solid var(--border); padding:8px 10px; border-radius:10px; color:var(--text);
      cursor:pointer; font-weight:600;
    }

    /* Main panel */
    .panel{
      border-radius:var(--radius); padding:22px; min-height:calc(100vh - 56px);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid var(--border); box-shadow:var(--shadow); display:flex; flex-direction:column; gap:16px;
      backdrop-filter: blur(4px) saturate(120%);
    }

    .panel__header{ display:flex; align-items:center; justify-content:space-between; gap:12px }
    .search{
      display:flex; align-items:center; gap:12px; padding:10px 14px; border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid var(--border);
      width:100%; max-width:760px;
    }
    .search input{ background:transparent; border:0; outline:0; color:var(--text); font-size:0.95rem; width:100% }
    .controls{ display:flex; gap:10px; align-items:center }

    .btn{
      padding:10px 14px; border-radius:12px; border:1px solid var(--border); cursor:pointer; font-weight:700;
      background:transparent; color:var(--text); display:inline-flex; gap:10px; align-items:center;
      transition: transform .12s, box-shadow .12s;
    }
    .btn:hover{ transform:translateY(-3px) }
    .btn--gold{
      background: linear-gradient(90deg, var(--gold), var(--gold-2));
      color: var(--bg-900); border:1px solid rgba(0,0,0,0.12);
      box-shadow: 0 8px 30px rgba(191,162,90,0.06);
    }

    .avatar{ display:flex; align-items:center; gap:10px }
    .avatar__bubble{
      width:44px;height:44px;border-radius:10px; display:grid; place-items:center;
      border:1px solid var(--border); background:transparent; font-weight:700; font-family:var(--font-serif);
      color:var(--text);
    }

    .welcome{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .welcome h1{ font-family:var(--font-serif); font-size:1.9rem; letter-spacing:-0.8px; color:var(--text) }
    .welcome p{ color:var(--muted); margin-top:6px }

    .kpi{ display:flex; gap:12px; align-items:center }
    .kpi-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:12px 14px; border-radius:12px; border:1px solid var(--border); min-width:140px;
    }
    .kpi-card small{ color:var(--muted); display:block; font-size:0.8rem }
    .kpi-card strong{ display:block; margin-top:6px; font-size:1.1rem }

    .grid{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:14px; margin-top:6px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px; padding:16px; border:1px solid var(--border);
      min-height:110px;
    }

    .panel__footer{ text-align:center; color:var(--muted); font-size:0.9rem; margin-top:auto }

    /* Responsive */
    @media (max-width:1100px){
      .shell{ grid-template-columns: 1fr; gap:12px; padding-bottom:20px }
      .sidebar{ position:relative; height:auto; order:2; display:flex; flex-direction:row; overflow:auto; gap:12px; padding:12px }
      .brand__mark{ width:48px;height:48px }
      nav.nav{ flex-direction:row; gap:10px; min-width:max-content }
      .panel{ order:1; min-height: auto }
      .grid{ grid-template-columns: repeat(2, 1fr) }
    }
    @media (max-width:640px){
      .grid{ grid-template-columns: 1fr }
      .search{ max-width:100% }
    }
  </style>
</head>
<body>

  <div class="shell" role="application">

    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="Menú principal">
      <div class="brand" aria-hidden="false">
        <div class="brand__mark" aria-hidden="true">K</div>
        <div>
          <div class="brand__title">KLOHE</div>
          <div class="brand__sub">jewelry · carteras · experiencias</div>
        </div>
      </div>

      <nav class="nav" id="nav">
        <a href="almacenamiento.html"><i class="fa-solid fa-warehouse"></i> Almacén</a>
        <a href="clientes.html"><i class="fa-solid fa-users"></i> Clientes</a>
        <a href="compra.html" id="compra-link"><i class="fa-solid fa-cart-plus"></i> Compra</a>
        <a href="descuentos.html" id="descuentos-link"><i class="fa-solid fa-percent"></i> Descuentos</a>
        <a href="facturas.html"><i class="fa-solid fa-file-invoice"></i> Facturas</a>
        <a href="gastos.html"><i class="fa-solid fa-money-check-dollar"></i> Gastos</a>
        <a href="inventario.html"><i class="fa-solid fa-boxes-stacked"></i> Inventario</a>
        <a href="lista.html" id="lista-link"><i class="fa-solid fa-list"></i> Lista</a>
        <a href="traslados.html"><i class="fa-solid fa-truck"></i> Traslados</a>
        <a href="venta.html" id="venta-link"><i class="fa-solid fa-cash-register"></i> Venta</a>
        <a href="lista_usuarios.html" id="usuarios-link"><i class="fa-solid fa-user-gear"></i> Usuarios</a>
        <a href="Verificasion.html"><i class="fa-solid fa-check-double"></i> Verificación</a>
      </nav>

      <div class="sidebar__meta" aria-hidden="false">
        <div>
          <div style="font-size:0.75rem;color:var(--muted)">Versión</div>
          <div style="font-weight:700">2025 • KLOHE</div>
        </div>

        <div style="text-align:right">
          <div id="session-user" style="font-size:0.9rem;color:var(--muted)">—</div>
          <div style="margin-top:8px">
            <button class="btn-ghost" onclick="logout()" title="Cerrar sesión"><i class="fa-solid fa-right-from-bracket"></i></button>
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN PANEL -->
    <main class="panel" role="main" aria-labelledby="welcome-title">
      <div class="panel__header">
        <div class="search" role="search" aria-label="Buscar">
          <i class="fa-solid fa-magnifying-glass" style="opacity:.8;color:var(--muted)"></i>
          <input id="search-input" placeholder="Buscar producto, cliente, factura..." aria-label="Buscar" />
        </div>

        <div class="controls" role="toolbar">
          <button class="btn" onclick="toggleTheme()" title="Cambiar tema">
            <i id="theme-icon" class="fa-solid fa-moon"></i>
            <span style="display:none">tema</span>
          </button>

          <button class="btn btn--gold" onclick="location.href='venta.html'"><i class="fa-solid fa-cash-register"></i> Nueva venta</button>

          <div class="avatar" title="Usuario">
            <div class="avatar__bubble" id="avatar-initial">KT</div>
          </div>
        </div>
      </div>

      <section class="welcome">
        <div>
          <h1 id="welcome-title">KLOHE — A FAMILY COMPANY</h1>
          <p>Panel administrativo • Acceso rápido a inventario, ventas y clientes</p>
        </div>

        <div class="kpi" aria-hidden="false">
          <div class="kpi-card">
            <small>Ventas (hoy)</small>
            <strong id="stat-sales">$0.00</strong>
          </div>
          <div class="kpi-card">
            <small>Inventario</small>
            <strong id="stat-stock">— ítems</strong>
          </div>
          <div class="kpi-card">
            <small>Clientes</small>
            <strong id="stat-clients">—</strong>
          </div>
        </div>
      </section>

      <div class="grid" aria-live="polite">
        <div class="card">
          <h3 style="margin-bottom:8px;font-size:1rem">Resumen</h3>
          <p style="color:var(--muted)">Accede a las funciones desde la barra lateral. Todas las integraciones (IndexedDB, roles, sesión) están preservadas.</p>
        </div>

        <div class="card">
          <h3 style="margin-bottom:8px;font-size:1rem">Atajos</h3>
          <p style="color:var(--muted)">Crear venta, ver inventario, administrar usuarios y más.</p>
        </div>

        <div class="card">
          <h3 style="margin-bottom:8px;font-size:1rem">Notificaciones</h3>
          <p style="color:var(--muted)">No hay notificaciones nuevas.</p>
        </div>
      </div>

      <div class="panel__footer">© 2025 KLOHE – Sistema empresarial</div>
    </main>

  </div>

  <!-- ================= JS: conservé exactamente las funciones clave para no romper nada ================= -->
  <script>
    /* ---------- IndexedDB (mismos nombres y estructura) ---------- */
    const DB_NAME = 'menuDB';
    const STORE_THEME = 'theme';
    const STORE_SESSION = 'userSession';
    let db;

    async function openDB() {
      return new Promise((res, rej) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onerror = () => rej(req.error);
        req.onsuccess = () => res(db = req.result);
        req.onupgradeneeded = () => {
          const dbu = req.result;
          if (!dbu.objectStoreNames.contains(STORE_THEME)) dbu.createObjectStore(STORE_THEME);
          if (!dbu.objectStoreNames.contains(STORE_SESSION)) dbu.createObjectStore(STORE_SESSION, { keyPath: 'id' });
        };
      });
    }

    async function getTheme() {
      try {
        const tx = db.transaction([STORE_THEME], 'readonly');
        return await new Promise((res, rej) => {
          const req = tx.objectStore(STORE_THEME).get('current');
          req.onsuccess = () => res(req.result);
          req.onerror = () => rej(req.error);
        });
      } catch (e) { return null; }
    }
    async function setTheme(value) {
      try {
        const tx = db.transaction([STORE_THEME], 'readwrite');
        tx.objectStore(STORE_THEME).put(value, 'current');
        return tx.complete;
      } catch(e){ console.warn(e); }
    }

    async function getSession() {
      try {
        const tx = db.transaction([STORE_SESSION], 'readonly');
        return await new Promise((res, rej) => {
          const req = tx.objectStore(STORE_SESSION).get(1);
          req.onsuccess = () => res(req.result);
          req.onerror = () => rej(req.error);
        });
      } catch (e) { return null; }
    }
    async function clearSession() {
      try {
        const tx = db.transaction([STORE_SESSION], 'readwrite');
        tx.objectStore(STORE_SESSION).clear();
        return tx.complete;
      } catch (e) { console.warn(e); }
    }

    /* ---------- Sesión / autenticación ---------- */
    function checkAuthentication() {
      if (sessionStorage.getItem('loggedIn') !== 'true') {
        if (!window.location.pathname.endsWith('index.html')) {
          window.location.replace('index.html');
        }
      }
    }

    async function logout() {
      try { await clearSession(); } catch(e){ console.warn(e); }
      sessionStorage.clear();
      window.location.replace('index.html');
    }

    /* ---------- Mostrar/ocultar enlaces por rol (mismos IDs) ---------- */
    async function configureUserLinks() {
      const session = await getSession();
      const userID = session ? session.userID : null;
      const userLink = document.getElementById('usuarios-link');
      const compraLink = document.getElementById('compra-link');
      const ventaLink = document.getElementById('venta-link');

      if (userLink) userLink.style.display = (userID === '2005') ? '' : 'none';
      if (compraLink) compraLink.style.display = (userID && userID.startsWith('100')) ? 'none' : '';
      if (ventaLink) ventaLink.style.display = (userID && userID.startsWith('100')) ? 'none' : '';

      // Mostrar nombre/initials
      const sessionUserEl = document.getElementById('session-user');
      const avatarEl = document.getElementById('avatar-initial');
      if (session && session.name) {
        if (sessionUserEl) sessionUserEl.textContent = session.name;
        if (avatarEl) {
          const initials = session.name.split(' ').map(s => s.charAt(0)).slice(0,2).join('').toUpperCase();
          avatarEl.textContent = initials || 'KT';
        }
      } else {
        if (sessionUserEl) sessionUserEl.textContent = 'Invitado';
      }
    }

    /* ---------- Tema (preservé nombres applyTheme / toggleTheme) ---------- */
    async function applyTheme(theme) {
      const icon = document.getElementById('theme-icon');
      if (!theme || theme === 'dark') {
        document.body.removeAttribute('data-theme'); // mantiene variables dark por defecto
        icon.classList.remove('fa-sun'); icon.classList.add('fa-moon');
      } else {
        document.body.setAttribute('data-theme', 'light'); // alternamos a light
        icon.classList.remove('fa-moon'); icon.classList.add('fa-sun');
      }
    }

    async function toggleTheme() {
      const current = (await getTheme()) || 'dark';
      const newTheme = current === 'dark' ? 'light' : 'dark';
      try { await setTheme(newTheme); } catch(e){ console.warn(e); }
      await applyTheme(newTheme);
    }

    /* ---------- Resaltar página actual (misma función) ---------- */
    function highlightCurrentPage() {
      const currentPage = window.location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.nav a').forEach(link => {
        const href = link.getAttribute('href') || '';
        if (href === currentPage) link.classList.add('active');
        else link.classList.remove('active');
      });
    }

    /* ---------- Inicialización ---------- */
    document.addEventListener('DOMContentLoaded', async () => {
      try { await openDB(); } catch(e){ console.warn('No se pudo abrir IndexedDB', e); }

      // autenticación (preserva comportamiento antiguo)
      checkAuthentication();

      // configurar enlaces según sesión
      try { await configureUserLinks(); } catch(e){ console.warn(e); }

      // resaltar página en nav
      highlightCurrentPage();

      // aplicar tema guardado
      try {
        const saved = (await getTheme()) || 'dark';
        await applyTheme(saved);
      } catch(e){ console.warn(e); }

      // estadisticas placeholder (puedes reemplazar por datos reales)
      document.getElementById('stat-sales').textContent = '$0.00';
      document.getElementById('stat-stock').textContent = '— ítems';
      document.getElementById('stat-clients').textContent = '—';
    });

    /* ---------- UX: Enter en búsqueda ---------- */
    document.getElementById('search-input').addEventListener('keydown', function(e){
      if (e.key === 'Enter') {
        const q = e.target.value.trim();
        if (!q) return;
        window.location.href = `lista.html?search=${encodeURIComponent(q)}`;
      }
    });
  </script>
</body>
</html>
