<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Factura KLOHESV</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>
  <style>
    body{font-family:Courier New,monospace;background:#f9f9f9;display:flex;justify-content:center;padding:20px}
    .ticket{width:320px;background:#fff;padding:15px;box-shadow:0 0 5px rgba(0,0,0,.2);border-radius:8px}
    h2{text-align:center;margin-bottom:5px;letter-spacing:1px}
    .center{text-align:center}
    .info,.footer{font-size:13px;margin-top:10px;border-top:1px dashed #999;padding-top:5px}
    table{width:100%;border-collapse:collapse;font-size:13px;margin-top:10px}
    th,td{text-align:left;padding:5px 0}
    th{border-bottom:1px dashed #999}
    .total{border-top:1px dashed #999;text-align:right;font-weight:bold;margin-top:10px;padding-top:5px}
    button{margin-top:10px;width:100%;background:#000;color:#fff;border:none;padding:8px;cursor:pointer;border-radius:5px}
    button:hover{background:#333}
    @media print{button{display:none}}
  </style>
</head>
<body>
<div class="ticket" id="invoice">
  <h2>KLOHESV</h2>
  <div class="center">
    <p>San Salvador, El Salvador</p>
    <p>Correo: industriastobias@gmail.com</p>
    <p>Instagram: @Klohesv</p>
  </div>
  <div class="info">
    <p><strong>Factura N°:</strong> <span contenteditable="true" id="facturaNum">00015</span></p>
    <p><strong>Fecha:</strong> <span contenteditable="true" id="fecha"></span></p>
    <p><strong>Cliente:</strong> <span contenteditable="true" id="cliente">Consumidor Final</span></p>
  </div>

  <table>
    <thead>
      <tr><th>Producto</th><th>Cant</th><th>Precio</th><th>Total</th></tr>
    </thead>
    <tbody id="productos">
      <tr>
        <td contenteditable="true">Collar</td>
        <td contenteditable="true" class="cantidad">1</td>
        <td contenteditable="true" class="precio">10.00</td>
        <td class="subtotal">10.00</td>
      </tr>
    </tbody>
  </table>

  <button onclick="agregarFila()">Agregar producto</button>
  <button onclick="calcularTotal()">Actualizar total</button>

  <div class="total">
    TOTAL: $<span id="total">10.00</span>
  </div>

  <div class="footer center">
    <p>¡Gracias por su compra!</p>
    <p style="font-size:10px;color:#555">No se aceptan cambios ni devoluciones, a menos que el producto esté dañado.</p>
  </div>

  <button onclick="descargarPDF()">Descargar PDF</button>
  <button onclick="window.print()">Imprimir Factura</button>
</div>

<script>
  document.getElementById('fecha').innerText = new Date().toLocaleDateString('es-SV');

  function agregarFila() {
    const tbody = document.getElementById('productos');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td contenteditable="true">Nuevo producto</td>
      <td contenteditable="true" class="cantidad">1</td>
      <td contenteditable="true" class="precio">0.00</td>
      <td class="subtotal">0.00</td>`;
    tbody.appendChild(tr);
    calcularTotal();
  }

  function calcularTotal() {
    let total = 0;
    document.querySelectorAll('#productos tr').forEach(r => {
      const c = parseFloat(r.querySelector('.cantidad').innerText) || 0;
      const p = parseFloat(r.querySelector('.precio').innerText) || 0;
      const s = (c * p).toFixed(2);
      r.querySelector('.subtotal').innerText = s;
      total += parseFloat(s);
    });
    document.getElementById('total').innerText = total.toFixed(2);
  }

  /* ---------- PDF TEXTO-PURO (AppsGeyser) ---------- */
  function descargarPDF() {
    try {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: [80, 200] });

      const numFac = document.getElementById('facturaNum').innerText;
      const fecha  = document.getElementById('fecha').innerText;
      const cliente= document.getElementById('cliente').innerText;
      const filas  = [];
      document.querySelectorAll('#productos tr').forEach(r => {
        const c = r.querySelectorAll('td');
        filas.push([c[0].innerText, c[1].innerText, c[2].innerText, c[3].innerText]);
      });
      const total = document.getElementById('total').innerText;

      pdf.setFontSize(12);
      pdf.text('KLOHESV', 40, 8, { align: 'center' });
      pdf.setFontSize(9);
      pdf.text('San Salvador, El Salvador', 40, 13, { align: 'center' });
      pdf.text('Correo: industriastobias@gmail.com', 40, 18, { align: 'center' });
      pdf.text('Instagram: @Klohesv', 40, 23, { align: 'center' });
      pdf.text('-------------------------------------', 5, 28);
      pdf.text(`Factura N°: ${numFac}`, 5, 33);
      pdf.text(`Fecha: ${fecha}`, 5, 38);
      pdf.text(`Cliente: ${cliente}`, 5, 43);
      pdf.text('-------------------------------------', 5, 48);

      pdf.autoTable({
        head: [['Producto', 'Cant', 'Precio', 'Total']],
        body: filas,
        startY: 52,
        theme: 'plain',
        styles: { fontSize: 9, cellPadding: 1 },
        headStyles: { fontStyle: 'bold' },
        margin: { left: 5, right: 5 }
      });

      const finalY = pdf.lastAutoTable.finalY || 52;
      pdf.text('-------------------------------------', 5, finalY + 4);
      pdf.text(`TOTAL: $${total}`, 60, finalY + 9, { align: 'right' });
      pdf.text('-------------------------------------', 5, finalY + 14);
      pdf.text('¡Gracias por su compra!', 40, finalY + 20, { align: 'center' });
      pdf.text('No se aceptan cambios ni devoluciones', 40, finalY + 26, { align: 'center', fontSize: 7 });
      pdf.text('a menos que el producto esté dañado.', 40, finalY + 30, { align: 'center', fontSize: 7 });

      pdf.save('factura_KLOHESV.pdf');
    } catch (err) {
      alert('Error: ' + err);
    }
  }
</script>
</body>
</html>
