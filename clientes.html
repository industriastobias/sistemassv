<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clientes â€” 20/80 Split</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/clusterize.js@0.18.0/clusterize.css">
  <style>
    :root{--primary:#4f46e5;--primary-hover:#4338ca;--bg:#f5f7fa;--card:#ffffff;--text:#111827;--muted:#6b7280;--border:#e5e7eb;--radius:12px;--error:#ef4444}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif}
    html,body{height:100%}body{background:var(--bg);color:var(--text)}
    .split{display:flex;height:100%}
    .left{flex:0 0 20%;background:var(--card);border-right:1px solid var(--border);padding:2rem 1.5rem;overflow-y:auto}
    .right{flex:0 0 80%;padding:2rem;overflow:hidden;display:flex;flex-direction:column}
    h1{font-size:1.5rem;font-weight:600;margin-bottom:1.5rem}
    label{font-weight:500;margin-bottom:.25rem;display:block}
    input,select{width:100%;padding:.6rem .75rem;border:1px solid var(--border);border-radius:8px;margin-bottom:1rem;transition:border-color .2s}
    input:focus,select:focus{outline:none;border-color:var(--primary)}
    input.error{border-color:var(--error)}
    button{width:100%;padding:.6rem;border:none;border-radius:8px;font-weight:500;cursor:pointer;background:var(--primary);color:#fff;transition:background .2s}
    button:disabled{background:var(--muted);cursor:not-allowed}
    button:hover:not(:disabled){background:var(--primary-hover)}
    table{width:100%;border-collapse:collapse;font-size:.95rem}
    th,td{padding:.6rem .75rem;text-align:left;border-bottom:1px solid var(--border)}
    th{background:var(--bg);font-weight:600;cursor:pointer;user-select:none}
    .actions{display:flex;gap:.25rem}
    .actions button{width:28px;height:28px;padding:0;background:var(--bg);border:1px solid var(--border);color:var(--text);font-size:.9rem;transition:all .2s}
    .actions button:hover{background:var(--primary);color:#fff;border-color:var(--primary)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
    .modal.active{opacity:1;pointer-events:auto}
    .modal-content{background:var(--card);padding:2rem;border-radius:var(--radius);width:90%;max-width:400px}
    .modal-actions{display:flex;gap:1rem;justify-content:flex-end;margin-top:1.5rem}
    .notification{position:fixed;bottom:2rem;right:2rem;background:var(--primary);color:#fff;padding:1rem 1.5rem;border-radius:8px;opacity:0;transform:translateY(10px);transition:all .3s;z-index:1000}
    .notification.show{opacity:1;transform:none}
    .history{max-height:200px;overflow-y:auto;font-size:.85rem;margin-top:1rem}
    .history li{margin-bottom:.5rem}
    #scrollArea{flex:1 1 auto}
    @media(max-width:768px){.split{flex-direction:column}.left,.right{flex:1 1 auto;width:100%}.left{border-right:none;border-bottom:1px solid var(--border)}}
  </style>
</head>
<body>
<div class="split">
  <div class="left">
    <h1>Agregar Cliente</h1>
    <form id="form-cliente">
      <label for="cliente-id">ID</label>
      <input id="cliente-id" placeholder="ABC123" required />

      <label for="cliente-correo-select">Dominio</label>
      <select id="cliente-correo-select">
        <option value="@gmail.com">@gmail.com</option>
        <option value="@outlook.com">@outlook.com</option>
        <option value="@icloud.com">@icloud.com</option>
        <option value="@hotmail.com">@hotmail.com</option>
        <option value="otro">Otro</option>
      </select>

      <label for="cliente-usuario">Usuario (sin @)</label>
      <input id="cliente-usuario" placeholder="usuario" />
      <input id="cliente-correo" type="hidden" />

      <label for="cliente-telefono">Celular</label>
      <input id="cliente-telefono" type="tel" placeholder="777123456" required />

      <button id="btn-guardar" disabled>Agregar Cliente</button>
    </form>
    <button id="btn-export-zip" style="margin-top:.5rem;background:#3b82f6;">Exportar ZIP</button>
    <button id="btn-import-zip" style="margin-top:.5rem;background:#8b5cf6;">Importar ZIP</button>
    <input type="file" id="input-import-zip" accept=".zip" style="display:none;" />
  </div>

  <div class="right">
    <h1>Clientes</h1>
    <div class="filters" style="display:flex;gap:1rem;margin-bottom:1rem;">
      <input id="filtro-id" placeholder="ID" />
      <input id="filtro-correo" placeholder="Correo" />
      <input id="filtro-telefono" placeholder="Celular" />
    </div>
    <table id="tabla-clientes">
      <thead>
        <tr>
          <th>ID</th>
          <th>Correo</th>
          <th>Celular</th>
          <th id="sort-puntos" style="cursor:pointer">Puntos</th>
          <th id="sort-fecha" style="cursor:pointer">Fecha â–¼</th>
          <th></th>
        </tr>
      </thead>
    </table>
    <div id="scrollArea">
      <table><tbody id="clientes-table"></tbody></table>
    </div>
  </div>
</div>

<!-- Modales -->
<div class="modal" id="modal-overlay">
  <div class="modal-content">
    <h2>Modificar Puntos</h2>
    <input id="input-puntos" type="number" min="1" placeholder="Cantidad" />
    <input id="input-motivo" placeholder="Motivo (opcional)" style="margin-top:.5rem;" />
    <div class="modal-actions">
      <button id="btn-sumar" class="btn-primary">Sumar</button>
      <button id="btn-quitar" style="background:#f59e0b;">Quitar</button>
      <button id="btn-cerrar" style="background:var(--border);color:var(--text);">Cancelar</button>
    </div>
  </div>
</div>

<div class="modal" id="modal-historial">
  <div class="modal-content">
    <h2>Historial de Puntos</h2>
    <ul class="history" id="historial-lista"></ul>
    <button id="btn-cerrar-historial" style="background:var(--border);color:var(--text);margin-top:1rem;">Cerrar</button>
  </div>
</div>

<div class="notification" id="notification"></div>

<script src="https://cdn.jsdelivr.net/npm/clusterize.js@0.18.0/clusterize.min.js"></script>
<script>
/* ---------- IndexedDB simple (get/set) ---------- */
const KEY = 'clientes';
let clientes = [];
let clusterize;
let ordenDesc = true;   // true â†’ mÃ¡s reciente primero
let ordenarPor = 'fecha';

const idb = (() => {
  let db;
  const open = () => {
    return new Promise((res, rej) => {
      const req = indexedDB.open('clientesDB', 1);
      req.onerror = () => rej(req.error);
      req.onsuccess = () => { db = req.result; res(); };
      req.onupgradeneeded = () => {
        db = req.result;
        if (!db.objectStoreNames.contains('store')) db.createObjectStore('store');
      };
    });
  };
  const get = async () => {
    if (!db) await open();
    return new Promise((res, rej) => {
      const tx = db.transaction('store', 'readonly');
      const req = tx.objectStore('store').get(KEY);
      req.onerror = () => rej(req.error);
      req.onsuccess = () => res(req.result || []);
    });
  };
  const set = async (data) => {
    if (!db) await open();
    return new Promise((res, rej) => {
      const tx = db.transaction('store', 'readwrite');
      const req = tx.objectStore('store').put(data, KEY);
      req.onerror = () => rej(req.error);
      req.onsuccess = () => res();
    });
  };
  return { get, set };
})();

async function load() { clientes = await idb.get(); }
async function save() { await idb.set(clientes); }

/* ---------- Utilidades ---------- */
const $ = s => document.querySelector(s);
const notify = msg => {
  const n = $('#notification');
  n.textContent = msg;
  n.classList.add('show');
  setTimeout(() => n.classList.remove('show'), 3000);
};
const validarId = i => /^[a-zA-Z0-9\-]{1,20}$/.test(i);
const validarEmail = e => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
const validarTel = t => /^\d{7,15}$/.test(t);

/* ---------- Correo dinÃ¡mico ---------- */
const sel = $('#cliente-correo-select');
const usr = $('#cliente-usuario');
const hdn = $('#cliente-correo');
function armaCorreo() {
  if (sel.value === 'otro') {
    hdn.type = 'email'; hdn.placeholder = 'correo@dominio.com'; hdn.disabled = false;
    usr.style.display = 'none'; usr.required = false; hdn.required = true;
  } else {
    hdn.type = 'hidden'; hdn.disabled = true; usr.style.display = 'block'; usr.placeholder = 'usuario';
    hdn.required = false; usr.required = true; hdn.value = usr.value.trim() + sel.value;
  }
  validarFormulario();
}
sel.addEventListener('change', armaCorreo);
usr.addEventListener('input', armaCorreo);
armaCorreo();

function validarFormulario() {
  const id = $('#cliente-id').value.trim();
  const correo = hdn.value.trim();
  const telefono = $('#cliente-telefono').value.trim();
  const ok = validarId(id) && validarEmail(correo) && validarTel(telefono);
  $('#btn-guardar').disabled = !ok;
}
$('#cliente-id').addEventListener('input', validarFormulario);
$('#cliente-telefono').addEventListener('input', validarFormulario);

/* ---------- Clusterize ---------- */
function initClusterize(rows) {
  if (clusterize) clusterize.destroy();
  clusterize = new Clusterize({
    rows: rows,
    scrollElem: $('#scrollArea'),
    contentElem: $('#clientes-table')
  });
}

/* ---------- Render ---------- */
let editando = null;
function render() {
  const fid = $('#filtro-id').value.trim().toLowerCase();
  const fcor = $('#filtro-correo').value.trim().toLowerCase();
  const ftel = $('#filtro-telefono').value.trim().toLowerCase();

  let filtrados = clientes.filter(c =>
    (!fid || c.id === fid) &&
    (!fcor || c.correo.toLowerCase().includes(fcor)) &&
    (!ftel || c.telefono === ftel)
  );

  // orden por fecha (default)
  filtrados.sort((a, b) => {
    const valA = ordenarPor === 'fecha' ? new Date(a.fecha) : a.puntos;
    const valB = ordenarPor === 'fecha' ? new Date(b.fecha) : b.puntos;
    return ordenDesc ? valB - valA : valA - valB;
  });

  const htmlRows = filtrados.length
    ? filtrados.map(c => `
        <tr>
          <td>${c.id}</td>
          <td>${c.correo}</td>
          <td>${c.telefono}</td>
          <td>${c.puntos}</td>
          <td>${c.fecha}</td>
          <td class="actions">
            <button class="history" data-id="${c.id}" title="Historial">ðŸ“‹</button>
            <button class="add" data-id="${c.id}" title="Sumar">+</button>
            <button class="sub" data-id="${c.id}" title="Restar">âˆ’</button>
            <button class="del" data-id="${c.id}" title="Eliminar">Ã—</button>
          </td>
        </tr>`)
    : [`<tr><td colspan="6" style="text-align:center;color:var(--muted)">Sin coincidencias</td></tr>`];
  initClusterize(htmlRows);
}

/* ---------- Orden por columnas ---------- */
$('#sort-fecha').onclick = () => {
  if (ordenarPor === 'fecha') ordenDesc = !ordenDesc;
  else { ordenarPor = 'fecha'; ordenDesc = true; }
  $('#sort-fecha').textContent = `Fecha ${ordenDesc ? 'â–¼' : 'â–²'}`;
  $('#sort-puntos').textContent = 'Puntos';
  render();
};
$('#sort-puntos').onclick = () => {
  if (ordenarPor === 'puntos') ordenDesc = !ordenDesc;
  else { ordenarPor = 'puntos'; ordenDesc = true; }
  $('#sort-puntos').textContent = `Puntos ${ordenDesc ? 'â–¼' : 'â–²'}`;
  $('#sort-fecha').textContent = 'Fecha';
  render();
};

/* ---------- Altas / ediciones ---------- */
$('#form-cliente').addEventListener('submit', async e => {
  e.preventDefault();
  const id = $('#cliente-id').value.trim();
  const correo = hdn.value.trim();
  const telefono = $('#cliente-telefono').value.trim();
  if (!validarId(id)) return alert('ID invÃ¡lido');
  if (!validarEmail(correo)) return alert('Correo invÃ¡lido');
  if (!validarTel(telefono)) return alert('Celular invÃ¡lido');
  if (editando) {
    const c = clientes.find(x => x.id === editando);
    c.correo = correo; c.telefono = telefono;
    notify('Actualizado');
    editando = null;
    $('#btn-guardar').textContent = 'Agregar Cliente';
    $('#cliente-id').disabled = false;
  } else {
    if (clientes.some(x => x.id === id)) return alert('ID duplicado');
    clientes.push({ id, correo, telefono, puntos: 0, fecha: new Date().toLocaleDateString(), historial: [] });
    notify('Agregado');
  }
  await save(); e.target.reset(); armaCorreo(); render();
});

/* ---------- Acciones fila ---------- */
$('#clientes-table').addEventListener('click', async e => {
  const b = e.target.closest('button');
  if (!b) return;
  const id = b.dataset.id;
  const c = clientes.find(x => x.id === id);
  if (!c) return;
  if (b.classList.contains('history')) {
    $('#modal-historial').classList.add('active');
    $('#historial-lista').innerHTML = c.historial.length
      ? c.historial.map(h => `<li><strong>${h.tipo === 'suma' ? '+' : '-'}${h.cantidad}</strong> â€” ${h.motivo || 'Sin motivo'} â€” ${h.fecha}</li>`).join('')
      : '<li>Sin movimientos</li>';
  }
  if (b.classList.contains('del') && confirm(`Â¿Eliminar ${id}?`)) {
    clientes = clientes.filter(x => x.id !== id);
    await save(); render();
    if (editando === id) { editando = null; $('#form-cliente').reset(); $('#btn-guardar').textContent = 'Agregar Cliente'; $('#cliente-id').disabled = false; }
  }
  if (b.classList.contains('add') || b.classList.contains('sub')) {
    const m = $('#modal-overlay');
    m.dataset.id = id; m.dataset.act = b.classList.contains('add') ? 'sum' : 'res';
    m.classList.add('active');
    $('#input-puntos').value = ''; $('#input-motivo').value = '';
    $('#input-puntos').focus();
  }
});

$('#btn-cerrar').onclick = () => $('#modal-overlay').classList.remove('active');
$('#btn-cerrar-historial').onclick = () => $('#modal-historial').classList.remove('active');

['#btn-sumar', '#btn-quitar'].forEach((s, i) => {
  $(s).onclick = async () => {
    const cant = parseInt($('#input-puntos').value);
    const motivo = $('#input-motivo').value.trim();
    if (isNaN(cant) || cant < 1) return alert('Cantidad invÃ¡lida');
    const id = $('#modal-overlay').dataset.id;
    const c = clientes.find(x => x.id === id);
    if (i === 0) {
      c.puntos += cant;
      c.historial.unshift({ tipo: 'suma', cantidad: cant, motivo, fecha: new Date().toLocaleString() });
      notify(`+${cant} puntos`);
    } else {
      if (cant > c.puntos) return alert('Puntos insuficientes');
      c.puntos -= cant;
      c.historial.unshift({ tipo: 'resta', cantidad: cant, motivo, fecha: new Date().toLocaleString() });
      notify(`-${cant} puntos`);
    }
    await save(); render();
    $('#modal-overlay').classList.remove('active');
  };
});

/* ---------- Filtros ---------- */
['#filtro-id', '#filtro-correo', '#filtro-telefono'].forEach(id => $(id).addEventListener('input', render));

/* ---------- ZIP ---------- */
$('#btn-export-zip').onclick = async () => {
  const zip = (await import('https://cdn.skypack.dev/jszip@3.10.1')).default();
  zip.file('clientes.json', JSON.stringify(clientes));
  const rows = [['ID', 'Correo', 'Tipo', 'Cantidad', 'Motivo', 'Fecha']];
  clientes.forEach(c => c.historial.forEach(h => rows.push([c.id, c.correo, h.tipo, h.cantidad, h.motivo || '', h.fecha])));
  const csv = rows.map(r => r.map(f => `"${f}"`).join(',')).join('\n');
  zip.file('historial_completo.csv', csv);
  const blob = await zip.generateAsync({ type: 'blob' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'clientes_historial.zip'; a.click();
  notify('ZIP exportado');
};
$('#btn-import-zip').onclick = () => $('#input-import-zip').click();
$('#input-import-zip').addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file || !file.name.endsWith('.zip')) return notify('Archivo no vÃ¡lido');
  try {
    const zip = await (await import('https://cdn.skypack.dev/jszip@3.10.1')).default.loadAsync(file);
    const jsonFile = zip.file('clientes.json');
    if (!jsonFile) return notify('No se encontrÃ³ clientes.json en el ZIP');
    const data = JSON.parse(await jsonFile.async('text'));
    if (!Array.isArray(data)) throw new Error('Formato invÃ¡lido');
    if (confirm(`Â¿Importar ${data.length} clientes? Se reemplazarÃ¡n los actuales.`)) {
      clientes = data; await save(); render(); notify('ZIP importado correctamente');
    }
  } catch (err) { notify('Error al importar ZIP'); console.error(err); }
  e.target.value = '';
});

/* ---------- Inicio ---------- */
await load(); render();
</script>
</body>
</html>
