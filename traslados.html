<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Traslados • AESIER - IndexedDB</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* TU CSS ORIGINAL (SIN CAMBIOS) */
    :root{--bg:#fafafa;--card:#ffffff;--text:#1f1f1f;--line:#e5e7eb;--accent:#6b7280}
    [data-theme="dark"]{--bg:#0a0a0a;--card:#111111;--text:#f0f0f0;--line:#27272a;--accent:#9ca3af}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif}
    html,body{height:100%;background:var(--bg);color:var(--text);transition:background .3s,color .3s}
    body{display:flex;flex-direction:column}
    header{display:flex;justify-content:space-between;align-items:center;padding:1.5rem 2rem;border-bottom:1px solid var(--line)}
    header h1{font-size:1.25rem;font-weight:600;letter-spacing:.5px}
    .actions{display:flex;gap:1rem;align-items:center}
    input[type="search"]{padding:.5rem .75rem;border-radius:6px;border:1px solid var(--line);background:var(--bg);color:var(--text);width:200px}
    button.icon{background:none;border:none;color:var(--accent);font-size:1.1rem;cursor:pointer;transition:color .2s}
    button.icon:hover{color:var(--text)}
    main{flex:1;padding:2rem;overflow-y:auto}
    .grid{display:grid;gap:1.5rem;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:1.5rem;display:flex;flex-direction:column;gap:1rem}
    .form-row{display:flex;flex-wrap:wrap;gap:.75rem}
    .form-row input{flex:1 1 160px;padding:.75rem 1rem;border:1px solid var(--line);border-radius:8px;background:var(--bg);color:var(--text);font-size:.95rem}
    .btn-primary{align-self:flex-start;padding:.65rem 1.25rem;border-radius:8px;border:none;background:var(--accent);color:var(--card);font-weight:500;cursor:pointer;transition:opacity .2s}
    .btn-primary:hover{opacity:.85}
    table{width:100%;border-collapse:collapse;font-size:.95rem}
    th,td{padding:.75rem 1rem;text-align:left;border-bottom:1px solid var(--line)}
    th{cursor:pointer;user-select:none;font-weight:600;color:var(--accent)}
    th:hover{color:var(--text)}
    .total-bar{display:flex;justify-content:space-between;align-items:center;margin-top:1rem;font-weight:500}
    .toast{position:fixed;bottom:2rem;right:2rem;background:var(--card);border:1px solid var(--line);padding:.75rem 1.25rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);opacity:0;transform:translateY(10px);transition:opacity .3s,transform .3s;pointer-events:none}
    .toast.show{opacity:1;transform:translateY(0)}
    @media (max-width:600px){header{flex-direction:column;gap:1rem}input[type="search"]{width:100%}}
  </style>
</head>
<body data-theme="light">

<header>
  <h1>Sistema de Traslados</h1>
  <div class="actions">
    <input type="search" id="search" placeholder="Buscar..." />
    <button class="icon" onclick="exportExcel()" title="Exportar Excel">⬇</button>
    <button class="icon" onclick="toggleTheme()" title="Cambiar tema">○</button>
  </div>
</header>

<main>
  <div class="grid">
    <!-- Formulario -->
    <div class="card">
      <h2>Registrar traslado</h2>
      <div class="form-row">
        <input type="text" id="nombre" placeholder="Nombre" />
        <input type="number" id="cantidad" placeholder="Cantidad" min="0" />
        <input type="text" id="codigo" placeholder="Código" />
        <input type="text" id="lugar" placeholder="Lugar" />
        <input type="number" id="precio" placeholder="Precio vendido" min="0" step="0.01" />
      </div>
      <button class="btn-primary" onclick="addItem()">Agregar</button>
    </div>

    <!-- Tabla + total -->
    <div class="card" style="grid-column: 1/-1;">
      <table id="table">
        <thead>
          <tr>
            <th onclick="sortTable(0)">Nombre</th>
            <th onclick="sortTable(1)">Cantidad</th>
            <th onclick="sortTable(2)">Código</th>
            <th onclick="sortTable(3)">Lugar</th>
            <th onclick="sortTable(4)">Precio</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
      <div class="total-bar">
        <span>Total general</span>
        <span id="total">$0.00</span>
      </div>
    </div>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
/* ---------- IndexedDB ---------- */
const DB_NAME = 'trasladosDB';
const STORE_TRASLADOS = 'traslados';
const STORE_THEME = 'theme';
let db;
let data = []; // en memoria

async function openDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onerror = () => rej(req.error);
    req.onsuccess = () => res(db = req.result);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE_TRASLADOS))
        db.createObjectStore(STORE_TRASLADOS, { keyPath: 'id', autoIncrement: true });
      if (!db.objectStoreNames.contains(STORE_THEME))
        db.createObjectStore(STORE_THEME);
    };
  });
}
async function getTraslados() {
  const tx = db.transaction([STORE_TRASLADOS], 'readonly');
  return tx.objectStore(STORE_TRASLADOS).getAll();
}
async function setTraslados(items) {
  const tx = db.transaction([STORE_TRASLADOS], 'readwrite');
  const store = tx.objectStore(STORE_TRASLADOS);
  await store.clear();
  for (const it of items) await store.put(it);
}
async function deleteTraslado(id) {
  const tx = db.transaction([STORE_TRASLADOS], 'readwrite');
  tx.objectStore(STORE_TRASLADOS).delete(id);
}
async function getTheme() {
  const tx = db.transaction([STORE_THEME], 'readonly');
  return tx.objectStore(STORE_THEME).get('current');
}
async function setTheme(value) {
  const tx = db.transaction([STORE_THEME], 'readwrite');
  tx.objectStore(STORE_THEME).put(value, 'current');
}

/* ---------- Funciones auxiliares ---------- */
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

async function save() {
  await setTraslados(data);
  render();
}

async function addItem() {
  const nombre = document.getElementById('nombre').value.trim();
  const cantidad = document.getElementById('cantidad').value;
  const codigo = document.getElementById('codigo').value.trim();
  const lugar = document.getElementById('lugar').value.trim();
  const precio = document.getElementById('precio').value;

  if (!nombre || !cantidad || !codigo || !lugar || !precio) return toast('Completa todos los campos');
  data.push({ nombre, cantidad: Number(cantidad), codigo, lugar, precio: Number(precio) });
  document.querySelectorAll('.form-row input').forEach(i => i.value = '');
  toast('Traslado agregado');
  await save();
}

async function removeItem(index) {
  const id = data[index].id;
  data.splice(index, 1);
  await deleteTraslado(id);
  toast('Eliminado');
  await save();
}

function sortTable(col) {
  const key = ['nombre', 'cantidad', 'codigo', 'lugar', 'precio'][col];
  data.sort((a, b) => sortDirection ? (a[key] > b[key] ? 1 : -1) : (a[key] < b[key] ? 1 : -1));
  sortDirection = !sortDirection;
  render();
}

async function exportExcel() {
  const ws = XLSX.utils.json_to_sheet(data.map(({id,...r})=>r)); // sin id interno
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Traslados');
  XLSX.writeFile(wb, 'INDUSTRIAS_TOBIAS.xlsx');
}

async function toggleTheme() {
  const html = document.body;
  const current = (await getTheme()) || 'light';
  const next = current === 'light' ? 'dark' : 'light';
  html.setAttribute('data-theme', next);
  await setTheme(next);
}

async function render() {
  const list = document.getElementById('list');
  const search = document.getElementById('search').value.toLowerCase();
  const filtered = data.filter(r =>
    Object.values(r).some(v => String(v).toLowerCase().includes(search))
  );

  list.innerHTML = filtered.map((r, i) => `
    <tr>
      <td>${r.nombre}</td>
      <td>${r.cantidad}</td>
      <td>${r.codigo}</td>
      <td>${r.lugar}</td>
      <td>$${r.precio.toFixed(2)}</td>
      <td><button class="icon" onclick="removeItem(${data.indexOf(r)})">×</button></td>
    </tr>
  `).join('');

  const total = filtered.reduce((s, r) => s + r.precio * r.cantidad, 0);
  document.getElementById('total').textContent = `$${total.toFixed(2)}`;
}

/* ---------- Arranque ---------- */
window.addEventListener('DOMContentLoaded', async () => {
  await openDB();
  // Cargar datos
  data = await getTraslados();
  // Tema
  const savedTheme = (await getTheme()) || 'light';
  document.body.setAttribute('data-theme', savedTheme);
  // Render
  render();
  // Búsqueda en tiempo real
  document.getElementById('search').addEventListener('input', render);
});
</script>
</body>
</html>