<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Descuentos - FULL</title>
  <style>
    :root {
      --primary: #0052d4;
      --primary-light: #4f83cc;
      --bg: #f5f7fa;
      --card: #ffffff;
      --text: #222;
      --green: #00c853;
      --red: #ff5252;
      --shadow: 0 4px 12px rgba(0,0,0,.08);
    }
    * { box-sizing: border-box; font-family: "Segoe UI", sans-serif; }
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
    body { background: var(--bg); color: var(--text); display: flex; flex-direction: column; }
    header {
      background: var(--primary);
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.3rem;
      font-weight: 600;
      box-shadow: var(--shadow);
      flex-shrink: 0;
    }
    .wrap {
      flex: 1 1 auto;
      width: 100%;
      max-width: 1200px;
      margin: auto;
      padding: 1rem;
      overflow-y: auto;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: .8rem;
      margin-bottom: 1.2rem;
    }
    .filters input, .filters select, .filters button {
      padding: .55rem .7rem;
      border: 1px solid #bbb;
      border-radius: 6px;
      font-size: .95rem;
    }
    .filters button {
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer;
    }
    .filters button:hover { background: var(--primary-light); }
    table {
      width: 100%;
      background: var(--card);
      border-collapse: collapse;
      box-shadow: var(--shadow);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td { padding: .7rem .8rem; text-align: left; border-bottom: 1px solid #e5e5e5; }
    th { background: #f2f5ff; }
    tr.highlight { background: var(--green); color: #fff; }
    .thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; }
    .info { margin: .5rem 0; font-weight: 600; }
    .counters {
      margin: .5rem 0;
      font-size: .95rem;
      font-weight: 600;
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    .price-desc {
      font-size: .85rem;
      color: #555;
      margin-top: .25rem;
    }
    #scrollArea { height: 65vh; overflow: auto; }
  </style>
</head>
<body>

<header>Sistema de Descuentos - FULL</header>

<div class="wrap">
  <!-- Filtros -->
  <div class="filters">
    <input id="searchBarcode" placeholder="Código de barras (ENTER)" autocomplete="off">
    <select id="catFilter">
      <option value="">-- Categoría --</option>
      <option value="Accesorios para el cabello">Accesorios para el cabello</option>
      <option value="Anillos">Anillos</option>
      <option value="Aritos">Aritos</option>
      <option value="Billeteras">Billeteras</option>
      <option value="Carteras">Carteras</option>
      <option value="Case audífonos">Case audífonos</option>
      <option value="Case teléfonos">Case teléfonos</option>
      <option value="Chokers">Chokers</option>
      <option value="Collares">Collares</option>
      <option value="General">General</option>
      <option value="Lentes de sol">Lentes de sol</option>
      <option value="Otros">Otros</option>
      <option value="Pulseras">Pulseras</option>
      <option value="Relojes">Relojes</option>
    </select>
    <input id="globalDisc" type="number" min="0" max="100" placeholder="Dto global %">
    <button onclick="applyGlobal()">Aplicar</button>
    <button onclick="removeGlobal()">Quitar</button>
    <button onclick="downloadCSV()">Exportar CSV</button>
    <input type="file" id="csvFile" accept=".csv" style="display:none" onchange="uploadCSV(event)">
    <button onclick="document.getElementById('csvFile').click()">Importar CSV</button>
  </div>

  <div class="info" id="info"></div>
  <div class="counters" id="counters"></div>

  <div id="scrollArea">
    <table>
      <thead>
        <tr>
          <th>#</th><th>Imagen</th><th>Nombre</th><th>Código</th><th>Cód.Barras</th><th>Precio</th>
          <th>Dto %</th><th>Final</th><th>Categoría</th><th>Stock</th><th>Acción</th>
        </tr>
      </thead>
      <tbody id="list"></tbody>
    </table>
  </div>
</div>

<!-- localforage para imágenes -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clusterize.js/0.19.0/clusterize.min.js"></script>
<script type="module">
/* ----------  CONFIG  ---------- */
const DB_NAME   = 'inv_v1';
const STORE     = 'products';
const IMG_STORE = 'images';
const CHECKSUM  = 'inv_checksum';
const STORED_FILTERS = 'last_filters';

const db  = localforage.createInstance({ name: DB_NAME, storeName: STORE });
const img = localforage.createInstance({ name: DB_NAME, storeName: IMG_STORE });

/* ----------  UTILS  ---------- */
const $   = s => document.querySelector(s);
const fmt = n => (+n).toLocaleString('es-CL', {minimumFractionDigits:2});
const sha256 = async txt => {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(txt));
  return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,'0')).join('');
};

/* ----------  STATE  ---------- */
let inv = [];
let barMap = new Map();          // barcode -> index
let virt;                        // clusterize instance

/* ----------  RENDER  ---------- */
function rowTpl(it, idx){
  const final = (+it.price * (1 - (it.discount||0)/100)).toFixed(2);
  return `<tr data-line="${idx+1}">
    <td>${idx+1}</td>
    <td><img class="thumb" data-code="${it.code}" src="https://via.placeholder.com/60?text=Sin+img"></td>
    <td>${it.name}</td>
    <td>${it.code}</td>
    <td>${it.barcode||''}</td>
    <td><span style="text-decoration:line-through;opacity:.7;">$${fmt(it.price)}</span>
        <strong>$${fmt(final)}</strong></td>
    <td><input type="number" min="0" max="100" value="${it.discount||0}"
               onchange="setDisc('${it.code}',this.value)"></td>
    <td>$${fmt(final)}</td>
    <td>${it.category}</td>
    <td>${it.quantity}</td>
    <td><button onclick="removeDisc('${it.code}')">Quitar</button></td>
  </tr>`;
}

async function render(list = inv){
  const rows = list.map(rowTpl);
  virt ? virt.update(rows) : virt = new Clusterize({ rows, scrollElem: $('#scrollArea'), contentElem: $('#list') });
  loadImages(list);
  updateCounters(list);
}

/* ----------  IMAGES  ---------- */
async function loadImages(list){
  for(const it of list){
    const el = $(`img[data-code="${it.code}"]`);
    if(!el) continue;
    const blob = await img.getItem(it.code);
    el.src = blob ? URL.createObjectURL(blob) : 'https://via.placeholder.com/60?text=Sin+img';
  }
}

/* ----------  DISCOUNTS  ---------- */
window.setDisc = (code, val) => {
  const it = inv.find(i=>i.code===code);
  if(it){ it.discount = Math.max(0, Math.min(100, parseFloat(val)||0)); save(); render(); }
};
window.removeDisc = code => setDisc(code,0);

/* ----------  SAVE / LOAD  ---------- */
async function save(){
  const txt = JSON.stringify(inv);
  const sum = await sha256(txt);
  localStorage.setItem(DB_NAME, txt);
  localStorage.setItem(CHECKSUM, sum);
  downloadBackup(txt);
}
async function load(){
  const txt = localStorage.getItem(DB_NAME);
  if(!txt) return;
  if(await sha256(txt) !== localStorage.getItem(CHECKSUM)){
     if(!confirm('Integridad comprometida. ¿Restaurar igualmente?')) return;
  }
  inv = JSON.parse(txt);
  inv.forEach((it,i)=> it.barcode && barMap.set(it.barcode, i));
}
function downloadBackup(txt){
  const blob = new Blob([txt], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'inventario_'+new Date().toISOString().slice(0,10)+'.bak';
  a.click();
}

/* ----------  FILTERS  ---------- */
let lastFilter = JSON.parse(localStorage.getItem(STORED_FILTERS)||'{}');
$('#searchBarcode').value = lastFilter.barcode||'';
$('#catFilter').value     = lastFilter.cat||'';

function applyFilters(){
  const bc = $('#searchBarcode').value.trim();
  const ct = $('#catFilter').value;
  localStorage.setItem(STORED_FILTERS, JSON.stringify({barcode:bc, cat:ct}));

  let list = inv;
  if(bc) list = list.filter(it=>it.barcode===bc);
  if(ct) list = list.filter(it=>it.category===ct);
  render(list);
}
$('#searchBarcode').addEventListener('input', applyFilters);
$('#catFilter').addEventListener('change', applyFilters);

/* ----------  COUNTERS  ---------- */
function updateCounters(list){
  const w = list.filter(it=> (it.discount||0)>0 ).length;
  const n = list.length - w;
  const tNorm = list.reduce((s,it)=> s + it.price * it.quantity, 0);
  const tDisc = list.reduce((s,it)=> s + it.price * (1-(it.discount||0)/100) * it.quantity, 0);
  $('#counters').innerHTML = `Con descuento: ${w} | Normal: ${n} | Total Normal: <strong>$${fmt(tNorm)}</strong> | Con dto: <strong>$${fmt(tDisc)}</strong>`;
}

/* ----------  GLOBAL DISCOUNT  ---------- */
window.applyGlobal = () => {
  const v = parseFloat($('#globalDisc').value);
  if(isNaN(v) || v<0 || v>100) return alert('Descuento inválido');
  inv.forEach(i=> i.discount = v);
  save(); render();
};
window.removeGlobal = () => {
  inv.forEach(i=> i.discount = 0);
  save(); render();
};

/* ----------  CSV  ---------- */
window.downloadCSV = () => {
  const hdr = 'code,name,barcode,price,discount,category,quantity\n';
  const rows = inv.map(i => `${i.code},"${i.name}",${i.barcode||''},${i.price},${i.discount||0},${i.category},${i.quantity}`).join('\n');
  const blob = new Blob([hdr+rows], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'inventario.csv';
  a.click();
};
window.uploadCSV = async (ev) => {
  const file = ev.target.files[0];
  if(!file) return;
  const txt = await file.text();
  const lines = txt.split('\n').slice(1).filter(l=>l.trim());
  const parsed = lines.map(l=>{
    const [code,name,barcode,price,discount,category,quantity] = l.split(',');
    return {code,name,barcode,price:+price,discount:+discount,category,quantity:+quantity};
  });
  inv = parsed;
  save();
  render();
};

/* ----------  INIT  ---------- */
await load();
render();
</script>
</body>
</html>
