<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inventario con B칰squeda de Im치genes</title>
  <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; background: #f5f5f5; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #eee; }
    input, button { margin: 5px; padding: 5px; }
    img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>游닍 Inventario con Im치genes</h1>

  <div>
    <input type="text" id="code" placeholder="C칩digo">
    <input type="text" id="name" placeholder="Nombre">
    <input type="number" id="price" placeholder="Precio">
    <input type="file" id="image" accept="image/*">
    <button onclick="addProduct()">Agregar producto</button>
    <button onclick="exportarZIP()">Exportar ZIP</button>
    <input type="file" id="zipImport" accept=".zip" onchange="importarZIP(this)">
  </div>

  <div>
    <input type="text" id="search" placeholder="Buscar por nombre o c칩digo" oninput="buscar(this.value)">
    <input type="file" id="imgSearch" accept="image/*" onchange="buscarIgualQueImagen(this.files[0])">
    <label for="imgSearch" style="background:#0b79d0;color:white;padding:6px;border-radius:5px;cursor:pointer;">游댌 Buscar imagen exacta</label>
  </div>

  <table id="table">
    <thead>
      <tr>
        <th>C칩digo</th>
        <th>Nombre</th>
        <th>Precio</th>
        <th>Imagen</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let inventory = [];
    let filtered = [];

    async function loadInventory(){
      const data = await localforage.getItem("inventory");
      inventory = data || [];
      filtered = inventory;
      await renderTable();
    }

    async function saveInventory(){
      await localforage.setItem("inventory", inventory);
    }

    async function addProduct(){
      const code = codeInput.value.trim();
      const name = nameInput.value.trim();
      const price = parseFloat(priceInput.value || 0);
      const file = image.files[0];
      if(!code || !name || !file) return alert("Completa todos los campos");

      const imgBlob = await fileToBlob(file);
      inventory.push({ code, name, price });
      await localforage.setItem(`img_${code}`, imgBlob);
      await saveInventory();
      filtered = inventory;
      renderTable();
      codeInput.value = nameInput.value = priceInput.value = "";
      image.value = "";
    }

    async function renderTable(){
      const tbody = document.querySelector("#table tbody");
      tbody.innerHTML = "";
      for(const p of filtered){
        const tr = document.createElement("tr");
        const blob = await localforage.getItem(`img_${p.code}`);
        const url = blob ? URL.createObjectURL(blob) : "";
        tr.innerHTML = `
          <td>${p.code}</td>
          <td>${p.name}</td>
          <td>$${p.price.toFixed(2)}</td>
          <td>${url ? `<img src="${url}">` : ""}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function buscar(valor){
      valor = valor.toLowerCase();
      filtered = inventory.filter(p =>
        p.name.toLowerCase().includes(valor) ||
        p.code.toLowerCase().includes(valor)
      );
      renderTable();
    }

    async function fileToBlob(file){
      const buffer = await file.arrayBuffer();
      return new Blob([buffer], {type:file.type});
    }

    // ----------- NUEVA FUNCI칍N MEJORADA: Buscar por imagen visual -----------

    async function buscarIgualQueImagen(file){
      const hashBuscado = await getImageHash(file);
      const coincidencias = [];
      for(const p of inventory){
        const blob = await localforage.getItem(`img_${p.code}`);
        if(blob){
          const hash = await getImageHash(blob);
          // Si el hash visual es id칠ntico o muy parecido
          if(Math.abs(hash - hashBuscado) < 5000) coincidencias.push(p);
        }
      }
      filtered = coincidencias;
      await renderTable();
    }

    async function getImageHash(file){
      return new Promise(resolve=>{
        const img = new Image();
        img.onload = ()=>{
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const size = 16;
          canvas.width = size;
          canvas.height = size;
          ctx.drawImage(img, 0, 0, size, size);
          const data = ctx.getImageData(0, 0, size, size).data;
          let hash = 0;
          for(let i=0; i<data.length; i++) hash = (hash + data[i]) % 1e9;
          resolve(hash);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    // ---------------- ZIP export / import ----------------

    async function exportarZIP(){
      const zip = new JSZip();
      const meta = [];
      for(const p of inventory){
        meta.push(p);
        const blob = await localforage.getItem(`img_${p.code}`);
        if(blob) zip.file(`imagenes/${p.code}.jpg`, blob);
      }
      zip.file("data.json", JSON.stringify(meta));
      const content = await zip.generateAsync({type:"blob"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(content);
      a.download = "inventario.zip";
      a.click();
    }

    async function importarZIP(input){
      const file = input.files[0];
      if(!file) return;
      const zip = await JSZip.loadAsync(file);
      const jsonText = await zip.file("data.json").async("string");
      const nuevos = JSON.parse(jsonText);
      for(const p of nuevos){
        const blobFile = zip.file(`imagenes/${p.code}.jpg`);
        const blob = blobFile ? await blobFile.async("blob") : null;
        const index = inventory.findIndex(x => x.code === p.code);
        if(index >= 0) inventory[index] = p;
        else inventory.push(p);
        if(blob) await localforage.setItem(`img_${p.code}`, blob);
      }
      await saveInventory();
      filtered = inventory;
      await renderTable();
      alert("ZIP importado correctamente");
      input.value = "";
    }

    window.addEventListener("load", loadInventory);

    // Elementos de formulario
    const codeInput = document.getElementById("code");
    const nameInput = document.getElementById("name");
    const priceInput = document.getElementById("price");
    const image = document.getElementById("image");
  </script>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</body>
</html>
