<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ventas Realizadas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

  <!-- NUEVO DISE√ëO -->
  <style>
    :root {
      --blanco: #ffffff;
      --negro: #1f2937;
      --gris: #f5f7fa;
      --accent: #2563eb;
      --rosa: #fce7f3;
      --radio: 12px;
      --fuente: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: var(--fuente);
    }

    body {
      background: var(--gris);
      color: var(--negro);
      display: flex;
      justify-content: center;
      padding: 40px 20px;
      min-height: 100vh;
    }

    .oculto {
      display: none;
    }

    input, select, button {
      padding: 10px 14px;
      border: 1px solid #e5e7eb;
      border-radius: var(--radio);
      background: var(--blanco);
      color: var(--negro);
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    button {
      cursor: pointer;
      background: var(--accent);
      color: white;
      border: none;
    }

    button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    #loginOverlay {
      position: fixed;
      inset: 0;
      background: var(--gris);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #loginBox {
      width: 320px;
      text-align: center;
      background: var(--blanco);
      padding: 32px;
      border-radius: var(--radio);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    #mainApp {
      width: 100%;
      max-width: 900px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
    }

    .card {
      background: var(--blanco);
      padding: 16px;
      border-radius: var(--radio);
      position: relative;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
      transition: transform 0.2s ease;
    }

    .card:hover {
      transform: translateY(-4px);
    }

    .card img {
      width: 100%;
      height: 120px;
      object-fit: contain;
      margin-bottom: 10px;
      cursor: pointer;
      border-radius: 8px;
    }

    .barcode-text {
      font-size: 0.7rem;
      text-align: center;
      margin-top: 6px;
      opacity: 0.6;
    }

    .factCheck {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
    }

    .fab:hover {
      transform: scale(1.1);
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal > div {
      background: var(--blanco);
      padding: 24px;
      border: none;
      border-radius: var(--radio);
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .close {
      float: right;
      font-size: 1.2rem;
      cursor: pointer;
      color: #6b7280;
    }

    .close:hover {
      color: var(--negro);
    }

    .ticket {
      font-family: 'Courier New', Courier, monospace;
      font-size: 11px;
      line-height: 1.3;
      white-space: pre-wrap;
      background: #fafafa;
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
    }

    @media print {
      .header, .row, .fab, .modal, .close, .factCheck {
        display: none !important;
      }
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <div id="loginBox">
    <h2>Acceso</h2>
    <label>Ingrese PIN</label>
    <input id="pinInput" type="password" placeholder="****" autocomplete="off">
    <div id="loginMsg" style="color:#ef4444;font-size:.75rem;margin-top:6px;height:16px;"></div>
  </div>
</div>

<div id="mainApp" class="oculto">
  <div class="header">
    <h1>Ventas Realizadas</h1>
    <div class="row">
      <button onclick="setTheme('white')">Blanco</button>
      <button onclick="setTheme('rose')">Rosa</button>
    </div>
  </div>

  <div class="row">
    <input type="text" id="unifiedSearch" placeholder="Buscar nombre / c√≥digo / barcode">
    <select id="rowsPerPage" onchange="loadSoldInventory()">
      <option value="10">10</option>
      <option value="25">25</option>
      <option value="50">50</option>
      <option value="100" selected>100</option>
    </select>
    <button onclick="abrirFactura()">üßæ Generar Factura</button>
    <button onclick="location.href='lista.html'">üìä Ver Ingresos</button>
  </div>

  <div class="row" id="totalBox" style="display:none;">
    <div>
      <div style="font-size:1rem;font-weight:600;">Unidades vendidas</div>
      <div id="totalQty" style="font-size:2rem;font-weight:700;color:var(--accent);">0</div>
    </div>
    <div>
      <div style="font-size:1rem;font-weight:600;">Total vendido</div>
      <div id="totalUSD" style="font-size:2rem;font-weight:700;color:var(--accent);">$0.00</div>
    </div>
  </div>

  <section class="grid" id="soldInventoryList"></section>

  <div id="noResults" class="oculto">
    <svg viewBox="0 0 64 64"><path d="M32 4a24 24 0 1 0 0 48 24 24 0 0 0 0-48zm0 44a20 20 0 1 1 0-40 20 20 0 0 1 0 40zM28 20h8v14h-8zm0 18h8v4h-8z"/></svg>
    <div>No se encontraron productos</div>
  </div>

  <div class="row">
    <button onclick="prevPage()">‚Üê Anterior</button>
    <button onclick="nextPage()">Siguiente ‚Üí</button>
  </div>
</div>

<button class="fab" onclick="abrirModalTotales()" id="fabBtn" style="display:none;">
  <span id="fabQty">0</span>
</button>

<!-- MODALES (simplificados) -->
<div id="totalesModal" class="modal" onclick="if(event.target===this) cerrarModalTotales()">
  <div>
    <span class="close" onclick="cerrarModalTotales()">√ó</span>
    <div class="card" style="text-align:center;">
      <div style="font-size:1rem;font-weight:600;">Unidades vendidas</div>
      <div id="totalQtyModal" style="font-size:2rem;font-weight:700;color:var(--accent);">0</div>
      <div style="font-size:1rem;font-weight:600;margin-top:12px;">Total vendido</div>
      <div id="totalUSDModal" style="font-size:2rem;font-weight:700;color:var(--accent);">$0.00</div>
    </div>
  </div>
</div>

<div id="facturaModal" class="modal" onclick="if(event.target===this) cerrarFactura()">
  <div>
    <span class="close" onclick="cerrarFactura()">√ó</span>
    <h2>Factura ‚Äì Ticket</h2>
    <label>Factura N¬∞</label><input id="fNum" value="00015" oninput="actualizarTablaTicket()">
    <label>Fecha</label><input id="fFecha" readonly>
    <label>Cliente</label><input id="fCliente" value="Consumidor Final" oninput="actualizarTablaTicket()">
    <div class="ticket" id="ticketPreview"></div>
    <div class="row">
      <button onclick="cerrarFactura()">Cerrar</button>
      <button onclick="imprimirTicket()">Imprimir</button>
      <button onclick="descargarPDF()">PDF</button>
    </div>
  </div>
</div>

<div id="imgModal" class="modal" onclick="cerrarImgModal()">
  <img id="imgModalImg" src="" alt="Imagen ampliada" style="max-width:90vw;max-height:90vh;border-radius:8px;">
</div>

<!-- JAVASCRIPT (sin cambios) -->
<script>
  /* ----------  LOGIN  ---------- */
  const CLAVE = '132412';
  const loginOverlay = document.getElementById('loginOverlay');
  const pinInput = document.getElementById('pinInput');
  const loginMsg = document.getElementById('loginMsg');
  let pinAttempts = 0;
  const MAX_ATTEMPTS = 3;
  const LOCK_TIME = 30_000;
  let lockTimeout;

  pinInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const val = pinInput.value.trim();
      if (val === CLAVE) {
        loginOverlay.style.display = 'none';
        document.getElementById('mainApp').classList.remove('oculto');
        document.getElementById('fabBtn').style.display = 'flex';
        loadSoldInventory();
      } else {
        pinAttempts++;
        pinInput.value = '';
        if (pinAttempts >= MAX_ATTEMPTS) {
          pinInput.disabled = true;
          let t = LOCK_TIME / 1000;
          loginMsg.textContent = `Bloqueado ${t}s`;
          lockTimeout = setInterval(() => {
            t--;
            loginMsg.textContent = `Bloqueado ${t}s`;
            if (t <= 0) {
              clearInterval(lockTimeout);
              pinInput.disabled = false;
              pinAttempts = 0;
              loginMsg.textContent = '';
            }
          }, 1000);
        } else {
          loginMsg.textContent = `PIN incorrecto (${pinAttempts}/${MAX_ATTEMPTS})`;
        }
      }
    }
  });

  /* ----------  TEMA  ---------- */
  function setTheme(t) {
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
  }

  /* ----------  FUNCIONES AUX  ---------- */
  let soldInventory = JSON.parse(localStorage.getItem('soldInventory')) || [];
  let currentPage = 1;
  let rowsPerPage = 100;

  function showSpinner() {}
  function hideSpinner() {}
  let searchTimeout;
  document.getElementById('unifiedSearch').addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => { currentPage = 1; loadSoldInventory(); }, 250);
  });

  /* ----------  CARGAR VENTAS  ---------- */
  async function loadSoldInventory() {
    const search = document.getElementById('unifiedSearch').value.toLowerCase();
    rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);

    let filtered = soldInventory.filter(item =>
      item.name.toLowerCase().includes(search) ||
      item.code.toLowerCase().includes(search) ||
      item.barcode.toLowerCase().includes(search)
    );

    const totalUnits = filtered.reduce((sum, item) => sum + Number(item.quantity), 0);
    const totalUSD = filtered.reduce((sum, item) => sum + Number(item.total), 0);

    document.getElementById('totalQty').textContent = new Intl.NumberFormat('es-SV').format(totalUnits);
    document.getElementById('totalUSD').textContent = `$${new Intl.NumberFormat('es-SV').format(totalUSD.toFixed(2))}`;
    document.getElementById('totalQtyModal').textContent = new Intl.NumberFormat('es-SV').format(totalUnits);
    document.getElementById('totalUSDModal').textContent = `$${new Intl.NumberFormat('es-SV').format(totalUSD.toFixed(2))}`;
    document.getElementById('fabQty').textContent = new Intl.NumberFormat('es-SV').format(totalUnits);

    const start = (currentPage - 1) * rowsPerPage;
    const paginated = filtered.slice(start, start + rowsPerPage);

    const container = document.getElementById('soldInventoryList');
    container.innerHTML = '';

    if (paginated.length === 0) {
      document.getElementById('noResults').classList.remove('oculto');
    } else {
      document.getElementById('noResults').classList.add('oculto');
    }

    for (const item of paginated) {
      const card = document.createElement('div');
      card.className = 'card';

      const img = document.createElement('img');
      img.alt = `${item.name} - ${item.code}`;

      const blob = await localforage.getItem(`img_${item.code}`);
      if (blob) {
        img.src = URL.createObjectURL(blob);
        img.onclick = () => abrirImgModal(img.src);
      } else {
        img.style.display = 'none';
      }

      const barcodeText = document.createElement('div');
      barcodeText.className = 'barcode';
      barcodeText.textContent = `C√≥digo: ${item.barcode}`;

      card.innerHTML = `
        <div style="font-weight:600;margin-bottom:6px;">${item.name}</div>
        <div style="color:var(--accent);font-size:1.1rem;font-weight:700;margin-bottom:6px;">$${new Intl.NumberFormat('es-SV').format(Number(item.price).toFixed(2))}</div>
        <div style="font-size:0.85rem;margin-bottom:6px;">Cantidad vendida: ${new Intl.NumberFormat('es-SV').format(item.quantity)}</div>
        <div style="font-size:0.85rem;margin-bottom:10px;">Total: $${new Intl.NumberFormat('es-SV').format(Number(item.total).toFixed(2))}</div>
        <button onclick="confirmDelete('${item.code}')" style="background:#ef4444;color:white;border:none;padding:6px 10px;border-radius:6px;font-size:0.8rem;cursor:pointer;">Eliminar</button>
        <input type="checkbox" class="factCheck" value='${JSON.stringify(item)}'>
      `;

      card.insertBefore(img, card.firstChild);
      card.insertBefore(barcodeText, card.querySelector('button'));
      container.appendChild(card);
    }
  }

  /* ----------  ELIMINAR  ---------- */
  window.confirmDelete = function (code) {
    if (confirm('¬øEliminar este producto?')) {
      const index = soldInventory.findIndex(item => item.code === code);
      if (index !== -1) {
        soldInventory.splice(index, 1);
        localStorage.setItem('soldInventory', JSON.stringify(soldInventory));
        loadSoldInventory();
      }
    }
  };

  /* ----------  FACTURA / TICKET  ---------- */
  function abrirFactura() {
    const seleccionados = [...document.querySelectorAll('.factCheck:checked')];
    if (seleccionados.length === 0) { alert('Por favor selecciona al menos un producto para facturar.'); return; }
    document.getElementById('facturaModal').style.display = 'flex';
    document.getElementById('fFecha').value = new Date().toLocaleDateString('es-SV');
    actualizarTablaTicket();
  }
  function cerrarFactura() { document.getElementById('facturaModal').style.display = 'none'; }
  function actualizarTablaTicket() {
    const checks = [...document.querySelectorAll('.factCheck:checked')];
    const ticket = document.getElementById('ticketPreview');
    ticket.textContent = '';
    let sum = 0;
    checks.forEach(ch => {
      const p = JSON.parse(ch.value);
      ticket.textContent += `${p.name}  ${p.quantity}  $${Number(p.total).toFixed(2)}\n`;
      sum += Number(p.total);
    });
    ticket.textContent += `\nTOTAL: $${sum.toFixed(2)}`;
  }
  function imprimirTicket() {
    const ventana = window.open('', '', 'width=360,height=600');
    ventana.document.write(`<html><head><title>Ticket</title><style>
      body{margin:0;padding:6px;font:11px/1.2 'Courier New',monospace;width:360px;color:#000;background:#fff}
      </style></head><body><pre>${document.getElementById('ticketPreview').textContent}</pre></body></html>`);
    ventana.document.close();
    ventana.focus();
    ventana.print();
    ventana.close();
  }
  function descargarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'mm', format:[80, 190] });
    doc.setFontSize(10);
    const lineas = document.getElementById('ticketPreview').textContent.split('\n');
    let y = 10;
    lineas.forEach(l => {
      doc.text(l, 5, y);
      y += 4;
    });
    doc.save(`ticket_${document.getElementById('fNum').value}.pdf`);
  }
  function abrirModalTotales() { document.getElementById('totalesModal').style.display = 'flex'; }
  function cerrarModalTotales() { document.getElementById('totalesModal').style.display = 'none'; }
  function abrirImgModal(src) {
    const modal = document.getElementById('imgModal');
    const img = document.getElementById('imgModalImg');
    img.src = src;
    modal.style.display = 'flex';
  }
  function cerrarImgModal() { document.getElementById('imgModal').style.display = 'none'; }
  function prevPage() { if (currentPage > 1) { currentPage--; loadSoldInventory(); } }
  function nextPage() {
    const filtered = soldInventory.filter(item =>
      item.name.toLowerCase().includes(document.getElementById('unifiedSearch').value.toLowerCase()) ||
      item.code.toLowerCase().includes(document.getElementById('unifiedSearch').value.toLowerCase()) ||
      item.barcode.toLowerCase().includes(document.getElementById('unifiedSearch').value.toLowerCase())
    );
    if (currentPage < Math.ceil(filtered.length / rowsPerPage)) { currentPage++; loadSoldInventory(); }
  }

  /* ----------  INICIO  ---------- */
  loadSoldInventory();
</script>
</body>
</html>
