<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventario</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    :root {
      --fondo: #f7f3f5;
      --rosado: #DBB8BC;
      --rosado-oscuro: #c79da1;
      --texto: #2e2e2e;
      --blanco: #fff;
      --sombra: rgba(0, 0, 0, 0.1);
      --resaltado: #fef9fa;
      --peligro: #e63946;
    }

    * {
      margin: 0; padding: 0; box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: var(--fondo);
      color: var(--texto);
      display: flex; flex-direction: column;
      align-items: center;
      padding: 1rem;
    }

    header {
      display: flex; justify-content: space-between;
      align-items: center; width: 98%;
      max-width: 1400px; margin-bottom: 1rem;
    }

    h1 {
      color: var(--rosado);
      text-transform: uppercase;
      display: flex; align-items: center;
      gap: .5rem; font-size: 1.8rem;
    }

    .historial-btn {
      background: var(--rosado);
      color: var(--blanco);
      border: none; border-radius: 8px;
      padding: .6rem 1rem;
      font-weight: 600; cursor: pointer;
      transition: .3s;
    }

    .historial-btn:hover {
      background: var(--rosado-oscuro);
      transform: translateY(-2px);
    }

    .container {
      background: var(--blanco);
      border-radius: 16px;
      box-shadow: 0 6px 25px var(--sombra);
      width: 98vw; max-width: 1400px;
      padding: 1.5rem; display: flex; flex-direction: column;
    }

    .search-block {
      display: flex; flex-wrap: wrap; gap: 1rem;
      margin-bottom: 1rem; align-items: flex-end;
    }

    label {
      font-weight: 600; font-size: .9rem;
    }

    input, select {
      padding: .55rem .7rem;
      border: 1px solid #ddd;
      border-radius: 8px; font-size: .9rem;
    }

    button.stamp {
      padding: .6rem 1.1rem;
      background: var(--rosado);
      color: var(--blanco);
      border: none; border-radius: 8px;
      font-weight: 600; cursor: pointer;
      transition: all .3s ease;
      text-transform: uppercase;
      font-size: .85rem; letter-spacing: .5px;
    }

    button.stamp:hover {
      background: var(--rosado-oscuro);
      transform: translateY(-2px);
    }

    table {
      width: 100%; border-collapse: collapse;
      margin-top: .6rem; font-size: .9rem;
    }

    thead {
      background: var(--rosado);
      color: var(--blanco);
    }

    th, td {
      padding: .6rem; border: 1px solid #ddd; text-align: left;
    }

    tbody tr:nth-child(odd) {
      background: var(--resaltado);
    }

    tbody tr:hover {
      background: #fdeff1;
    }

    td img {
      max-height: 48px; border-radius: 6px; cursor: pointer; object-fit: cover;
    }

    .no-results {
      color: var(--peligro); font-weight: 600; text-align: center; margin-top: 1rem;
    }

    .result-message {
      text-align: center; color: var(--texto);
      margin-top: .5rem; font-weight: 600;
    }

    tr.highlight {
      outline: 2px solid var(--rosado);
      background: #fdeff1;
    }

    .modal {
      display: none; position: fixed;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(5px);
      z-index: 100;
    }

    .modal-content {
      background: var(--blanco);
      margin: 5vh auto; padding: 2rem;
      border-radius: 16px;
      width: 90vw; max-width: 600px;
      box-shadow: 0 10px 40px var(--sombra);
      position: relative;
    }

    .close {
      position: absolute; top: 12px; right: 16px;
      font-size: 24px; color: #555; cursor: pointer;
    }

    .close:hover { color: var(--rosado); }

    #modalImage {
      width: 100%; max-height: 70vh;
      object-fit: contain; border-radius: 12px; margin-top: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fa-solid fa-boxes-stacked"></i> Inventario</h1>
    <button class="historial-btn" onclick="openSalesHistory()">
      <i class="fa-solid fa-clock-rotate-left"></i> Historial (Ventas)
    </button>
  </header>

  <div class="container">
    <div class="search-block">
      <div>
        <label for="searchCategory">Categor铆a:</label>
        <select id="searchCategory">
          <option value="">Todas</option>
          <option>Aritos</option>
          <option>Billeteras</option>
          <option>Carteras</option>
          <option>Chokers</option>
          <option>Collares</option>
          <option>Lentes de sol</option>
          <option>Pulseras</option>
          <option>Relojes</option>
          <option>Anillos</option>
          <option>Accesorios para el cabello</option>
          <option>Otros</option>
        </select>
      </div>

      <div>
        <label for="searchCode">C贸digo de barras:</label>
        <input type="text" id="searchCode" placeholder="Ej: 123456789">
      </div>

      <button class="stamp" onclick="filterInventory()">Buscar</button>
      <button class="stamp" onclick="clearFilters()">Limpiar</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Imagen</th>
          <th>Nombre</th>
          <th>C贸digo</th>
          <th>C贸digo Barras</th>
          <th>Precio</th>
          <th>Desc(%)</th>
          <th>Precio Final</th>
          <th>Descripci贸n</th>
          <th>Categor铆a</th>
          <th>Stock</th>
          <th>Acci贸n</th>
        </tr>
      </thead>
      <tbody id="inventoryList"></tbody>
    </table>

    <div id="noResultsMessage" class="no-results" style="display:none;">
      No se encontraron productos.
    </div>
  </div>

  <!-- Modal de imagen -->
  <div id="imageModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeImageModal()">&times;</span>
      <img id="modalImage" src="">
    </div>
  </div>

  <script>
    let inventory = [];

    async function loadInventory() {
      const data = await localforage.getItem('inventory');
      inventory = data || [];
      renderInventory(inventory);
    }

    function renderInventory(data) {
      const list = document.getElementById('inventoryList');
      const noResults = document.getElementById('noResultsMessage');

      // Ordenar: primero los que tienen stock > 0
      data = [...data].sort((a, b) => (a.quantity === 0) - (b.quantity === 0));

      if (!data.length) {
        noResults.style.display = 'block';
        list.innerHTML = '';
        return;
      }

      noResults.style.display = 'none';
      list.innerHTML = data.map((item, index) => {
        const desc = item.description?.trim() || '---';
        const img = item.image || '';
        const priceFinal = (item.price * (1 - item.discount / 100)).toFixed(2);
        return `
          <tr>
            <td>${index + 1}</td>
            <td>${img ? `<img src="${img}" onclick="openImageModal('${img}')">` : '---'}</td>
            <td>${item.name}</td>
            <td>${item.code}</td>
            <td>${item.barcode}</td>
            <td>$${item.price.toFixed(2)}</td>
            <td>${item.discount}%</td>
            <td>$${priceFinal}</td>
            <td>${desc}</td>
            <td>${item.category}</td>
            <td>${item.quantity}</td>
            <td><button class="stamp" onclick="sellProduct(${index})"><i class="fa-solid fa-cash-register"></i></button></td>
          </tr>
        `;
      }).join('');
    }

    function openImageModal(src) {
      document.getElementById('modalImage').src = src;
      document.getElementById('imageModal').style.display = 'block';
    }

    function closeImageModal() {
      document.getElementById('imageModal').style.display = 'none';
    }

    function filterInventory() {
      const cat = document.getElementById('searchCategory').value.toLowerCase();
      const code = document.getElementById('searchCode').value.trim();
      const filtered = inventory.filter(i =>
        (!cat || i.category?.toLowerCase() === cat) &&
        (!code || i.barcode?.includes(code))
      );
      renderInventory(filtered);
    }

    function clearFilters() {
      document.getElementById('searchCategory').value = '';
      document.getElementById('searchCode').value = '';
      renderInventory(inventory);
    }

    async function sellProduct(index) {
      const product = inventory[index];
      if (product.quantity <= 0) {
        alert('Producto sin stock');
        return;
      }
      product.quantity -= 1;
      await localforage.setItem('inventory', inventory);
      renderInventory(inventory);
    }

    function openSalesHistory() {
      alert(' Historial de ventas pr贸ximamente...');
    }

    loadInventory();
  </script>
</body>
</html>
