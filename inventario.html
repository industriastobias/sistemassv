<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventario</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css "/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js "></script>
  <style>
    :root{--bg:#f5f7fa;--card:#ffffff;--text:#1f2937;--accent:#3b82f6;--accent-hover:#2563eb;--danger:#ef4444;--success:#10b981;--warning:#f59e0b;--info:#06b6d4;--radius:16px;--shadow:0 6px 20px rgba(0,0,0,.08);--shadow-hover:0 8px 24px rgba(0,0,0,.12);--transition:.3s ease;--highlight:#fef08a;}
    body.dark{--bg:#111;--card:#1e1e1e;--text:#eee;--highlight:#fde047;}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',system-ui,sans-serif}
    html{scroll-behavior:smooth}
    body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;padding:2rem 1rem}

    /* ---------- MENÚ KIOSKO ---------- */
    #kioskoBar{
      position:fixed;
      top:0; right:0;
      z-index: 9999;
      background: var(--card);
      box-shadow: var(--shadow);
      border-radius: 0 0 0 var(--radius);
      padding: .4rem .6rem;
      display: flex; gap: .5rem; flex-wrap: wrap;
      transform: translateX(100%);
      transition: transform .3s ease;
    }
    #kioskoBar.show{ transform: translateX(0); }
    #kioskoBar a{
      color: var(--accent);
      font-size: 1.3rem;
      padding: .4rem;
      border-radius: 50%;
      transition: background .2s;
    }
    #kioskoBar a:hover{background: var(--highlight);}

    #menuToggle{
      position: fixed;
      top: 1rem; right: 1rem;
      z-index: 10000;
      background: var(--accent);
      color: #fff;
      border: none;
      padding: .5rem .7rem;
      border-radius: 50%;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: var(--shadow);
    }

    h1{font-size:2rem;font-weight:700;margin-bottom:1rem;letter-spacing:-.5px}
    h2{font-size:1.5rem;font-weight:600;margin:1.5rem 0 1rem;color:var(--accent)}
    mark{background:var(--highlight);padding:.05rem .2rem;border-radius:4px;color:var(--text)}
    #themeToggle{position:fixed;top:1rem;left:1rem;background:var(--accent);color:#fff;border:none;padding:.5rem .7rem;border-radius:50%;font-size:1rem;cursor:pointer;box-shadow:var(--shadow);}
    
    .report-section{
      width:100%;
      max-width:1200px;
      background:var(--card);
      border-radius:var(--radius);
      padding:1.5rem;
      margin-bottom:1.5rem;
      box-shadow:var(--shadow);
    }
    .report-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:1rem;
      margin-bottom:1rem;
    }
    .report-card{
      background:var(--bg);
      border-radius:12px;
      padding:1rem;
      border-left:4px solid var(--accent);
    }
    .report-card.warning{border-left-color:var(--warning);}
    .report-card.danger{border-left-color:var(--danger);}
    .report-card.success{border-left-color:var(--success);}
    .report-card.info{border-left-color:var(--info);}
    .report-card h4{font-size:.85rem;color:#6b7280;margin-bottom:.5rem;text-transform:uppercase;}
    .report-card .value{font-size:1.8rem;font-weight:700;color:var(--text);}
    .report-card .detail{font-size:.8rem;color:#6b7280;margin-top:.25rem;}
    
    .chart-container{
      width:100%;
      max-width:600px;
      margin:1rem auto;
      height:300px;
    }
    
    .table-responsive{
      width:100%;
      overflow-x:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.9rem;
    }
    th,td{
      padding:.75rem;
      text-align:left;
      border-bottom:1px solid #e5e7eb;
    }
    th{
      background:var(--bg);
      font-weight:600;
      color:var(--text);
      font-size:.8rem;
      text-transform:uppercase;
    }
    tr:hover{background:var(--bg);}
    .badge{
      display:inline-block;
      padding:.25rem .5rem;
      border-radius:9999px;
      font-size:.75rem;
      font-weight:600;
    }
    .badge-success{background:#d1fae5;color:#065f46;}
    .badge-warning{background:#fef3c7;color:#92400e;}
    .badge-danger{background:#fee2e2;color:#991b1b;}
    .badge-info{background:#cffafe;color:#155e75;}
    
    .price-range{display:flex;gap:.5rem;align-items:center;margin-bottom:1rem;width:100%;max-width:960px}
    .price-range input{width:100%;padding:.5rem;border:1px solid #e5e7eb;border-radius:8px;background:#f9fafb;font-size:.9rem}
    .summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1.5rem;width:100%;max-width:960px;}
    .summary-card{background:var(--card);border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow);text-align:center;}
    .summary-card h3{font-size:.8rem;color:#6b7280;margin-bottom:.25rem}
    .summary-card p{font-size:1.5rem;font-weight:700;color:var(--accent);margin:0}
    .search-bar{width:100%;max-width:960px;margin-bottom:1.5rem;}
    .search-bar input{width:100%;padding:.75rem 1rem;border:1px solid #e5e7eb;border-radius:12px;background:#f9fafb;font-size:1rem;}
    .search-bar input:focus{outline:none;background:#fff;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.2);}
    
    /* Botones de descarga */
    .pdf-buttons{
      width:100%;
      max-width:960px;
      margin-bottom:1rem;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:1rem;
    }
    .pdf-buttons button{
      width:100%;
      padding:.75rem 1rem;
      border:none;
      border-radius:12px;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      transition:transform .2s,box-shadow .2s;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.5rem;
    }
    .pdf-buttons button:hover{transform:translateY(-2px)}
    
    .btn-report{
      background:var(--success);
      color:#fff;
      box-shadow:0 4px 14px rgba(16,185,129,.4);
    }
    .btn-catalog{
      background:var(--accent);
      color:#fff;
      box-shadow:0 4px 14px rgba(59,130,246,.4);
    }
    .btn-catalog i{font-size:1.2rem}

    .table-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:1.5rem;width:100%;max-width:1200px;}
    @media(max-width:1200px){.table-grid{grid-template-columns:repeat(4,1fr)}}
    @media(max-width:900px){.table-grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:600px){.table-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:400px){.table-grid{grid-column:1fr}}
    .line-item{background:var(--card);border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:.5rem;transition:transform var(--transition),box-shadow var(--transition);}
    .line-item:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover)}
    .line-item img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;cursor:zoom-in}
    .line-item h3{font-size:1rem;color:var(--accent)}
    .line-item p{margin:0;font-size:.75rem;color:#6b7280}
    .stock-line{font-weight:600;color:var(--success)}
    .actions{display:flex;gap:.5rem;margin-top:auto}
    button{padding:.4rem .8rem;border:none;border-radius:12px;font-weight:600;cursor:pointer;transition:transform .2s,box-shadow .2s;font-size:.75rem;}
    button:hover{transform:translateY(-2px)}
    .btn-primary{background:var(--accent);color:#fff;box-shadow:0 4px 14px rgba(59,130,246,.4);}
    .btn-danger{background:var(--danger);color:#fff;box-shadow:0 4px 14px rgba(239,68,68,.4);}
    .btn-warning{background:var(--warning);color:#fff;box-shadow:0 4px 14px rgba(245,158,11,.4);}
    .total-box{background:var(--card);padding:1.2rem 2rem;border-radius:var(--radius);box-shadow:var(--shadow);text-align:center;margin-top:2rem;}
    .total-box h2{font-size:1rem;color:var(--accent);margin:0}
    .total-box p{font-size:2rem;font-weight:700;margin:0;color:var(--accent)}
    .copy-barcode{cursor:pointer;margin-left:.3rem;color:var(--accent)}
    .copy-barcode:hover{color:var(--accent-hover)}
    .edit-form{display:flex;flex-direction:column;gap:.4rem;margin-top:.5rem;font-size:.75rem;}
    .edit-form input, .edit-form select, .edit-form textarea{padding:.4rem .5rem;border:1px solid #e5e7eb;border-radius:6px;font-size:.75rem;}
    .edit-form textarea{resize:vertical;min-height:60px;}
    @media print{body *{visibility:hidden} #printArea,#printArea *{visibility:visible} #printArea{position:absolute;top:0;left:0;width:100%}}
    #lightbox{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:9999;}
    #lightbox img{max-width:90%;max-height:90%;border-radius:12px;}

    #pdfContent{display: none;}
  </style>
</head>
<body>

<button id="menuToggle" title="Abrir menú"><i class="fa fa-bars"></i></button>

<nav id="kioskoBar">
  <a href="compra.html" title="Compra"><i class="fa fa-shopping-cart"></i></a>
  <a href="almacenamiento.html" title="Almacenamiento"><i class="fa fa-warehouse"></i></a>
  <a href="finanzas.html" title="Finanzas"><i class="fa fa-chart-line"></i></a>
  <a href="inventario.html" title="Inventario"><i class="fa fa-boxes"></i></a>
  <a href="catalogo.html" title="Catálogo"><i class="fa fa-book"></i></a>
  <a href="clientes.html" title="Clientes"><i class="fa fa-users"></i></a>
  <a href="descuentos.html" title="Descuentos"><i class="fa fa-percent"></i></a>
  <a href="facturas.html" title="Facturas"><i class="fa fa-file-invoice"></i></a>
  <a href="traslados.html" title="Traslados"><i class="fa fa-truck"></i></a>
  <a href="venta.html" title="Venta"><i class="fa fa-cash-register"></i></a>
  <a href="menu.html" title="Menú"><i class="fa fa-bars"></i></a>
</nav>

<button id="themeToggle" title="Cambiar tema"><i class="fa fa-moon"></i></button>

<h1><i class="fa fa-boxes"></i> Inventario – Sincronizado con Compras</h1>

<!-- NUEVO: Dashboard de Reportes -->
<div class="report-section">
  <h2><i class="fa fa-chart-pie"></i> Resumen Ejecutivo</h2>
  <div class="report-grid" id="executiveSummary">
    <!-- Se llena dinámicamente -->
  </div>
  
  <h3 style="margin-top:1.5rem;margin-bottom:1rem;color:var(--text);font-size:1.1rem;">
    <i class="fa fa-exclamation-triangle"></i> Alertas y Notificaciones
  </h3>
  <div id="alertsContainer" style="display:flex;flex-direction:column;gap:.5rem;">
    <!-- Alertas dinámicas -->
  </div>
</div>

<!-- NUEVO: Análisis por Categoría -->
<div class="report-section">
  <h2><i class="fa fa-layer-group"></i> Análisis por Categoría</h2>
  <div class="table-responsive">
    <table id="categoryTable">
      <thead>
        <tr>
          <th>Categoría</th>
          <th>Productos</th>
          <th>Stock Total</th>
          <th>Valor del Stock</th>
          <th>Promedio por Producto</th>
          <th>% del Total</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody id="categoryTableBody">
        <!-- Se llena dinámicamente -->
      </tbody>
    </table>
  </div>
</div>

<!-- NUEVO: Top Productos -->
<div class="report-section">
  <h2><i class="fa fa-trophy"></i> Top Productos por Valor</h2>
  <div class="table-responsive">
    <table id="topProductsTable">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Producto</th>
          <th>Categoría</th>
          <th>Stock</th>
          <th>Precio Unit.</th>
          <th>Valor Total</th>
          <th>% del Inventario</th>
        </tr>
      </thead>
      <tbody id="topProductsBody">
        <!-- Se llena dinámicamente -->
      </tbody>
    </table>
  </div>
</div>

<!-- NUEVO: Productos con Problemas -->
<div class="report-section" id="problemSection" style="display:none;">
  <h2><i class="fa fa-exclamation-circle"></i> Productos que Requieren Atención</h2>
  <div id="problemProductsContainer"></div>
</div>

<div class="summary-cards">
  <div class="summary-card"><h3>Total de productos</h3><p id="totalProducts">0</p></div>
  <div class="summary-card"><h3>Stock total</h3><p id="totalStock">0</p></div>
</div>

<div class="price-range">
  <input id="minPrice" type="number" placeholder="Precio mínimo" min="0" step="0.01"/>
  <input id="maxPrice" type="number" placeholder="Precio máximo" min="0" step="0.01"/>
</div>

<div class="search-bar">
  <input id="searchInput" type="text" placeholder="Buscar por nombre, código, barras o categoría..."/>
</div>

<!-- BOTONES DE DESCARGA -->
<div class="pdf-buttons">
  <button onclick="downloadPDF()" class="btn-report">
    <i class="fa fa-file-pdf"></i> Descargar Reporte Completo PDF
  </button>
  <button onclick="downloadCatalogPDF()" class="btn-catalog">
    <i class="fa fa-images"></i> PRODUCTOS (Catálogo)
  </button>
</div>

<div id="inventoryTable" class="table-grid"></div>

<div class="total-box"><h2>Total en USD</h2><p id="totalAmount">$0.00</p></div>

<div id="printArea" style="display:none;"></div>

<div id="lightbox" onclick="closeLightbox()">
  <img id="lightboxImg" src="" alt="Imagen ampliada"/>
</div>

<div id="pdfContent"></div>

<script>
function entrarKiosko(){
  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen().catch(()=>{});
  }
}
window.addEventListener('load', entrarKiosko);

const menuToggle = document.getElementById('menuToggle');
const kioskoBar  = document.getElementById('kioskoBar');
menuToggle.addEventListener('click', () => kioskoBar.classList.toggle('show'));

const CATEGORY_ORDER = [
  "Carteras","Aritos","Billeteras","Chokers","Collares","Lentes de sol","Pulseras","Relojes","Anillos","Accesorios para el cabello","Otros","Case teléfonos","Case audífonos","General"
];

let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
let filtered   = [...inventory];
let searchTerm = '';

const themeToggle = document.getElementById('themeToggle');
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  themeToggle.innerHTML = document.body.classList.contains('dark') ? '<i class="fa fa-sun"></i>' : '<i class="fa fa-moon"></i>';
});

function calculateTotal(list){
  return list.reduce((sum,item)=>{
    const price = parseFloat(item.price)||0;
    const qty   = parseFloat(item.quantity)||0;
    const disc  = parseFloat(item.discount)||0;
    return sum + (price * (1 - disc/100)) * qty;
  },0);
}
function stockTotal(list){
  return list.reduce((sum,item)=> sum + (parseInt(item.quantity)||0), 0);
}
function calculateItemValue(item){
  const price = parseFloat(item.price)||0;
  const qty = parseInt(item.quantity)||0;
  const disc = parseFloat(item.discount)||0;
  return (price * (1 - disc/100)) * qty;
}

function sortByCustomCategory(list) {
  return [...list].sort((a, b) => {
    const catA = (a.category || "Otros").trim();
    const catB = (b.category || "Otros").trim();
    const indexA = CATEGORY_ORDER.indexOf(catA);
    const indexB = CATEGORY_ORDER.indexOf(catB);
    const posA = indexA === -1 ? 999 : indexA;
    const posB = indexB === -1 ? 999 : indexB;
    return posA - posB || a.name.localeCompare(b.name);
  });
}

function highlight(text, query){
  if(!query) return text;
  const re = new RegExp(`(${query})`, 'gi');
  return text.replace(re, '<mark>$1</mark>');
}
function copyToClipboard(text){
  navigator.clipboard.writeText(text).then(()=>{
    alert('Código de barras copiado: ' + text);
  });
}

function openLightbox(src) {
  const lightbox = document.getElementById('lightbox');
  const img = document.getElementById('lightboxImg');
  img.src = src;
  lightbox.style.display = 'flex';
}
function closeLightbox() {
  document.getElementById('lightbox').style.display = 'none';
}

function generateExecutiveReports(){
  const totalValue = calculateTotal(inventory);
  const totalQty = stockTotal(inventory);
  const outOfStock = inventory.filter(i => parseInt(i.quantity) === 0);
  const lowStock = inventory.filter(i => {
    const q = parseInt(i.quantity);
    return q > 0 && q <= 5;
  });
  const inStock = inventory.filter(i => parseInt(i.quantity) > 5);
  
  const avgPrice = inventory.length > 0 ? totalValue / totalQty : 0;
  const categories = [...new Set(inventory.map(i => i.category || 'Sin categoría'))];
  
  const mostValuable = inventory.length > 0 ? 
    inventory.reduce((max, item) => calculateItemValue(item) > calculateItemValue(max) ? item : max, inventory[0]) : null;
  
  const highestStock = inventory.length > 0 ?
    inventory.reduce((max, item) => parseInt(item.quantity) > parseInt(max.quantity) ? item : max, inventory[0]) : null;

  const summaryHTML = `
    <div class="report-card success">
      <h4><i class="fa fa-check-circle"></i> En Stock Saludable</h4>
      <div class="value">${inStock.length}</div>
      <div class="detail">Productos con >5 unidades</div>
    </div>
    <div class="report-card warning">
      <h4><i class="fa fa-exclamation-triangle"></i> Stock Bajo</h4>
      <div class="value">${lowStock.length}</div>
      <div class="detail">Productos con 1-5 unidades</div>
    </div>
    <div class="report-card danger">
      <h4><i class="fa fa-times-circle"></i> Fuera de Stock</h4>
      <div class="value">${outOfStock.length}</div>
      <div class="detail">Productos agotados</div>
    </div>
    <div class="report-card info">
      <h4><i class="fa fa-dollar-sign"></i> Valor Promedio</h4>
      <div class="value">$${avgPrice.toFixed(2)}</div>
      <div class="detail">Por unidad en inventario</div>
    </div>
    <div class="report-card">
      <h4><i class="fa fa-tags"></i> Categorías</h4>
      <div class="value">${categories.length}</div>
      <div class="detail">Diferentes categorías activas</div>
    </div>
    <div class="report-card">
      <h4><i class="fa fa-crown"></i> Producto Top</h4>
      <div class="value" style="font-size:1.2rem;">${mostValuable ? mostValuable.name.substring(0,15) + '...' : 'N/A'}</div>
      <div class="detail">Mayor valor: $${mostValuable ? calculateItemValue(mostValuable).toFixed(2) : '0.00'}</div>
    </div>
  `;
  
  document.getElementById('executiveSummary').innerHTML = summaryHTML;
  
  const alertsContainer = document.getElementById('alertsContainer');
  alertsContainer.innerHTML = '';
  
  if (outOfStock.length > 0) {
    alertsContainer.innerHTML += `
      <div style="background:#fee2e2;border-left:4px solid #ef4444;padding:1rem;border-radius:8px;">
        <strong style="color:#991b1b;"><i class="fa fa-times-circle"></i> ${outOfStock.length} productos agotados</strong>
        <p style="color:#991b1b;font-size:.9rem;margin-top:.25rem;">Requiere reposición inmediata para evitar pérdida de ventas.</p>
      </div>
    `;
  }
  
  if (lowStock.length > 0) {
    alertsContainer.innerHTML += `
      <div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:1rem;border-radius:8px;">
        <strong style="color:#92400e;"><i class="fa fa-exclamation-triangle"></i> ${lowStock.length} productos con stock crítico</strong>
        <p style="color:#92400e;font-size:.9rem;margin-top:.25rem;">Considere reordenar pronto para mantener disponibilidad.</p>
      </div>
    `;
  }
  
  if (inventory.length === 0) {
    alertsContainer.innerHTML += `
      <div style="background:#e0f2fe;border-left:4px solid #06b6d4;padding:1rem;border-radius:8px;">
        <strong style="color:#155e75;"><i class="fa fa-info-circle"></i> Inventario vacío</strong>
        <p style="color:#155e75;font-size:.9rem;margin-top:.25rem;">No hay productos registrados en el sistema.</p>
      </div>
    `;
  }
  
  generateCategoryTable();
  generateTopProductsTable();
  generateProblemProducts();
}

function generateCategoryTable(){
  const categories = {};
  const totalValue = calculateTotal(inventory);
  
  inventory.forEach(item => {
    const cat = item.category || 'Sin categoría';
    if (!categories[cat]) {
      categories[cat] = { count: 0, stock: 0, value: 0 };
    }
    categories[cat].count++;
    categories[cat].stock += parseInt(item.quantity) || 0;
    categories[cat].value += calculateItemValue(item);
  });
  
  const tbody = document.getElementById('categoryTableBody');
  tbody.innerHTML = Object.entries(categories)
    .sort((a, b) => b[1].value - a[1].value)
    .map(([cat, data]) => {
      const percentage = totalValue > 0 ? ((data.value / totalValue) * 100).toFixed(1) : 0;
      const avgPerProduct = data.count > 0 ? (data.stock / data.count).toFixed(1) : 0;
      
      let statusBadge = '<span class="badge badge-success">OK</span>';
      if (data.stock === 0) statusBadge = '<span class="badge badge-danger">Agotado</span>';
      else if (data.stock / data.count <= 2) statusBadge = '<span class="badge badge-warning">Bajo</span>';
      
      return `
        <tr>
          <td><strong>${cat}</strong></td>
          <td>${data.count}</td>
          <td>${data.stock} u.</td>
          <td>$${data.value.toFixed(2)}</td>
          <td>${avgPerProduct} u.</td>
          <td>${percentage}%</td>
          <td>${statusBadge}</td>
        </tr>
      `;
    }).join('');
}

function generateTopProductsTable(){
  const totalValue = calculateTotal(inventory);
  const sorted = [...inventory]
    .sort((a, b) => calculateItemValue(b) - calculateItemValue(a))
    .slice(0, 10);
  
  const tbody = document.getElementById('topProductsBody');
  tbody.innerHTML = sorted.map((item, index) => {
    const value = calculateItemValue(item);
    const percentage = totalValue > 0 ? ((value / totalValue) * 100).toFixed(1) : 0;
    const finalPrice = item.discount > 0 
      ? (item.price * (1 - item.discount / 100)).toFixed(2)
      : parseFloat(item.price).toFixed(2);
    
    return `
      <tr>
        <td><span class="badge badge-info">#${index + 1}</span></td>
        <td>${item.name}</td>
        <td>${item.category}</td>
        <td>${item.quantity} u.</td>
        <td>$${finalPrice}</td>
        <td><strong>$${value.toFixed(2)}</strong></td>
        <td>${percentage}%</td>
      </tr>
    `;
  }).join('');
}

function generateProblemProducts(){
  const problems = inventory.filter(item => {
    const qty = parseInt(item.quantity);
    return qty === 0 || (qty > 0 && qty <= 2);
  }).sort((a, b) => parseInt(a.quantity) - parseInt(b.quantity));
  
  const section = document.getElementById('problemSection');
  const container = document.getElementById('problemProductsContainer');
  
  if (problems.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  container.innerHTML = problems.map(item => {
    const qty = parseInt(item.quantity);
    const isOut = qty === 0;
    const statusClass = isOut ? 'badge-danger' : 'badge-warning';
    const statusText = isOut ? 'AGOTADO' : 'CRÍTICO';
    
    return `
      <div style="display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--bg);border-radius:8px;margin-bottom:.5rem;border-left:4px solid ${isOut ? '#ef4444' : '#f59e0b'};">
        <div style="flex:1;">
          <strong>${item.name}</strong>
          <span class="badge ${statusClass}" style="margin-left:.5rem;">${statusText}</span>
          <p style="font-size:.8rem;color:#6b7280;margin-top:.25rem;">
            Código: ${item.code} | Categoría: ${item.category} | Stock: ${qty} u.
          </p>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:700;color:var(--accent);">$${parseFloat(item.price).toFixed(2)}</div>
          <div style="font-size:.75rem;color:#6b7280;">Precio unitario</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderTable(){
  const container = document.getElementById('inventoryTable');

  document.getElementById('totalProducts').textContent = inventory.length;
  document.getElementById('totalStock').textContent = stockTotal(inventory);

  filtered = sortByCustomCategory(filtered);

  if(!filtered.length){
    container.innerHTML = '<p style="text-align:center;color:#6b7280;grid-column:1/-1">No hay productos que coincidan con la búsqueda.</p>';
    document.getElementById('totalAmount').textContent = '$0.00';
    return;
  }

  container.innerHTML = filtered.map((item,idx)=>`
    <div class="line-item" id="card-${idx}">
      <img id="invImg${idx}" src="" alt="${item.name}"/>
      <h3>${highlight(item.name, searchTerm)}</h3>
      <p>Código: ${highlight(item.code, searchTerm)}</p>
      <p class="stock-line"><i class="fa fa-box"></i> Stock: ${item.quantity} u.</p>
      ${typeof item.discount === 'number' && item.discount > 0 ? `
        <p style="color:#ef4444;font-weight:600;">${item.discount}% OFF</p>
        <p>Precio: <del style="color:#9ca3af;">$${item.price}</del> <strong>$${(item.price * (1 - item.discount / 100)).toFixed(2)}</strong></p>
      ` : `
        <p>Precio: $${item.price}</p>
      `}
      <p>Categoría: ${highlight(item.category, searchTerm)}</p>
      ${item.description ? `<p style="font-size:.7rem;color:#4b5563;"><i class="fa fa-info-circle"></i> ${item.description.substring(0, 50)}${item.description.length > 50 ? '...' : ''}</p>` : ''}
      <p style="font-size:.7rem;">Barras: ${highlight(item.barcode, searchTerm)}
        <i class="fa fa-copy copy-barcode" onclick="copyToClipboard('${item.barcode}')" title="Copiar código"></i>
      </p>
      <div class="actions">
        <button onclick="viewItem(${idx})" class="btn-primary">Ver</button>
        <button onclick="deleteItem(${idx})" class="btn-danger">Eliminar</button>
        <button onclick="editItem(${idx})" class="btn-primary">Editar</button>
      </div>
    </div>
  `).join('');

  filtered.forEach((p,i)=>{
    localforage.getItem(`img_${p.code}`).then(blob=>{
      if(blob){
        const url = URL.createObjectURL(blob);
        const img = document.getElementById(`invImg${i}`);
        img.src = url;
        img.onclick = () => openLightbox(url);
      }
    });
  });

  document.getElementById('totalAmount').textContent = `$${calculateTotal(filtered).toFixed(2)}`;
  generateExecutiveReports();
}

function viewItem(index){
  alert(`Detalles:\n\n${JSON.stringify(filtered[index],null,2)}`);
}
function deleteItem(index){
  if(!confirm('¿Eliminar producto?'))return;
  const realIndex = inventory.findIndex(it=> it.code === filtered[index].code);
  const item = inventory[realIndex];
  localforage.removeItem(`img_${item.code}`);
  inventory.splice(realIndex,1);
  localStorage.setItem('inventory', JSON.stringify(inventory));
  doFilter();
}

function editItem(index){
  const card = document.getElementById(`card-${index}`);
  const p    = filtered[index];
  const realIndex = inventory.findIndex(it=> it.code === p.code);
  if(card.querySelector('.edit-form')) return;

  const form = document.createElement('div');
  form.className = 'edit-form';
  form.innerHTML = `
    <input id="editName${index}" value="${p.name}" placeholder="Nombre"/>
    <input id="editPrice${index}" type="number" step="0.01" value="${p.price}" placeholder="Precio"/>
    <input id="editQty${index}"  type="number" value="${p.quantity}" placeholder="Stock"/>
    <input id="editMinStock${index}" type="number" value="${p.minStock || 5}" placeholder="Stock mínimo (alerta)"/>
    <textarea id="editDesc${index}" placeholder="Descripción" rows="2">${p.description || ''}</textarea>
    <select id="editCat${index}">
      <option value="Accesorios para el cabello" ${p.category === 'Accesorios para el cabello' ? 'selected' : ''}>Accesorios para el cabello</option>
      <option value="Anillos" ${p.category === 'Anillos' ? 'selected' : ''}>Anillos</option>
      <option value="Aritos" ${p.category === 'Aritos' ? 'selected' : ''}>Aritos</option>
      <option value="Billetera" ${p.category === 'Billetera' ? 'selected' : ''}>Billetera</option>
      <option value="Carteras" ${p.category === 'Carteras' ? 'selected' : ''}>Carteras</option>
      <option value="Case audífonos" ${p.category === 'Case audífonos' ? 'selected' : ''}>Case audífonos</option>
      <option value="Case teléfonos" ${p.category === 'Case teléfonos' ? 'selected' : ''}>Case teléfonos</option>
      <option value="Chokers" ${p.category === 'Chokers' ? 'selected' : ''}>Chokers</option>
      <option value="Collares" ${p.category === 'Collares' ? 'selected' : ''}>Collares</option>
      <option value="General" ${p.category === 'General' ? 'selected' : ''}>General</option>
      <option value="Lentes de sol" ${p.category === 'Lentes de sol' ? 'selected' : ''}>Lentes de sol</option>
      <option value="Pulseras" ${p.category === 'Pulseras' ? 'selected' : ''}>Pulseras</option>
      <option value="Relojes" ${p.category === 'Relojes' ? 'selected' : ''}>Relojes</option>
      <option value="Otros" ${p.category === 'Otros' ? 'selected' : ''}>Otros</option>
    </select>
    <input id="editBar${index}"  value="${p.barcode}" placeholder="Código de barras"/>
    <div style="display:flex;gap:.3rem">
      <button onclick="saveEdit(${index},${realIndex})" class="btn-primary">Guardar</button>
      <button onclick="cancelEdit(${index})" class="btn-danger">Cancelar</button>
    </div>
  `;
  card.appendChild(form);
}
function cancelEdit(index){
  document.getElementById(`card-${index}`).querySelector('.edit-form').remove();
}
function saveEdit(filterIdx, invIdx){
  const newData = {
    name:     document.getElementById(`editName${filterIdx}`).value.trim(),
    price:    document.getElementById(`editPrice${filterIdx}`).value.trim(),
    quantity: document.getElementById(`editQty${filterIdx}`).value.trim(),
    minStock: document.getElementById(`editMinStock${filterIdx}`).value.trim() || 5,
    description: document.getElementById(`editDesc${filterIdx}`).value.trim(),
    category: document.getElementById(`editCat${filterIdx}`).value.trim(),
    barcode:  document.getElementById(`editBar${filterIdx}`).value.trim(),
    code:     filtered[filterIdx].code,
    discount: filtered[filterIdx].discount || 0
  };
  inventory[invIdx] = newData;
  localStorage.setItem('inventory', JSON.stringify(inventory));
  doFilter();
}

function doFilter(){
  searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
  const minP = parseFloat(document.getElementById('minPrice').value) || 0;
  const maxP = parseFloat(document.getElementById('maxPrice').value) || Infinity;

  filtered = inventory.filter(p=>{
    const price = parseFloat(p.price)||0;
    const matchText = !searchTerm ||
      p.name.toLowerCase().includes(searchTerm) ||
      p.code.toLowerCase().includes(searchTerm) ||
      p.barcode.toLowerCase().includes(searchTerm) ||
      p.category.toLowerCase().includes(searchTerm) ||
      (p.description && p.description.toLowerCase().includes(searchTerm));
    const matchPrice = price >= minP && price <= maxP;
    return matchText && matchPrice;
  });
  renderTable();
}
document.getElementById('searchInput').addEventListener('input',doFilter);
document.getElementById('minPrice').addEventListener('input',doFilter);
document.getElementById('maxPrice').addEventListener('input',doFilter);

window.addEventListener('storage', e => {
  if(e.key === 'inventory'){
    inventory = JSON.parse(e.newValue) || [];
    doFilter();
  }
});
window.addEventListener('storage', e => {
  if (e.key === 'inventario') {
    inventory = JSON.parse(e.newValue) || [];
    localStorage.setItem('inventory', JSON.stringify(inventory));
    doFilter();
  }
});
const originalSetItem = localStorage.setItem;
localStorage.setItem = function(key, value) {
  originalSetItem.call(this, key, value);
  if (key === 'inventory') {
    originalSetItem.call(this, 'inventario', value);
  }
};

// FUNCIÓN ORIGINAL: Reporte completo de inventario
async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  
  if (!filtered || filtered.length === 0) {
    alert('No hay productos para generar el PDF');
    return;
  }
  
  const pdf = new jsPDF('p', 'mm', 'a4');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const margin = 15;
  
  let yPosition = 20;
  let pageCount = 1;
  
  const checkNewPage = (neededSpace = 40) => {
    if (yPosition > 280 - neededSpace) {
      pdf.addPage();
      pageCount++;
      yPosition = 20;
      pdf.setFontSize(8);
      pdf.setTextColor(150, 150, 150);
      pdf.text(`Reporte de Inventario - Página ${pageCount}`, pageWidth / 2, 10, { align: 'center' });
    }
  };
  
  const blobToBase64 = (blob) => {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  };
  
  // PORTADA
  pdf.setFontSize(24);
  pdf.setTextColor(59, 130, 246);
  pdf.setFont(undefined, 'bold');
  pdf.text('REPORTE DE INVENTARIO', pageWidth / 2, yPosition, { align: 'center' });
  yPosition += 12;
  
  pdf.setFontSize(10);
  pdf.setTextColor(100, 100, 100);
  pdf.setFont(undefined, 'normal');
  const fecha = new Date().toLocaleDateString('es-ES', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  pdf.text(`Generado el ${fecha} | ${inventory.length} productos registrados`, pageWidth / 2, yPosition, { align: 'center' });
  yPosition += 15;
  
  pdf.setDrawColor(59, 130, 246);
  pdf.line(margin, yPosition, pageWidth - margin, yPosition);
  yPosition += 10;
  
  // RESUMEN EJECUTIVO
  pdf.setFontSize(16);
  pdf.setTextColor(31, 41, 55);
  pdf.setFont(undefined, 'bold');
  pdf.text('1. RESUMEN EJECUTIVO', margin, yPosition);
  yPosition += 8;
  
  const totalValue = calculateTotal(inventory);
  const totalQty = stockTotal(inventory);
  const outOfStock = inventory.filter(i => parseInt(i.quantity) === 0).length;
  const lowStock = inventory.filter(i => {
    const q = parseInt(i.quantity);
    return q > 0 && q <= 5;
  }).length;
  const inStock = inventory.filter(i => parseInt(i.quantity) > 5).length;
  const avgPrice = inventory.length > 0 ? totalValue / totalQty : 0;
  
  pdf.setFontSize(10);
  pdf.setFont(undefined, 'normal');
  
  const summaryData = [
    ['Total de Productos:', inventory.length.toString()],
    ['Unidades en Stock:', totalQty.toString()],
    ['Valor Total del Inventario:', `$${totalValue.toFixed(2)}`],
    ['Precio Promedio por Unidad:', `$${avgPrice.toFixed(2)}`],
    ['Productos Agotados:', outOfStock.toString()],
    ['Productos con Stock Bajo:', lowStock.toString()],
    ['Productos con Stock Saludable:', inStock.toString()]
  ];
  
  summaryData.forEach(([label, value]) => {
    pdf.setTextColor(100, 100, 100);
    pdf.text(label, margin, yPosition);
    pdf.setTextColor(0, 0, 0);
    pdf.setFont(undefined, 'bold');
    pdf.text(value, margin + 70, yPosition);
    pdf.setFont(undefined, 'normal');
    yPosition += 6;
  });
  
  yPosition += 5;
  
  // DISTRIBUCIÓN POR ESTADO
  checkNewPage(60);
  pdf.setFontSize(16);
  pdf.setTextColor(31, 41, 55);
  pdf.setFont(undefined, 'bold');
  pdf.text('2. DISTRIBUCIÓN POR ESTADO DE STOCK', margin, yPosition);
  yPosition += 10;
  
  const maxVal = Math.max(inStock, lowStock, outOfStock, 1);
  const barWidth = 80;
  
  pdf.setFillColor(16, 185, 129);
  pdf.rect(margin, yPosition - 5, (inStock / maxVal) * barWidth, 8, 'F');
  pdf.setTextColor(0, 0, 0);
  pdf.text(`En Stock (>5u): ${inStock}`, margin + (inStock / maxVal) * barWidth + 5, yPosition);
  yPosition += 12;
  
  pdf.setFillColor(245, 158, 11);
  pdf.rect(margin, yPosition - 5, (lowStock / maxVal) * barWidth, 8, 'F');
  pdf.text(`Stock Bajo (1-5u): ${lowStock}`, margin + (lowStock / maxVal) * barWidth + 5, yPosition);
  yPosition += 12;
  
  pdf.setFillColor(239, 68, 68);
  pdf.rect(margin, yPosition - 5, (outOfStock / maxVal) * barWidth, 8, 'F');
  pdf.text(`Agotado (0u): ${outOfStock}`, margin + (outOfStock / maxVal) * barWidth + 5, yPosition);
  yPosition += 15;
  
  // ANÁLISIS POR CATEGORÍA
  checkNewPage(100);
  pdf.setFontSize(16);
  pdf.setTextColor(31, 41, 55);
  pdf.setFont(undefined, 'bold');
  pdf.text('3. ANÁLISIS POR CATEGORÍA', margin, yPosition);
  yPosition += 10;
  
  const categories = {};
  inventory.forEach(item => {
    const cat = item.category || 'Sin categoría';
    if (!categories[cat]) categories[cat] = { count: 0, stock: 0, value: 0 };
    categories[cat].count++;
    categories[cat].stock += parseInt(item.quantity) || 0;
    categories[cat].value += calculateItemValue(item);
  });
  
  pdf.setFillColor(243, 244, 246);
  pdf.rect(margin, yPosition - 6, pageWidth - margin * 2, 8, 'F');
  pdf.setFontSize(9);
  pdf.setTextColor(75, 85, 99);
  pdf.text('Categoría', margin + 2, yPosition);
  pdf.text('Prod.', margin + 60, yPosition);
  pdf.text('Stock', margin + 80, yPosition);
  pdf.text('Valor Total', margin + 105, yPosition);
  pdf.text('% del Total', margin + 140, yPosition);
  yPosition += 8;
  
  pdf.setTextColor(0, 0, 0);
  Object.entries(categories)
    .sort((a, b) => b[1].value - a[1].value)
    .forEach(([cat, data]) => {
      checkNewPage(15);
      const percentage = totalValue > 0 ? ((data.value / totalValue) * 100).toFixed(1) : 0;
      
      pdf.setFontSize(9);
      pdf.text(cat.substring(0, 25), margin + 2, yPosition);
      pdf.text(data.count.toString(), margin + 60, yPosition);
      pdf.text(data.stock.toString(), margin + 80, yPosition);
      pdf.text(`$${data.value.toFixed(2)}`, margin + 105, yPosition);
      pdf.text(`${percentage}%`, margin + 140, yPosition);
      
      pdf.setFillColor(59, 130, 246);
      pdf.rect(margin + 160, yPosition - 4, percentage * 0.8, 4, 'F');
      
      yPosition += 7;
    });
  
  yPosition += 10;
  
  // TOP 10 PRODUCTOS
  checkNewPage(120);
  pdf.setFontSize(16);
  pdf.setTextColor(31, 41, 55);
  pdf.setFont(undefined, 'bold');
  pdf.text('4. TOP 10 PRODUCTOS POR VALOR DE INVENTARIO', margin, yPosition);
  yPosition += 10;
  
  const topProducts = [...inventory]
    .sort((a, b) => calculateItemValue(b) - calculateItemValue(a))
    .slice(0, 10);
  
  pdf.setFillColor(243, 244, 246);
  pdf.rect(margin, yPosition - 6, pageWidth - margin * 2, 8, 'F');
  pdf.setFontSize(9);
  pdf.setTextColor(75, 85, 99);
  pdf.text('#', margin + 2, yPosition);
  pdf.text('Producto', margin + 15, yPosition);
  pdf.text('Stock', margin + 90, yPosition);
  pdf.text('Precio', margin + 110, yPosition);
  pdf.text('Valor Total', margin + 135, yPosition);
  pdf.text('%', margin + 165, yPosition);
  yPosition += 8;
  
  topProducts.forEach((item, idx) => {
    checkNewPage(15);
    const value = calculateItemValue(item);
    const percentage = totalValue > 0 ? ((value / totalValue) * 100).toFixed(1) : 0;
    const finalPrice = item.discount > 0 
      ? (item.price * (1 - item.discount / 100)).toFixed(2)
      : parseFloat(item.price).toFixed(2);
    
    pdf.setFontSize(9);
    pdf.setTextColor(0, 0, 0);
    pdf.text((idx + 1).toString(), margin + 2, yPosition);
    pdf.text(item.name.substring(0, 35), margin + 15, yPosition);
    pdf.text(item.quantity.toString(), margin + 90, yPosition);
    pdf.text(`$${finalPrice}`, margin + 110, yPosition);
    pdf.setFont(undefined, 'bold');
    pdf.text(`$${value.toFixed(2)}`, margin + 135, yPosition);
    pdf.setFont(undefined, 'normal');
    pdf.text(`${percentage}%`, margin + 165, yPosition);
    yPosition += 7;
  });
  
  yPosition += 10;
  
  // PRODUCTOS CON PROBLEMAS
  const problems = inventory.filter(item => {
    const qty = parseInt(item.quantity);
    return qty === 0 || (qty > 0 && qty <= 2);
  }).sort((a, b) => parseInt(a.quantity) - parseInt(b.quantity));
  
  if (problems.length > 0) {
    checkNewPage(100);
    pdf.setFontSize(16);
    pdf.setTextColor(239, 68, 68);
    pdf.setFont(undefined, 'bold');
    pdf.text('5. PRODUCTOS QUE REQUIEREN ATENCIÓN INMEDIATA', margin, yPosition);
    yPosition += 10;
    
    pdf.setFontSize(9);
    pdf.setTextColor(0, 0, 0);
    
    problems.forEach(item => {
      checkNewPage(20);
      const qty = parseInt(item.quantity);
      const isOut = qty === 0;
      
      pdf.setFillColor(isOut ? 239 : 245, isOut ? 68 : 158, isOut ? 68 : 11);
      pdf.circle(margin + 3, yPosition - 2, 2, 'F');
      
      pdf.setFont(undefined, 'bold');
      pdf.text(item.name.substring(0, 40), margin + 10, yPosition);
      pdf.setFont(undefined, 'normal');
      pdf.text(`[${isOut ? 'AGOTADO' : 'CRÍTICO'}] Stock: ${qty}u | Código: ${item.code} | $${parseFloat(item.price).toFixed(2)}`, 
        margin + 10, yPosition + 5);
      yPosition += 12;
    });
    
    yPosition += 5;
  }
  
  // LISTADO COMPLETO
  checkNewPage(40);
  pdf.addPage();
  pageCount++;
  yPosition = 20;
  
  pdf.setFontSize(16);
  pdf.setTextColor(31, 41, 55);
  pdf.setFont(undefined, 'bold');
  pdf.text('6. LISTADO COMPLETO DE PRODUCTOS', margin, yPosition);
  yPosition += 10;
  
  const sortedItems = sortByCustomCategory(filtered);
  
  for (let index = 0; index < sortedItems.length; index++) {
    const item = sortedItems[index];
    checkNewPage(35);
    
    const finalPrice = item.discount > 0 
      ? (item.price * (1 - item.discount / 100)).toFixed(2)
      : parseFloat(item.price).toFixed(2);
    
    try {
      const blob = await localforage.getItem(`img_${item.code}`);
      if (blob) {
        const base64 = await blobToBase64(blob);
        pdf.addImage(base64, 'JPEG', margin, yPosition, 20, 20);
      }
    } catch (e) {}
    
    const textX = margin + 25;
    
    pdf.setFontSize(10);
    pdf.setTextColor(59, 130, 246);
    pdf.setFont(undefined, 'bold');
    let nombre = item.name.length > 35 ? item.name.substring(0, 32) + '...' : item.name;
    pdf.text(nombre, textX, yPosition + 4);
    
    const qty = parseInt(item.quantity) || 0;
    pdf.setFontSize(8);
    if (qty === 0) {
      pdf.setTextColor(239, 68, 68);
      pdf.text('[SIN STOCK]', textX + pdf.getTextWidth(nombre) + 5, yPosition + 4);
    } else if (qty <= 5) {
      pdf.setTextColor(245, 158, 11);
      pdf.text('[STOCK BAJO]', textX + pdf.getTextWidth(nombre) + 5, yPosition + 4);
    }
    
    yPosition += 7;
    
    pdf.setFontSize(8);
    pdf.setTextColor(80, 80, 80);
    pdf.setFont(undefined, 'normal');
    pdf.text(`Código: ${item.code} | Stock: ${item.quantity}u | Categoría: ${item.category}`, textX, yPosition);
    yPosition += 4;
    
    if (item.discount > 0) {
      pdf.setTextColor(239, 68, 68);
      pdf.text(`Precio: $${finalPrice} (desc. ${item.discount}%) | Barras: ${item.barcode}`, textX, yPosition);
    } else {
      pdf.text(`Precio: $${finalPrice} | Barras: ${item.barcode}`, textX, yPosition);
    }
    yPosition += 4;
    
    if (item.description) {
      pdf.setTextColor(100, 100, 100);
      pdf.setFontSize(7);
      let desc = item.description.trim();
      if (desc.length > 80) desc = desc.substring(0, 77) + '...';
      pdf.text(`Descripción: ${desc}`, textX, yPosition);
      yPosition += 4;
    }
    
    yPosition += 8;
    pdf.setDrawColor(230, 230, 230);
    pdf.line(margin, yPosition - 3, pageWidth - margin, yPosition - 3);
  }
  
  pdf.setFontSize(8);
  pdf.setTextColor(150, 150, 150);
  pdf.text(`Reporte generado automáticamente por Sistema de Inventario | Total de páginas: ${pageCount}`, 
    pageWidth / 2, 285, { align: 'center' });
  
  pdf.save(`reporte_inventario_completo_${new Date().toISOString().split('T')[0]}.pdf`);
}

// NUEVA FUNCIÓN: Catálogo de Productos (Base de Datos en PDF) - CORREGIDA CON PRECIO NEGRO
async function downloadCatalogPDF() {
  const { jsPDF } = window.jspdf;
  
  if (!filtered || filtered.length === 0) {
    alert('No hay productos para generar el catálogo');
    return;
  }
  
  const pdf = new jsPDF('p', 'mm', 'a4');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const margin = 15;
  
  let yPosition = 20;
  let pageCount = 1;
  
  // Función para convertir blob a base64
  const blobToBase64 = (blob) => {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  };
  
  // Función para verificar espacio y agregar nueva página
  const checkNewPage = (neededSpace = 60) => {
    if (yPosition > pageHeight - margin - neededSpace) {
      pdf.addPage();
      pageCount++;
      yPosition = margin;
      // Header en nueva página
      addHeader();
    }
  };
  
  // Función para agregar header
  const addHeader = () => {
    pdf.setFillColor(59, 130, 246);
    pdf.rect(0, 0, pageWidth, 12, 'F');
    pdf.setFontSize(10);
    pdf.setTextColor(255, 255, 255);
    pdf.setFont(undefined, 'bold');
    pdf.text('CATÁLOGO DE PRODUCTOS', pageWidth / 2, 8, { align: 'center' });
    
    pdf.setFontSize(8);
    pdf.setTextColor(150, 150, 150);
    pdf.text(`Página ${pageCount}`, pageWidth - margin, 8, { align: 'right' });
  };
  
  // Función para convertir número a palabras (para el precio en letras)
  const numeroALetras = (numero) => {
    const unidades = ['cero', 'uno', 'dos', 'tres', 'cuatro', 'cinco', 'seis', 'siete', 'ocho', 'nueve'];
    const decenas = ['diez', 'once', 'doce', 'trece', 'catorce', 'quince', 'dieciséis', 'diecisiete', 'dieciocho', 'diecinueve'];
    const decenasCompuestas = ['veinte', 'treinta', 'cuarenta', 'cincuenta', 'sesenta', 'setenta', 'ochenta', 'noventa'];
    const centenas = ['cien', 'doscientos', 'trescientos', 'cuatrocientos', 'quinientos', 'seiscientos', 'setecientos', 'ochocientos', 'novecientos'];
    
    const entero = Math.floor(numero);
    const decimal = Math.round((numero - entero) * 100);
    
    let resultado = '';
    
    if (entero === 0) {
      resultado = unidades[0];
    } else if (entero < 10) {
      resultado = unidades[entero];
    } else if (entero < 20) {
      resultado = decenas[entero - 10];
    } else if (entero < 100) {
      const decena = Math.floor(entero / 10);
      const unidad = entero % 10;
      resultado = decenasCompuestas[decena - 2];
      if (unidad > 0) resultado += ' y ' + unidades[unidad];
    } else if (entero < 1000) {
      const centena = Math.floor(entero / 100);
      const resto = entero % 100;
      resultado = centenas[centena - 1];
      if (resto > 0) {
        if (centena === 1) resultado = 'ciento';
        resultado += ' ' + numeroALetras(resto);
      }
    } else if (entero < 1000000) {
      const miles = Math.floor(entero / 1000);
      const resto = entero % 1000;
      if (miles === 1) {
        resultado = 'mil';
      } else {
        resultado = numeroALetras(miles) + ' mil';
      }
      if (resto > 0) resultado += ' ' + numeroALetras(resto);
    }
    
    return resultado.toUpperCase() + (decimal > 0 ? ' CON ' + decimal + '/100' : ' CON 00/100') + ' DÓLARES';
  };
  
  // PORTADA DEL CATÁLOGO
  pdf.setFillColor(59, 130, 246);
  pdf.rect(0, 0, pageWidth, pageHeight, 'F');
  
  pdf.setTextColor(255, 255, 255);
  pdf.setFontSize(32);
  pdf.setFont(undefined, 'bold');
  pdf.text('CATÁLOGO', pageWidth / 2, pageHeight / 2 - 20, { align: 'center' });
  pdf.text('DE PRODUCTOS', pageWidth / 2, pageHeight / 2 + 10, { align: 'center' });
  
  pdf.setFontSize(14);
  pdf.setFont(undefined, 'normal');
  const fecha = new Date().toLocaleDateString('es-ES', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric'
  });
  pdf.text(`Actualizado: ${fecha}`, pageWidth / 2, pageHeight / 2 + 40, { align: 'center' });
  pdf.text(`${filtered.length} productos disponibles`, pageWidth / 2, pageHeight / 2 + 50, { align: 'center' });
  
  pdf.addPage();
  pageCount++;
  yPosition = margin;
  addHeader();
  yPosition += 15;
  
  // Ordenar productos por categoría
  const sortedItems = sortByCustomCategory(filtered);
  let currentCategory = '';
  
  // Procesar cada producto
  for (let index = 0; index < sortedItems.length; index++) {
    const item = sortedItems[index];
    
    // Nueva categoría?
    if (item.category !== currentCategory) {
      checkNewPage(30);
      currentCategory = item.category;
      
      // Título de categoría
      pdf.setFillColor(243, 244, 246);
      pdf.rect(margin, yPosition - 5, pageWidth - margin * 2, 10, 'F');
      pdf.setFontSize(12);
      pdf.setTextColor(59, 130, 246);
      pdf.setFont(undefined, 'bold');
      pdf.text(currentCategory.toUpperCase(), pageWidth / 2, yPosition + 1, { align: 'center' });
      yPosition += 15;
    }
    
    checkNewPage(80);
    
    // ✅ CORRECCIÓN: Asegurar que el precio sea número
    const rawPrice = parseFloat(item.price) || 0;
    const finalPrice = item.discount > 0 
      ? (rawPrice * (1 - item.discount / 100)).toFixed(2)
      : rawPrice.toFixed(2);
    
    // === DISEÑO DE FICHA DE PRODUCTO ===
    
    // Caja contenedora
    pdf.setDrawColor(229, 231, 235);
    pdf.setLineWidth(0.5);
    pdf.roundedRect(margin, yPosition, pageWidth - margin * 2, 75, 3, 3, 'S');
    
    // Imagen del producto (lado izquierdo)
    let imgX = margin + 5;
    let imgY = yPosition + 5;
    let imgWidth = 40;
    let imgHeight = 50;
    
    try {
      const blob = await localforage.getItem(`img_${item.code}`);
      if (blob) {
        const base64 = await blobToBase64(blob);
        pdf.addImage(base64, 'JPEG', imgX, imgY, imgWidth, imgHeight);
      } else {
        // Placeholder si no hay imagen
        pdf.setFillColor(243, 244, 246);
        pdf.rect(imgX, imgY, imgWidth, imgHeight, 'F');
        pdf.setTextColor(156, 163, 175);
        pdf.setFontSize(8);
        pdf.text('Sin imagen', imgX + imgWidth/2, imgY + imgHeight/2, { align: 'center' });
      }
    } catch (e) {
      pdf.setFillColor(243, 244, 246);
      pdf.rect(imgX, imgY, imgWidth, imgHeight, 'F');
    }
    
    // Información del producto (lado derecho)
    let textX = margin + 50;
    let textY = yPosition + 10;
    
    // Nombre del producto
    pdf.setFontSize(14);
    pdf.setTextColor(31, 41, 55);
    pdf.setFont(undefined, 'bold');
    let nombre = item.name;
    if (nombre.length > 40) nombre = nombre.substring(0, 37) + '...';
    pdf.text(nombre, textX, textY);
    textY += 8;
    
    // Categoría
    pdf.setFontSize(9);
    pdf.setTextColor(107, 114, 128);
    pdf.setFont(undefined, 'normal');
    pdf.text(`Categoría: ${item.category}`, textX, textY);
    textY += 6;
    
    // Código y código de barras
    pdf.setFontSize(8);
    pdf.text(`Código: ${item.code}  |  Código de barras: ${item.barcode}`, textX, textY);
    textY += 6;
    
    // Descripción
    if (item.description && item.description.trim() !== '') {
      pdf.setTextColor(75, 85, 99);
      let desc = item.description.trim();
      // Dividir descripción en líneas si es muy larga
      const maxChars = 65;
      const lines = [];
      while (desc.length > 0) {
        if (desc.length <= maxChars) {
          lines.push(desc);
          break;
        }
        let line = desc.substring(0, maxChars);
        const lastSpace = line.lastIndexOf(' ');
        if (lastSpace > 0) {
          line = line.substring(0, lastSpace);
        }
        lines.push(line);
        desc = desc.substring(line.length).trim();
      }
      
      lines.slice(0, 2).forEach(line => {
        pdf.text(line, textX, textY);
        textY += 4;
      });
      if (item.description.length > maxChars * 2) {
        pdf.text('...', textX, textY);
        textY += 4;
      }
      textY += 2;
    }
    
    // Stock disponible
    const qty = parseInt(item.quantity) || 0;
    pdf.setFontSize(9);
    if (qty === 0) {
      pdf.setTextColor(239, 68, 68);
      pdf.setFont(undefined, 'bold');
      pdf.text(`STOCK: AGOTADO`, textX, textY);
    } else if (qty <= 5) {
      pdf.setTextColor(245, 158, 11);
      pdf.setFont(undefined, 'bold');
      pdf.text(`STOCK: ${qty} unidades (¡Últimas!)`, textX, textY);
    } else {
      pdf.setTextColor(16, 185, 129);
      pdf.setFont(undefined, 'bold');
      pdf.text(`STOCK: ${qty} unidades disponibles`, textX, textY);
    }
    textY += 12;
    
    // ✅ PRECIO EN NEGRO - NÚMEROS Y LETRAS
    pdf.setFontSize(11);
    pdf.setTextColor(0, 0, 0); // NEGRO PURO
    pdf.setFont(undefined, 'bold');
    
    // Precio en números
    const precioNumeros = `$${finalPrice}`;
    pdf.text(`PRECIO: ${precioNumeros}`, textX, textY);
    
    // Precio en letras (debajo)
    textY += 6;
    pdf.setFontSize(8);
    pdf.setFont(undefined, 'normal');
    pdf.setTextColor(80, 80, 80); // Gris oscuro para las letras
    
    const precioLetras = numeroALetras(parseFloat(finalPrice));
    // Dividir en líneas si es muy largo
    const maxLetrasChars = 60;
    if (precioLetras.length > maxLetrasChars) {
      pdf.text(precioLetras.substring(0, maxLetrasChars), textX, textY);
      textY += 4;
      pdf.text(precioLetras.substring(maxLetrasChars), textX, textY);
    } else {
      pdf.text(precioLetras, textX, textY);
    }
    
    // Si hay descuento, mostrar precio original tachado al lado
    if (item.discount > 0) {
      textY -= 6; // Volver a la línea del precio
      const oldPriceX = textX + pdf.getTextWidth(`PRECIO: ${precioNumeros}`) + 15;
      pdf.setFontSize(9);
      pdf.setTextColor(156, 163, 175); // Gris claro para precio tachado
      pdf.setFont(undefined, 'normal');
      pdf.text(`$${rawPrice.toFixed(2)}`, oldPriceX, textY);
      // Tachar
      const oldPriceWidth = pdf.getTextWidth(`$${rawPrice.toFixed(2)}`);
      pdf.setDrawColor(156, 163, 175);
      pdf.line(oldPriceX, textY - 2, oldPriceX + oldPriceWidth, textY - 2);
      
      // Badge de descuento
      pdf.setFillColor(239, 68, 68);
      pdf.roundedRect(oldPriceX + oldPriceWidth + 5, textY - 5, 18, 7, 2, 2, 'F');
      pdf.setTextColor(255, 255, 255);
      pdf.setFontSize(7);
      pdf.text(`-${item.discount}%`, oldPriceX + oldPriceWidth + 9, textY - 1);
    }
    
    yPosition += 80; // Espacio para la siguiente ficha
  }
  
  // Pie de página final
  pdf.setFontSize(8);
  pdf.setTextColor(150, 150, 150);
  pdf.text(`Catálogo generado automáticamente | Total de páginas: ${pageCount}`, 
    pageWidth / 2, pageHeight - 10, { align: 'center' });
  
  // Guardar
  pdf.save(`catalogo_productos_${new Date().toISOString().split('T')[0]}.pdf`);
}

window.addEventListener('DOMContentLoaded',()=> doFilter());
</script>
</body>
</html>
