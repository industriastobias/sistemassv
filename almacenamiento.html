<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Almacenamiento</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111827;
      --border: #e5e7eb;
      --accent: #000000;
      --accent-hover: #333333;
      --highlight: #f9fafb;
      --white: #ffffff;
      --danger: #ef4444;
      --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: var(--bg);
      color: var(--text);
      font-size: 15px;
      line-height: 1.5;
      padding: 2rem 1rem;
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
      width: 100%;
      max-width: 900px;
      margin-bottom: 1.5rem;
    }
    label {
      font-weight: 600;
      font-size: 0.9rem;
    }
    input, select, textarea {
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.9rem;
      width: 100%;
    }
    button.stamp {
      padding: 0.5rem 1rem;
      border: 1px solid var(--accent);
      background: var(--white);
      color: var(--accent);
      font-weight: 500;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s ease;
    }
    button.stamp:hover {
      background: var(--accent);
      color: var(--white);
    }
    .actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    #previewImg {
      max-height: 120px;
      border-radius: 6px;
      object-fit: cover;
      margin-top: 0.5rem;
    }
    .result-message {
      font-weight: 600;
      margin-top: 1rem;
    }
  </style>
</head>

<body>
  <h1><i class="fa-solid fa-warehouse"></i> Alta / Edición de Productos</h1>

  <div class="form-grid">
    <div>
      <label>Nombre del producto</label>
      <input type="text" id="name" placeholder="Ej: Collar estrella" />
    </div>
    <div>
      <label>Código de barras</label>
      <input type="text" id="barcode" placeholder="Ej: 1234567890123" />
    </div>
    <div>
      <label>Precio ($)</label>
      <input type="number" id="price" min="0" step="0.01" placeholder="0.00" />
    </div>
    <div>
      <label>Descuento (%)</label>
      <input type="number" id="discount" min="0" max="100" step="1" placeholder="0" />
    </div>
    <div>
      <label>Cantidad / Stock</label>
      <input type="number" id="quantity" min="0" step="1" placeholder="0" />
    </div>
    <div>
      <label>Stock mínimo</label>
      <input type="number" id="stockMin" min="0" step="1" placeholder="0" />
    </div>
    <div>
      <label>Categoría</label>
      <select id="category">
        <option value="">-- Selecciona --</option>
        <option>Accesorios para el cabello</option>
        <option>Anillos</option>
        <option>Aritos</option>
        <option>Billeteras</option>
        <option>Carteras</option>
        <option>Case audífonos</option>
        <option>Case teléfonos</option>
        <option>Chokers</option>
        <option>Collares</option>
        <option>General</option>
        <option>Lentes de sol</option>
        <option>Otros</option>
        <option>Pulseras</option>
        <option>Relojes</option>
      </select>
    </div>
    <div>
      <label>Código interno (SKU)</label>
      <input type="text" id="code" placeholder="Ej: COLL001" />
    </div>
  </div>

  <div style="width:100%;max-width:900px;">
    <label>Fotografía</label>
    <input type="file" id="photo" accept="image/*" />
    <br />
    <img id="previewImg" style="display:none;" />
  </div>

  <div class="actions">
    <button class="stamp" onclick="guardarProducto()"><i class="fa-solid fa-save"></i> Guardar producto</button>
    <button class="stamp" onclick="limpiarFormulario()"><i class="fa-solid fa-eraser"></i> Limpiar</button>
    <button class="stamp" onclick="volverAtras()"><i class="fa-solid fa-arrow-left"></i> Volver</button>
  </div>

  <div id="msg" class="result-message"></div>

  <!-- CAPA DE DATOS INDEXEDDB -->
  <script>
    const DB = (() => {
      const INV_KEY = 'inv_v2';
      return {
        saveInventory: async (arr) => await localforage.setItem(INV_KEY, arr),
        loadInventory: async () => (await localforage.getItem(INV_KEY)) || []
      };
    })();
  </script>

  <script>
    (async () => {
      let inventory = await DB.loadInventory();

      // Preview de imagen
      document.getElementById('photo').addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = evt => {
          const img = document.getElementById('previewImg');
          img.src = evt.target.result;
          img.style.display = 'block';
        };
        reader.readAsDataURL(file);
      });

      window.guardarProducto = async () => {
        const name = document.getElementById('name').value.trim();
        const barcode = document.getElementById('barcode').value.trim();
        const price = parseFloat(document.getElementById('price').value) || 0;
        const discount = parseFloat(document.getElementById('discount').value) || 0;
        const quantity = parseInt(document.getElementById('quantity').value) || 0;
        const stockMin = parseInt(document.getElementById('stockMin').value) || 0;
        const category = document.getElementById('category').value;
        const code = document.getElementById('code').value.trim();
        const photoFile = document.getElementById('photo').files[0];

        if (!name || !code) {
          alert('Nombre y código interno son obligatorios');
          return;
        }

        // Si el código ya existe, sobrescribimos
        const existingIndex = inventory.findIndex(p => p.code === code);
        const newItem = {
          name,
          barcode,
          price,
          discount,
          quantity,
          stockMin,
          category,
          code,
          date: new Date().toISOString()
        };

        if (existingIndex >= 0) {
          inventory[existingIndex] = newItem;
        } else {
          inventory.push(newItem);
        }

        // Guardar imagen si hay
        if (photoFile) {
          const blob = await fetch(URL.createObjectURL(photoFile)).then(r => r.blob());
          await localforage.setItem(`img_${code}`, blob);
        }

        await DB.saveInventory(inventory);
        document.getElementById('msg').textContent = 'Producto guardado ✅';
        limpiarFormulario();
      };

      window.limpiarFormulario = () => {
        document.querySelectorAll('input, select').forEach(el => el.value = '');
        document.getElementById('previewImg').style.display = 'none';
        document.getElementById('msg').textContent = '';
      };

      window.volverAtras = () => {
        window.location.href = 'menu.html';
      };
    })();
  </script>
</body>
</html>
