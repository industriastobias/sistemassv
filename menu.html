<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="robots" content="noindex,nofollow">
  <meta name="description" content="Dashboard TOBIAS PALACIOS">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' *.googleapis.com cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' *.googleapis.com; font-src 'self' *.gstatic.com; img-src 'self' data: blob:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" href="https://fonts.googleapis.com/icon?family=Material+Icons" as="style" crossorigin>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" as="style" crossorigin>
  <title>Dashboard – TOBIAS PALACIOS</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    :root {
      --color-bg: #ffffff;
      --color-panel: #ffffff;
      --color-accent: #DBB8BC;
      --color-text: #1F2937;
      --color-muted: #9CA3AF;
      --color-danger: #EF4444;
      --color-border: #DBB8BC;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
      --radius: 10px;
      --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-smooth: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      --font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    .nav-link, .logout-btn, .user-avatar { will-change: transform; transform: translateZ(0); backface-visibility: hidden; perspective: 1000px; }
    body { font-family: var(--font-family); background: var(--color-bg); color: var(--color-text); display: flex; min-height: 100vh; overflow: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .sidebar { width: 260px; background: var(--color-panel); padding: 1.5rem 1rem; border-right: 1px solid var(--color-border); height: 100vh; display: flex; flex-direction: column; }
    .nav { display: flex; flex-direction: column; gap: .6rem; flex-grow: 1; overflow-y: auto; list-style: none; overflow-anchor: none; }
    .nav-link { display: flex; align-items: center; gap: .8rem; padding: .8rem 1rem; border-radius: var(--radius); text-decoration: none; color: var(--color-text); font-size: 1rem; font-weight: 500; transition: background var(--transition-fast), color var(--transition-fast); white-space: nowrap; border: 2px solid transparent; background: transparent; cursor: pointer; width: 100%; position: relative; touch-action: manipulation; -webkit-user-select: none; user-select: none; transform: translateZ(0); }
    .nav-link:hover { background: rgba(219, 184, 188, 0.15); }
    .nav-link.active { background: var(--color-accent); color: #fff; }
    .nav-link:focus-visible { outline: 2px solid var(--color-accent); outline-offset: -2px; transition: outline-offset var(--transition-fast); }
    .nav-link .material-icons { font-size: 22px; flex-shrink: 0; transform: translateZ(0); }
    main { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 2rem clamp(1rem, 4vw, 2.5rem); }
    .welcome { font-size: clamp(1.8rem, 5cqw, 2.4rem); font-weight: 800; color: var(--color-accent); margin-bottom: .3rem; transform: translateZ(0); }
    .subtitle { font-size: clamp(1rem, 2.5cqw, 1.1rem); color: var(--color-muted); transform: translateZ(0); }
    .right-panel { position: absolute; right: 1.5rem; top: 1rem; display: flex; flex-direction: column; align-items: center; justify-content: space-between; height: calc(100% - 2rem); min-height: 120px; }
    .user-section { text-align: center; display: flex; flex-direction: column; align-items: center; gap: .5rem; }
    .user-avatar { width: 85px; height: 85px; border-radius: 50%; object-fit: cover; border: 3px solid var(--color-accent); background: var(--color-panel); transition: transform var(--transition-smooth); touch-action: manipulation; user-select: none; }
    .user-avatar:hover { transform: scale(1.05); }
    .logout-btn { background: var(--color-danger); color: #fff; border: none; border-radius: var(--radius); padding: .8rem 1.5rem; font-size: 1rem; font-weight: 500; cursor: pointer; transition: transform var(--transition-fast), box-shadow var(--transition-fast); display: inline-flex; align-items: center; gap: .5rem; box-shadow: var(--shadow-sm); min-width: fit-content; transform: translateZ(0); touch-action: manipulation; -webkit-user-select: none; user-select: none; }
    .logout-btn:active { transform: scale(0.95) translateZ(0); transition-duration: 0.05s; }
    .logout-btn:hover { box-shadow: var(--shadow-md); }
    .logout-btn:focus-visible { outline: 2px solid var(--color-accent); outline-offset: 2px; }
    .nav::-webkit-scrollbar { width: 6px; }
    .nav::-webkit-scrollbar-track { background: transparent; }
    .nav::-webkit-scrollbar-thumb { background: var(--color-accent); border-radius: 3px; }

    #kioskBtn {
      position: fixed;
      bottom: 10px;
      right: 10px;
      z-index: 9999;
      padding: 6px 10px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      background: #00796b;
      color: #fff;
      cursor: pointer;
    }

    @media (max-width: 1024px) {
      .sidebar { height: 100dvh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    }

    @media (max-width: 768px) {
      body { flex-direction: column; overflow: auto; }
      .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; border-right: none; border-bottom: 1px solid var(--color-border); padding: 1rem; position: sticky; top: 0; z-index: 100; background: rgba(255, 255, 255, 0.85); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); will-change: transform; transform: translateZ(0); }
      .nav { flex-direction: row; gap: .4rem; flex-wrap: nowrap; }
      .nav-link { flex: 0 0 auto; padding: .7rem .9rem; font-size: .9rem; }
      .right-panel { position: static; flex-direction: row; justify-content: space-between; width: 100%; padding: 1rem; height: auto; border-top: 1px solid var(--color-border); }
      .logout-btn { margin-bottom: 0; padding: .7rem 1.2rem; }
      .user-avatar { width: 65px; height: 65px; }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
    }

    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border-width: 0; }
  </style>
</head>
<body>

<aside class="sidebar" aria-label="Navegación principal">
  <nav class="nav" id="main-nav" role="navigation">
    <a class="nav-link" href="compra.html" data-page="compra"><span class="material-icons" aria-hidden="true">shopping_cart</span><span>Compra</span></a>
    <a class="nav-link" href="almacenamiento.html" data-page="almacenamiento"><span class="material-icons" aria-hidden="true">warehouse</span><span>Almacenamiento</span></a>
    <a class="nav-link" href="lista.html" data-page="lista"><span class="material-icons" aria-hidden="true">account_balance</span><span>Finanzas</span></a>
    <a class="nav-link" href="inventario.html" data-page="inventario"><span class="material-icons" aria-hidden="true">inventory_2</span><span>Inventario</span></a>
    <a class="nav-link" href="gastos.html" data-page="gastos"><span class="material-icons" aria-hidden="true">store</span><span>Catálogo</span></a>
    <a class="nav-link" href="clientes.html" data-page="clientes"><span class="material-icons" aria-hidden="true">groups</span><span>Clientes</span></a>
    <a class="nav-link" href="descuentos.html" data-page="descuentos"><span class="material-icons" aria-hidden="true">local_offer</span><span>Descuentos</span></a>
    <a class="nav-link" href="facturas.html" data-page="facturas"><span class="material-icons" aria-hidden="true">receipt_long</span><span>Facturas</span></a>
    <a class="nav-link" href="traslados.html" data-page="traslados"><span class="material-icons" aria-hidden="true">local_shipping</span><span>Traslados</span></a>
    <a class="nav-link" href="venta.html" data-page="venta"><span class="material-icons" aria-hidden="true">point_of_sale</span><span>Venta</span></a>
    <a class="nav-link" href="Verificasion.html" data-page="Verificasion"><span class="material-icons" aria-hidden="true">verified</span><span>Verificación</span></a>

    <button id="exportBtn" class="nav-link" style="margin-top: auto;"><span class="material-icons" aria-hidden="true">archive</span><span>Exportar ZIP</span></button>
    <button id="importBtn" class="nav-link"><span class="material-icons" aria-hidden="true">unarchive</span><span>Importar ZIP</span></button>
    <input type="file" id="importFile" accept=".zip" style="display:none;" />
  </nav>
</aside>

<div class="right-panel" role="complementary" aria-label="Panel de usuario">
  <div class="user-section">
    <img id="userPhoto" class="user-avatar" src="user2005.jpg" alt="Avatar del usuario ERNESTO TOBIAS" loading="lazy" width="85" height="85">
    <div id="userName" class="user-name">ERNESTO TOBIAS</div>
  </div>
  <button id="logoutBtn" class="logout-btn" aria-label="Cerrar sesión"><span class="material-icons" aria-hidden="true">logout</span><span>Exit</span></button>
</div>

<main role="main">
  <h1 class="welcome">TOBIAS PALACIOS</h1>
  <p class="subtitle">A FAMILY COMPANY</p>
</main>

<!-- Botón modo kiosko -->
<button id="kioskBtn">Modo kiosko</button>

<script>
  const CONFIG = { DB_NAME: 'menuDB', STORE_SESSION: 'userSession', DEFAULT_AVATAR: 'user2005.jpg', DEFAULT_USER: 'Usuario', REDIRECT_PAGE: 'index.html' };
  const Logger = { warn: (...args) => console.warn('[Dashboard]', ...args) };

  class StorageManager {
    static #instance = null;
    static getInstance() { if (!this.#instance) this.#instance = new StorageManager(); return this.#instance; }
    constructor() { this.db = null; this.#open(); }
    async #open() { return new Promise((res, rej) => { const req = indexedDB.open(CONFIG.DB_NAME, 1); req.onerror = () => rej(req.error); req.onsuccess = () => { this.db = req.result; res(); }; req.onupgradeneeded = () => { const d = req.result; if (!d.objectStoreNames.contains(CONFIG.STORE_SESSION)) d.createObjectStore(CONFIG.STORE_SESSION, { keyPath: 'id', autoIncrement: true }); }; }); }
    async getLastSession() { if (!this.db) await this.#open(); const tx = this.db.transaction([CONFIG.STORE_SESSION], 'readonly'); return new Promise(res => { tx.objectStore(CONFIG.STORE_SESSION).openCursor(null, 'prev').onsuccess = (e) => res(e.target.result?.value || null); }); }
    async clear() { if (!this.db) await this.#open(); this.db.transaction([CONFIG.STORE_SESSION], 'readwrite').objectStore(CONFIG.STORE_SESSION).clear(); }
  }

  const AuthManager = {
    check: () => { if (sessionStorage.getItem('loggedIn') !== 'true') { location.replace(CONFIG.REDIRECT_PAGE); return false; } return true; },
    logout: async () => { await StorageManager.getInstance().clear(); sessionStorage.clear(); location.replace(CONFIG.REDIRECT_PAGE); }
  };

  const UIManager = {
    async init() { const [photo, name] = [sessionStorage.getItem('foto'), sessionStorage.getItem('nombre')]; if (photo && name) this.update(photo, name); else { const session = await StorageManager.getInstance().getLastSession(); if (session?.foto && session?.nombre) { sessionStorage.setItem('foto', session.foto); sessionStorage.setItem('nombre', session.nombre); this.update(session.foto, session.nombre); } else this.update(CONFIG.DEFAULT_AVATAR, CONFIG.DEFAULT_USER); } },
    update(foto, nombre) { const imgEl = document.getElementById('userPhoto'); const nameEl = document.getElementById('userName'); if (imgEl) { imgEl.src = foto; imgEl.onerror = () => imgEl.src = CONFIG.DEFAULT_AVATAR; } if (nameEl) nameEl.textContent = nombre || CONFIG.DEFAULT_USER; }
  };

  const NavManager = { init() { const current = location.pathname.split('/').pop(); document.querySelectorAll('.nav-link').forEach(link => { if (link.getAttribute('href') === current) { link.classList.add('active'); link.setAttribute('aria-current', 'page'); } }); } };

  /* ----------  EXPORTAR / IMPORTAR ZIP  ---------- */
  async function exportLocalForageBlobs(zipFolder) {
    const keys = await localforage.keys();
    for (const key of keys) {
      if (key.startsWith('img_compra_')) continue;
      if (key.startsWith('img_')) {
        try {
          const blob = await localforage.getItem(key);
          if (blob) zipFolder.file(`${key}.jpg`, blob);
        } catch (e) {
          console.warn('No se pudo leer', key, e);
        }
      }
    }
  }

  async function importLocalForageBlobs(zip) {
    const imgFolder = zip.folder('localforage');
    if (!imgFolder) return;
    for (const [fileName, zipEntry] of Object.entries(imgFolder.files)) {
      if (!zipEntry.dir && fileName.startsWith('img_')) {
        try {
          const blob = await zipEntry.async('blob');
          const key = fileName.replace('.jpg', '');
          await localforage.setItem(key, blob);
        } catch (e) {
          console.warn('Error al restaurar', fileName, e);
        }
      }
    }
  }

  async function exportZIP() {
    const zip = new JSZip();

    for (let key in localStorage) {
      if (key.startsWith('compra_')) continue;
      try {
        zip.file(`localStorage/${key}`, localStorage.getItem(key));
      } catch {}
    }

    const dbs = await window.indexedDB.databases?.() || [];
    for (const dbInfo of dbs) {
      const db = await new Promise((res, rej) => {
        const req = indexedDB.open(dbInfo.name);
        req.onsuccess = () => res(req.result);
        req.onerror = () => rej(req.error);
      });
      const tx = db.transaction(db.objectStoreNames, 'readonly');
      for (const storeName of db.objectStoreNames) {
        if (storeName.toLowerCase().includes('compra')) continue;
        const store = tx.objectStore(storeName);
        const all = await store.getAll();
        zip.file(`indexedDB/${dbInfo.name}/${storeName}.json`, JSON.stringify(all));
      }
    }

    await exportLocalForageBlobs(zip.folder('localforage'));

    const blob = await zip.generateAsync({ type: 'blob' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `backup-${new Date().toISOString().split('T')[0]}.zip`;
    a.click();
  }

  async function importZIP(file) {
    const zip = await JSZip.loadAsync(file);
    for (const [path, zipEntry] of Object.entries(zip.files)) {
      if (path.startsWith('localStorage/')) {
        const key = path.replace('localStorage/', '');
        const content = await zipEntry.async('string');
        localStorage.setItem(key, content);
      }
      if (path.startsWith('indexedDB/')) {
        const json = await zipEntry.async('string');
        const parts = path.split('/');
        const dbName = parts[1];
        const storeName = parts[2].replace('.json', '');
        const data = JSON.parse(json);
        const req = indexedDB.open(dbName, 1);
        req.onsuccess = () => {
          const db = req.result;
          const tx = db.transaction(storeName, 'readwrite');
          const store = tx.objectStore(storeName);
          data.forEach(item => store.put(item));
        };
      }
    }
    await importLocalForageBlobs(zip);
    alert('✅ Datos importados correctamente. Refresca las páginas para ver los cambios.');
  }

  document.getElementById('exportBtn').addEventListener('click', exportZIP);
  document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFile').click());
  document.getElementById('importFile').addEventListener('change', e => { const file = e.target.files[0]; if (file) importZIP(file); });

  /* ----------  MODO KIOSKO  ---------- */
  (() => {
    const btn = document.getElementById('kioskBtn');
    const KIOSK_KEY = 'kioskActivo';

    function estaEnFullscreen() {
      return !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
    }

    function toggleFullscreen() {
      if (!estaEnFullscreen()) {
        const el = document.documentElement;
        (el.requestFullscreen || el.webkitRequestFullscreen || el.mozRequestFullScreen || el.msRequestFullscreen).call(el);
      } else {
        (document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen).call(document);
      }
    }

    function actualizaUI() {
      const activo = estaEnFullscreen();
      btn.textContent = activo ? 'Salir kiosko' : 'Modo kiosko';
      localStorage.setItem(KIOSK_KEY, activo ? '1' : '0');
    }

    btn.addEventListener('click', () => {
      toggleFullscreen();
      actualizaUI();
    });

    ['fullscreenchange','webkitfullscreenchange','mozfullscreenchange','msfullscreenchange']
      .forEach(ev => document.addEventListener(ev, actualizaUI));

    if (localStorage.getItem(KIOSK_KEY) === '1') {
      toggleFullscreen();
      actualizaUI();
    }
  })();

  (function () {
    'use strict';
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init, { passive: true }); else init();
    async function init() {
      if (!AuthManager.check()) return;
      UIManager.init().catch(Logger.warn); NavManager.init();
      const logoutBtn = document.getElementById('logoutBtn'); if (logoutBtn) logoutBtn.addEventListener('click', (e) => { e.preventDefault(); AuthManager.logout(); }, { passive: false });
    }
  })();
</script>
</body>
</html>
